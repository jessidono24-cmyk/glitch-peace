(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const r of l)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function a(l){const r={};return l.integrity&&(r.integrity=l.integrity),l.referrerPolicy&&(r.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?r.credentials="include":l.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(l){if(l.ep)return;l.ep=!0;const r=a(l);fetch(l.href,r)}})();const s={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},le={[s.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[s.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[s.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[s.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[s.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[s.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[s.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[s.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[s.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[s.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[s.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[s.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[s.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[s.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[s.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[s.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[s.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},p=44,G=2,ut={small:10,medium:13,large:17},Ke={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function xe(e){const t={};for(const[a,i]of Object.entries(le))t[a]={bg:i.bg,bd:i.bd,glow:i.glow};if(e)for(const[a,i]of Object.entries(e))Object.assign(t[a],i);return t}const pt=xe(null),mt=xe({[s.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[s.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[s.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[s.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[s.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[s.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[s.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[s.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[s.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),re={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},$=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[s.DESPAIR,s.TERROR,s.HOPELESS],hazardCounts:[6,5,4],specialTiles:[s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[s.RAGE,s.DESPAIR,s.GLITCH],hazardCounts:[5,6,5],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[s.TERROR,s.SELF_HARM,s.HOPELESS],hazardCounts:[4,3,5],specialTiles:[s.TELEPORT,s.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[s.ARCHETYPE,s.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM,s.PAIN],hazardCounts:[7,6,4,3],specialTiles:[s.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[s.TERROR,s.RAGE,s.GLITCH],hazardCounts:[6,5,4],specialTiles:[s.COVER,s.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[s.TRAP,s.RAGE,s.DESPAIR,s.TERROR],hazardCounts:[6,4,5,4],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[s.HOPELESS,s.DESPAIR,s.GLITCH],hazardCounts:[4,4,4],specialTiles:[s.TELEPORT,s.ARCHETYPE,s.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[s.DESPAIR,s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM,s.GLITCH,s.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[s.ARCHETYPE,s.TELEPORT,s.INSIGHT,s.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],ne=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],yt=["memory…","choice…","echo…","void…","self…","signal…","fragment…","persist…","clarity…","dissolve…","boundary…","witness…","anchor…","pattern…","emergence…","dragon…","guide…","orb…","fear…","hope…"],ct=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],gt=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],wt=["small","medium","large"],At=["easy","normal","hard"],D={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let He=[],et=0,J=0,Le=[],x="B",ye=0;function tt(e){x=e}function at(e){ye=e}function Et(e){ye+=e}function Tt(e=1){J+=e}function it(e){J=Math.max(0,J-e)}function St(e){Le.push(e)}function lt(e){He=e}function Ve(){et=0,J=0,Le=[],x="B",ye=0}const u={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function bt(){Object.assign(u,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function rt(e){return{maxhp:u.maxHp>100,speed:u.moveDelay<120,magnet:u.magnet,freeze:u.freeze,aura:u.aura,energy:u.energyMax>100,rewind:u.temporalRewind,pulse:u.glitchPulse}[e]||!1}let _="title";function U(e){_=e}const R={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title"};function O(e){return Math.floor(Math.random()*e)}function he(e){return e[O(e.length)]}function Ae(e,t,a){return Math.max(t,Math.min(a,e))}const ze=[1,1,2,3,5,8,13,21,34,55,89];function Mt(e){return ze[Math.min(e,ze.length-1)]}const ot="glitch_peace_v4";function Ct(e){try{localStorage.setItem(ot+"_scores",JSON.stringify(e))}catch{}}function st(){try{const e=localStorage.getItem(ot+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Be(){return ut[D.gridSize]}function Rt(){return Ke[D.difficulty]}function nt(){return Be()*p+(Be()-1)*G}function ce(){return nt()+48}function ge(){return nt()+148}function vt(e){const t=Array.from({length:e},()=>new Array(e).fill(s.VOID)),a=Math.floor(e*e*.07);for(let i=0;i<a;i++){const l=1+O(e-2),r=1+O(e-2);t[l][r]=s.WALL}return t}function pe(e,t,a,i,l){let r=0,d=0;for(;r<t&&d<9999;){d++;const f=O(i),h=O(i);if(e[f][h]===s.VOID){if(f<2&&h<2)continue;e[f][h]=a,r++}}}function Pt(e,t,a,i,l,r,d){const f=Rt(),h=vt(t);h[0][0]=s.VOID,t>1&&(h[0][1]=s.VOID,h[1][0]=s.VOID);const m=Mt(a+2)+(t-13>0?t-13:0),y=1+Math.floor(a/3);if(e.hazardSet.forEach((N,C)=>{const E=Math.round((e.hazardCounts[C]||4)*f.hazMul);pe(h,E,N,t)}),pe(h,m,s.PEACE,t),pe(h,y,s.INSIGHT,t),e.specialTiles.forEach(N=>pe(h,2,N,t)),d&&d.length>0&&pe(h,3,s.MEMORY,t),e.id==="aztec")for(let N=0;N<t*2;N++){const C=1+O(t-2),E=1+O(t-2);h[C][E]===s.VOID&&(h[C][E]=s.WALL)}const w=e.id==="bedroom"?2:e.id==="summit"?1:0,c=Math.min(e.enemyCount+Math.floor(a*.5)+w,10),o=Math.max(1,c+(D.difficulty==="hard"?2:D.difficulty==="easy"?-1:0)),M=[],T=Math.max(2,Math.floor(t/5));for(let N=0;N<o;N++){let C,E,H=0;do C=T+O(t-T*2),E=T+O(t-T*2),H++;while((h[C][E]!==s.VOID||C<2&&E<2)&&H<400);M.push({y:C,x:E,timer:O(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+O(3),prevY:C,prevX:E,momentum:[0,0],type:"hunter"})}let P=null;if(a>=6&&(e.id==="summit"||e.id==="integration")){const N=Math.floor(t/2),C=Math.floor(t/2);h[C][N]=s.VOID,P={y:C,x:N,hp:5+a,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:h,enemies:M,boss:P,sz:t,level:a,ds:e,player:{y:0,x:0},hp:l!==void 0?Math.min(r,l+25):r,score:i||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:m,insightLeft:y,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+O(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function z(e,t,a,i,l,r){if(!(!D.particles||!e))for(let d=0;d<l;d++){const f=Math.PI*2*d/l+Math.random()*.6,h=r*(.6+Math.random()*.8);e.particles.push({x:t*(p+G)+p/2,y:a*(p+G)+p/2,vx:Math.cos(f)*h,vy:Math.sin(f)*h-1,r:2+Math.random()*3,color:i,life:20+O(16),maxLife:36})}}function ve(e,t,a,i){!D.particles||!e||(e.resonanceWave={x:t*(p+G)+p/2,y:a*(p+G)+p/2,r:0,maxR:200,color:i,alpha:.55})}function ft(e,t){D.particles&&e.echos.push({x:e.player.x*(p+G)+p/2,y:e.player.y*(p+G)+p/2,life:30,maxLife:30,size:p*.38,color:t==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}function It(e,t,a,i,l,r,d){const f=e,h=f.sz,m=Ke[D.difficulty];if(!f||f.hp<=0)return;if(u.freeze&&u.freezeTimer>0){u.freezeTimer-=t;return}const y=f.slowMoves?1.5:1,w=m.eSpeedBase-f.level*30,c=Math.max(m.eSpeedMin,w)*(i==="A"?.65:1)*y;if(f.level>=3){if(l.splice(0,l.length,...l.filter(o=>o.life>0)),Math.random()<6e-4*f.level&&l.length<3){const o=O(h),M=O(h);f.grid[o][M]===s.VOID&&l.push({y:o,x:M,timer:0,life:5e3+O(4e3)})}for(const o of l)if(o.life-=t,o.timer+=t,o.timer>450){o.timer=0;const M=f.player.x-o.x,T=f.player.y-o.y,P=T>0?1:T<0?-1:0,N=M>0?1:M<0?-1:0,C=o.y+P,E=o.x+N;C>=0&&C<h&&E>=0&&E<h&&(o.y=C,o.x=E),o.y===f.player.y&&o.x===f.player.x&&(f.hp=Math.max(0,f.hp-8),o.life=0,f.shakeFrames=4,f.flashColor="#8800ff",f.flashAlpha=.18,r("CHAOS PHANTOM!","#aa00ff",35))}}if(f.boss&&f.boss.hp>0){const o=f.boss;if(o.timer+=t,o.phaseTimer-=t,o.phaseTimer<=0&&(o.phase=o.phase==="chase"?"orbit":"chase",o.phaseTimer=400+O(300)),o.timer>280){o.timer=0;let M=f.player.x,T=f.player.y;f.level>=8&&(M+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,T+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const P=T-o.y,N=M-o.x,C=P>0?1:P<0?-1:0,E=N>0?1:N<0?-1:0;if(C&&o.y+C>=0&&o.y+C<h?o.y+=C:E&&o.x+E>=0&&o.x+E<h&&(o.x+=E),o.y===f.player.y&&o.x===f.player.x){const H=Math.round(40*m.dmgMul*(i==="A"?1.3:1));f.hp=Math.max(0,f.hp-H),f.shakeFrames=14,f.flashColor="#ff00aa",f.flashAlpha=.45,z(f,f.player.x,f.player.y,"#ff00aa",22,5),r("BOSS! -"+H,"#ff00aa",50)}}}for(const o of f.enemies){if(o.stunTimer>0){o.stunTimer-=t;continue}if(o.timer+=t,o.timer<c)continue;o.timer=0,o.prevY=o.y,o.prevX=o.x;const M=o.behavior||f.ds.enemyBehavior,T=f.player.x-o.x,P=f.player.y-o.y,N=Math.abs(T)+Math.abs(P);let C=!1;if(M==="wander"||N>h*.7){const E=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[H,I]of E){const g=o.y+H,S=o.x+I;if(g>=0&&g<h&&S>=0&&S<h&&f.grid[g][S]!==s.WALL){o.y=g,o.x=S,C=!0;break}}}else if(M==="patrol"){o.patrolAngle+=(Math.random()-.5)*.4;const E=Math.round(Math.sin(o.patrolAngle)),H=Math.round(Math.cos(o.patrolAngle)),I=o.y+Ae(E,-1,1),g=o.x+Ae(H,-1,1);if(I>=0&&I<h&&g>=0&&g<h&&f.grid[I][g]!==s.WALL&&(o.y=I,o.x=g,C=!0),N<5&&Math.random()<.7){const S=P>0?1:P<0?-1:0,n=T>0?1:T<0?-1:0,b=o.y+S,L=o.x+n;b>=0&&b<h&&L>=0&&L<h&&f.grid[b][L]!==s.WALL&&(o.y=b,o.x=L)}}else if(M==="orbit"){o.orbitAngle+=.25;const E=f.player.x+Math.round(Math.cos(o.orbitAngle)*o.orbitR),H=f.player.y+Math.round(Math.sin(o.orbitAngle)*o.orbitR),I=H-o.y>0?1:H-o.y<0?-1:0,g=E-o.x>0?1:E-o.x<0?-1:0;o.y+I>=0&&o.y+I<h&&o.x+g>=0&&o.x+g<h&&f.grid[o.y+I][o.x+g]!==s.WALL&&(o.y+=I,o.x+=g)}else if(M==="chase_fast"||M==="adaptive"||M==="predictive"){let E=f.player.x,H=f.player.y;M==="predictive"&&f.level>=7&&(E+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,H+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const I=E-o.x,g=H-o.y,S=Math.abs(g)>=Math.abs(I)?[[g>0?1:-1,0],[0,I>0?1:-1]]:[[0,I>0?1:-1],[g>0?1:-1,0]];for(const[n,b]of S){const L=o.y+n,k=o.x+b;if(L>=0&&L<h&&k>=0&&k<h&&f.grid[L][k]!==s.WALL){o.y=L,o.x=k,C=!0;break}}if(!C){const n=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[b,L]of n){const k=o.y+b,B=o.x+L;if(k>=0&&k<h&&B>=0&&B<h&&f.grid[k][B]!==s.WALL){o.y=k,o.x=B;break}}}}else if(M==="rush"){const E=Math.abs(P)>=Math.abs(T)?[[P>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[P>0?1:-1,0]];for(const[H,I]of E){const g=o.y+H,S=o.x+I;if(g>=0&&g<h&&S>=0&&S<h&&f.grid[g][S]!==s.WALL){o.y=g,o.x=S,C=!0;break}}if(!C){const H=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[I,g]of H){const S=o.y+I,n=o.x+g;if(S>=0&&S<h&&n>=0&&n<h&&f.grid[S][n]!==s.WALL){o.y=S,o.x=n;break}}}}else if(M==="scatter"){const E=Math.abs(P)>=Math.abs(T)?[[P>0?-1:1,0],[0,T>0?-1:1]]:[[0,T>0?-1:1],[P>0?-1:1,0]];for(const[H,I]of E){const g=o.y+H,S=o.x+I;if(g>=0&&g<h&&S>=0&&S<h&&f.grid[g][S]!==s.WALL){o.y=g,o.x=S,C=!0;break}}if(!C){const H=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[I,g]of H){const S=o.y+I,n=o.x+g;if(S>=0&&S<h&&n>=0&&n<h&&f.grid[S][n]!==s.WALL){o.y=S,o.x=n;break}}}}else if(M==="labyrinth"){if(N<4){const E=Math.abs(P)>=Math.abs(T)?[[P>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[P>0?1:-1,0]];for(const[H,I]of E){const g=o.y+H,S=o.x+I;if(g>=0&&g<h&&S>=0&&S<h&&f.grid[g][S]!==s.WALL){o.y=g,o.x=S,C=!0;break}}}if(!C){o.patrolAngle+=Math.random()<.35?(Math.random()-.5)*1.2:0;const E=Math.round(Math.sin(o.patrolAngle)),H=Math.round(Math.cos(o.patrolAngle)),I=o.y+Ae(E,-1,1),g=o.x+Ae(H,-1,1);if(I>=0&&I<h&&g>=0&&g<h&&f.grid[I][g]!==s.WALL&&(o.y=I,o.x=g,C=!0),!C){o.patrolAngle+=Math.PI*.5;const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[n,b]of S){const L=o.y+n,k=o.x+b;if(L>=0&&L<h&&k>=0&&k<h&&f.grid[L][k]!==s.WALL){o.y=L,o.x=k;break}}}}}else{const E=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[H,I]of E){const g=o.y+H,S=o.x+I;if(g>=0&&g<h&&S>=0&&S<h&&f.grid[g][S]!==s.WALL){o.y=g,o.x=S;break}}}if(o.y===f.player.y&&o.x===f.player.x)if(u.shield&&u.shieldTimer>0)o.stunTimer=1300,r("SHIELD HELD!","#00ffcc",38),z(f,f.player.x,f.player.y,"#00ffcc",14,3);else{const E=Math.round(22*m.dmgMul*(i==="A"?1.3:1));f.hp=Math.max(0,f.hp-E),f.shakeFrames=8,f.flashColor="#ff2200",f.flashAlpha=.35,z(f,f.player.x,f.player.y,"#ff4400",16,4),o.stunTimer=900,u.shieldCount=0,u.comboCount=0,r("HIT! -"+E,"#ff4400",40),d(f,"panic")}for(const E of f.captureZones)Math.abs(o.x-f.player.x)<=E.r&&Math.abs(o.y-f.player.y)<=E.r&&(f.hp=Math.max(0,f.hp-5),r("CAPTURED!","#ff0044",25))}f.captureZones=f.captureZones.filter(o=>(o.timer--,o.timer>0))}function Te(e,t){u.emotion=t,u.emotionTimer=120,e.emotionTimer=120,e.slowMoves=t==="hopeless"||t==="despair"}function oe(e,t,a,i){e&&(e.msg=t,e.msgColor=a,e.msgTimer=i)}function Dt(e,t,a){const i=re[t];if(i){if(e.archetypeActive=!0,e.archetypeType=t,e.archetypeTimer=180,u.archetypePower=i.power,u.archetypeDuration=180,oe(e,i.activationMsg,"#ffdd00",70),ve(e,e.player.x,e.player.y,"#ffdd00"),z(e,e.player.x,e.player.y,"#ffdd00",24,4),t==="child"){for(let l=0;l<e.sz;l++)for(let r=0;r<e.sz;r++)e.grid[l][r]===s.HIDDEN&&e.tileFlicker.push({y:l,x:r,t:200,reveal:!0});oe(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}t==="protector"&&(u.shield=!0,u.shieldTimer=30,z(e,e.player.x,e.player.y,"#88ccff",20,5)),t==="orb"&&(u.phaseShift=!0,u.phaseTimer=15),t==="captor"&&(u.temporalRewind=!0,u.rewindBuffer=u.rewindBuffer.slice(-3))}}function Ye(e){const t=u.archetypePower;if(!t)return;const a=e.sz;if(t==="wall_jump")for(const[i,l]of[[-2,0],[2,0],[0,-2],[0,2]]){const r=e.player.y+i,d=e.player.x+l;if(r>=0&&r<a&&d>=0&&d<a&&e.grid[r][d]!==s.WALL){ft(e,"B"),e.player.y=r,e.player.x=d,z(e,d,r,"#ffaa00",16,3),oe(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(t==="phase_walk")u.phaseShift=!0,u.phaseTimer=10,oe(e,"ORB PHASE ACTIVE","#aaddff",35);else if(t==="rewind")if(u.rewindBuffer.length>0){const i=u.rewindBuffer.pop();if(e.player.y=i.y,e.player.x=i.x,i.grid)for(let l=0;l<a;l++)for(let r=0;r<a;r++)e.grid[l][r]=i.grid[l][r];z(e,e.player.x,e.player.y,"#ffaadd",20,3),oe(e,"TEMPORAL REWIND","#ffaadd",40)}else oe(e,"NO REWIND MEMORY","#443344",30);else if(t==="shield_burst"){u.shield=!0,u.shieldTimer=25;for(const i of e.enemies)i.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),z(e,e.player.x,e.player.y,"#88ccff",30,6),oe(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function Lt(e,t,a,i,l,r,d,f){const h=e.sz,m=e.player.y+t,y=e.player.x+a;if(m<0||m>=h||y<0||y>=h)return!1;const w=e.grid[m][y];if(w===s.WALL&&!(u.phaseShift&&u.phaseTimer>0)||w===s.HIDDEN&&i==="A"&&!u.phaseShift)return!1;if(u.temporalRewind&&u.rewindBuffer.length<8){const o=e.grid.map(M=>[...M]);u.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:o})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),ft(e,i),D.particles&&e.trail.push({x:e.player.x*(p+G)+p/2,y:e.player.y*(p+G)+p/2,life:14,maxLife:14,color:i==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=m,e.player.x=y,u.phaseShift&&u.phaseTimer>0&&(u.phaseTimer--,u.phaseTimer<=0&&(u.phaseShift=!1,r("PHASE FADED","#445566",25))),u.shield&&u.shieldTimer>0&&(u.shieldTimer--,u.shieldTimer<=0&&(u.shield=!1,r("SHIELD FADED","#445566",25))),i==="A"?u.energy=Math.max(0,u.energy-.9):u.energy=Math.min(u.energyMax,u.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,u.archetypePower=null));const c={dmgMul:D.difficulty==="hard"?1.45:D.difficulty==="easy"?.55:1};if(w===s.PEACE){const o=Math.round((150+e.level*20)*u.resonanceMultiplier);e.score+=o,e.hp=Math.min(u.maxHp,e.hp+20),e.grid[m][y]=s.VOID,e.peaceLeft--,z(e,y,m,u.particleColor,18,3.5),u.shieldCount++,u.comboCount++,u.resonanceMultiplier=Math.min(4,1+u.comboCount*.25),u.glitchPulseCharge=Math.min(100,u.glitchPulseCharge+15),u.comboCount>=3&&!u.shield?(u.shield=!0,u.shieldTimer=20,ve(e,y,m,"#00ffcc"),z(e,y,m,"#00ffcc",26,5),r("SHIELD ACTIVE! ×"+u.resonanceMultiplier.toFixed(1),"#00ffcc",55)):r("+PEACE +"+o+(u.comboCount>1?" ×"+u.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),Te(e,"peace"),e.peaceLeft===0&&l()}else if(w===s.INSIGHT){const o=Math.round((300+e.level*50)*u.resonanceMultiplier);e.score+=o,f(d+1),e.grid[m][y]=s.VOID,e.insightLeft--,z(e,y,m,"#00eeff",24,4),ve(e,y,m,"#00eeff"),r("INSIGHT ◆×"+(d+1),"#00eeff",60);for(let M=0;M<h;M++)for(let T=0;T<h;T++)e.grid[M][T]===s.HIDDEN&&e.tileFlicker.push({y:M,x:T,t:100,reveal:!0});Te(e,"clarity")}else if(w===s.ARCHETYPE){e.grid[m][y]=s.VOID;const o=e.ds.archetype==="all"?he(Object.keys(re)):e.ds.archetype||"orb";Dt(e,o)}else if(w===s.TELEPORT){let o=0,M=O(h),T=O(h);for(;(e.grid[M][T]!==s.VOID||M===m&&T===y)&&o<200;)M=O(h),T=O(h),o++;e.player.y=M,e.player.x=T,e.grid[m][y]=s.VOID,z(e,T,M,"#00aaff",16,3),r("LEAP!","#00aaff",30)}else if(w===s.COVER){r("COVER","#446688",20);for(const o of e.enemies)Math.abs(o.y-m)+Math.abs(o.x-y)<=2&&(o.stunTimer=600)}else if(w===s.MEMORY)e.grid[m][y]=s.VOID,e.score+=50,r("MEMORY ECHO…","#88bbaa",30),z(e,y,m,"#88bbaa",10,2);else if(le[w]&&le[w].dmg>0)if(u.shield&&u.shieldTimer>0)r("SHIELDED","#00ffcc",20);else{const o=le[w];let M=Math.round(o.dmg*c.dmgMul*(i==="A"?1.25:1));if(w===s.RAGE&&o.push>0){const C=m+t*o.push,E=y+a*o.push;C>=0&&C<h&&E>=0&&E<h&&e.grid[C][E]!==s.WALL&&(e.player.y=C,e.player.x=E,r("-RAGE (pushed!)","#ff0066",40))}if(w===s.SELF_HARM&&(e.grid[m][y]=s.PAIN),w===s.HOPELESS&&Te(e,"hopeless"),w===s.DESPAIR&&Math.random()<.3){const C=[[1,0],[-1,0],[0,1],[0,-1]],[E,H]=he(C),I=m+E,g=y+H;I>=0&&I<h&&g>=0&&g<h&&e.grid[I][g]===s.VOID&&(e.grid[I][g]=s.DESPAIR)}e.hp=Math.max(0,e.hp-M),e.shakeFrames=5;const T={[s.DESPAIR]:"#2244ff",[s.TERROR]:"#ff0000",[s.SELF_HARM]:"#660000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},P={[s.DESPAIR]:"#3355ff",[s.TERROR]:"#ff2222",[s.SELF_HARM]:"#880000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},N={[s.DESPAIR]:"-DESPAIR",[s.TERROR]:"-TERROR!",[s.SELF_HARM]:"-SELF·HARM",[s.RAGE]:"-RAGE",[s.HOPELESS]:"-HOPELESS",[s.GLITCH]:"-GLITCH",[s.TRAP]:"-TRAP",[s.PAIN]:"-PAIN"};e.flashColor=T[w]||"#ff0000",e.flashAlpha=.28,z(e,y,m,P[w]||"#ff2222",10,3),r((N[w]||"-HAZARD")+" -"+M,P[w]||"#ff3333",38),u.shieldCount=0,u.comboCount=0,u.resonanceMultiplier=1}return!0}function Nt(e,t){if(!e||u.glitchPulseCharge<100)return;u.glitchPulseCharge=0;let a=0;for(let i=0;i<e.sz;i++)for(let l=0;l<e.sz;l++)Math.abs(i-e.player.y)+Math.abs(l-e.player.x)<=3&&le[e.grid[i][l]]?.dmg>0&&(e.grid[i][l]=s.VOID,a++);for(const i of e.enemies)Math.abs(i.y-e.player.y)+Math.abs(i.x-e.player.x)<=4&&(i.stunTimer=1800);ve(e,e.player.x,e.player.y,"#aa00ff"),z(e,e.player.x,e.player.y,"#aa00ff",32,6),t("GLITCH PULSE! "+a+" CLEARED","#aa00ff",55)}function Ot(e,t){if(e.spreadTimer-=t,e.spreadTimer>0)return;e.spreadTimer=3e3+O(1e3);const a=e.sz,i=[];for(let l=0;l<a;l++)for(let r=0;r<a;r++){const d=e.grid[l][r];if((d===s.DESPAIR||d===s.HOPELESS)&&le[d].spread)for(const[f,h]of[[1,0],[-1,0],[0,1],[0,-1]]){const m=l+f,y=r+h;m>=0&&m<a&&y>=0&&y<a&&e.grid[m][y]===s.VOID&&Math.random()<.2&&i.push({y:m,x:y,type:d})}}for(const l of i.slice(0,2))e.grid[l.y][l.x]=l.type}function Ht(e){return e==="A"?mt:pt}function Bt(e,t,a,i,l,r,d,f,h,m,y,w){const c=a;if(!c)return;const o=c.sz,M=o*p+(o-1)*G,T=M+48,P=M+148,N=Ht(i),C=c.ds;e.clearRect(0,0,T,P),e.fillStyle=C.bgColor,e.fillRect(0,0,T,P);const E=e.createRadialGradient(T*.7,P*.3,0,T*.7,P*.3,T*.8);E.addColorStop(0,C.bgAccent+"33"),E.addColorStop(1,"transparent"),e.fillStyle=E,e.fillRect(0,0,T,P),i==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,T,P));for(let n=0;n<P;n+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,n,T,1);for(const n of l){const b=n.a*(.5+.5*Math.sin(t*8e-4+n.phase));e.globalAlpha=b,e.fillStyle="#ffffff",e.beginPath(),e.arc(n.x,n.y,n.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,m>0&&(e.fillStyle=`rgba(${i==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*P),T,2+Math.floor(Math.random()*4)));let H=0,I=0;c.shakeFrames>0&&(H=(Math.random()-.5)*9*(c.shakeFrames/10),I=(Math.random()-.5)*9*(c.shakeFrames/10),c.shakeFrames--);const g=(T-M)/2+H,S=100+I;for(const n of r)n.x+=n.dx,n.y+=n.dy,n.life--,n.life>n.maxLife*.85?n.alpha=Math.min(n.targetAlpha,(n.maxLife-n.life)/(n.maxLife*.15)*n.targetAlpha):n.life<n.maxLife*.15&&(n.alpha=Math.max(0,n.life/(n.maxLife*.15)*n.targetAlpha)),n.life<=0&&(n.life=200+Math.floor(Math.random()*400),n.maxLife=600),e.globalAlpha=n.alpha*(i==="A"?.7:1),e.fillStyle=i==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(n.text,n.x,n.y);e.globalAlpha=1,e.textAlign="left";for(let n=0;n<o;n++)for(let b=0;b<o;b++){const L=c.grid[n][b],k=c.tileFlicker.find(F=>F.y===n&&F.x===b),B=k&&k.reveal&&L===s.HIDDEN?s.INSIGHT:L,j=le[B]||le[s.VOID],ie=N[B]||N[s.VOID],V=g+b*(p+G),Y=S+n*(p+G);if(f&&(n===h.row||b===h.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):ie.glow?(e.shadowColor=ie.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=ie.bg,e.beginPath(),e.roundRect(V,Y,p,p,4),e.fill(),e.strokeStyle=ie.bd,e.lineWidth=1,e.beginPath(),e.roundRect(V+.5,Y+.5,p-1,p-1,4),e.stroke(),e.shadowBlur=0,B===s.PEACE){const F=(t*.05+n*6+b*4)%(p*2);if(F<p){const X=e.createLinearGradient(V,Y+F-5,V,Y+F+5);X.addColorStop(0,"rgba(0,255,140,0)"),X.addColorStop(.5,"rgba(0,255,140,0.45)"),X.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=X,e.fillRect(V,Y,p,p)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(V+p/2,Y+p/2,5+2*Math.sin(t*.006+b+n),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(B===s.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const F=t*.008+b*1.7+n*1.3;for(let X=0;X<4;X++){const ue=F+X*Math.PI*.5,K=7+2*Math.sin(t*.005+X);e.fillStyle=X%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(V+p/2+Math.cos(ue)*K,Y+p/2+Math.sin(ue)*K,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(B===s.ARCHETYPE){const F=.5+.5*Math.sin(t*.01+b+n);e.shadowColor="#ffdd00",e.shadowBlur=16*F,e.fillStyle=`rgba(255,220,0,${.15*F})`,e.fillRect(V,Y,p,p),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",V+p/2,Y+p/2+6),e.shadowBlur=0,e.textAlign="left"}if(B===s.TELEPORT){const F=.5+.5*Math.sin(t*.012+b*2+n);e.shadowColor="#00aaff",e.shadowBlur=12*F,e.fillStyle=`rgba(0,170,255,${.2*F})`,e.fillRect(V,Y,p,p),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",V+p/2,Y+p/2+5),e.shadowBlur=0,e.textAlign="left"}if(B===s.MEMORY){const F=.3+.3*Math.sin(t*.004+b+n);e.globalAlpha=.4+.2*F,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(V,Y,p,p),e.globalAlpha=1}j.sym&&B!==s.VOID&&B!==s.WALL&&B!==s.PEACE&&B!==s.INSIGHT&&B!==s.ARCHETYPE&&B!==s.TELEPORT&&B!==s.HIDDEN&&B!==s.MEMORY&&(e.fillStyle=ie.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(j.sym,V+p/2,Y+p/2+5),e.globalAlpha=1,e.textAlign="left"),(B===s.PEACE||B===s.INSIGHT)&&u.magnet&&Math.abs(n-c.player.y)+Math.abs(b-c.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(V+2,Y+2,p-4,p-4,4),e.stroke())}c.tileFlicker=c.tileFlicker.filter(n=>(n.t--,n.t>0)),w&&w.length>0&&(w.forEach((n,b)=>{const L=g+n.x*(p+G),k=S+n.y*(p+G),B=.22-b*.05,j=n.hpDelta>0?"#00ffaa":n.hpDelta<0?"#ff3333":"#aaaaff";e.globalAlpha=Math.max(.05,B),e.strokeStyle=j,e.lineWidth=2,e.beginPath(),e.roundRect(L+2,k+2,p-4,p-4,3),e.stroke(),n.hpDelta!==0&&(e.fillStyle=j,e.font="9px Courier New",e.textAlign="center",e.globalAlpha=Math.max(.1,B+.1),e.fillText((n.hpDelta>0?"+":"")+Math.round(n.hpDelta),L+p/2,k+p/2+4),e.textAlign="left")}),e.globalAlpha=1);for(const n of c.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(n.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(g+n.x*(p+G)+p/2,S+n.y*(p+G)+p/2,(n.r+.5)*(p+G),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const n of c.echos)e.globalAlpha=n.life/n.maxLife*.55,e.fillStyle=n.color,e.beginPath(),e.arc(g+n.x,S+n.y,n.size*(n.life/n.maxLife),0,Math.PI*2),e.fill(),n.life--;if(c.echos=c.echos.filter(n=>n.life>0),e.globalAlpha=1,D.particles){for(const n of c.trail)e.globalAlpha=n.life/n.maxLife*.48,e.fillStyle=n.color,e.shadowColor=n.color,e.shadowBlur=4,e.beginPath(),e.arc(g+n.x,S+n.y,4*(n.life/n.maxLife),0,Math.PI*2),e.fill(),n.life--;c.trail=c.trail.filter(n=>n.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const n of d){if(n.life<=0)continue;const b=g+n.x*(p+G),L=S+n.y*(p+G),k=.3+.25*Math.sin(Date.now()*.006+n.x);e.globalAlpha=k,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(b+8,L+8,p-16,p-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",b+p/2,L+p/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const n of c.enemies){const b=g+n.x*(p+G),L=S+n.y*(p+G),k=.6+.4*Math.sin(t*.007+n.x*1.3),B=n.stunTimer>0,j=n.type==="rush",ie=B?"#8888ff":j?"#ff0066":i==="A"?"#ff0044":"#ff4400";e.shadowColor=ie,e.shadowBlur=14*k,e.fillStyle=B?"#1c1c44":j?"#4a0022":i==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(b+5,L+5,p-10,p-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=B?"#4444aa":j?"#ff0066":i==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(b+p/2,L+12),e.lineTo(b+p-12,L+p-12),e.lineTo(b+12,L+p-12),e.closePath(),e.fill(),e.fillStyle=B?"#6666cc":"#ffcc00",e.beginPath(),e.arc(b+p/2,L+p/2+2,4,0,Math.PI*2),e.fill()}if(c.boss&&c.boss.hp>0){const n=c.boss,b=g+n.x*(p+G),L=S+n.y*(p+G),k=.5+.5*Math.sin(t*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*k,e.fillStyle="#330022",e.beginPath(),e.roundRect(b+1,L+1,p-2,p-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(b+p/2,L+p/2,p*.3+4*k,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+n.hp,b+p/2,L+p/2+4),e.textAlign="left",e.shadowBlur=0}{const n=g+c.player.x*(p+G),b=S+c.player.y*(p+G),L=.55+.45*Math.sin(t*.009),k=u.shield&&u.shieldTimer>0,B=u.phaseShift&&u.phaseTimer>0,j=u.emotion,V=i==="A"?"#ff0088":k?"#00ffff":B?"#00aaff":j==="panic"?"#ff0022":j==="hopeless"?"#0033aa":j==="peace"?"#00ffcc":j==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=V,e.shadowBlur=(k?36:u.aura?30:22)*L;const Y=i==="A"?"#aa0055":"#005533",F=i==="A"?"#cc0077":"#00cc77",X=i==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=Y,e.beginPath(),e.roundRect(n+4,b+4,p-8,p-8,8),e.fill(),e.fillStyle=F,e.beginPath(),e.roundRect(n+9,b+9,p-18,p-18,5),e.fill(),e.fillStyle=X,e.beginPath(),e.roundRect(n+15,b+15,p-30,p-30,3),e.fill(),c.archetypeActive){const K=re[c.archetypeType||"orb"];e.strokeStyle=K.glow,e.lineWidth=2,e.shadowColor=K.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(n+1,b+1,p-2,p-2,8),e.stroke()}k&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(n,b,p,p,8),e.stroke()),B&&(e.globalAlpha=.4),u.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*L})`,e.lineWidth=3,e.beginPath(),e.arc(n+p/2,b+p/2,(p/2+7)*L,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=V,e.lineWidth=2;const ue=9;[[n,b],[n+p,b],[n,b+p],[n+p,b+p]].forEach(([K,we],Ue)=>{const Fe=Ue%2===0?1:-1,We=Ue<2?1:-1;e.beginPath(),e.moveTo(K+Fe*2,we),e.lineTo(K+Fe*(2+ue),we),e.stroke(),e.beginPath(),e.moveTo(K,we+We*2),e.lineTo(K,we+We*(2+ue)),e.stroke()}),e.shadowBlur=0}if(D.particles){a.particles=a.particles.filter(n=>n.life>0);for(const n of a.particles)e.globalAlpha=Math.max(0,n.life/n.maxLife),e.fillStyle=n.color,e.shadowColor=n.color,e.shadowBlur=7,e.beginPath(),e.arc(g+n.x,S+n.y,n.r*(n.life/n.maxLife),0,Math.PI*2),e.fill(),n.x+=n.vx,n.y+=n.vy,n.vy+=.25,n.life--;e.globalAlpha=1,e.shadowBlur=0}if(c.resonanceWave){const n=c.resonanceWave;n.r+=7,n.alpha=Math.max(0,n.alpha-.55/n.maxR*7),e.strokeStyle=n.color,e.globalAlpha=n.alpha,e.lineWidth=2,e.shadowColor=n.color,e.shadowBlur=10,e.beginPath(),e.arc(g+n.x,S+n.y,n.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,n.r>=n.maxR&&(c.resonanceWave=null)}if(c.flashAlpha>0&&(e.fillStyle=c.flashColor,e.globalAlpha=c.flashAlpha,e.fillRect(g,S,M,M),e.globalAlpha=1,c.flashAlpha=Math.max(0,c.flashAlpha-.04)),i==="A"){const n=e.createRadialGradient(T/2,P/2,P*.25,T/2,P/2,P*.9);n.addColorStop(0,"rgba(80,0,20,0)"),n.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=n,e.fillRect(0,0,T,P)}kt(e,c,T,P,M,g,S,i)}function kt(e,t,a,i,l,r,d,f){const h=u,m=92;e.fillStyle="#070714",e.fillRect(0,0,a,m),e.strokeStyle="rgba(255,255,255,0.04)",e.lineWidth=1,e.beginPath(),e.moveTo(0,m),e.lineTo(a,m),e.stroke(),e.fillStyle=t.ds.bgAccent+"88",e.fillRect(0,0,a,16),e.fillStyle="#334455",e.font="8px Courier New",e.textAlign="center",e.fillText(t.ds.name+"  ·  "+t.ds.emotion,a/2,11),e.textAlign="left";const y=138;e.fillStyle="#333",e.font="9px Courier New",e.fillText("HP",14,30),e.fillStyle="#0e0e1e",e.fillRect(32,20,y,13);const w=t.hp/h.maxHp,c=w>.6?"#00ff88":w>.3?"#ffaa00":"#ff3333";e.fillStyle=c,e.shadowColor=c,e.shadowBlur=5,e.fillRect(32,20,y*w,13),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.06)",e.strokeRect(32,20,y,13),e.fillStyle="#444",e.font="8px Courier New",e.fillText(t.hp+"/"+h.maxHp,32+y+4,30);const o=138;e.fillStyle="#222",e.font="8px Courier New",e.fillText("EN",14,50),e.fillStyle="#0a0a1a",e.fillRect(32,41,o,9);const M=f==="A"?"#ff0055":"#0088ff";if(e.fillStyle=M,e.shadowColor=M,e.shadowBlur=4,e.fillRect(32,41,o*(h.energy/h.energyMax),9),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.04)",e.strokeRect(32,41,o,9),h.glitchPulse){e.fillStyle="#220a22",e.fillRect(32,53,o,6);const N=h.glitchPulseCharge/100;e.fillStyle=N>=1?"#ff00ff":"#660088",e.fillRect(32,53,o*N,6),e.strokeStyle="rgba(150,0,200,0.2)",e.strokeRect(32,53,o,6),e.fillStyle=N>=1?"#ff00ff":"#553355",e.font="7px Courier New",e.fillText("PULSE"+(N>=1?" READY":""),32+o+4,59)}if(t.archetypeActive&&t.archetypeType){const N=re[t.archetypeType];e.fillStyle=N?N.color:"#ffdd00",e.shadowColor=N?N.glow:"#ffdd00",e.shadowBlur=4,e.font="8px Courier New",e.fillText(N?N.name+" ACTIVE":"[ARCH ACTIVE]",14,68),e.shadowBlur=0}else h.shield&&h.shieldTimer>0?(e.fillStyle="#00ffff",e.font="8px Courier New",e.fillText("SHIELD×"+h.shieldTimer,14,68)):h.shieldCount>0&&(e.fillStyle="#334455",e.font="8px Courier New",e.fillText("streak "+h.shieldCount+"/3",14,68));h.comboCount>1&&(e.fillStyle="#ffcc00",e.shadowColor="#ffcc00",e.shadowBlur=6,e.font="8px Courier New",e.fillText("COMBO ×"+h.resonanceMultiplier.toFixed(1),14,80),e.shadowBlur=0),e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=5,e.font="9px Courier New",e.fillText("◆×"+(window._insightTokens||0),14,90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 19px Courier New",e.textAlign="center",e.fillText(String(t.score).padStart(7,"0"),a/2,38),e.shadowBlur=0,e.fillStyle="#222838",e.font="8px Courier New",e.fillText("SCORE",a/2,52);const T=f==="A"?"#ff0055":"#00aa55";e.fillStyle=T,e.shadowColor=T,e.shadowBlur=7,e.font="bold 10px Courier New",e.fillText("MTX·"+f,a/2-16,68),e.shadowBlur=0,e.textAlign="right",e.fillStyle="#445566",e.font="10px Courier New",e.fillText("LVL "+t.level,a-12,30),e.fillStyle="#005533",e.fillText("◈×"+t.peaceLeft,a-12,44),e.fillStyle="#223344",e.font="8px Courier New",e.fillText((window._dreamIdx+1||1)+"/10 DREAMS",a-12,58);const P=window._tmods;P&&(e.fillStyle="#223344",e.font="7px Courier New",e.fillText(P.lunarName||"",a-12,70),e.fillText(P.planetName||"",a-12,80)),e.textAlign="left",t.msg&&t.msgTimer>0&&(e.globalAlpha=Math.min(1,t.msgTimer/18),e.font="bold 16px Courier New",e.textAlign="center",e.fillStyle=t.msgColor,e.shadowColor=t.msgColor,e.shadowBlur=16,e.fillText(t.msg,a/2,d-16),e.textAlign="left",e.globalAlpha=1,e.shadowBlur=0,t.msgTimer--),e.fillStyle="#070714",e.fillRect(0,i-28,a,28),e.strokeStyle="rgba(255,255,255,0.03)",e.beginPath(),e.moveTo(0,i-28),e.lineTo(a,i-28),e.stroke(),e.fillStyle="#1a1a2a",e.font="8px Courier New",e.textAlign="center",e.fillText("WASD/ARROWS · SHIFT=matrix · ESC=pause · J=arch · R=pulse · Q=freeze · C=contain",a/2,i-11),e.textAlign="left"}function Gt(e,t,a){for(const i of t)e.globalAlpha=i.a*(.5+.5*Math.sin(a*8e-4+i.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(i.x,i.y,i.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function _t(e,t,a,i,l,r,d){e.fillStyle="#02020a",e.fillRect(0,0,t,a);for(let y=0;y<a;y+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,y,t,1);Gt(e,i,l),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",t/2,a/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",t/2,a/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",t/2,a/2-78);const f=d==="shooter"?"[ SHOOTER MODE ]":"[ GRID MODE ]",h=d==="shooter"?"#ff6622":"#00ff88";e.fillStyle=h,e.shadowColor=h,e.shadowBlur=8,e.font="10px Courier New",e.fillText(f+"  ·  M to switch",t/2,a/2-60),e.shadowBlur=0;const m=a/2-42;ct.forEach((y,w)=>{const c=w===r,o=m+w*36;c&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-130,o-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(t/2-130,o-19,260,28)),e.fillStyle=c?"#00ff88":"#2a3a2a",e.shadowColor=c?"#00ff88":"transparent",e.shadowBlur=c?8:0,e.font=c?"bold 14px Courier New":"12px Courier New",e.fillText(y,t/2,o),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  M toggle mode",t/2,a-20),e.textAlign="left"}function Ut(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",t/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",t/2,68);const l=Math.min($.length,6),r=Math.max(0,Math.min(i-Math.floor(l/2),$.length-l));for(let d=0;d<l;d++){const f=r+d,h=$[f],m=f===i,y=95+d*55;if(m&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(t/2-160,y-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(t/2-160,y-18,320,46)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.font=m?"bold 12px Courier New":"11px Courier New",e.fillText(f+1+".  "+h.name,t/2,y),e.fillStyle=m?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(h.subtitle+"  ·  "+h.emotion,t/2,y+16),m&&h.archetype&&re[h.archetype]){const w=re[h.archetype];e.fillStyle="#665522",e.fillText("archetype: "+w.name+" — "+w.powerDesc,t/2,y+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",t/2,a-20),e.textAlign="left"}function Ft(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",t/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:wt,cur:D.gridSize},{label:"DIFFICULTY",opts:At,cur:D.difficulty},{label:"PARTICLES",opts:["on","off"],cur:D.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((r,d)=>{const f=d===i,h=105+d*68;r.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(r.label,t/2,h)),r.opts.forEach((m,y)=>{const w=m===r.cur,c=t/2+(y-(r.opts.length-1)/2)*110,o=h+24;e.fillStyle=f&&w?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(c-44,o-16,88,24),e.strokeStyle=f&&w?"rgba(0,255,136,0.5)":w?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(c-44,o-16,88,24),e.fillStyle=w?"#00ff88":"#334455",e.shadowColor=w?"#00ff88":"transparent",e.shadowBlur=w?5:0,e.font=w?"bold 11px Courier New":"10px Courier New",e.fillText(m.toUpperCase(),c,o),e.shadowBlur=0}),f&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",t/2-154,h+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",t/2,a-20),e.textAlign="left"}function Wt(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",t/2,50),e.shadowBlur=0,i.length?i.slice(0,8).forEach((l,r)=>{const d=95+r*38,f=r===0?"◈":r===1?"◇":"·";e.fillStyle=r===0?"#ffdd00":r===1?"#aaaaaa":r===2?"#cc8833":"#334455",e.font=r<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${f}  ${String(l.score).padStart(7,"0")}   LVL${String(l.level).padStart(2,"0")}   ${l.dreamscape}   ${l.date}`,t/2,d)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",t/2,a/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",t/2,a-20),e.textAlign="left"}function Vt(e,t,a,i,l,r){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",t/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+l,t/2,68),ne.forEach((d,f)=>{const h=f===i,m=r(d.id),y=l>=d.cost&&!m,w=92+f*48;h&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(t/2-155,w-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(t/2-155,w-14,310,40)),e.fillStyle=m?"#00ff88":y?"#00ccdd":"#334455",e.shadowColor=m?"#00ff88":h?"#00ccdd":"transparent",e.shadowBlur=h&&!m?5:0,e.font="bold 11px Courier New",e.fillText(d.name,t/2-55,w),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(d.desc,t/2-55,w+14),e.fillStyle=m?"#005533":y?"#006677":"#221122",e.font="10px Courier New",e.fillText(m?"OWNED":"◆×"+d.cost,t/2+88,w+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",t/2,a-20),e.textAlign="left"}function zt(e,t,a,i,l){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",t/2,a/2-80),e.shadowBlur=0,i&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(i.ds.name+"  ·  LEVEL "+i.level,t/2,a/2-58),e.fillStyle="#334455",e.fillText(i.ds.narrative,t/2,a/2-44)),gt.forEach((r,d)=>{const f=d===l,h=a/2-14+d*36;f&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-110,h-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(t/2-110,h-18,220,26)),e.fillStyle=f?"#00ff88":"#334433",e.shadowColor=f?"#00ff88":"transparent",e.shadowBlur=f?6:0,e.font=f?"bold 13px Courier New":"12px Courier New",e.fillText(r,t/2,h),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",t/2,a-20),e.textAlign="left"}function Yt(e,t,a,i,l){const r=1-i.timer/220,d=r<.1?r/.1:r>.9?(1-r)/.1:1,f=i.ds||$[0];e.fillStyle=f.bgColor||"#02020a",e.fillRect(0,0,t,a);for(let h=0;h<7;h++){const m=(l*.02+h*t/7)%t;e.strokeStyle=`rgba(0,255,136,${.02*d})`,e.lineWidth=1,e.beginPath(),e.moveTo(m,0),e.lineTo(m-100,a),e.stroke()}if(e.globalAlpha=d,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(i.text,t/2,a/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+f.name,t/2,a/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(f.narrative,t/2,a/2+24),f.archetype&&re[f.archetype]){const h=re[f.archetype];e.fillStyle=h.glow,e.shadowColor=h.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+h.name,t/2,a/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function qt(e,t,a,i,l,r,d,f){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,t,a),e.textAlign="center";const h=i?.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+(h?.name||"THE VOID"),t/2,a/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",t/2,a/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(i.score).padStart(7,"0"),t/2,a/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+i.level,t/2,a/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+r.length+"/"+$.length,t/2,a/2+14),e.fillText("REP "+(f>=0?"+":"")+f+"  ·  ◆×"+d,t/2,a/2+32),l.length>0){const y=l.findIndex(w=>w.score===i.score);y>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(y+1)+" ALL TIME",t/2,a/2+54))}const m=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*m})`,e.fillRect(t/2-110,a/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*m})`,e.strokeRect(t/2-110,a/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",t/2,a/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",t/2,a/2+120),e.textAlign="left"}class $t{constructor(){this.audioContext=null,this.masterGain=null,this.enabled=!0,this.volume=.3,this.initialize()}initialize(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=this.volume,this.masterGain.connect(this.audioContext.destination)}catch(t){console.warn("Web Audio API not supported:",t),this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.masterGain&&(this.masterGain.gain.value=this.volume)}toggle(){return this.enabled=!this.enabled,this.enabled}playPeaceCollect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[523.25,659.25,783.99,1046.5].forEach((i,l)=>{const r=this.audioContext.createOscillator(),d=this.audioContext.createGain();r.type="sine",r.frequency.value=i,d.gain.setValueAtTime(0,t+l*.08),d.gain.linearRampToValueAtTime(.15,t+l*.08+.01),d.gain.exponentialRampToValueAtTime(.001,t+l*.08+.3),r.connect(d),d.connect(this.masterGain),r.start(t+l*.08),r.stop(t+l*.08+.3)})}playDamage(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),l=this.audioContext.createBiquadFilter();a.type="sawtooth",a.frequency.setValueAtTime(80,t),a.frequency.exponentialRampToValueAtTime(40,t+.15),l.type="lowpass",l.frequency.value=800,l.Q.value=5,i.gain.setValueAtTime(.25,t),i.gain.exponentialRampToValueAtTime(.001,t+.15),a.connect(l),l.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.15)}playMatrixSwitch(t=!1){if(!this.enabled||!this.audioContext)return;this.resume();const a=this.audioContext.currentTime,i=this.audioContext.createOscillator(),l=this.audioContext.createGain();i.type="square",t?(i.frequency.setValueAtTime(400,a),i.frequency.exponentialRampToValueAtTime(200,a+.2)):(i.frequency.setValueAtTime(200,a),i.frequency.exponentialRampToValueAtTime(400,a+.2)),l.gain.setValueAtTime(.2,a),l.gain.exponentialRampToValueAtTime(.001,a+.2),i.connect(l),l.connect(this.masterGain),i.start(a),i.stop(a+.2)}playLevelComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[261.63,329.63,392,523.25].forEach(i=>{const l=this.audioContext.createOscillator(),r=this.audioContext.createGain();l.type="sine",l.frequency.value=i,r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(.12,t+.05),r.gain.exponentialRampToValueAtTime(.001,t+.8),l.connect(r),r.connect(this.masterGain),l.start(t),l.stop(t+.8)})}playEnemyHit(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),l=this.audioContext.createBiquadFilter();a.type="triangle",a.frequency.setValueAtTime(150,t),a.frequency.exponentialRampToValueAtTime(50,t+.1),l.type="lowpass",l.frequency.value=400,i.gain.setValueAtTime(.3,t),i.gain.exponentialRampToValueAtTime(.001,t+.1),a.connect(l),l.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.1)}playMenuNav(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.type="sine",a.frequency.value=440,i.gain.setValueAtTime(.1,t),i.gain.exponentialRampToValueAtTime(.001,t+.05),a.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.05)}playMenuSelect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.type="square",a.frequency.value=880,i.gain.setValueAtTime(.15,t),i.gain.exponentialRampToValueAtTime(.001,t+.1),a.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.1)}playArchetypePower(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;for(let a=0;a<5;a++){const i=this.audioContext.createOscillator(),l=this.audioContext.createGain();i.type="sine",i.frequency.value=220*(a+1);const r=t+a*.03;l.gain.setValueAtTime(.08,r),l.gain.exponentialRampToValueAtTime(.001,r+.2),i.connect(l),l.connect(this.masterGain),i.start(r),i.stop(r+.2)}}dispose(){this.audioContext&&this.audioContext.close()}}const v=new $t,jt=new Date("2025-01-29").getTime(),Ee=29.53*24*60*60*1e3,qe=[{name:"New Moon",fraction:0,insightMul:1,enemyMul:.85,desc:"Seed — quiet spawns, tutorial-friendly"},{name:"Waxing Crescent",fraction:.13,insightMul:1.1,enemyMul:.9,desc:"Build — gentle challenge increase"},{name:"First Quarter",fraction:.25,insightMul:1.2,enemyMul:1,desc:"Momentum — balanced tension"},{name:"Waxing Gibbous",fraction:.38,insightMul:1.3,enemyMul:1.1,desc:"Amplify — insight tokens more common"},{name:"Full Moon",fraction:.5,insightMul:1.5,enemyMul:1.2,desc:"Illuminate — peak clarity and challenge"},{name:"Waning Gibbous",fraction:.63,insightMul:1.2,enemyMul:1.1,desc:"Release — pruning, closure rewards"},{name:"Last Quarter",fraction:.75,insightMul:1.1,enemyMul:1,desc:"Reflect — integration, story fragments"},{name:"Waning Crescent",fraction:.88,insightMul:1,enemyMul:.9,desc:"Rest — soft spawns, dreamscape teasers"}],Zt=[{planet:"Sun",coherenceMul:1.2,insightMul:1.1,themes:["Radiance","Will","Clarity"],desc:"Visibility bonuses, coherence stabilisation"},{planet:"Moon",coherenceMul:1.1,insightMul:1.05,themes:["Dream","Tide","Reflection"],desc:"Dreamscape bias, softer soundscape"},{planet:"Mars",coherenceMul:.85,insightMul:1.2,themes:["Trial","Courage","Initiation"],desc:"Enemies more aggressive, higher rewards"},{planet:"Mercury",coherenceMul:1.05,insightMul:1.35,themes:["Signal","Learning","Pathfinding"],desc:"Insight tokens more common, puzzles"},{planet:"Jupiter",coherenceMul:1.15,insightMul:1.25,themes:["Expansion","Wisdom","Fortune"],desc:"Map grows, upgrade shop richer"},{planet:"Venus",coherenceMul:1.25,insightMul:1.15,themes:["Harmony","Beauty","Love"],desc:"Healing nodes, softer hazards"},{planet:"Saturn",coherenceMul:.9,insightMul:1,themes:["Structure","Limits","Discipline"],desc:"Walls and boundaries, planning bonuses"}];function Jt(){return((Date.now()-jt)%Ee+Ee)%Ee/Ee}function $e(){const e=Jt();let t=qe[0];for(const a of qe)e>=a.fraction&&(t=a);return t}function je(){const e=new Date().getDay();return Zt[e]}class Xt{constructor(){this._lunar=$e(),this._planet=je(),this._lastRefresh=0}refresh(){this._lunar=$e(),this._planet=je(),this._lastRefresh=Date.now()}getLunarPhase(){return this._lunar}getPlanetaryDay(){return this._planet}getEnemyMul(){const t=this._lunar.enemyMul,a=this._planet.planet==="Mars"?.1:0;return t+a}getInsightMul(){return this._lunar.insightMul*(this._planet.insightMul??1)}getCoherenceMul(){return this._planet.coherenceMul??1}getModifiers(){return{enemyMul:this.getEnemyMul(),insightMul:this.getInsightMul(),coherenceMul:this.getCoherenceMul(),lunarName:this._lunar.name,planetName:this._planet.planet,lunarDesc:this._lunar.desc,planetDesc:this._planet.desc,themes:this._planet.themes}}}const Pe=new Xt,Ze=[{id:"joy",display:"Joy",valence:1,arousal:.7,coherence:.9},{id:"hope",display:"Hope",valence:.8,arousal:.5,coherence:.8},{id:"trust",display:"Trust",valence:.7,arousal:.4,coherence:.85},{id:"surprise",display:"Surprise",valence:.2,arousal:1,coherence:.5},{id:"fear",display:"Fear",valence:-.7,arousal:.9,coherence:.2},{id:"sadness",display:"Sadness",valence:-1,arousal:.3,coherence:.3},{id:"disgust",display:"Disgust",valence:-.8,arousal:.6,coherence:.1},{id:"anger",display:"Anger",valence:-.9,arousal:.8,coherence:.15},{id:"shame",display:"Shame",valence:-.95,arousal:.5,coherence:.05},{id:"anticipation",display:"Anticipation",valence:.3,arousal:.8,coherence:.6}],Qt=[{id:"FOCUSED_FORCE",label:"Focused Force",test:e=>e.coherence>.8&&e.valence>.5},{id:"CHAOS_BURST",label:"Chaos Burst",test:e=>e.distortion>.7&&e.coherence<.3},{id:"DEEP_INSIGHT",label:"Deep Insight",test:e=>e.coherence>.9&&e.valence>.7},{id:"NUMBNESS",label:"Numbness",test:e=>e.valence<-.7&&e.coherence<.2},{id:"SERENITY",label:"Serenity",test:e=>e.valence>.8&&e.coherence>.8},{id:"TURBULENCE",label:"Turbulence",test:e=>e.distortion>.5&&e.valence<0},{id:"EQUILIBRIUM",label:"Equilibrium",test:e=>Math.abs(e.valence)<.1&&e.coherence>.7}],Je=[{id:"MIND",label:"Mind",test:e=>e.purgDepth<.2},{id:"PURGATORY",label:"Purgatory",test:e=>e.purgDepth>=.2&&e.purgDepth<.5},{id:"IMAGINATION",label:"Imagination",test:e=>e.purgDepth>=.5&&e.purgDepth<.7},{id:"HEAVEN",label:"Heaven",test:e=>e.purgDepth>=.7&&e.valence>.5},{id:"HELL",label:"Hell",test:e=>e.purgDepth>=.7&&e.valence<=.5}];class Kt{constructor(t={}){this.emotions={},Ze.forEach(a=>{this.emotions[a.id]=typeof t[a.id]=="number"?t[a.id]:0}),this.lastUpdate=Date.now(),this.weekdayCoherenceMul=1}getEmotionArray(){return Ze.map(t=>({...t,value:this.emotions[t.id]}))}getDominantEmotion(){return this.getEmotionArray().reduce((i,l)=>i.value>l.value?i:l)}get valence(){let t=this.getEmotionArray(),a=t.reduce((l,r)=>l+r.value*r.valence,0),i=t.reduce((l,r)=>l+r.value,0)||1;return a/i}get coherence(){let t=this.getEmotionArray(),a=t.reduce((l,r)=>l+r.value*r.coherence,0),i=t.reduce((l,r)=>l+r.value,0)||1;return a/i}get distortion(){let t=this.getEmotionArray();return t.reduce((i,l)=>i+l.value*l.arousal*(1-l.coherence),0)/t.length}get purgDepth(){return Math.max(0,Math.min(1,this.distortion))}get synergy(){for(let t of Qt)if(t.test(this))return t;return null}get realm(){for(let t of Je)if(t.test(this))return t;return Je[0]}decay(t=null){let a=Date.now(),i=t||(a-this.lastUpdate)/1e3;this.lastUpdate=a;let l=.05*this.weekdayCoherenceMul;for(let r in this.emotions)this.emotions[r]>0?this.emotions[r]=Math.max(0,this.emotions[r]-l*i):this.emotions[r]<0&&(this.emotions[r]=Math.min(0,this.emotions[r]+l*i))}setEmotion(t,a){this.emotions.hasOwnProperty(t)&&(this.emotions[t]=Math.max(-1,Math.min(1,a)))}addEmotion(t,a){this.emotions.hasOwnProperty(t)&&this.setEmotion(t,this.emotions[t]+a)}setAll(t){for(let a in t)this.setEmotion(a,t[a])}toJSON(){return{...this.emotions}}fromJSON(t){for(let a in t)this.setEmotion(a,t[a])}}class xt{constructor(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}calculateHPDelta(t,a){const i=a.dmgMul||1,l=a.healMul||1;switch(t){case 1:return-8*i;case 2:return-20*i;case 3:return-14*i;case 4:return 20*l;case 8:return-18*i;case 9:return-12*i;case 14:return-16*i;case 16:return-6*i;default:return 0}}update(t,a,i=3){if(!t||!a){this.active=!1,this.ghostPath=[];return}this.active=!0,this.direction=t,this.ghostPath=[];const[l,r]=t;let d=a.hp,f=a.player.y,h=a.player.x;const m=a.sz;for(let y=0;y<i;y++){const w=f+l,c=h+r;if(w<0||w>=m||c<0||c>=m)break;const o=a.grid[w][c];if(o===5)break;const M=this.calculateHPDelta(o,a);d+=M,this.ghostPath.push({y:w,x:c,tile:o,hpDelta:M,projectedHP:d}),f=w,h=c}this.projectedHP=d}deactivate(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}getGhostPath(){return this.active?this.ghostPath:[]}getTotalDelta(t){return!this.active||this.ghostPath.length===0?0:this.projectedHP-t}isActive(){return this.active&&this.ghostPath.length>0}}class ea{constructor(t){this.emotionalField=t.emotionalField,this.temporalSystem=t.temporalSystem,this.sfxManager=t.sfxManager,this.impulseBuffer=t.impulseBuffer,this.consequencePreview=t.consequencePreview,this.name="base",this.isActive=!1}init(t){this.isActive=!0}update(t,a,i,l){return null}render(t,a,i){}handleInput(t,a,i){return!1}cleanup(){this.isActive=!1}getState(){return{name:this.name}}restoreState(t){}getConfigOptions(){return[]}onEmotionChange(t){}onTemporalUpdate(t){}}class ta extends ea{constructor(t){super(t),this.name="shooter",this.player={x:0,y:0,vx:0,vy:0,angle:0,health:100,maxHealth:100,speed:200,radius:15,score:0},this.bullets=[],this.fireRate=.25,this.timeSinceLastShot=0,this.bulletSpeed=400,this.bulletDamage=10,this.enemies=[],this.wave=1,this.enemiesPerWave=5,this.waveTimer=0,this.waveDelay=3,this.powerUps=[],this.activePowerUps=[],this.mouseX=0,this.mouseY=0,this.isShooting=!1,this.worldWidth=800,this.worldHeight=600,this.camera={x:0,y:0},this._lastDt=.016}init(t={}){super.init(t),this.player.x=this.worldWidth/2,this.player.y=this.worldHeight/2,this.player.vx=0,this.player.vy=0,this.player.health=this.player.maxHealth,this.player.score=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps=[],this.wave=1,this.waveTimer=0,this.spawnWave(),this.timeSinceLastShot=0,console.log("[ShooterMode] Initialized")}update(t,a,i,l){const r=t/1e3;return this._lastDt=r,this.updatePlayerMovement(r,a),this.updateShooting(r),this.updateBullets(r),this.updateEnemies(r),this.updatePowerUps(r),this.checkCollisions(),this.updateWaveSpawning(r),this.updateCamera(),this.player.health<=0?{phase:"dead",data:{score:this.player.score,mode:"shooter"}}:(this.enemies.length>3?this.emotionalField.addEmotion("fear",.1*r):this.emotionalField.addEmotion("joy",.05*r),this.emotionalField.decay(r),null)}updatePlayerMovement(t,a){let i=0,l=0;if((a.has("w")||a.has("W")||a.has("ArrowUp"))&&(l-=1),(a.has("s")||a.has("S")||a.has("ArrowDown"))&&(l+=1),(a.has("a")||a.has("A")||a.has("ArrowLeft"))&&(i-=1),(a.has("d")||a.has("D")||a.has("ArrowRight"))&&(i+=1),i!==0&&l!==0){const r=Math.sqrt(i*i+l*l);i/=r,l/=r}this.player.vx=i*this.player.speed,this.player.vy=l*this.player.speed,this.player.x+=this.player.vx*t,this.player.y+=this.player.vy*t,this.player.x=Math.max(this.player.radius,Math.min(this.worldWidth-this.player.radius,this.player.x)),this.player.y=Math.max(this.player.radius,Math.min(this.worldHeight-this.player.radius,this.player.y))}updateShooting(t){this.timeSinceLastShot+=t,this.isShooting&&this.timeSinceLastShot>=this.fireRate&&(this.shoot(),this.timeSinceLastShot=0)}shoot(){const t=this.player.angle,a={x:this.player.x,y:this.player.y,vx:Math.cos(t)*this.bulletSpeed,vy:Math.sin(t)*this.bulletSpeed,damage:this.bulletDamage,radius:3,age:0,maxAge:2};this.bullets.push(a),this.sfxManager&&this.sfxManager.playMenuSelect()}updateBullets(t){for(let a=this.bullets.length-1;a>=0;a--){const i=this.bullets[a];i.x+=i.vx*t,i.y+=i.vy*t,i.age+=t,(i.age>i.maxAge||i.x<0||i.x>this.worldWidth||i.y<0||i.y>this.worldHeight)&&this.bullets.splice(a,1)}}updateEnemies(t){for(let a=this.enemies.length-1;a>=0;a--){const i=this.enemies[a],l=this.player.x-i.x,r=this.player.y-i.y,d=Math.sqrt(l*l+r*r);d>0&&(i.x+=l/d*i.speed*t,i.y+=r/d*i.speed*t),i.health<=0&&(this.enemies.splice(a,1),this.player.score+=10,Math.random()<.2&&this.spawnPowerUp(i.x,i.y))}}updatePowerUps(t){for(let a=this.powerUps.length-1;a>=0;a--){const i=this.powerUps[a];i.age+=t,i.age>10&&this.powerUps.splice(a,1)}for(let a=this.activePowerUps.length-1;a>=0;a--){const i=this.activePowerUps[a];i.timeLeft-=t,i.timeLeft<=0&&(this.deactivatePowerUp(i),this.activePowerUps.splice(a,1))}}checkCollisions(){for(let a=this.bullets.length-1;a>=0;a--){const i=this.bullets[a];for(let l=this.enemies.length-1;l>=0;l--){const r=this.enemies[l],d=i.x-r.x,f=i.y-r.y;if(Math.sqrt(d*d+f*f)<i.radius+r.radius){r.health-=i.damage,this.bullets.splice(a,1),this.sfxManager&&this.sfxManager.playEnemyHit();break}}}const t=.5;for(const a of this.enemies){const i=this.player.x-a.x,l=this.player.y-a.y,r=Math.sqrt(i*i+l*l);r<this.player.radius+a.radius&&((!a._contactCooldown||a._contactCooldown<=0)&&(this.player.health-=a.damage,a._contactCooldown=t),r>0&&(this.player.x+=i/r*3,this.player.y+=l/r*3)),a._contactCooldown>0&&(a._contactCooldown-=this._lastDt)}for(let a=this.powerUps.length-1;a>=0;a--){const i=this.powerUps[a],l=this.player.x-i.x,r=this.player.y-i.y;Math.sqrt(l*l+r*r)<this.player.radius+i.radius&&(this.collectPowerUp(i),this.powerUps.splice(a,1))}}spawnWave(){const t=this.enemiesPerWave+Math.floor(this.wave/2);for(let a=0;a<t;a++){const i=Math.floor(Math.random()*4);let l,r;switch(i){case 0:l=Math.random()*this.worldWidth,r=-20;break;case 1:l=this.worldWidth+20,r=Math.random()*this.worldHeight;break;case 2:l=Math.random()*this.worldWidth,r=this.worldHeight+20;break;case 3:l=-20,r=Math.random()*this.worldHeight;break}this.enemies.push({x:l,y:r,health:30+this.wave*5,maxHealth:30+this.wave*5,speed:50+this.wave*2,radius:12,damage:10})}console.log(`[ShooterMode] Wave ${this.wave} spawned: ${t} enemies`)}updateWaveSpawning(t){this.enemies.length===0?(this.waveTimer+=t,this.waveTimer>=this.waveDelay&&(this.wave++,this.waveTimer=0,this.spawnWave())):this.waveTimer=0}spawnPowerUp(t,a){const i=["health","speed","rapidfire","shield"],l=i[Math.floor(Math.random()*i.length)];this.powerUps.push({x:t,y:a,type:l,radius:10,age:0})}collectPowerUp(t){switch(this.sfxManager&&this.sfxManager.playPeaceCollect(),t.type){case"health":this.player.health=Math.min(this.player.maxHealth,this.player.health+30);break;case"speed":this.activePowerUps.push({type:"speed",timeLeft:5}),this.player.speed=300;break;case"rapidfire":this.activePowerUps.push({type:"rapidfire",timeLeft:5}),this.fireRate=.1;break;case"shield":this.activePowerUps.push({type:"shield",timeLeft:8});break}}deactivatePowerUp(t){switch(t.type){case"speed":this.player.speed=200;break;case"rapidfire":this.fireRate=.25;break}}updateCamera(){this.camera.x=this.player.x-300,this.camera.y=this.player.y-250}render(t,a,i){const l=i?.w||t.canvas.width,r=i?.h||t.canvas.height;t.fillStyle="#0a0a0f",t.fillRect(0,0,l,r),t.save(),t.translate(-this.camera.x,-this.camera.y),t.strokeStyle="#333",t.lineWidth=2,t.strokeRect(0,0,this.worldWidth,this.worldHeight);for(const d of this.powerUps)this.drawPowerUp(t,d);t.fillStyle="#00ffff";for(const d of this.bullets)t.beginPath(),t.arc(d.x,d.y,d.radius,0,Math.PI*2),t.fill();for(const d of this.enemies)this.drawEnemy(t,d);this.drawPlayer(t),t.restore(),this.drawHUD(t,l,r)}drawPlayer(t){const a=this.player;t.fillStyle="#00ff88",t.beginPath(),t.arc(a.x,a.y,a.radius,0,Math.PI*2),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(a.x+Math.cos(a.angle)*(a.radius+5),a.y+Math.sin(a.angle)*(a.radius+5)),t.stroke()}drawEnemy(t,a){t.fillStyle="#ff3366",t.beginPath(),t.arc(a.x,a.y,a.radius,0,Math.PI*2),t.fill();const i=a.radius*2,l=3,r=a.health/a.maxHealth;t.fillStyle="#333",t.fillRect(a.x-i/2,a.y-a.radius-8,i,l),t.fillStyle="#00ff00",t.fillRect(a.x-i/2,a.y-a.radius-8,i*r,l)}drawPowerUp(t,a){const i={health:"#00ff00",speed:"#ffff00",rapidfire:"#ff8800",shield:"#0088ff"};t.fillStyle=i[a.type]||"#ffffff",t.beginPath(),t.arc(a.x,a.y,a.radius,0,Math.PI*2),t.fill();const l=Math.sin(a.age*5)*3;t.strokeStyle=i[a.type]||"#ffffff",t.lineWidth=2,t.beginPath(),t.arc(a.x,a.y,a.radius+l,0,Math.PI*2),t.stroke()}drawHUD(t,a,i){t.fillStyle="#ffffff",t.font="16px monospace";const l=Math.max(0,this.player.health/this.player.maxHealth);t.fillStyle=l>.5?"#00ff00":l>.25?"#ffff00":"#ff0000",t.fillText(`HP: ${Math.ceil(this.player.health)}`,10,20),t.fillStyle="#ffffff",t.fillText(`Score: ${this.player.score}`,10,40),t.fillText(`Wave: ${this.wave}`,10,60),t.fillText(`Enemies: ${this.enemies.length}`,10,80);let r=100;for(const d of this.activePowerUps)t.fillStyle="#ffff00",t.fillText(`${d.type.toUpperCase()}: ${Math.ceil(d.timeLeft)}s`,10,r),r+=20}handleInput(t,a,i){if(i&&i.type==="mousemove"){const l=i.target.getBoundingClientRect();this.mouseX=i.clientX-l.left+this.camera.x,this.mouseY=i.clientY-l.top+this.camera.y;const r=this.mouseX-this.player.x,d=this.mouseY-this.player.y;return this.player.angle=Math.atan2(d,r),!0}return a==="mousedown"?(this.isShooting=!0,!0):a==="mouseup"?(this.isShooting=!1,!0):!1}cleanup(){super.cleanup(),this.bullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps=[],console.log("[ShooterMode] Cleaned up")}getState(){return{name:this.name,player:{...this.player},wave:this.wave,score:this.player.score}}restoreState(t){t.player&&(this.player={...this.player,...t.player}),t.wave&&(this.wave=t.wave)}}const ae=document.getElementById("c"),Q=ae.getContext("2d"),fe=Math.min(window.devicePixelRatio||1,2);function _e(){const e=ce(),t=ge();ae.width=e*fe,ae.height=t*fe,ae.style.width=Math.min(e,window.innerWidth-16)+"px",ae.style.height="auto",Q.setTransform(1,0,0,1,0,0),Q.scale(fe,fe)}_e();const me=new Kt,Se=new xt;window.sfxManager=v;const aa={emotionalField:me,temporalSystem:Pe,sfxManager:v,impulseBuffer:null,consequencePreview:Se},se=new ta(aa);let A=null,Oe=null,q=null,Xe=0,Ie=0,ee="grid";const ia=.15;window._insightTokens=J;window._dreamIdx=D.dreamIdx;let Qe=0,be=500,Me=!1,Ce={row:-1,col:-1,t:0},ke=[],De=[],Ge=[],Re={text:"",timer:0,ds:null};const te=new Set;function ht(e,t){De=[];for(let a=0;a<30;a++)De.push({x:Math.random()*e,y:Math.random()*t,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}function la(e,t){Ge=[];for(let a=0;a<5;a++)Ge.push({text:he(yt),x:40+Math.random()*(e-80),y:90+Math.random()*(t-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+O(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}function W(e,t,a){A&&(A.msg=e,A.msgColor=t,A.msgTimer=a)}function ra(e,t,a){const i=st();i.push({score:e,level:t,dreamscape:a?.name||"?",date:new Date().toLocaleDateString()}),i.sort((r,d)=>d.score-r.score);const l=i.slice(0,8);lt(l),Ct(l)}function oa(e){const t=e.ds.environmentEvent,a=e.sz;if(t){if(t==="gravity_shift"){const[i,l]=he([[-1,0],[1,0],[0,-1],[0,1]]),r=e.player.y+i,d=e.player.x+l;r>=0&&r<a&&d>=0&&d<a&&e.grid[r][d]!==5&&(e.player.y=r,e.player.x=d,W("GRAVITY SHIFTS…","#8888ff",40))}else if(t==="loop_reset"){for(let i=-2;i<=2;i++)for(let l=-2;l<=2;l++){const r=e.player.y+i,d=e.player.x+l;r>=0&&r<a&&d>=0&&d<a&&e.grid[r][d]===0&&Math.random()<.25&&(e.grid[r][d]=8)}W("THE LOOP TIGHTENS…","#ff8800",40)}else if(t==="capture_zones"){const i=he(e.enemies);i&&(e.captureZones=[{x:i.x,y:i.y,r:2,timer:300}]),W("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(t==="rapid_spawn"){if(e.enemies.length<10){const i=2+O(a-4),l=2+O(a-4);e.enemies.push({y:i,x:l,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:i,prevX:l,momentum:[0,0],type:"rush"}),W("CHAOS ERUPTS!","#ff0044",40)}}else if(t==="wall_phase"){let i=0;for(let l=0;l<a&&i<4;l++)for(let r=0;r<a&&i<4;r++)e.grid[l][r]===5&&Math.random()<.3&&(e.grid[l][r]=10,i++);W("MEMBRANE DISSOLVES…","#00ccff",40)}else if(t==="glide_nodes"){let i=0,l=0;for(;i<2&&l<999;){l++;const r=O(a),d=O(a);e.grid[r][d]===0&&(e.grid[r][d]=12,i++)}W("GLIDE NODES APPEAR","#00aaff",40)}else if(t==="mashup"){const i=he($.filter(l=>l.id!==e.ds.id));if(i.hazardSet[0]){let l=0,r=0;for(;l<3&&r<999;){r++;const d=O(a),f=O(a);e.grid[d][f]===0&&(e.grid[d][f]=i.hazardSet[0],l++)}}W("DREAMSCAPES MERGE…","#ffaaff",40)}else if(t==="line_of_sight"){for(const r of e.enemies)r.stunTimer>0&&(r.stunTimer=0);let i=0,l=0;for(;i<3&&l<999;){l++;const r=O(a),d=O(a);e.grid[r][d]===0&&Math.random()<.5&&(e.grid[r][d]=2,i++)}W("THE SUMMIT WATCHES…","#ff4422",40)}else if(t==="dead_ends"){let i=0,l=0;for(;i<4&&l<999;){l++;const r=1+O(a-2),d=1+O(a-2);e.grid[r][d]===0&&(e.grid[r][d]=5,i++)}W("THE LABYRINTH SHIFTS…","#cc8800",40)}if(Math.random()<.4){const i=O(a);for(let l=0;l<a;l++)e.grid[i][l]===1?e.grid[i][l]=4:e.grid[i][l]===4&&Math.random()<.3&&(e.grid[i][l]=1);Ce={row:i,col:-1,t:50},Me=!0}}}function dt(e,t,a,i){const l=(a||0)+1;_e();const r=$[e%$.length];tt(r.matrixDefault);const d=Pt(r,Be(),l,t,i,u.maxHp,Le);return la(ce(),ge()),ke=[],be=500+O(500),ht(ce(),ge()),d}function de(e){v.resume(),Pe.refresh();const t=Pe.getModifiers();if(window._tmods=t,ee==="shooter"){Ve(),se.init({}),U("playing"),Ie=0,cancelAnimationFrame(q),q=requestAnimationFrame(Z);return}bt(),Ve(),me.setAll({joy:0,hope:0,trust:0,surprise:0,fear:0,sadness:0,disgust:0,anger:0,shame:0,anticipation:0}),D.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=D.dreamIdx,A=dt(D.dreamIdx,0,0,void 0),U("playing"),Ie=0,at(0),cancelAnimationFrame(q),q=requestAnimationFrame(Z)}function sa(){const e=A,t=(D.dreamIdx+1)%$.length;D.dreamIdx=t,window._dreamIdx=t,St(e.ds.id),v.playLevelComplete(),Re={text:e.ds.completionText,subtext:$[t].narrative,timer:220,ds:$[t]},U("interlude"),setTimeout(()=>{_e(),A=dt(t,e.score+400+e.level*60,e.level,e.hp),A.msg=$[t].name,A.msgColor="#ffdd00",A.msgTimer=90,_==="interlude"&&U("playing")},3600)}function na(e){const t=ne.find(a=>a.id===e);!t||J<t.cost||rt(e)||(it(t.cost),window._insightTokens=J,e==="maxhp"&&(u.maxHp+=25,A&&(A.hp=Math.min(A.hp+25,u.maxHp))),e==="speed"&&(u.moveDelay=Math.max(55,u.moveDelay-15)),e==="magnet"&&(u.magnet=!0),e==="freeze"&&(u.freeze=!0),e==="aura"&&(u.aura=!0),e==="energy"&&(u.energyMax=Math.min(200,u.energyMax+30)),e==="rewind"&&(u.temporalRewind=!0),e==="pulse"&&(u.glitchPulse=!0))}function Z(e){const t=e-Xe;Xe=e;const a=ce(),i=ge();if(_==="title"){_t(Q,a,i,De,e,R.menu,ee),q=requestAnimationFrame(Z);return}if(_==="dreamselect"){Ut(Q,a,i,D.dreamIdx),q=requestAnimationFrame(Z);return}if(_==="options"){Ft(Q,a,i,R.opt),q=requestAnimationFrame(Z);return}if(_==="highscores"){Wt(Q,a,i,He),q=requestAnimationFrame(Z);return}if(_==="upgrade"){Vt(Q,a,i,R.shop,J,rt),q=requestAnimationFrame(Z);return}if(_==="dead"){qt(Q,a,i,Oe,He,Le,J,et),q=requestAnimationFrame(Z);return}if(_==="paused"){zt(Q,a,i,A,R.pause),q=requestAnimationFrame(Z);return}if(_==="interlude"){Yt(Q,a,i,Re,e),Re.timer--,Re.timer<=0&&_==="interlude"&&U("playing"),q=requestAnimationFrame(Z);return}if(ee==="shooter"){const y=se.update(t,te,x,e);se.render(Q,e,{w:a,h:i,DPR:fe}),y&&y.phase==="dead"&&(Oe={score:y.data.score,level:se.wave,ds:{name:"SHOOTER ARENA"}},A=null,U("dead")),q=requestAnimationFrame(Z);return}const l=window._tmods||Pe.getModifiers();A.temporalEnemyMul=l.enemyMul,A.insightMul=l.insightMul;const r=(x==="B"?1.2:.7)*(l.coherenceMul||1);me.weekdayCoherenceMul=r,me.decay(t/1e3);const d=me.getDominantEmotion();d.value>ia&&(u.emotion=d.id);const f=A.slowMoves?u.moveDelay*1.5:u.moveDelay,h={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};let m=null;for(const[y,[w,c]]of Object.entries(h))if(te.has(y)){m=[w,c];break}if(m?Se.update(m,A,3):Se.deactivate(),e-Ie>f){for(const[y,[w,c]]of Object.entries(h))if(te.has(y)){Lt(A,w,c,x,sa,W,J,o=>{for(;J<o;)Tt();window._insightTokens=J}),Ie=e;break}}if(A.emotionTimer>0&&(A.emotionTimer--,A.emotionTimer<=0&&(A.slowMoves=!1,u.emotion="neutral")),Et(t),x==="B"&&ye>4e3&&Math.random()<2e-4*t&&(A.hp=Math.min(u.maxHp,A.hp+1)),x==="A"&&ye>2500&&Math.random()<3e-4*t&&(A.hp=Math.max(0,A.hp-1)),be-=t,be<=0&&(Qe=2+O(4),be=500+O(700)),Me&&(Ce.t--,Ce.t<=0&&(Me=!1)),A.environmentTimer-=t,A.environmentTimer<=0&&(A.environmentTimer=900+O(700),Math.random()<.6&&oa(A)),Ot(A,t),It(A,t,te,x,ke,W,Te),A.hp<=0){Oe=A,ra(A.score,A.level,A.ds),U("dead"),q=requestAnimationFrame(Z);return}Bt(Q,e,A,x,De,Ge,ke,Me,Ce,Qe,fe,Se.getGhostPath()),q=requestAnimationFrame(Z)}window.addEventListener("keydown",e=>{if(te.add(e.key),_==="title"){e.key==="ArrowUp"&&(R.menu=(R.menu-1+5)%5,v.resume(),v.playMenuNav()),e.key==="ArrowDown"&&(R.menu=(R.menu+1)%5,v.resume(),v.playMenuNav()),(e.key==="m"||e.key==="M")&&(ee=ee==="grid"?"shooter":"grid",v.resume(),v.playMatrixSwitch(ee==="grid")),(e.key==="Enter"||e.key===" ")&&(v.resume(),v.playMenuSelect(),R.menu===0?de(D.dreamIdx):R.menu===1?U("dreamselect"):R.menu===2?(R.opt=0,U("options")):R.menu===3?U("highscores"):R.menu===4&&(R.shop=0,R.upgradeFrom="title",U("upgrade"))),e.preventDefault();return}if(_==="dreamselect"){e.key==="ArrowUp"&&(D.dreamIdx=(D.dreamIdx-1+$.length)%$.length,v.resume(),v.playMenuNav()),e.key==="ArrowDown"&&(D.dreamIdx=(D.dreamIdx+1)%$.length,v.resume(),v.playMenuNav()),e.key==="Enter"&&(v.resume(),v.playMenuSelect(),de(D.dreamIdx)),e.key==="Escape"&&U("title"),e.preventDefault();return}if(_==="options"){if(e.key==="ArrowUp"&&(R.opt=(R.opt-1+4)%4,v.resume(),v.playMenuNav()),e.key==="ArrowDown"&&(R.opt=(R.opt+1)%4,v.resume(),v.playMenuNav()),e.key==="ArrowLeft"||e.key==="ArrowRight"){const a=e.key==="ArrowLeft"?-1:1;if(R.opt===0){const i=["small","medium","large"].indexOf(D.gridSize);D.gridSize=["small","medium","large"][(i+a+3)%3]}else if(R.opt===1){const i=["easy","normal","hard"].indexOf(D.difficulty);D.difficulty=["easy","normal","hard"][(i+a+3)%3]}else R.opt===2&&(D.particles=!D.particles);v.resume(),v.playMenuNav()}(e.key==="Enter"||e.key==="Escape")&&(R.opt===3||e.key==="Escape")&&U(A?"paused":"title"),e.preventDefault();return}if(_==="highscores"){(e.key==="Enter"||e.key==="Escape")&&U("title"),e.preventDefault();return}if(_==="upgrade"){e.key==="ArrowUp"&&(R.shop=(R.shop-1+ne.length)%ne.length,v.resume(),v.playMenuNav()),e.key==="ArrowDown"&&(R.shop=(R.shop+1)%ne.length,v.resume(),v.playMenuNav()),e.key==="Enter"&&(v.resume(),v.playMenuSelect(),na(ne[R.shop].id)),e.key==="Escape"&&U(R.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(_==="dead"){(e.key==="Enter"||e.key===" ")&&(v.resume(),v.playMenuSelect(),de(D.dreamIdx)),e.key==="Escape"&&(U("title"),R.menu=0),e.preventDefault();return}if(_==="paused"){e.key==="ArrowUp"&&(R.pause=(R.pause-1+4)%4,v.resume(),v.playMenuNav()),e.key==="ArrowDown"&&(R.pause=(R.pause+1)%4,v.resume(),v.playMenuNav()),e.key==="Enter"&&(R.pause===0?U("playing"):R.pause===1?(R.opt=0,U("options")):R.pause===2?(R.shop=0,R.upgradeFrom="paused",U("upgrade")):(U("title"),R.menu=0,A=null)),e.key==="Escape"&&U("playing"),e.preventDefault();return}if(_==="playing"){if(ee==="shooter"){e.key==="Escape"&&(U("title"),R.menu=0),e.preventDefault();return}if(e.key==="Escape"&&(R.pause=0,U("paused")),e.key==="Shift"&&!e.repeat){const a=x==="A"?"B":"A";tt(a),at(0),v.resume(),v.playMatrixSwitch(a==="A");const i=a==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",l=a==="A"?"#ff0055":"#00ff88";W(i,l,55),D.particles&&z(A,A.player.x,A.player.y,l,22,4)}(e.key==="j"||e.key==="J")&&!e.repeat&&(A.archetypeActive||u.temporalRewind&&u.rewindBuffer.length>0?(Ye(A),v.resume(),v.playArchetypePower()):W("NO ARCHETYPE ACTIVE","#334455",25)),(e.key==="r"||e.key==="R")&&!e.repeat&&(u.glitchPulse&&u.glitchPulseCharge>=100?Nt(A,W):u.glitchPulse?W("CHARGING… "+Math.round(u.glitchPulseCharge)+"%","#660088",22):W("BUY GLITCH PULSE IN UPGRADES","#334455",28)),(e.key==="q"||e.key==="Q")&&!e.repeat&&u.freeze&&u.freezeTimer<=0&&(u.freezeTimer=2500,W("FREEZE ACTIVE!","#0088ff",50),z(A,A.player.x,A.player.y,"#0088ff",20,4)),(e.key==="c"||e.key==="C")&&!e.repeat&&(J>=2?(it(2),window._insightTokens=J,A.contZones||(A.contZones=[]),A.contZones.push({x:A.player.x,y:A.player.y,timer:240,maxTimer:240}),W("CONTAINMENT ZONE","#00ffcc",38)):W("NEED 2 ◆ FOR CONTAINMENT","#334455",28))}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>te.delete(e.key));ae.addEventListener("mousemove",e=>{_==="playing"&&ee==="shooter"&&se.handleInput(null,"mousemove",e)});ae.addEventListener("mousedown",e=>{_==="playing"&&ee==="shooter"&&(v.resume(),se.handleInput(null,"mousedown",e))});ae.addEventListener("mouseup",e=>{_==="playing"&&ee==="shooter"&&se.handleInput(null,"mouseup",e)});function Ne(e,t){const a=document.getElementById(e);if(!a)return;let i;a.addEventListener("touchstart",l=>{l.preventDefault(),te.add(t),_==="title"&&de(D.dreamIdx),i=()=>te.delete(t)},{passive:!1}),a.addEventListener("touchend",l=>{l.preventDefault(),i&&i()},{passive:!1}),a.addEventListener("mousedown",()=>{te.add(t),_==="title"&&de(D.dreamIdx)}),a.addEventListener("mouseup",()=>te.delete(t))}Ne("btn-up","ArrowUp");Ne("btn-down","ArrowDown");Ne("btn-left","ArrowLeft");Ne("btn-right","ArrowRight");ae.addEventListener("click",()=>{_==="title"&&de(D.dreamIdx)});lt(st());ht(ce(),ge());q=requestAnimationFrame(Z);
