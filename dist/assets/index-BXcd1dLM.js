(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const r of l)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function a(l){const r={};return l.integrity&&(r.integrity=l.integrity),l.referrerPolicy&&(r.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?r.credentials="include":l.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(l){if(l.ep)return;l.ep=!0;const r=a(l);fetch(l.href,r)}})();const s={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},oe={[s.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[s.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[s.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[s.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[s.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[s.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[s.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[s.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[s.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[s.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[s.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[s.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[s.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[s.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[s.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[s.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[s.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},p=44,_=2,yt={small:10,medium:13,large:17},tt={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function at(e){const t={};for(const[a,i]of Object.entries(oe))t[a]={bg:i.bg,bd:i.bd,glow:i.glow};if(e)for(const[a,i]of Object.entries(e))Object.assign(t[a],i);return t}const ct=at(null),gt=at({[s.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[s.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[s.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[s.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[s.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[s.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[s.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[s.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[s.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),se={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},j=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[s.DESPAIR,s.TERROR,s.HOPELESS],hazardCounts:[6,5,4],specialTiles:[s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[s.RAGE,s.DESPAIR,s.GLITCH],hazardCounts:[5,6,5],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[s.TERROR,s.SELF_HARM,s.HOPELESS],hazardCounts:[4,3,5],specialTiles:[s.TELEPORT,s.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[s.ARCHETYPE,s.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM,s.PAIN],hazardCounts:[7,6,4,3],specialTiles:[s.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[s.TERROR,s.RAGE,s.GLITCH],hazardCounts:[6,5,4],specialTiles:[s.COVER,s.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[s.TRAP,s.RAGE,s.DESPAIR,s.TERROR],hazardCounts:[6,4,5,4],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[s.HOPELESS,s.DESPAIR,s.GLITCH],hazardCounts:[4,4,4],specialTiles:[s.TELEPORT,s.ARCHETYPE,s.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[s.DESPAIR,s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM,s.GLITCH,s.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[s.ARCHETYPE,s.TELEPORT,s.INSIGHT,s.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],de=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],wt=["memory…","choice…","echo…","void…","self…","signal…","fragment…","persist…","clarity…","dissolve…","boundary…","witness…","anchor…","pattern…","emergence…","dragon…","guide…","orb…","fear…","hope…"],At=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],Tt=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],St=["small","medium","large"],Et=["easy","normal","hard"],D={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let _e=[],it=0,X=0,He=[],ee="B",we=0;function lt(e){ee=e}function rt(e){we=e}function bt(e){we+=e}function Mt(e=1){X+=e}function ot(e){X=Math.max(0,X-e)}function Ct(e){He.push(e)}function st(e){_e=e}function qe(){it=0,X=0,He=[],ee="B",we=0}const u={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function Rt(){Object.assign(u,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function nt(e){return{maxhp:u.maxHp>100,speed:u.moveDelay<120,magnet:u.magnet,freeze:u.freeze,aura:u.aura,energy:u.energyMax>100,rewind:u.temporalRewind,pulse:u.glitchPulse}[e]||!1}let G="title";function U(e){G=e}const R={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title"};function L(e){return Math.floor(Math.random()*e)}function pe(e){return e[L(e.length)]}function Ee(e,t,a){return Math.max(t,Math.min(a,e))}const je=[1,1,2,3,5,8,13,21,34,55,89];function vt(e){return je[Math.min(e,je.length-1)]}const ft="glitch_peace_v4";function Pt(e){try{localStorage.setItem(ft+"_scores",JSON.stringify(e))}catch{}}function ht(){try{const e=localStorage.getItem(ft+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Ge(){return yt[D.gridSize]}function It(){return tt[D.difficulty]}function dt(){return Ge()*p+(Ge()-1)*_}function Ae(){return dt()+48}function Te(){return dt()+148}function Dt(e){const t=Array.from({length:e},()=>new Array(e).fill(s.VOID)),a=Math.floor(e*e*.07);for(let i=0;i<a;i++){const l=1+L(e-2),r=1+L(e-2);t[l][r]=s.WALL}return t}function ce(e,t,a,i,l){let r=0,f=0;for(;r<t&&f<9999;){f++;const n=L(i),d=L(i);if(e[n][d]===s.VOID){if(n<2&&d<2)continue;e[n][d]=a,r++}}}function Nt(e,t,a,i,l,r,f){const n=It(),d=Dt(t);d[0][0]=s.VOID,t>1&&(d[0][1]=s.VOID,d[1][0]=s.VOID);const m=vt(a+2)+(t-13>0?t-13:0),y=1+Math.floor(a/3);if(e.hazardSet.forEach((k,g)=>{const S=Math.round((e.hazardCounts[g]||4)*n.hazMul);ce(d,S,k,t)}),ce(d,m,s.PEACE,t),ce(d,y,s.INSIGHT,t),e.specialTiles.forEach(k=>ce(d,2,k,t)),f&&f.length>0&&ce(d,3,s.MEMORY,t),e.id==="aztec")for(let k=0;k<t*2;k++){const g=1+L(t-2),S=1+L(t-2);d[g][S]===s.VOID&&(d[g][S]=s.WALL)}const A=e.id==="bedroom"?2:e.id==="summit"?1:0,c=Math.min(e.enemyCount+Math.floor(a*.5)+A,10),o=Math.max(1,c+(D.difficulty==="hard"?2:D.difficulty==="easy"?-1:0)),M=[],E=Math.max(2,Math.floor(t/5));for(let k=0;k<o;k++){let g,S,O=0;do g=E+L(t-E*2),S=E+L(t-E*2),O++;while((d[g][S]!==s.VOID||g<2&&S<2)&&O<400);M.push({y:g,x:S,timer:L(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+L(3),prevY:g,prevX:S,momentum:[0,0],type:"hunter"})}let v=null;if(a>=6&&(e.id==="summit"||e.id==="integration")){const k=Math.floor(t/2),g=Math.floor(t/2);d[g][k]=s.VOID,v={y:g,x:k,hp:5+a,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:d,enemies:M,boss:v,sz:t,level:a,ds:e,player:{y:0,x:0},hp:l!==void 0?Math.min(r,l+25):r,score:i||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:m,insightLeft:y,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+L(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function z(e,t,a,i,l,r){if(!(!D.particles||!e))for(let f=0;f<l;f++){const n=Math.PI*2*f/l+Math.random()*.6,d=r*(.6+Math.random()*.8);e.particles.push({x:t*(p+_)+p/2,y:a*(p+_)+p/2,vx:Math.cos(n)*d,vy:Math.sin(n)*d-1,r:2+Math.random()*3,color:i,life:20+L(16),maxLife:36})}}function De(e,t,a,i){!D.particles||!e||(e.resonanceWave={x:t*(p+_)+p/2,y:a*(p+_)+p/2,r:0,maxR:200,color:i,alpha:.55})}function ut(e,t){D.particles&&e.echos.push({x:e.player.x*(p+_)+p/2,y:e.player.y*(p+_)+p/2,life:30,maxLife:30,size:p*.38,color:t==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}function Lt(e,t,a,i,l,r,f){const n=e,d=n.sz,m=tt[D.difficulty];if(!n||n.hp<=0)return;if(u.freeze&&u.freezeTimer>0){u.freezeTimer-=t;return}const y=n.slowMoves?1.5:1,A=m.eSpeedBase-n.level*30,c=Math.max(m.eSpeedMin,A)*(i==="A"?.65:1)*y;if(n.level>=3){if(l.splice(0,l.length,...l.filter(o=>o.life>0)),Math.random()<6e-4*n.level&&l.length<3){const o=L(d),M=L(d);n.grid[o][M]===s.VOID&&l.push({y:o,x:M,timer:0,life:5e3+L(4e3)})}for(const o of l)if(o.life-=t,o.timer+=t,o.timer>450){o.timer=0;const M=n.player.x-o.x,E=n.player.y-o.y,v=E>0?1:E<0?-1:0,k=M>0?1:M<0?-1:0,g=o.y+v,S=o.x+k;g>=0&&g<d&&S>=0&&S<d&&(o.y=g,o.x=S),o.y===n.player.y&&o.x===n.player.x&&(n.hp=Math.max(0,n.hp-8),o.life=0,n.shakeFrames=4,n.flashColor="#8800ff",n.flashAlpha=.18,r("CHAOS PHANTOM!","#aa00ff",35))}}if(n.boss&&n.boss.hp>0){const o=n.boss;if(o.timer+=t,o.phaseTimer-=t,o.phaseTimer<=0&&(o.phase=o.phase==="chase"?"orbit":"chase",o.phaseTimer=400+L(300)),o.timer>280){o.timer=0;let M=n.player.x,E=n.player.y;n.level>=8&&(M+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,E+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const v=E-o.y,k=M-o.x,g=v>0?1:v<0?-1:0,S=k>0?1:k<0?-1:0;if(g&&o.y+g>=0&&o.y+g<d?o.y+=g:S&&o.x+S>=0&&o.x+S<d&&(o.x+=S),o.y===n.player.y&&o.x===n.player.x){const O=Math.round(40*m.dmgMul*(i==="A"?1.3:1));n.hp=Math.max(0,n.hp-O),n.shakeFrames=14,n.flashColor="#ff00aa",n.flashAlpha=.45,z(n,n.player.x,n.player.y,"#ff00aa",22,5),r("BOSS! -"+O,"#ff00aa",50)}}}for(const o of n.enemies){if(o.stunTimer>0){o.stunTimer-=t;continue}if(o.timer+=t,o.timer<c)continue;o.timer=0,o.prevY=o.y,o.prevX=o.x;const M=o.behavior||n.ds.enemyBehavior,E=n.player.x-o.x,v=n.player.y-o.y,k=Math.abs(E)+Math.abs(v);let g=!1;if(M==="wander"||k>d*.7){const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[O,I]of S){const w=o.y+O,b=o.x+I;if(w>=0&&w<d&&b>=0&&b<d&&n.grid[w][b]!==s.WALL){o.y=w,o.x=b,g=!0;break}}}else if(M==="patrol"){o.patrolAngle+=(Math.random()-.5)*.4;const S=Math.round(Math.sin(o.patrolAngle)),O=Math.round(Math.cos(o.patrolAngle)),I=o.y+Ee(S,-1,1),w=o.x+Ee(O,-1,1);if(I>=0&&I<d&&w>=0&&w<d&&n.grid[I][w]!==s.WALL&&(o.y=I,o.x=w,g=!0),k<5&&Math.random()<.7){const b=v>0?1:v<0?-1:0,h=E>0?1:E<0?-1:0,C=o.y+b,N=o.x+h;C>=0&&C<d&&N>=0&&N<d&&n.grid[C][N]!==s.WALL&&(o.y=C,o.x=N)}}else if(M==="orbit"){o.orbitAngle+=.25;const S=n.player.x+Math.round(Math.cos(o.orbitAngle)*o.orbitR),O=n.player.y+Math.round(Math.sin(o.orbitAngle)*o.orbitR),I=O-o.y>0?1:O-o.y<0?-1:0,w=S-o.x>0?1:S-o.x<0?-1:0;o.y+I>=0&&o.y+I<d&&o.x+w>=0&&o.x+w<d&&n.grid[o.y+I][o.x+w]!==s.WALL&&(o.y+=I,o.x+=w)}else if(M==="chase_fast"||M==="adaptive"||M==="predictive"){let S=n.player.x,O=n.player.y;M==="predictive"&&n.level>=7&&(S+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,O+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const I=S-o.x,w=O-o.y,b=Math.abs(w)>=Math.abs(I)?[[w>0?1:-1,0],[0,I>0?1:-1]]:[[0,I>0?1:-1],[w>0?1:-1,0]];for(const[h,C]of b){const N=o.y+h,B=o.x+C;if(N>=0&&N<d&&B>=0&&B<d&&n.grid[N][B]!==s.WALL){o.y=N,o.x=B,g=!0;break}}if(!g){const h=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[C,N]of h){const B=o.y+C,H=o.x+N;if(B>=0&&B<d&&H>=0&&H<d&&n.grid[B][H]!==s.WALL){o.y=B,o.x=H;break}}}}else if(M==="rush"){const S=Math.abs(v)>=Math.abs(E)?[[v>0?1:-1,0],[0,E>0?1:-1]]:[[0,E>0?1:-1],[v>0?1:-1,0]];for(const[O,I]of S){const w=o.y+O,b=o.x+I;if(w>=0&&w<d&&b>=0&&b<d&&n.grid[w][b]!==s.WALL){o.y=w,o.x=b,g=!0;break}}if(!g){const O=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[I,w]of O){const b=o.y+I,h=o.x+w;if(b>=0&&b<d&&h>=0&&h<d&&n.grid[b][h]!==s.WALL){o.y=b,o.x=h;break}}}}else if(M==="scatter"){const S=Math.abs(v)>=Math.abs(E)?[[v>0?-1:1,0],[0,E>0?-1:1]]:[[0,E>0?-1:1],[v>0?-1:1,0]];for(const[O,I]of S){const w=o.y+O,b=o.x+I;if(w>=0&&w<d&&b>=0&&b<d&&n.grid[w][b]!==s.WALL){o.y=w,o.x=b,g=!0;break}}if(!g){const O=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[I,w]of O){const b=o.y+I,h=o.x+w;if(b>=0&&b<d&&h>=0&&h<d&&n.grid[b][h]!==s.WALL){o.y=b,o.x=h;break}}}}else if(M==="labyrinth"){if(k<4){const S=Math.abs(v)>=Math.abs(E)?[[v>0?1:-1,0],[0,E>0?1:-1]]:[[0,E>0?1:-1],[v>0?1:-1,0]];for(const[O,I]of S){const w=o.y+O,b=o.x+I;if(w>=0&&w<d&&b>=0&&b<d&&n.grid[w][b]!==s.WALL){o.y=w,o.x=b,g=!0;break}}}if(!g){o.patrolAngle+=Math.random()<.35?(Math.random()-.5)*1.2:0;const S=Math.round(Math.sin(o.patrolAngle)),O=Math.round(Math.cos(o.patrolAngle)),I=o.y+Ee(S,-1,1),w=o.x+Ee(O,-1,1);if(I>=0&&I<d&&w>=0&&w<d&&n.grid[I][w]!==s.WALL&&(o.y=I,o.x=w,g=!0),!g){o.patrolAngle+=Math.PI*.5;const b=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[h,C]of b){const N=o.y+h,B=o.x+C;if(N>=0&&N<d&&B>=0&&B<d&&n.grid[N][B]!==s.WALL){o.y=N,o.x=B;break}}}}}else{const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[O,I]of S){const w=o.y+O,b=o.x+I;if(w>=0&&w<d&&b>=0&&b<d&&n.grid[w][b]!==s.WALL){o.y=w,o.x=b;break}}}if(o.y===n.player.y&&o.x===n.player.x)if(u.shield&&u.shieldTimer>0)o.stunTimer=1300,r("SHIELD HELD!","#00ffcc",38),z(n,n.player.x,n.player.y,"#00ffcc",14,3);else{const S=Math.round(22*m.dmgMul*(i==="A"?1.3:1));n.hp=Math.max(0,n.hp-S),n.shakeFrames=8,n.flashColor="#ff2200",n.flashAlpha=.35,z(n,n.player.x,n.player.y,"#ff4400",16,4),o.stunTimer=900,u.shieldCount=0,u.comboCount=0,r("HIT! -"+S,"#ff4400",40),f(n,"panic")}for(const S of n.captureZones)Math.abs(o.x-n.player.x)<=S.r&&Math.abs(o.y-n.player.y)<=S.r&&(n.hp=Math.max(0,n.hp-5),r("CAPTURED!","#ff0044",25))}n.captureZones=n.captureZones.filter(o=>(o.timer--,o.timer>0))}function Me(e,t){u.emotion=t,u.emotionTimer=120,e.emotionTimer=120,e.slowMoves=t==="hopeless"||t==="despair"}function ne(e,t,a,i){e&&(e.msg=t,e.msgColor=a,e.msgTimer=i)}function Ot(e,t,a){const i=se[t];if(i){if(e.archetypeActive=!0,e.archetypeType=t,e.archetypeTimer=180,u.archetypePower=i.power,u.archetypeDuration=180,ne(e,i.activationMsg,"#ffdd00",70),De(e,e.player.x,e.player.y,"#ffdd00"),z(e,e.player.x,e.player.y,"#ffdd00",24,4),t==="child"){for(let l=0;l<e.sz;l++)for(let r=0;r<e.sz;r++)e.grid[l][r]===s.HIDDEN&&e.tileFlicker.push({y:l,x:r,t:200,reveal:!0});ne(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}t==="protector"&&(u.shield=!0,u.shieldTimer=30,z(e,e.player.x,e.player.y,"#88ccff",20,5)),t==="orb"&&(u.phaseShift=!0,u.phaseTimer=15),t==="captor"&&(u.temporalRewind=!0,u.rewindBuffer=u.rewindBuffer.slice(-3))}}function Ze(e){const t=u.archetypePower;if(!t)return;const a=e.sz;if(t==="wall_jump")for(const[i,l]of[[-2,0],[2,0],[0,-2],[0,2]]){const r=e.player.y+i,f=e.player.x+l;if(r>=0&&r<a&&f>=0&&f<a&&e.grid[r][f]!==s.WALL){ut(e,"B"),e.player.y=r,e.player.x=f,z(e,f,r,"#ffaa00",16,3),ne(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(t==="phase_walk")u.phaseShift=!0,u.phaseTimer=10,ne(e,"ORB PHASE ACTIVE","#aaddff",35);else if(t==="rewind")if(u.rewindBuffer.length>0){const i=u.rewindBuffer.pop();if(e.player.y=i.y,e.player.x=i.x,i.grid)for(let l=0;l<a;l++)for(let r=0;r<a;r++)e.grid[l][r]=i.grid[l][r];z(e,e.player.x,e.player.y,"#ffaadd",20,3),ne(e,"TEMPORAL REWIND","#ffaadd",40)}else ne(e,"NO REWIND MEMORY","#443344",30);else if(t==="shield_burst"){u.shield=!0,u.shieldTimer=25;for(const i of e.enemies)i.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),z(e,e.player.x,e.player.y,"#88ccff",30,6),ne(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function Ht(e,t,a,i,l,r,f,n){const d=e.sz,m=e.player.y+t,y=e.player.x+a;if(m<0||m>=d||y<0||y>=d)return!1;const A=e.grid[m][y];if(A===s.WALL&&!(u.phaseShift&&u.phaseTimer>0)||A===s.HIDDEN&&i==="A"&&!u.phaseShift)return!1;if(u.temporalRewind&&u.rewindBuffer.length<8){const o=e.grid.map(M=>[...M]);u.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:o})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),ut(e,i),D.particles&&e.trail.push({x:e.player.x*(p+_)+p/2,y:e.player.y*(p+_)+p/2,life:14,maxLife:14,color:i==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=m,e.player.x=y,u.phaseShift&&u.phaseTimer>0&&(u.phaseTimer--,u.phaseTimer<=0&&(u.phaseShift=!1,r("PHASE FADED","#445566",25))),u.shield&&u.shieldTimer>0&&(u.shieldTimer--,u.shieldTimer<=0&&(u.shield=!1,r("SHIELD FADED","#445566",25))),i==="A"?u.energy=Math.max(0,u.energy-.9):u.energy=Math.min(u.energyMax,u.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,u.archetypePower=null));const c={dmgMul:D.difficulty==="hard"?1.45:D.difficulty==="easy"?.55:1};if(A===s.PEACE){const o=Math.round((150+e.level*20)*u.resonanceMultiplier);e.score+=o,e.hp=Math.min(u.maxHp,e.hp+20),e.grid[m][y]=s.VOID,e.peaceLeft--,z(e,y,m,u.particleColor,18,3.5),u.shieldCount++,u.comboCount++,u.resonanceMultiplier=Math.min(4,1+u.comboCount*.25),u.glitchPulseCharge=Math.min(100,u.glitchPulseCharge+15),u.comboCount>=3&&!u.shield?(u.shield=!0,u.shieldTimer=20,De(e,y,m,"#00ffcc"),z(e,y,m,"#00ffcc",26,5),r("SHIELD ACTIVE! ×"+u.resonanceMultiplier.toFixed(1),"#00ffcc",55)):r("+PEACE +"+o+(u.comboCount>1?" ×"+u.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),Me(e,"peace"),e.peaceLeft===0&&l()}else if(A===s.INSIGHT){const o=Math.round((300+e.level*50)*u.resonanceMultiplier);e.score+=o,n(f+1),e.grid[m][y]=s.VOID,e.insightLeft--,z(e,y,m,"#00eeff",24,4),De(e,y,m,"#00eeff"),r("INSIGHT ◆×"+(f+1),"#00eeff",60);for(let M=0;M<d;M++)for(let E=0;E<d;E++)e.grid[M][E]===s.HIDDEN&&e.tileFlicker.push({y:M,x:E,t:100,reveal:!0});Me(e,"clarity")}else if(A===s.ARCHETYPE){e.grid[m][y]=s.VOID;const o=e.ds.archetype==="all"?pe(Object.keys(se)):e.ds.archetype||"orb";Ot(e,o)}else if(A===s.TELEPORT){let o=0,M=L(d),E=L(d);for(;(e.grid[M][E]!==s.VOID||M===m&&E===y)&&o<200;)M=L(d),E=L(d),o++;e.player.y=M,e.player.x=E,e.grid[m][y]=s.VOID,z(e,E,M,"#00aaff",16,3),r("LEAP!","#00aaff",30)}else if(A===s.COVER){r("COVER","#446688",20);for(const o of e.enemies)Math.abs(o.y-m)+Math.abs(o.x-y)<=2&&(o.stunTimer=600)}else if(A===s.MEMORY)e.grid[m][y]=s.VOID,e.score+=50,r("MEMORY ECHO…","#88bbaa",30),z(e,y,m,"#88bbaa",10,2);else if(oe[A]&&oe[A].dmg>0)if(u.shield&&u.shieldTimer>0)r("SHIELDED","#00ffcc",20);else{const o=oe[A];let M=Math.round(o.dmg*c.dmgMul*(i==="A"?1.25:1));if(A===s.RAGE&&o.push>0){const g=m+t*o.push,S=y+a*o.push;g>=0&&g<d&&S>=0&&S<d&&e.grid[g][S]!==s.WALL&&(e.player.y=g,e.player.x=S,r("-RAGE (pushed!)","#ff0066",40))}if(A===s.SELF_HARM&&(e.grid[m][y]=s.PAIN),A===s.HOPELESS&&Me(e,"hopeless"),A===s.DESPAIR&&Math.random()<.3){const g=[[1,0],[-1,0],[0,1],[0,-1]],[S,O]=pe(g),I=m+S,w=y+O;I>=0&&I<d&&w>=0&&w<d&&e.grid[I][w]===s.VOID&&(e.grid[I][w]=s.DESPAIR)}e.hp=Math.max(0,e.hp-M),e.shakeFrames=5;const E={[s.DESPAIR]:"#2244ff",[s.TERROR]:"#ff0000",[s.SELF_HARM]:"#660000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},v={[s.DESPAIR]:"#3355ff",[s.TERROR]:"#ff2222",[s.SELF_HARM]:"#880000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},k={[s.DESPAIR]:"-DESPAIR",[s.TERROR]:"-TERROR!",[s.SELF_HARM]:"-SELF·HARM",[s.RAGE]:"-RAGE",[s.HOPELESS]:"-HOPELESS",[s.GLITCH]:"-GLITCH",[s.TRAP]:"-TRAP",[s.PAIN]:"-PAIN"};e.flashColor=E[A]||"#ff0000",e.flashAlpha=.28,z(e,y,m,v[A]||"#ff2222",10,3),r((k[A]||"-HAZARD")+" -"+M,v[A]||"#ff3333",38),u.shieldCount=0,u.comboCount=0,u.resonanceMultiplier=1}return!0}function Bt(e,t){if(!e||u.glitchPulseCharge<100)return;u.glitchPulseCharge=0;let a=0;for(let i=0;i<e.sz;i++)for(let l=0;l<e.sz;l++)Math.abs(i-e.player.y)+Math.abs(l-e.player.x)<=3&&oe[e.grid[i][l]]?.dmg>0&&(e.grid[i][l]=s.VOID,a++);for(const i of e.enemies)Math.abs(i.y-e.player.y)+Math.abs(i.x-e.player.x)<=4&&(i.stunTimer=1800);De(e,e.player.x,e.player.y,"#aa00ff"),z(e,e.player.x,e.player.y,"#aa00ff",32,6),t("GLITCH PULSE! "+a+" CLEARED","#aa00ff",55)}function kt(e,t){if(e.spreadTimer-=t,e.spreadTimer>0)return;e.spreadTimer=3e3+L(1e3);const a=e.sz,i=[];for(let l=0;l<a;l++)for(let r=0;r<a;r++){const f=e.grid[l][r];if((f===s.DESPAIR||f===s.HOPELESS)&&oe[f].spread)for(const[n,d]of[[1,0],[-1,0],[0,1],[0,-1]]){const m=l+n,y=r+d;m>=0&&m<a&&y>=0&&y<a&&e.grid[m][y]===s.VOID&&Math.random()<.2&&i.push({y:m,x:y,type:f})}}for(const l of i.slice(0,2))e.grid[l.y][l.x]=l.type}function _t(e){return e==="A"?gt:ct}function Gt(e,t,a,i,l,r,f,n,d,m,y,A){const c=a;if(!c)return;const o=c.sz,M=o*p+(o-1)*_,E=M+48,v=M+148,k=_t(i),g=c.ds;e.clearRect(0,0,E,v),e.fillStyle=g.bgColor,e.fillRect(0,0,E,v);const S=e.createRadialGradient(E*.7,v*.3,0,E*.7,v*.3,E*.8);S.addColorStop(0,g.bgAccent+"33"),S.addColorStop(1,"transparent"),e.fillStyle=S,e.fillRect(0,0,E,v),i==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,E,v));for(let h=0;h<v;h+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,h,E,1);for(const h of l){const C=h.a*(.5+.5*Math.sin(t*8e-4+h.phase));e.globalAlpha=C,e.fillStyle="#ffffff",e.beginPath(),e.arc(h.x,h.y,h.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,m>0&&(e.fillStyle=`rgba(${i==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*v),E,2+Math.floor(Math.random()*4)));let O=0,I=0;c.shakeFrames>0&&(O=(Math.random()-.5)*9*(c.shakeFrames/10),I=(Math.random()-.5)*9*(c.shakeFrames/10),c.shakeFrames--);const w=(E-M)/2+O,b=110+I;for(const h of r)h.x+=h.dx,h.y+=h.dy,h.life--,h.life>h.maxLife*.85?h.alpha=Math.min(h.targetAlpha,(h.maxLife-h.life)/(h.maxLife*.15)*h.targetAlpha):h.life<h.maxLife*.15&&(h.alpha=Math.max(0,h.life/(h.maxLife*.15)*h.targetAlpha)),h.life<=0&&(h.life=200+Math.floor(Math.random()*400),h.maxLife=600),e.globalAlpha=h.alpha*(i==="A"?.7:1),e.fillStyle=i==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(h.text,h.x,h.y);e.globalAlpha=1,e.textAlign="left";for(let h=0;h<o;h++)for(let C=0;C<o;C++){const N=c.grid[h][C],B=c.tileFlicker.find(F=>F.y===h&&F.x===C),H=B&&B.reveal&&N===s.HIDDEN?s.INSIGHT:N,Z=oe[H]||oe[s.VOID],le=k[H]||k[s.VOID],W=w+C*(p+_),Y=b+h*(p+_);if(n&&(h===d.row||C===d.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):le.glow?(e.shadowColor=le.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=le.bg,e.beginPath(),e.roundRect(W,Y,p,p,4),e.fill(),e.strokeStyle=le.bd,e.lineWidth=1,e.beginPath(),e.roundRect(W+.5,Y+.5,p-1,p-1,4),e.stroke(),e.shadowBlur=0,H===s.PEACE){const F=(t*.05+h*6+C*4)%(p*2);if(F<p){const $=e.createLinearGradient(W,Y+F-5,W,Y+F+5);$.addColorStop(0,"rgba(0,255,140,0)"),$.addColorStop(.5,"rgba(0,255,140,0.45)"),$.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=$,e.fillRect(W,Y,p,p)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(W+p/2,Y+p/2,5+2*Math.sin(t*.006+C+h),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(H===s.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const F=t*.008+C*1.7+h*1.3;for(let $=0;$<4;$++){const ye=F+$*Math.PI*.5,K=7+2*Math.sin(t*.005+$);e.fillStyle=$%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(W+p/2+Math.cos(ye)*K,Y+p/2+Math.sin(ye)*K,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(H===s.ARCHETYPE){const F=.5+.5*Math.sin(t*.01+C+h);e.shadowColor="#ffdd00",e.shadowBlur=16*F,e.fillStyle=`rgba(255,220,0,${.15*F})`,e.fillRect(W,Y,p,p),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",W+p/2,Y+p/2+6),e.shadowBlur=0,e.textAlign="left"}if(H===s.TELEPORT){const F=.5+.5*Math.sin(t*.012+C*2+h);e.shadowColor="#00aaff",e.shadowBlur=12*F,e.fillStyle=`rgba(0,170,255,${.2*F})`,e.fillRect(W,Y,p,p),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",W+p/2,Y+p/2+5),e.shadowBlur=0,e.textAlign="left"}if(H===s.MEMORY){const F=.3+.3*Math.sin(t*.004+C+h);e.globalAlpha=.4+.2*F,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(W,Y,p,p),e.globalAlpha=1}Z.sym&&H!==s.VOID&&H!==s.WALL&&H!==s.PEACE&&H!==s.INSIGHT&&H!==s.ARCHETYPE&&H!==s.TELEPORT&&H!==s.HIDDEN&&H!==s.MEMORY&&(e.fillStyle=le.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(Z.sym,W+p/2,Y+p/2+5),e.globalAlpha=1,e.textAlign="left"),(H===s.PEACE||H===s.INSIGHT)&&u.magnet&&Math.abs(h-c.player.y)+Math.abs(C-c.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(W+2,Y+2,p-4,p-4,4),e.stroke())}c.tileFlicker=c.tileFlicker.filter(h=>(h.t--,h.t>0)),A&&A.length>0&&(A.forEach((h,C)=>{const N=w+h.x*(p+_),B=b+h.y*(p+_),H=.22-C*.05,Z=h.hpDelta>0?"#00ffaa":h.hpDelta<0?"#ff3333":"#aaaaff";e.globalAlpha=Math.max(.05,H),e.strokeStyle=Z,e.lineWidth=2,e.beginPath(),e.roundRect(N+2,B+2,p-4,p-4,3),e.stroke(),h.hpDelta!==0&&(e.fillStyle=Z,e.font="9px Courier New",e.textAlign="center",e.globalAlpha=Math.max(.1,H+.1),e.fillText((h.hpDelta>0?"+":"")+Math.round(h.hpDelta),N+p/2,B+p/2+4),e.textAlign="left")}),e.globalAlpha=1);for(const h of c.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(h.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(w+h.x*(p+_)+p/2,b+h.y*(p+_)+p/2,(h.r+.5)*(p+_),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const h of c.echos)e.globalAlpha=h.life/h.maxLife*.55,e.fillStyle=h.color,e.beginPath(),e.arc(w+h.x,b+h.y,h.size*(h.life/h.maxLife),0,Math.PI*2),e.fill(),h.life--;if(c.echos=c.echos.filter(h=>h.life>0),e.globalAlpha=1,D.particles){for(const h of c.trail)e.globalAlpha=h.life/h.maxLife*.48,e.fillStyle=h.color,e.shadowColor=h.color,e.shadowBlur=4,e.beginPath(),e.arc(w+h.x,b+h.y,4*(h.life/h.maxLife),0,Math.PI*2),e.fill(),h.life--;c.trail=c.trail.filter(h=>h.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const h of f){if(h.life<=0)continue;const C=w+h.x*(p+_),N=b+h.y*(p+_),B=.3+.25*Math.sin(Date.now()*.006+h.x);e.globalAlpha=B,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(C+8,N+8,p-16,p-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",C+p/2,N+p/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const h of c.enemies){const C=w+h.x*(p+_),N=b+h.y*(p+_),B=.6+.4*Math.sin(t*.007+h.x*1.3),H=h.stunTimer>0,Z=h.type==="rush",le=H?"#8888ff":Z?"#ff0066":i==="A"?"#ff0044":"#ff4400";e.shadowColor=le,e.shadowBlur=14*B,e.fillStyle=H?"#1c1c44":Z?"#4a0022":i==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(C+5,N+5,p-10,p-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=H?"#4444aa":Z?"#ff0066":i==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(C+p/2,N+12),e.lineTo(C+p-12,N+p-12),e.lineTo(C+12,N+p-12),e.closePath(),e.fill(),e.fillStyle=H?"#6666cc":"#ffcc00",e.beginPath(),e.arc(C+p/2,N+p/2+2,4,0,Math.PI*2),e.fill()}if(c.boss&&c.boss.hp>0){const h=c.boss,C=w+h.x*(p+_),N=b+h.y*(p+_),B=.5+.5*Math.sin(t*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*B,e.fillStyle="#330022",e.beginPath(),e.roundRect(C+1,N+1,p-2,p-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(C+p/2,N+p/2,p*.3+4*B,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+h.hp,C+p/2,N+p/2+4),e.textAlign="left",e.shadowBlur=0}{const h=w+c.player.x*(p+_),C=b+c.player.y*(p+_),N=.55+.45*Math.sin(t*.009),B=u.shield&&u.shieldTimer>0,H=u.phaseShift&&u.phaseTimer>0,Z=u.emotion,W=i==="A"?"#ff0088":B?"#00ffff":H?"#00aaff":Z==="panic"?"#ff0022":Z==="hopeless"?"#0033aa":Z==="peace"?"#00ffcc":Z==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=W,e.shadowBlur=(B?36:u.aura?30:22)*N;const Y=i==="A"?"#aa0055":"#005533",F=i==="A"?"#cc0077":"#00cc77",$=i==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=Y,e.beginPath(),e.roundRect(h+4,C+4,p-8,p-8,8),e.fill(),e.fillStyle=F,e.beginPath(),e.roundRect(h+9,C+9,p-18,p-18,5),e.fill(),e.fillStyle=$,e.beginPath(),e.roundRect(h+15,C+15,p-30,p-30,3),e.fill(),c.archetypeActive){const K=se[c.archetypeType||"orb"];e.strokeStyle=K.glow,e.lineWidth=2,e.shadowColor=K.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(h+1,C+1,p-2,p-2,8),e.stroke()}B&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(h,C,p,p,8),e.stroke()),H&&(e.globalAlpha=.4),u.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*N})`,e.lineWidth=3,e.beginPath(),e.arc(h+p/2,C+p/2,(p/2+7)*N,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=W,e.lineWidth=2;const ye=9;[[h,C],[h+p,C],[h,C+p],[h+p,C+p]].forEach(([K,Se],We)=>{const ze=We%2===0?1:-1,Ye=We<2?1:-1;e.beginPath(),e.moveTo(K+ze*2,Se),e.lineTo(K+ze*(2+ye),Se),e.stroke(),e.beginPath(),e.moveTo(K,Se+Ye*2),e.lineTo(K,Se+Ye*(2+ye)),e.stroke()}),e.shadowBlur=0}if(D.particles){a.particles=a.particles.filter(h=>h.life>0);for(const h of a.particles)e.globalAlpha=Math.max(0,h.life/h.maxLife),e.fillStyle=h.color,e.shadowColor=h.color,e.shadowBlur=7,e.beginPath(),e.arc(w+h.x,b+h.y,h.r*(h.life/h.maxLife),0,Math.PI*2),e.fill(),h.x+=h.vx,h.y+=h.vy,h.vy+=.25,h.life--;e.globalAlpha=1,e.shadowBlur=0}if(c.resonanceWave){const h=c.resonanceWave;h.r+=7,h.alpha=Math.max(0,h.alpha-.55/h.maxR*7),e.strokeStyle=h.color,e.globalAlpha=h.alpha,e.lineWidth=2,e.shadowColor=h.color,e.shadowBlur=10,e.beginPath(),e.arc(w+h.x,b+h.y,h.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,h.r>=h.maxR&&(c.resonanceWave=null)}if(c.flashAlpha>0&&(e.fillStyle=c.flashColor,e.globalAlpha=c.flashAlpha,e.fillRect(w,b,M,M),e.globalAlpha=1,c.flashAlpha=Math.max(0,c.flashAlpha-.04)),i==="A"){const h=e.createRadialGradient(E/2,v/2,v*.25,E/2,v/2,v*.9);h.addColorStop(0,"rgba(80,0,20,0)"),h.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=h,e.fillRect(0,0,E,v)}Ut(e,c,E,v,M,w,b,i)}function Ut(e,t,a,i,l,r,f,n){const d=u,m=106;e.fillStyle="#070714",e.fillRect(0,0,a,m),e.strokeStyle="rgba(255,255,255,0.04)",e.lineWidth=1,e.beginPath(),e.moveTo(0,m),e.lineTo(a,m),e.stroke(),e.fillStyle=t.ds.bgAccent+"88",e.fillRect(0,0,a,16),e.fillStyle="#334455",e.font="8px Courier New",e.textAlign="center",e.fillText(t.ds.name+"  ·  "+t.ds.emotion,a/2,11),e.textAlign="left";const y=138;e.fillStyle="#333",e.font="9px Courier New",e.fillText("HP",14,30),e.fillStyle="#0e0e1e",e.fillRect(32,20,y,13);const A=t.hp/d.maxHp,c=A>.6?"#00ff88":A>.3?"#ffaa00":"#ff3333";e.fillStyle=c,e.shadowColor=c,e.shadowBlur=5,e.fillRect(32,20,y*A,13),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.06)",e.strokeRect(32,20,y,13),e.fillStyle="#444",e.font="8px Courier New",e.fillText(t.hp+"/"+d.maxHp,32+y+4,30);const o=138;e.fillStyle="#222",e.font="8px Courier New",e.fillText("EN",14,50),e.fillStyle="#0a0a1a",e.fillRect(32,41,o,9);const M=n==="A"?"#ff0055":"#0088ff";e.fillStyle=M,e.shadowColor=M,e.shadowBlur=4,e.fillRect(32,41,o*(d.energy/d.energyMax),9),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.04)",e.strokeRect(32,41,o,9);{const g=window._purgDepth||0;e.fillStyle="#1a0000",e.fillRect(32,52,o,5);const S=g>.7?"#ff2222":g>.4?"#aa2200":"#440000";e.fillStyle=S,e.fillRect(32,52,o*g,5),e.strokeStyle="rgba(200,0,0,0.2)",e.strokeRect(32,52,o,5),g>.05&&(e.fillStyle=g>.7?"#ff2222":"#660000",e.font="6px Courier New",e.fillText("PURG "+(g*100).toFixed(0)+"%",32+o+4,58))}if(d.glitchPulse){e.fillStyle="#220a22",e.fillRect(32,59,o,5);const g=d.glitchPulseCharge/100;e.fillStyle=g>=1?"#ff00ff":"#660088",e.fillRect(32,59,o*g,5),e.strokeStyle="rgba(150,0,200,0.2)",e.strokeRect(32,59,o,5),e.fillStyle=g>=1?"#ff00ff":"#553355",e.font="7px Courier New",e.fillText("PULSE"+(g>=1?" READY":""),32+o+4,65)}{const g=window._impulseProgress||0;g>0&&g<1&&(e.fillStyle="#332200",e.fillRect(32,66,o,4),e.fillStyle="#ffaa00",e.fillRect(32,66,o*g,4),e.strokeStyle="rgba(255,170,0,0.25)",e.strokeRect(32,66,o,4),e.fillStyle="#ffaa00",e.font="6px Courier New",e.fillText("HOLD…",32+o+4,70))}if(t.archetypeActive&&t.archetypeType){const g=se[t.archetypeType];e.fillStyle=g?g.color:"#ffdd00",e.shadowColor=g?g.glow:"#ffdd00",e.shadowBlur=4,e.font="8px Courier New",e.fillText(g?g.name+" ACTIVE":"[ARCH ACTIVE]",14,76),e.shadowBlur=0}else d.shield&&d.shieldTimer>0?(e.fillStyle="#00ffff",e.font="8px Courier New",e.fillText("SHIELD×"+d.shieldTimer,14,76)):d.shieldCount>0&&(e.fillStyle="#334455",e.font="8px Courier New",e.fillText("streak "+d.shieldCount+"/3",14,76));const E=window._emotionSynergy;E&&(e.fillStyle="#ffdd88",e.shadowColor="#ffcc44",e.shadowBlur=5,e.font="7px Courier New",e.fillText("⚡ "+E.label.toUpperCase(),14,84),e.shadowBlur=0),d.comboCount>1&&(e.fillStyle="#ffcc00",e.shadowColor="#ffcc00",e.shadowBlur=6,e.font="8px Courier New",e.fillText("COMBO ×"+d.resonanceMultiplier.toFixed(1),14,91),e.shadowBlur=0),e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=5,e.font="9px Courier New",e.fillText("◆×"+(window._insightTokens||0),14,99),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 19px Courier New",e.textAlign="center",e.fillText(String(t.score).padStart(7,"0"),a/2,38),e.shadowBlur=0,e.fillStyle="#222838",e.font="8px Courier New",e.fillText("SCORE",a/2,52);const v=n==="A"?"#ff0055":"#00aa55";e.fillStyle=v,e.shadowColor=v,e.shadowBlur=7,e.font="bold 10px Courier New",e.fillText("MTX·"+n,a/2-16,68),e.shadowBlur=0,e.textAlign="right",e.fillStyle="#445566",e.font="10px Courier New",e.fillText("LVL "+t.level,a-12,30),e.fillStyle="#005533",e.fillText("◈×"+t.peaceLeft,a-12,44),e.fillStyle="#223344",e.font="8px Courier New",e.fillText((window._dreamIdx+1||1)+"/10 DREAMS",a-12,58);const k=window._tmods;k&&(e.fillStyle="#223344",e.font="7px Courier New",e.fillText(k.lunarName||"",a-12,70),e.fillText(k.planetName||"",a-12,80)),e.textAlign="left",t.msg&&t.msgTimer>0&&(e.globalAlpha=Math.min(1,t.msgTimer/18),e.font="bold 16px Courier New",e.textAlign="center",e.fillStyle=t.msgColor,e.shadowColor=t.msgColor,e.shadowBlur=16,e.fillText(t.msg,a/2,f-16),e.textAlign="left",e.globalAlpha=1,e.shadowBlur=0,t.msgTimer--),e.fillStyle="#070714",e.fillRect(0,i-28,a,28),e.strokeStyle="rgba(255,255,255,0.03)",e.beginPath(),e.moveTo(0,i-28),e.lineTo(a,i-28),e.stroke(),e.fillStyle="#1a1a2a",e.font="8px Courier New",e.textAlign="center",e.fillText("WASD/ARROWS · SHIFT=matrix · ESC=pause · J=arch · R=pulse · Q=freeze · C=contain",a/2,i-11),e.textAlign="left"}function Ft(e,t,a){for(const i of t)e.globalAlpha=i.a*(.5+.5*Math.sin(a*8e-4+i.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(i.x,i.y,i.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function Vt(e,t,a,i,l,r,f){e.fillStyle="#02020a",e.fillRect(0,0,t,a);for(let y=0;y<a;y+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,y,t,1);Ft(e,i,l),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",t/2,a/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",t/2,a/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",t/2,a/2-78);const n=f==="shooter"?"[ SHOOTER MODE ]":"[ GRID MODE ]",d=f==="shooter"?"#ff6622":"#00ff88";e.fillStyle=d,e.shadowColor=d,e.shadowBlur=8,e.font="10px Courier New",e.fillText(n+"  ·  M to switch",t/2,a/2-60),e.shadowBlur=0;const m=a/2-42;At.forEach((y,A)=>{const c=A===r,o=m+A*36;c&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-130,o-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(t/2-130,o-19,260,28)),e.fillStyle=c?"#00ff88":"#2a3a2a",e.shadowColor=c?"#00ff88":"transparent",e.shadowBlur=c?8:0,e.font=c?"bold 14px Courier New":"12px Courier New",e.fillText(y,t/2,o),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  M toggle mode",t/2,a-20),e.textAlign="left"}function Wt(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",t/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",t/2,68);const l=Math.min(j.length,6),r=Math.max(0,Math.min(i-Math.floor(l/2),j.length-l));for(let f=0;f<l;f++){const n=r+f,d=j[n],m=n===i,y=95+f*55;if(m&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(t/2-160,y-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(t/2-160,y-18,320,46)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.font=m?"bold 12px Courier New":"11px Courier New",e.fillText(n+1+".  "+d.name,t/2,y),e.fillStyle=m?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(d.subtitle+"  ·  "+d.emotion,t/2,y+16),m&&d.archetype&&se[d.archetype]){const A=se[d.archetype];e.fillStyle="#665522",e.fillText("archetype: "+A.name+" — "+A.powerDesc,t/2,y+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",t/2,a-20),e.textAlign="left"}function zt(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",t/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:St,cur:D.gridSize},{label:"DIFFICULTY",opts:Et,cur:D.difficulty},{label:"PARTICLES",opts:["on","off"],cur:D.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((r,f)=>{const n=f===i,d=105+f*68;r.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(r.label,t/2,d)),r.opts.forEach((m,y)=>{const A=m===r.cur,c=t/2+(y-(r.opts.length-1)/2)*110,o=d+24;e.fillStyle=n&&A?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(c-44,o-16,88,24),e.strokeStyle=n&&A?"rgba(0,255,136,0.5)":A?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(c-44,o-16,88,24),e.fillStyle=A?"#00ff88":"#334455",e.shadowColor=A?"#00ff88":"transparent",e.shadowBlur=A?5:0,e.font=A?"bold 11px Courier New":"10px Courier New",e.fillText(m.toUpperCase(),c,o),e.shadowBlur=0}),n&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",t/2-154,d+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",t/2,a-20),e.textAlign="left"}function Yt(e,t,a,i){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",t/2,50),e.shadowBlur=0,i.length?i.slice(0,8).forEach((l,r)=>{const f=95+r*38,n=r===0?"◈":r===1?"◇":"·";e.fillStyle=r===0?"#ffdd00":r===1?"#aaaaaa":r===2?"#cc8833":"#334455",e.font=r<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${n}  ${String(l.score).padStart(7,"0")}   LVL${String(l.level).padStart(2,"0")}   ${l.dreamscape}   ${l.date}`,t/2,f)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",t/2,a/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",t/2,a-20),e.textAlign="left"}function qt(e,t,a,i,l,r){e.fillStyle="#02020a",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",t/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+l,t/2,68),de.forEach((f,n)=>{const d=n===i,m=r(f.id),y=l>=f.cost&&!m,A=92+n*48;d&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(t/2-155,A-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(t/2-155,A-14,310,40)),e.fillStyle=m?"#00ff88":y?"#00ccdd":"#334455",e.shadowColor=m?"#00ff88":d?"#00ccdd":"transparent",e.shadowBlur=d&&!m?5:0,e.font="bold 11px Courier New",e.fillText(f.name,t/2-55,A),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(f.desc,t/2-55,A+14),e.fillStyle=m?"#005533":y?"#006677":"#221122",e.font="10px Courier New",e.fillText(m?"OWNED":"◆×"+f.cost,t/2+88,A+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",t/2,a-20),e.textAlign="left"}function jt(e,t,a,i,l){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,t,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",t/2,a/2-80),e.shadowBlur=0,i&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(i.ds.name+"  ·  LEVEL "+i.level,t/2,a/2-58),e.fillStyle="#334455",e.fillText(i.ds.narrative,t/2,a/2-44)),Tt.forEach((r,f)=>{const n=f===l,d=a/2-14+f*36;n&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-110,d-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(t/2-110,d-18,220,26)),e.fillStyle=n?"#00ff88":"#334433",e.shadowColor=n?"#00ff88":"transparent",e.shadowBlur=n?6:0,e.font=n?"bold 13px Courier New":"12px Courier New",e.fillText(r,t/2,d),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",t/2,a-20),e.textAlign="left"}function Zt(e,t,a,i,l){const r=1-i.timer/220,f=r<.1?r/.1:r>.9?(1-r)/.1:1,n=i.ds||j[0];e.fillStyle=n.bgColor||"#02020a",e.fillRect(0,0,t,a);for(let d=0;d<7;d++){const m=(l*.02+d*t/7)%t;e.strokeStyle=`rgba(0,255,136,${.02*f})`,e.lineWidth=1,e.beginPath(),e.moveTo(m,0),e.lineTo(m-100,a),e.stroke()}if(e.globalAlpha=f,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(i.text,t/2,a/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+n.name,t/2,a/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(n.narrative,t/2,a/2+24),n.archetype&&se[n.archetype]){const d=se[n.archetype];e.fillStyle=d.glow,e.shadowColor=d.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+d.name,t/2,a/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function Jt(e,t,a,i,l,r,f,n){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,t,a),e.textAlign="center";const d=i?.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+(d?.name||"THE VOID"),t/2,a/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",t/2,a/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(i.score).padStart(7,"0"),t/2,a/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+i.level,t/2,a/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+r.length+"/"+j.length,t/2,a/2+14),e.fillText("REP "+(n>=0?"+":"")+n+"  ·  ◆×"+f,t/2,a/2+32),l.length>0){const y=l.findIndex(A=>A.score===i.score);y>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(y+1)+" ALL TIME",t/2,a/2+54))}const m=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*m})`,e.fillRect(t/2-110,a/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*m})`,e.strokeRect(t/2-110,a/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",t/2,a/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",t/2,a/2+120),e.textAlign="left"}class Xt{constructor(){this.audioContext=null,this.masterGain=null,this.enabled=!0,this.volume=.3,this.initialize()}initialize(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=this.volume,this.masterGain.connect(this.audioContext.destination)}catch(t){console.warn("Web Audio API not supported:",t),this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.masterGain&&(this.masterGain.gain.value=this.volume)}toggle(){return this.enabled=!this.enabled,this.enabled}playPeaceCollect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[523.25,659.25,783.99,1046.5].forEach((i,l)=>{const r=this.audioContext.createOscillator(),f=this.audioContext.createGain();r.type="sine",r.frequency.value=i,f.gain.setValueAtTime(0,t+l*.08),f.gain.linearRampToValueAtTime(.15,t+l*.08+.01),f.gain.exponentialRampToValueAtTime(.001,t+l*.08+.3),r.connect(f),f.connect(this.masterGain),r.start(t+l*.08),r.stop(t+l*.08+.3)})}playDamage(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),l=this.audioContext.createBiquadFilter();a.type="sawtooth",a.frequency.setValueAtTime(80,t),a.frequency.exponentialRampToValueAtTime(40,t+.15),l.type="lowpass",l.frequency.value=800,l.Q.value=5,i.gain.setValueAtTime(.25,t),i.gain.exponentialRampToValueAtTime(.001,t+.15),a.connect(l),l.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.15)}playMatrixSwitch(t=!1){if(!this.enabled||!this.audioContext)return;this.resume();const a=this.audioContext.currentTime,i=this.audioContext.createOscillator(),l=this.audioContext.createGain();i.type="square",t?(i.frequency.setValueAtTime(400,a),i.frequency.exponentialRampToValueAtTime(200,a+.2)):(i.frequency.setValueAtTime(200,a),i.frequency.exponentialRampToValueAtTime(400,a+.2)),l.gain.setValueAtTime(.2,a),l.gain.exponentialRampToValueAtTime(.001,a+.2),i.connect(l),l.connect(this.masterGain),i.start(a),i.stop(a+.2)}playLevelComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[261.63,329.63,392,523.25].forEach(i=>{const l=this.audioContext.createOscillator(),r=this.audioContext.createGain();l.type="sine",l.frequency.value=i,r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(.12,t+.05),r.gain.exponentialRampToValueAtTime(.001,t+.8),l.connect(r),r.connect(this.masterGain),l.start(t),l.stop(t+.8)})}playEnemyHit(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),l=this.audioContext.createBiquadFilter();a.type="triangle",a.frequency.setValueAtTime(150,t),a.frequency.exponentialRampToValueAtTime(50,t+.1),l.type="lowpass",l.frequency.value=400,i.gain.setValueAtTime(.3,t),i.gain.exponentialRampToValueAtTime(.001,t+.1),a.connect(l),l.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.1)}playMenuNav(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.type="sine",a.frequency.value=440,i.gain.setValueAtTime(.1,t),i.gain.exponentialRampToValueAtTime(.001,t+.05),a.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.05)}playMenuSelect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.type="square",a.frequency.value=880,i.gain.setValueAtTime(.15,t),i.gain.exponentialRampToValueAtTime(.001,t+.1),a.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.1)}playArchetypePower(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;for(let a=0;a<5;a++){const i=this.audioContext.createOscillator(),l=this.audioContext.createGain();i.type="sine",i.frequency.value=220*(a+1);const r=t+a*.03;l.gain.setValueAtTime(.08,r),l.gain.exponentialRampToValueAtTime(.001,r+.2),i.connect(l),l.connect(this.masterGain),i.start(r),i.stop(r+.2)}}playShoot(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.type="square",a.frequency.setValueAtTime(600,t),a.frequency.exponentialRampToValueAtTime(200,t+.06),i.gain.setValueAtTime(.08,t),i.gain.exponentialRampToValueAtTime(.001,t+.06),a.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.06)}playWaveComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[392,494,587,784].forEach((i,l)=>{const r=this.audioContext.createOscillator(),f=this.audioContext.createGain();r.type="triangle",r.frequency.value=i;const n=t+l*.1;f.gain.setValueAtTime(0,n),f.gain.linearRampToValueAtTime(.12,n+.02),f.gain.exponentialRampToValueAtTime(.001,n+.4),r.connect(f),f.connect(this.masterGain),r.start(n),r.stop(n+.4)})}playPowerUp(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;for(let a=0;a<3;a++){const i=this.audioContext.createOscillator(),l=this.audioContext.createGain();i.type="sine",i.frequency.value=880+a*440;const r=t+a*.05;l.gain.setValueAtTime(.1,r),l.gain.exponentialRampToValueAtTime(.001,r+.15),i.connect(l),l.connect(this.masterGain),i.start(r),i.stop(r+.15)}}playPlayerHurt(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,a=this.audioContext.createOscillator(),i=this.audioContext.createGain(),l=this.audioContext.createBiquadFilter();a.type="sawtooth",a.frequency.setValueAtTime(120,t),a.frequency.exponentialRampToValueAtTime(40,t+.2),l.type="bandpass",l.frequency.value=300,l.Q.value=2,i.gain.setValueAtTime(.2,t),i.gain.exponentialRampToValueAtTime(.001,t+.2),a.connect(l),l.connect(i),i.connect(this.masterGain),a.start(t),a.stop(t+.2)}dispose(){this.audioContext&&this.audioContext.close()}}const P=new Xt,$t=new Date("2025-01-29").getTime(),be=29.53*24*60*60*1e3,Je=[{name:"New Moon",fraction:0,insightMul:1,enemyMul:.85,desc:"Seed — quiet spawns, tutorial-friendly"},{name:"Waxing Crescent",fraction:.13,insightMul:1.1,enemyMul:.9,desc:"Build — gentle challenge increase"},{name:"First Quarter",fraction:.25,insightMul:1.2,enemyMul:1,desc:"Momentum — balanced tension"},{name:"Waxing Gibbous",fraction:.38,insightMul:1.3,enemyMul:1.1,desc:"Amplify — insight tokens more common"},{name:"Full Moon",fraction:.5,insightMul:1.5,enemyMul:1.2,desc:"Illuminate — peak clarity and challenge"},{name:"Waning Gibbous",fraction:.63,insightMul:1.2,enemyMul:1.1,desc:"Release — pruning, closure rewards"},{name:"Last Quarter",fraction:.75,insightMul:1.1,enemyMul:1,desc:"Reflect — integration, story fragments"},{name:"Waning Crescent",fraction:.88,insightMul:1,enemyMul:.9,desc:"Rest — soft spawns, dreamscape teasers"}],Qt=[{planet:"Sun",coherenceMul:1.2,insightMul:1.1,themes:["Radiance","Will","Clarity"],desc:"Visibility bonuses, coherence stabilisation"},{planet:"Moon",coherenceMul:1.1,insightMul:1.05,themes:["Dream","Tide","Reflection"],desc:"Dreamscape bias, softer soundscape"},{planet:"Mars",coherenceMul:.85,insightMul:1.2,themes:["Trial","Courage","Initiation"],desc:"Enemies more aggressive, higher rewards"},{planet:"Mercury",coherenceMul:1.05,insightMul:1.35,themes:["Signal","Learning","Pathfinding"],desc:"Insight tokens more common, puzzles"},{planet:"Jupiter",coherenceMul:1.15,insightMul:1.25,themes:["Expansion","Wisdom","Fortune"],desc:"Map grows, upgrade shop richer"},{planet:"Venus",coherenceMul:1.25,insightMul:1.15,themes:["Harmony","Beauty","Love"],desc:"Healing nodes, softer hazards"},{planet:"Saturn",coherenceMul:.9,insightMul:1,themes:["Structure","Limits","Discipline"],desc:"Walls and boundaries, planning bonuses"}];function Kt(){return((Date.now()-$t)%be+be)%be/be}function Xe(){const e=Kt();let t=Je[0];for(const a of Je)e>=a.fraction&&(t=a);return t}function $e(){const e=new Date().getDay();return Qt[e]}class xt{constructor(){this._lunar=Xe(),this._planet=$e(),this._lastRefresh=0}refresh(){this._lunar=Xe(),this._planet=$e(),this._lastRefresh=Date.now()}getLunarPhase(){return this._lunar}getPlanetaryDay(){return this._planet}getEnemyMul(){const t=this._lunar.enemyMul,a=this._planet.planet==="Mars"?.1:0;return t+a}getInsightMul(){return this._lunar.insightMul*(this._planet.insightMul??1)}getCoherenceMul(){return this._planet.coherenceMul??1}getModifiers(){return{enemyMul:this.getEnemyMul(),insightMul:this.getInsightMul(),coherenceMul:this.getCoherenceMul(),lunarName:this._lunar.name,planetName:this._planet.planet,lunarDesc:this._lunar.desc,planetDesc:this._planet.desc,themes:this._planet.themes}}}const Ne=new xt,Qe=[{id:"joy",display:"Joy",valence:1,arousal:.7,coherence:.9},{id:"hope",display:"Hope",valence:.8,arousal:.5,coherence:.8},{id:"trust",display:"Trust",valence:.7,arousal:.4,coherence:.85},{id:"surprise",display:"Surprise",valence:.2,arousal:1,coherence:.5},{id:"fear",display:"Fear",valence:-.7,arousal:.9,coherence:.2},{id:"sadness",display:"Sadness",valence:-1,arousal:.3,coherence:.3},{id:"disgust",display:"Disgust",valence:-.8,arousal:.6,coherence:.1},{id:"anger",display:"Anger",valence:-.9,arousal:.8,coherence:.15},{id:"shame",display:"Shame",valence:-.95,arousal:.5,coherence:.05},{id:"anticipation",display:"Anticipation",valence:.3,arousal:.8,coherence:.6}],ea=[{id:"FOCUSED_FORCE",label:"Focused Force",test:e=>e.coherence>.8&&e.valence>.5},{id:"CHAOS_BURST",label:"Chaos Burst",test:e=>e.distortion>.7&&e.coherence<.3},{id:"DEEP_INSIGHT",label:"Deep Insight",test:e=>e.coherence>.9&&e.valence>.7},{id:"NUMBNESS",label:"Numbness",test:e=>e.valence<-.7&&e.coherence<.2},{id:"SERENITY",label:"Serenity",test:e=>e.valence>.8&&e.coherence>.8},{id:"TURBULENCE",label:"Turbulence",test:e=>e.distortion>.5&&e.valence<0},{id:"EQUILIBRIUM",label:"Equilibrium",test:e=>Math.abs(e.valence)<.1&&e.coherence>.7}],Ke=[{id:"MIND",label:"Mind",test:e=>e.purgDepth<.2},{id:"PURGATORY",label:"Purgatory",test:e=>e.purgDepth>=.2&&e.purgDepth<.5},{id:"IMAGINATION",label:"Imagination",test:e=>e.purgDepth>=.5&&e.purgDepth<.7},{id:"HEAVEN",label:"Heaven",test:e=>e.purgDepth>=.7&&e.valence>.5},{id:"HELL",label:"Hell",test:e=>e.purgDepth>=.7&&e.valence<=.5}];class ta{constructor(t={}){this.emotions={},Qe.forEach(a=>{this.emotions[a.id]=typeof t[a.id]=="number"?t[a.id]:0}),this.lastUpdate=Date.now(),this.weekdayCoherenceMul=1}getEmotionArray(){return Qe.map(t=>({...t,value:this.emotions[t.id]}))}getDominantEmotion(){return this.getEmotionArray().reduce((i,l)=>i.value>l.value?i:l)}get valence(){let t=this.getEmotionArray(),a=t.reduce((l,r)=>l+r.value*r.valence,0),i=t.reduce((l,r)=>l+r.value,0)||1;return a/i}get coherence(){let t=this.getEmotionArray(),a=t.reduce((l,r)=>l+r.value*r.coherence,0),i=t.reduce((l,r)=>l+r.value,0)||1;return a/i}get distortion(){let t=this.getEmotionArray();return t.reduce((i,l)=>i+l.value*l.arousal*(1-l.coherence),0)/t.length}get purgDepth(){return Math.max(0,Math.min(1,this.distortion))}get synergy(){for(let t of ea)if(t.test(this))return t;return null}get realm(){for(let t of Ke)if(t.test(this))return t;return Ke[0]}decay(t=null){let a=Date.now(),i=t||(a-this.lastUpdate)/1e3;this.lastUpdate=a;let l=.05*this.weekdayCoherenceMul;for(let r in this.emotions)this.emotions[r]>0?this.emotions[r]=Math.max(0,this.emotions[r]-l*i):this.emotions[r]<0&&(this.emotions[r]=Math.min(0,this.emotions[r]+l*i))}setEmotion(t,a){this.emotions.hasOwnProperty(t)&&(this.emotions[t]=Math.max(-1,Math.min(1,a)))}addEmotion(t,a){this.emotions.hasOwnProperty(t)&&this.setEmotion(t,this.emotions[t]+a)}setAll(t){for(let a in t)this.setEmotion(a,t[a])}toJSON(){return{...this.emotions}}fromJSON(t){for(let a in t)this.setEmotion(a,t[a])}}class aa{constructor(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}calculateHPDelta(t,a){const i=a.dmgMul||1,l=a.healMul||1;switch(t){case 1:return-8*i;case 2:return-20*i;case 3:return-14*i;case 4:return 20*l;case 8:return-18*i;case 9:return-12*i;case 14:return-16*i;case 16:return-6*i;default:return 0}}update(t,a,i=3){if(!t||!a){this.active=!1,this.ghostPath=[];return}this.active=!0,this.direction=t,this.ghostPath=[];const[l,r]=t;let f=a.hp,n=a.player.y,d=a.player.x;const m=a.sz;for(let y=0;y<i;y++){const A=n+l,c=d+r;if(A<0||A>=m||c<0||c>=m)break;const o=a.grid[A][c];if(o===5)break;const M=this.calculateHPDelta(o,a);f+=M,this.ghostPath.push({y:A,x:c,tile:o,hpDelta:M,projectedHP:f}),n=A,d=c}this.projectedHP=f}deactivate(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}getGhostPath(){return this.active?this.ghostPath:[]}getTotalDelta(t){return!this.active||this.ghostPath.length===0?0:this.projectedHP-t}isActive(){return this.active&&this.ghostPath.length>0}}class ia{constructor(){this.activeDirection=null,this.holdStartTime=0,this.holdDuration=1e3,this.isHazard=!1,this.cancelled=!1}isHazardTile(t){return[1,2,3,8,9,14,16].includes(t)}startMove(t,a,i){return this.activeDirection=t,this.holdStartTime=i,this.isHazard=this.isHazardTile(a),this.cancelled=!1,this.isHazard?{ready:!1,progress:0}:{ready:!0,progress:1}}update(t){if(!this.activeDirection||this.cancelled)return{ready:!1,progress:0,cancelled:this.cancelled};if(!this.isHazard)return{ready:!0,progress:1,cancelled:!1};const a=t-this.holdStartTime,i=Math.min(1,a/this.holdDuration);return{ready:i>=1,progress:i,cancelled:!1}}cancel(){this.cancelled=!0,this.activeDirection=null,this.holdStartTime=0,this.isHazard=!1}reset(){this.activeDirection=null,this.holdStartTime=0,this.isHazard=!1,this.cancelled=!1}getProgress(){if(!this.activeDirection||!this.isHazard||this.cancelled)return 0;const t=Date.now()-this.holdStartTime;return Math.min(1,t/this.holdDuration)}isHolding(){return this.activeDirection!==null&&!this.cancelled&&this.isHazard}}class la{constructor(t){this.emotionalField=t.emotionalField,this.temporalSystem=t.temporalSystem,this.sfxManager=t.sfxManager,this.impulseBuffer=t.impulseBuffer,this.consequencePreview=t.consequencePreview,this.name="base",this.isActive=!1}init(t){this.isActive=!0}update(t,a,i,l){return null}render(t,a,i){}handleInput(t,a,i){return!1}cleanup(){this.isActive=!1}getState(){return{name:this.name}}restoreState(t){}getConfigOptions(){return[]}onEmotionChange(t){}onTemporalUpdate(t){}}const ra=.15,oa=.08,sa=.5,x={rusher:{color:"#ff3366",glowColor:"#ff0044",health:25,speed:80,radius:12,damage:12,score:10,shoots:!1},shooter:{color:"#ff8800",glowColor:"#ff6600",health:40,speed:45,radius:14,damage:8,score:20,shoots:!0,shootInterval:2.2,shootSpeed:260,shootDamage:6},tank:{color:"#cc00ff",glowColor:"#aa00ee",health:120,speed:28,radius:20,damage:18,score:40,shoots:!1}},re={health:{color:"#00ff44",label:"HEAL",duration:0,speedMul:1,fireMul:1},speed:{color:"#ffff00",label:"SPEED",duration:5,speedMul:1.6,fireMul:1},rapidfire:{color:"#ff8800",label:"RAPID",duration:5,speedMul:1,fireMul:.3},shield:{color:"#00aaff",label:"SHIELD",duration:8,speedMul:1,fireMul:1},multishot:{color:"#ff00ff",label:"MULTI",duration:6,speedMul:1,fireMul:1},bomb:{color:"#ff4400",label:"BOMB",duration:0,speedMul:1,fireMul:1},invincibility:{color:"#ffffff",label:"INVINCI",duration:4,speedMul:1,fireMul:1}};class na extends la{constructor(t){super(t),this.name="shooter",this.player={x:0,y:0,vx:0,vy:0,angle:0,health:100,maxHealth:100,speed:200,radius:15,score:0,invincible:0},this.bullets=[],this.enemyBullets=[],this.fireRate=.25,this.timeSinceLastShot=0,this.bulletSpeed=400,this.bulletDamage=10,this.enemies=[],this.wave=1,this.waveTimer=0,this.waveDelay=3,this.waveBanner=null,this.paused=!1,this.particles=[],this.powerUps=[],this.activePowerUps={},this.mouseX=0,this.mouseY=0,this.isShooting=!1,this.worldWidth=800,this.worldHeight=600,this.camera={x:0,y:0},this._lastDt=.016}init(t={}){super.init(t),this.player.x=this.worldWidth/2,this.player.y=this.worldHeight/2,this.player.vx=this.player.vy=0,this.player.health=this.player.maxHealth,this.player.score=0,this.player.invincible=0,this.bullets=[],this.enemyBullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps={},this.particles=[],this.waveBanner=null,this.paused=!1,this.wave=1,this.waveTimer=0,this.timeSinceLastShot=0,this.fireRate=.25,this.spawnWave(),console.log("[ShooterMode] Initialized")}update(t,a,i,l){if(this.paused)return null;const r=t/1e3;return this._lastDt=r,this.waveBanner&&(this.waveBanner.timer-=r,this.waveBanner.timer<=0&&(this.waveBanner=null),this.waveBanner&&this.waveBanner.timer>2)?null:(this.updatePlayerMovement(r,a),this.updateShooting(r),this.updateBullets(r),this.updateEnemyBullets(r),this.updateEnemies(r),this.updatePowerUps(r),this.updateParticles(r),this.checkCollisions(),this.updateWaveSpawning(r),this.updateCamera(),this.player.invincible>0&&(this.player.invincible-=r),this.enemies.length>3?this.emotionalField.addEmotion("fear",.1*r):this.emotionalField.addEmotion("joy",.05*r),this.emotionalField.decay(r),this.player.health<=0?{phase:"dead",data:{score:this.player.score,mode:"shooter",wave:this.wave}}:null)}updatePlayerMovement(t,a){let i=0,l=0;if((a.has("w")||a.has("W")||a.has("ArrowUp"))&&(l-=1),(a.has("s")||a.has("S")||a.has("ArrowDown"))&&(l+=1),(a.has("a")||a.has("A")||a.has("ArrowLeft"))&&(i-=1),(a.has("d")||a.has("D")||a.has("ArrowRight"))&&(i+=1),i!==0&&l!==0){const f=Math.sqrt(i*i+l*l);i/=f,l/=f}const r=this.activePowerUps.speed?this.player.speed*re.speed.speedMul:this.player.speed;this.player.vx=i*r,this.player.vy=l*r,this.player.x+=this.player.vx*t,this.player.y+=this.player.vy*t,this.player.x=Math.max(this.player.radius,Math.min(this.worldWidth-this.player.radius,this.player.x)),this.player.y=Math.max(this.player.radius,Math.min(this.worldHeight-this.player.radius,this.player.y))}updateShooting(t){this.timeSinceLastShot+=t;const a=this.activePowerUps.rapidfire?this.fireRate*re.rapidfire.fireMul:this.fireRate;this.isShooting&&this.timeSinceLastShot>=a&&(this.shoot(),this.timeSinceLastShot=0)}shoot(){const t=a=>({x:this.player.x,y:this.player.y,vx:Math.cos(a)*this.bulletSpeed,vy:Math.sin(a)*this.bulletSpeed,damage:this.bulletDamage,radius:3,age:0,maxAge:2});this.bullets.push(t(this.player.angle)),this.activePowerUps.multishot&&(this.bullets.push(t(this.player.angle-.25)),this.bullets.push(t(this.player.angle+.25))),this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playShoot?.())}updateBullets(t){for(let a=this.bullets.length-1;a>=0;a--){const i=this.bullets[a];i.x+=i.vx*t,i.y+=i.vy*t,i.age+=t,(i.age>i.maxAge||i.x<0||i.x>this.worldWidth||i.y<0||i.y>this.worldHeight)&&this.bullets.splice(a,1)}}updateEnemyBullets(t){for(let a=this.enemyBullets.length-1;a>=0;a--){const i=this.enemyBullets[a];i.x+=i.vx*t,i.y+=i.vy*t,i.age+=t,(i.age>i.maxAge||i.x<0||i.x>this.worldWidth||i.y<0||i.y>this.worldHeight)&&this.enemyBullets.splice(a,1)}}updateEnemies(t){for(let a=this.enemies.length-1;a>=0;a--){const i=this.enemies[a],l=this.player.x-i.x,r=this.player.y-i.y,f=Math.sqrt(l*l+r*r);if(i.type==="shooter"){if(f>0){const d=f>200?1:-.5;i.x+=l/f*i.speed*d*t,i.y+=r/f*i.speed*d*t}if(i._shootTimer=(i._shootTimer||0)-t,i._shootTimer<=0){i._shootTimer=x.shooter.shootInterval;const d=Math.atan2(r,l);this.enemyBullets.push({x:i.x,y:i.y,vx:Math.cos(d)*x.shooter.shootSpeed,vy:Math.sin(d)*x.shooter.shootSpeed,damage:x.shooter.shootDamage,radius:4,age:0,maxAge:3})}}else f>0&&(i.x+=l/f*i.speed*t,i.y+=r/f*i.speed*t);i.health<=0&&(this.spawnParticles(i.x,i.y,x[i.type].glowColor,12,120),this.player.score+=x[i.type].score*this.wave,Math.random()<.22&&this.spawnPowerUp(i.x,i.y),this.enemies.splice(a,1))}}updateParticles(t){for(let a=this.particles.length-1;a>=0;a--){const i=this.particles[a];i.x+=i.vx*t,i.y+=i.vy*t,i.vx*=.92,i.vy*=.92,i.life-=t,i.life<=0&&this.particles.splice(a,1)}}spawnParticles(t,a,i,l,r){for(let f=0;f<l;f++){const n=Math.PI*2*f/l+Math.random()*.5,d=r*(.5+Math.random()*.8);this.particles.push({x:t,y:a,vx:Math.cos(n)*d*.06,vy:Math.sin(n)*d*.06,r:2+Math.random()*2,color:i,life:.3+Math.random()*.3,maxLife:.6})}}updatePowerUps(t){for(let a=this.powerUps.length-1;a>=0;a--)this.powerUps[a].age+=t,this.powerUps[a].age>12&&this.powerUps.splice(a,1);for(const a of Object.keys(this.activePowerUps))this.activePowerUps[a]-=t,this.activePowerUps[a]<=0&&delete this.activePowerUps[a]}checkCollisions(){e:for(let t=this.bullets.length-1;t>=0;t--){const a=this.bullets[t];for(let i=this.enemies.length-1;i>=0;i--){const l=this.enemies[i],r=a.x-l.x,f=a.y-l.y;if(Math.sqrt(r*r+f*f)<a.radius+l.radius){l.health-=a.damage,this.spawnParticles(a.x,a.y,x[l.type].glowColor,4,60),this.bullets.splice(t,1),this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playEnemyHit?.());continue e}}}if(this.player.invincible<=0&&!this.activePowerUps.shield)for(let t=this.enemyBullets.length-1;t>=0;t--){const a=this.enemyBullets[t],i=a.x-this.player.x,l=a.y-this.player.y;Math.sqrt(i*i+l*l)<a.radius+this.player.radius&&(this.player.health-=a.damage,this.spawnParticles(a.x,a.y,"#ffaa00",5,50),this.enemyBullets.splice(t,1),this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playPlayerHurt?.()))}if(this.player.invincible<=0&&!this.activePowerUps.shield)for(const t of this.enemies){const a=this.player.x-t.x,i=this.player.y-t.y,l=Math.sqrt(a*a+i*i);l<this.player.radius+t.radius&&((!t._contactCooldown||t._contactCooldown<=0)&&(this.player.health-=x[t.type].damage,t._contactCooldown=sa,this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playPlayerHurt?.())),l>0&&(this.player.x+=a/l*4,this.player.y+=i/l*4)),t._contactCooldown>0&&(t._contactCooldown-=this._lastDt)}for(let t=this.powerUps.length-1;t>=0;t--){const a=this.powerUps[t],i=this.player.x-a.x,l=this.player.y-a.y;Math.sqrt(i*i+l*l)<this.player.radius+10&&(this.collectPowerUp(a),this.spawnParticles(a.x,a.y,re[a.type].color,8,80),this.powerUps.splice(t,1))}}spawnWave(){const t=4+Math.floor(this.wave*1.2),a={rusher:Math.max(1,Math.floor(t*.5)),shooter:Math.floor(t*.3),tank:Math.floor(t*.2)};for(const[i,l]of Object.entries(a))for(let r=0;r<l;r++){const f=Math.floor(Math.random()*4);let n,d;f===0?(n=Math.random()*this.worldWidth,d=-30):f===1?(n=this.worldWidth+30,d=Math.random()*this.worldHeight):f===2?(n=Math.random()*this.worldWidth,d=this.worldHeight+30):(n=-30,d=Math.random()*this.worldHeight);const m=x[i],y=1+(this.wave-1)*ra;this.enemies.push({x:n,y:d,type:i,health:Math.round(m.health*y),maxHealth:Math.round(m.health*y),speed:m.speed*(1+(this.wave-1)*oa),radius:m.radius,_contactCooldown:0,_shootTimer:m.shoots?m.shootInterval:0})}this.waveBanner={text:"WAVE "+this.wave,timer:2.5},this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playWaveComplete?.()),console.log("[ShooterMode] Wave "+this.wave+" spawned: "+this.enemies.length+" enemies")}updateWaveSpawning(t){this.enemies.length===0&&!this.waveBanner?(this.waveTimer+=t,this.waveTimer>=this.waveDelay&&(this.wave++,this.waveTimer=0,this.spawnWave())):this.enemies.length>0&&(this.waveTimer=0)}spawnPowerUp(t,a){const i=Object.keys(re);this.powerUps.push({x:t,y:a,type:i[Math.floor(Math.random()*i.length)],age:0})}collectPowerUp(t){switch(this.sfxManager&&(this.sfxManager.resume(),this.sfxManager.playPowerUp?.()),t.type){case"health":this.player.health=Math.min(this.player.maxHealth,this.player.health+35);break;case"speed":case"rapidfire":case"multishot":case"invincibility":case"shield":this.activePowerUps[t.type]=re[t.type].duration,t.type==="invincibility"&&(this.player.invincible=re.invincibility.duration);break;case"bomb":for(const a of this.enemies)a.type==="tank"?a.health-=60:a.health=0,this.spawnParticles(a.x,a.y,"#ff4400",10,150);break}}updateCamera(){this.camera.x=this.player.x-300,this.camera.y=this.player.y-250}render(t,a,i){const l=i?.w||640,r=i?.h||580;t.fillStyle="#0a0a14",t.fillRect(0,0,l,r);for(let f=0;f<r;f+=3)t.fillStyle="rgba(0,0,0,0.08)",t.fillRect(0,f,l,1);t.save(),t.translate(-this.camera.x,-this.camera.y),t.fillStyle="rgba(0,255,136,0.04)";for(let f=0;f<=this.worldWidth;f+=50)for(let n=0;n<=this.worldHeight;n+=50)t.beginPath(),t.arc(f,n,1,0,Math.PI*2),t.fill();t.strokeStyle="rgba(0,255,136,0.1)",t.lineWidth=1,t.strokeRect(0,0,this.worldWidth,this.worldHeight);for(const f of this.particles){const n=Math.max(0,f.life/f.maxLife);t.globalAlpha=n*.85,t.fillStyle=f.color,t.beginPath(),t.arc(f.x,f.y,f.r,0,Math.PI*2),t.fill()}t.globalAlpha=1;for(const f of this.powerUps){const n=re[f.type],d=Math.sin(f.age*4)*3;t.fillStyle=n.color,t.shadowColor=n.color,t.shadowBlur=10+d,t.beginPath(),t.arc(f.x,f.y,10,0,Math.PI*2),t.fill(),t.shadowBlur=0,t.fillStyle="#fff",t.font="8px Courier New",t.textAlign="center",t.fillText(n.label,f.x,f.y+22),t.textAlign="left"}for(const f of this.enemyBullets)t.fillStyle="#ff8800",t.shadowColor="#ff6600",t.shadowBlur=6,t.beginPath(),t.arc(f.x,f.y,f.radius,0,Math.PI*2),t.fill();t.shadowBlur=0;for(const f of this.bullets){const n=1-f.age/f.maxAge;t.fillStyle="rgba(0,255,136,"+n+")",t.shadowColor="#00ff88",t.shadowBlur=6,t.beginPath(),t.arc(f.x,f.y,f.radius,0,Math.PI*2),t.fill()}t.shadowBlur=0;for(const f of this.enemies)this.drawEnemy(t,f,a);this.drawPlayer(t,a),t.restore(),this.drawHUD(t,l,r),this.waveBanner&&this.drawWaveBanner(t,l,r)}drawPlayer(t,a){const i=this.player;if(i.invincible>0&&Math.floor(i.invincible*10)%2===0)return;const l=!!this.activePowerUps.shield,r=.5+.5*Math.sin(a*.009);l&&(t.strokeStyle="rgba(0,170,255,0.7)",t.lineWidth=3,t.shadowColor="#00aaff",t.shadowBlur=14,t.beginPath(),t.arc(i.x,i.y,i.radius+7,0,Math.PI*2),t.stroke(),t.shadowBlur=0),t.fillStyle="#00aa66",t.shadowColor="#00ff88",t.shadowBlur=18*r,t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.PI*2),t.fill(),t.fillStyle="#ccffee",t.shadowBlur=0,t.beginPath(),t.arc(i.x,i.y,4,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(0,255,136,0.8)",t.lineWidth=2,t.beginPath(),t.moveTo(i.x+Math.cos(i.angle)*i.radius,i.y+Math.sin(i.angle)*i.radius),t.lineTo(i.x+Math.cos(i.angle)*(i.radius+12),i.y+Math.sin(i.angle)*(i.radius+12)),t.stroke(),t.shadowBlur=0}drawEnemy(t,a,i){const l=x[a.type],r=a.health/a.maxHealth,f=.6+.4*Math.sin(i*.007+a.x*.01);t.fillStyle=l.color,t.shadowColor=l.glowColor,t.shadowBlur=8*f,a.type==="tank"?(t.beginPath(),t.rect(a.x-a.radius,a.y-a.radius,a.radius*2,a.radius*2),t.fill()):a.type==="shooter"?(t.beginPath(),t.moveTo(a.x,a.y-a.radius),t.lineTo(a.x+a.radius,a.y),t.lineTo(a.x,a.y+a.radius),t.lineTo(a.x-a.radius,a.y),t.closePath(),t.fill()):(t.beginPath(),t.arc(a.x,a.y,a.radius,0,Math.PI*2),t.fill()),t.shadowBlur=0;const n=a.radius*2.4;t.fillStyle="#1a1a2a",t.fillRect(a.x-n/2,a.y-a.radius-9,n,4),t.fillStyle=r>.5?"#00ff88":r>.25?"#ffaa00":"#ff3333",t.fillRect(a.x-n/2,a.y-a.radius-9,n*r,4)}drawHUD(t,a,i){t.fillStyle="rgba(7,7,20,0.9)",t.fillRect(0,0,a,92),t.strokeStyle="rgba(255,102,34,0.15)",t.lineWidth=1,t.beginPath(),t.moveTo(0,92),t.lineTo(a,92),t.stroke(),t.fillStyle="rgba(50,20,0,0.8)",t.fillRect(0,0,a,14),t.fillStyle="#ff6622",t.font="8px Courier New",t.textAlign="center",t.fillText("SHOOTER MODE  ·  WASD move  ·  Mouse aim+click shoot  ·  ESC pause",a/2,10),t.textAlign="left";const l=Math.max(0,this.player.health/this.player.maxHealth),r=l>.6?"#00ff88":l>.3?"#ffaa00":"#ff3333";t.fillStyle="#333",t.font="9px Courier New",t.fillText("HP",14,30),t.fillStyle="#0e0e1e",t.fillRect(32,20,138,13),t.fillStyle=r,t.shadowColor=r,t.shadowBlur=5,t.fillRect(32,20,138*l,13),t.shadowBlur=0,t.strokeStyle="rgba(255,255,255,0.06)",t.strokeRect(32,20,138,13),t.fillStyle="#888",t.font="8px Courier New",t.fillText(Math.max(0,Math.ceil(this.player.health))+"/"+this.player.maxHealth,178,30),t.fillStyle="#00ff88",t.shadowColor="#00ff88",t.shadowBlur=8,t.font="bold 18px Courier New",t.textAlign="center",t.fillText(String(this.player.score).padStart(7,"0"),a/2,38),t.shadowBlur=0,t.fillStyle="#223322",t.font="7px Courier New",t.fillText("SCORE",a/2,50),t.textAlign="left",t.textAlign="right",t.fillStyle="#ff8800",t.font="bold 11px Courier New",t.fillText("WAVE "+this.wave,a-12,30),t.fillStyle="#554422",t.font="8px Courier New",t.fillText("ENEMIES: "+this.enemies.length,a-12,44),this.enemies.length===0&&!this.waveBanner&&(t.fillStyle="#ffaa00",t.fillText("NEXT: "+(this.waveDelay-this.waveTimer).toFixed(1)+"s",a-12,58)),t.textAlign="left";let f=43;for(const[n,d]of Object.entries(this.activePowerUps)){const m=re[n];m&&(t.fillStyle=m.color,t.font="8px Courier New",t.fillText(m.label+" "+d.toFixed(1)+"s",14,f+15),f+=14)}}drawWaveBanner(t,a,i){const l=Math.min(1,this.waveBanner.timer>2?(2.5-this.waveBanner.timer)*4:this.waveBanner.timer*2.5);t.globalAlpha=Math.max(0,l),t.fillStyle="rgba(0,0,0,0.65)",t.fillRect(0,i/2-50,a,100),t.fillStyle="#ff8800",t.shadowColor="#ff8800",t.shadowBlur=30,t.font="bold 40px Courier New",t.textAlign="center",t.fillText(this.waveBanner.text,a/2,i/2+8),t.shadowBlur=0,t.fillStyle="#664400",t.font="13px Courier New",t.fillText("PREPAREâ¦",a/2,i/2+32),t.textAlign="left",t.globalAlpha=1}handleInput(t,a,i){if(i&&i.type==="mousemove"){const l=i.target.getBoundingClientRect();this.mouseX=i.clientX-l.left+this.camera.x,this.mouseY=i.clientY-l.top+this.camera.y;const r=this.mouseX-this.player.x,f=this.mouseY-this.player.y;return this.player.angle=Math.atan2(f,r),!0}return a==="mousedown"?(this.isShooting=!0,!0):a==="mouseup"?(this.isShooting=!1,!0):!1}cleanup(){super.cleanup(),this.bullets=[],this.enemyBullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps={},this.particles=[],console.log("[ShooterMode] Cleaned up")}getState(){return{name:this.name,wave:this.wave,score:this.player.score}}restoreState(t){t.wave&&(this.wave=t.wave),t.score&&(this.player.score=t.score)}}const ae=document.getElementById("c"),Q=ae.getContext("2d"),ue=Math.min(window.devicePixelRatio||1,2);function Ve(){const e=Ae(),t=Te();ae.width=e*ue,ae.height=t*ue,ae.style.width=Math.min(e,window.innerWidth-16)+"px",ae.style.height="auto",Q.setTransform(1,0,0,1,0,0),Q.scale(ue,ue)}Ve();const fe=new ta,Ce=new aa,ge=new ia;window.sfxManager=P;const fa={emotionalField:fe,temporalSystem:Ne,sfxManager:P,impulseBuffer:null,consequencePreview:Ce},he=new na(fa);let T=null,ke=null,q=null,xe=0,Le=0,te="grid";const ha=.15;window._insightTokens=X;window._dreamIdx=D.dreamIdx;let et=0,Re=500,ve=!1,Pe={row:-1,col:-1,t:0},Ue=[],Oe=[],Fe=[],Ie={text:"",timer:0,ds:null};const ie=new Set;function pt(e,t){Oe=[];for(let a=0;a<30;a++)Oe.push({x:Math.random()*e,y:Math.random()*t,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}function da(e,t){Fe=[];for(let a=0;a<5;a++)Fe.push({text:pe(wt),x:40+Math.random()*(e-80),y:90+Math.random()*(t-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+L(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}function V(e,t,a){T&&(T.msg=e,T.msgColor=t,T.msgTimer=a)}function ua(e,t,a){const i=ht();i.push({score:e,level:t,dreamscape:a?.name||"?",date:new Date().toLocaleDateString()}),i.sort((r,f)=>f.score-r.score);const l=i.slice(0,8);st(l),Pt(l)}function pa(e){const t=e.ds.environmentEvent,a=e.sz;if(t){if(t==="gravity_shift"){const[i,l]=pe([[-1,0],[1,0],[0,-1],[0,1]]),r=e.player.y+i,f=e.player.x+l;r>=0&&r<a&&f>=0&&f<a&&e.grid[r][f]!==5&&(e.player.y=r,e.player.x=f,V("GRAVITY SHIFTS…","#8888ff",40))}else if(t==="loop_reset"){for(let i=-2;i<=2;i++)for(let l=-2;l<=2;l++){const r=e.player.y+i,f=e.player.x+l;r>=0&&r<a&&f>=0&&f<a&&e.grid[r][f]===0&&Math.random()<.25&&(e.grid[r][f]=8)}V("THE LOOP TIGHTENS…","#ff8800",40)}else if(t==="capture_zones"){const i=pe(e.enemies);i&&(e.captureZones=[{x:i.x,y:i.y,r:2,timer:300}]),V("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(t==="rapid_spawn"){if(e.enemies.length<10){const i=2+L(a-4),l=2+L(a-4);e.enemies.push({y:i,x:l,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:i,prevX:l,momentum:[0,0],type:"rush"}),V("CHAOS ERUPTS!","#ff0044",40)}}else if(t==="wall_phase"){let i=0;for(let l=0;l<a&&i<4;l++)for(let r=0;r<a&&i<4;r++)e.grid[l][r]===5&&Math.random()<.3&&(e.grid[l][r]=10,i++);V("MEMBRANE DISSOLVES…","#00ccff",40)}else if(t==="glide_nodes"){let i=0,l=0;for(;i<2&&l<999;){l++;const r=L(a),f=L(a);e.grid[r][f]===0&&(e.grid[r][f]=12,i++)}V("GLIDE NODES APPEAR","#00aaff",40)}else if(t==="mashup"){const i=pe(j.filter(l=>l.id!==e.ds.id));if(i.hazardSet[0]){let l=0,r=0;for(;l<3&&r<999;){r++;const f=L(a),n=L(a);e.grid[f][n]===0&&(e.grid[f][n]=i.hazardSet[0],l++)}}V("DREAMSCAPES MERGE…","#ffaaff",40)}else if(t==="line_of_sight"){for(const r of e.enemies)r.stunTimer>0&&(r.stunTimer=0);let i=0,l=0;for(;i<3&&l<999;){l++;const r=L(a),f=L(a);e.grid[r][f]===0&&Math.random()<.5&&(e.grid[r][f]=2,i++)}V("THE SUMMIT WATCHES…","#ff4422",40)}else if(t==="dead_ends"){let i=0,l=0;for(;i<4&&l<999;){l++;const r=1+L(a-2),f=1+L(a-2);e.grid[r][f]===0&&(e.grid[r][f]=5,i++)}V("THE LABYRINTH SHIFTS…","#cc8800",40)}if(Math.random()<.4){const i=L(a);for(let l=0;l<a;l++)e.grid[i][l]===1?e.grid[i][l]=4:e.grid[i][l]===4&&Math.random()<.3&&(e.grid[i][l]=1);Pe={row:i,col:-1,t:50},ve=!0}}}function mt(e,t,a,i){const l=(a||0)+1;Ve();const r=j[e%j.length];lt(r.matrixDefault);const f=Nt(r,Ge(),l,t,i,u.maxHp,He);return da(Ae(),Te()),Ue=[],Re=500+L(500),pt(Ae(),Te()),f}function me(e){P.resume(),Ne.refresh();const t=Ne.getModifiers();if(window._tmods=t,te==="shooter"){qe(),he.init({}),U("playing"),Le=0,cancelAnimationFrame(q),q=requestAnimationFrame(J);return}Rt(),qe(),fe.setAll({joy:0,hope:0,trust:0,surprise:0,fear:0,sadness:0,disgust:0,anger:0,shame:0,anticipation:0}),D.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=D.dreamIdx,T=mt(D.dreamIdx,0,0,void 0),U("playing"),Le=0,rt(0),cancelAnimationFrame(q),q=requestAnimationFrame(J)}function ma(){const e=T,t=(D.dreamIdx+1)%j.length;D.dreamIdx=t,window._dreamIdx=t,Ct(e.ds.id),P.playLevelComplete(),Ie={text:e.ds.completionText,subtext:j[t].narrative,timer:220,ds:j[t]},U("interlude"),setTimeout(()=>{Ve(),T=mt(t,e.score+400+e.level*60,e.level,e.hp),T.msg=j[t].name,T.msgColor="#ffdd00",T.msgTimer=90,G==="interlude"&&U("playing")},3600)}function ya(e){const t=de.find(a=>a.id===e);!t||X<t.cost||nt(e)||(ot(t.cost),window._insightTokens=X,e==="maxhp"&&(u.maxHp+=25,T&&(T.hp=Math.min(T.hp+25,u.maxHp))),e==="speed"&&(u.moveDelay=Math.max(55,u.moveDelay-15)),e==="magnet"&&(u.magnet=!0),e==="freeze"&&(u.freeze=!0),e==="aura"&&(u.aura=!0),e==="energy"&&(u.energyMax=Math.min(200,u.energyMax+30)),e==="rewind"&&(u.temporalRewind=!0),e==="pulse"&&(u.glitchPulse=!0))}function J(e){const t=e-xe;xe=e;const a=Ae(),i=Te();if(G==="title"){Vt(Q,a,i,Oe,e,R.menu,te),q=requestAnimationFrame(J);return}if(G==="dreamselect"){Wt(Q,a,i,D.dreamIdx),q=requestAnimationFrame(J);return}if(G==="options"){zt(Q,a,i,R.opt),q=requestAnimationFrame(J);return}if(G==="highscores"){Yt(Q,a,i,_e),q=requestAnimationFrame(J);return}if(G==="upgrade"){qt(Q,a,i,R.shop,X,nt),q=requestAnimationFrame(J);return}if(G==="dead"){Jt(Q,a,i,ke,_e,He,X,it),q=requestAnimationFrame(J);return}if(G==="paused"){jt(Q,a,i,T,R.pause),q=requestAnimationFrame(J);return}if(G==="interlude"){Zt(Q,a,i,Ie,e),Ie.timer--,Ie.timer<=0&&G==="interlude"&&U("playing"),q=requestAnimationFrame(J);return}if(te==="shooter"){const y=he.update(t,ie,ee,e);he.render(Q,e,{w:a,h:i,DPR:ue}),y&&y.phase==="dead"&&(ke={score:y.data.score,level:he.wave,ds:{name:"SHOOTER ARENA"}},T=null,U("dead")),q=requestAnimationFrame(J);return}const l=window._tmods||Ne.getModifiers();T.temporalEnemyMul=l.enemyMul,T.insightMul=l.insightMul;const r=(ee==="B"?1.2:.7)*(l.coherenceMul||1);fe.weekdayCoherenceMul=r,fe.decay(t/1e3);const f=fe.getDominantEmotion();f.value>ha&&(u.emotion=f.id),window._emotionSynergy=fe.synergy,window._purgDepth=fe.purgDepth;const n=T.slowMoves?u.moveDelay*1.5:u.moveDelay,d={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};let m=null;for(const[y,[A,c]]of Object.entries(d))if(ie.has(y)){m=[A,c];break}if(m?Ce.update(m,T,3):Ce.deactivate(),m&&e-Le>n){const[y,A]=m,c=T.player.y+y,o=T.player.x+A,M=c>=0&&c<T.sz&&o>=0&&o<T.sz?T.grid[c][o]:0,E=ge.activeDirection?ge.update(e):ge.startMove(m,M,e);window._impulseProgress=E.progress,E.ready&&(Ht(T,y,A,ee,ma,V,X,v=>{for(;X<v;)Mt();window._insightTokens=X}),Le=e,ge.reset())}else m||(ge.cancel(),window._impulseProgress=0);if(T.emotionTimer>0&&(T.emotionTimer--,T.emotionTimer<=0&&(T.slowMoves=!1,u.emotion="neutral")),bt(t),ee==="B"&&we>4e3&&Math.random()<2e-4*t&&(T.hp=Math.min(u.maxHp,T.hp+1)),ee==="A"&&we>2500&&Math.random()<3e-4*t&&(T.hp=Math.max(0,T.hp-1)),Re-=t,Re<=0&&(et=2+L(4),Re=500+L(700)),ve&&(Pe.t--,Pe.t<=0&&(ve=!1)),T.environmentTimer-=t,T.environmentTimer<=0&&(T.environmentTimer=900+L(700),Math.random()<.6&&pa(T)),kt(T,t),Lt(T,t,ie,ee,Ue,V,Me),T.hp<=0){ke=T,ua(T.score,T.level,T.ds),U("dead"),q=requestAnimationFrame(J);return}Gt(Q,e,T,ee,Oe,Fe,Ue,ve,Pe,et,ue,Ce.getGhostPath()),q=requestAnimationFrame(J)}window.addEventListener("keydown",e=>{if(ie.add(e.key),G==="title"){e.key==="ArrowUp"&&(R.menu=(R.menu-1+5)%5,P.resume(),P.playMenuNav()),e.key==="ArrowDown"&&(R.menu=(R.menu+1)%5,P.resume(),P.playMenuNav()),(e.key==="m"||e.key==="M")&&(te=te==="grid"?"shooter":"grid",P.resume(),P.playMatrixSwitch(te==="grid")),(e.key==="Enter"||e.key===" ")&&(P.resume(),P.playMenuSelect(),R.menu===0?me(D.dreamIdx):R.menu===1?U("dreamselect"):R.menu===2?(R.opt=0,U("options")):R.menu===3?U("highscores"):R.menu===4&&(R.shop=0,R.upgradeFrom="title",U("upgrade"))),e.preventDefault();return}if(G==="dreamselect"){e.key==="ArrowUp"&&(D.dreamIdx=(D.dreamIdx-1+j.length)%j.length,P.resume(),P.playMenuNav()),e.key==="ArrowDown"&&(D.dreamIdx=(D.dreamIdx+1)%j.length,P.resume(),P.playMenuNav()),e.key==="Enter"&&(P.resume(),P.playMenuSelect(),me(D.dreamIdx)),e.key==="Escape"&&U("title"),e.preventDefault();return}if(G==="options"){if(e.key==="ArrowUp"&&(R.opt=(R.opt-1+4)%4,P.resume(),P.playMenuNav()),e.key==="ArrowDown"&&(R.opt=(R.opt+1)%4,P.resume(),P.playMenuNav()),e.key==="ArrowLeft"||e.key==="ArrowRight"){const a=e.key==="ArrowLeft"?-1:1;if(R.opt===0){const i=["small","medium","large"].indexOf(D.gridSize);D.gridSize=["small","medium","large"][(i+a+3)%3]}else if(R.opt===1){const i=["easy","normal","hard"].indexOf(D.difficulty);D.difficulty=["easy","normal","hard"][(i+a+3)%3]}else R.opt===2&&(D.particles=!D.particles);P.resume(),P.playMenuNav()}(e.key==="Enter"||e.key==="Escape")&&(R.opt===3||e.key==="Escape")&&U(T?"paused":"title"),e.preventDefault();return}if(G==="highscores"){(e.key==="Enter"||e.key==="Escape")&&U("title"),e.preventDefault();return}if(G==="upgrade"){e.key==="ArrowUp"&&(R.shop=(R.shop-1+de.length)%de.length,P.resume(),P.playMenuNav()),e.key==="ArrowDown"&&(R.shop=(R.shop+1)%de.length,P.resume(),P.playMenuNav()),e.key==="Enter"&&(P.resume(),P.playMenuSelect(),ya(de[R.shop].id)),e.key==="Escape"&&U(R.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(G==="dead"){(e.key==="Enter"||e.key===" ")&&(P.resume(),P.playMenuSelect(),me(D.dreamIdx)),e.key==="Escape"&&(U("title"),R.menu=0),e.preventDefault();return}if(G==="paused"){e.key==="ArrowUp"&&(R.pause=(R.pause-1+4)%4,P.resume(),P.playMenuNav()),e.key==="ArrowDown"&&(R.pause=(R.pause+1)%4,P.resume(),P.playMenuNav()),e.key==="Enter"&&(R.pause===0?U("playing"):R.pause===1?(R.opt=0,U("options")):R.pause===2?(R.shop=0,R.upgradeFrom="paused",U("upgrade")):(U("title"),R.menu=0,T=null)),e.key==="Escape"&&U("playing"),e.preventDefault();return}if(G==="playing"){if(te==="shooter"){e.key==="Escape"&&(U("title"),R.menu=0),e.preventDefault();return}if(e.key==="Escape"&&(R.pause=0,U("paused")),e.key==="Shift"&&!e.repeat){const a=ee==="A"?"B":"A";lt(a),rt(0),P.resume(),P.playMatrixSwitch(a==="A");const i=a==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",l=a==="A"?"#ff0055":"#00ff88";V(i,l,55),D.particles&&z(T,T.player.x,T.player.y,l,22,4)}(e.key==="j"||e.key==="J")&&!e.repeat&&(T.archetypeActive||u.temporalRewind&&u.rewindBuffer.length>0?(Ze(T),P.resume(),P.playArchetypePower()):V("NO ARCHETYPE ACTIVE","#334455",25)),(e.key==="r"||e.key==="R")&&!e.repeat&&(u.glitchPulse&&u.glitchPulseCharge>=100?Bt(T,V):u.glitchPulse?V("CHARGING… "+Math.round(u.glitchPulseCharge)+"%","#660088",22):V("BUY GLITCH PULSE IN UPGRADES","#334455",28)),(e.key==="q"||e.key==="Q")&&!e.repeat&&u.freeze&&u.freezeTimer<=0&&(u.freezeTimer=2500,V("FREEZE ACTIVE!","#0088ff",50),z(T,T.player.x,T.player.y,"#0088ff",20,4)),(e.key==="c"||e.key==="C")&&!e.repeat&&(X>=2?(ot(2),window._insightTokens=X,T.contZones||(T.contZones=[]),T.contZones.push({x:T.player.x,y:T.player.y,timer:240,maxTimer:240}),V("CONTAINMENT ZONE","#00ffcc",38)):V("NEED 2 ◆ FOR CONTAINMENT","#334455",28))}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>ie.delete(e.key));ae.addEventListener("mousemove",e=>{G==="playing"&&te==="shooter"&&he.handleInput(null,"mousemove",e)});ae.addEventListener("mousedown",e=>{G==="playing"&&te==="shooter"&&(P.resume(),he.handleInput(null,"mousedown",e))});ae.addEventListener("mouseup",e=>{G==="playing"&&te==="shooter"&&he.handleInput(null,"mouseup",e)});function Be(e,t){const a=document.getElementById(e);if(!a)return;let i;a.addEventListener("touchstart",l=>{l.preventDefault(),ie.add(t),G==="title"&&me(D.dreamIdx),i=()=>ie.delete(t)},{passive:!1}),a.addEventListener("touchend",l=>{l.preventDefault(),i&&i()},{passive:!1}),a.addEventListener("mousedown",()=>{ie.add(t),G==="title"&&me(D.dreamIdx)}),a.addEventListener("mouseup",()=>ie.delete(t))}Be("btn-up","ArrowUp");Be("btn-down","ArrowDown");Be("btn-left","ArrowLeft");Be("btn-right","ArrowRight");ae.addEventListener("click",()=>{G==="title"&&me(D.dreamIdx)});st(ht());pt(Ae(),Te());q=requestAnimationFrame(J);
