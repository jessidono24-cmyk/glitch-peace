(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const m of s.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&t(m)}).observe(document,{childList:!0,subtree:!0});function a(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=a(n);fetch(n.href,s)}})();const l={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},ee={[l.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[l.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[l.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[l.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[l.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[l.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[l.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[l.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[l.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[l.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[l.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[l.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[l.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[l.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[l.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[l.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[l.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},u=44,H=2,nr={small:10,medium:13,large:17},qe={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function Je(e){const r={};for(const[a,t]of Object.entries(ee))r[a]={bg:t.bg,bd:t.bd,glow:t.glow};if(e)for(const[a,t]of Object.entries(e))Object.assign(r[a],t);return r}const sr=Je(null),fr=Je({[l.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[l.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[l.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[l.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[l.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[l.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[l.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[l.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[l.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),ie={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},W=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[l.DESPAIR,l.TERROR,l.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[l.DESPAIR,l.TERROR,l.HOPELESS],hazardCounts:[6,5,4],specialTiles:[l.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[l.RAGE,l.DESPAIR,l.GLITCH],hazardCounts:[5,6,5],specialTiles:[l.TRAP,l.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[l.TERROR,l.SELF_HARM,l.HOPELESS],hazardCounts:[4,3,5],specialTiles:[l.TELEPORT,l.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[l.TERROR,l.RAGE,l.HOPELESS,l.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[l.ARCHETYPE,l.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[l.DESPAIR,l.TERROR,l.SELF_HARM,l.PAIN],hazardCounts:[7,6,4,3],specialTiles:[l.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[l.TERROR,l.RAGE,l.GLITCH],hazardCounts:[6,5,4],specialTiles:[l.COVER,l.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[l.TRAP,l.RAGE,l.DESPAIR,l.TERROR],hazardCounts:[6,4,5,4],specialTiles:[l.TRAP,l.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[l.HOPELESS,l.DESPAIR,l.GLITCH],hazardCounts:[4,4,4],specialTiles:[l.TELEPORT,l.ARCHETYPE,l.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[l.DESPAIR,l.TERROR,l.RAGE,l.HOPELESS,l.SELF_HARM,l.GLITCH,l.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[l.ARCHETYPE,l.TELEPORT,l.INSIGHT,l.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],le=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],dr=["memory…","choice…","echo…","void…","self…","signal…","fragment…","persist…","clarity…","dissolve…","boundary…","witness…","anchor…","pattern…","emergence…","dragon…","guide…","orb…","fear…","hope…"],hr=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],ur=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],pr=["small","medium","large"],mr=["easy","normal","hard"],C={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let Ce=[],$e=0,Z=0,we=[],Q="B",de=0;function je(e){Q=e}function Xe(e){de=e}function yr(e){de+=e}function cr(e=1){Z+=e}function Qe(e){Z=Math.max(0,Z-e)}function gr(e){we.push(e)}function Ke(e){Ce=e}function Er(){$e=0,Z=0,we=[],Q="B",de=0}const d={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function Ar(){Object.assign(d,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function xe(e){return{maxhp:d.maxHp>100,speed:d.moveDelay<120,magnet:d.magnet,freeze:d.freeze,aura:d.aura,energy:d.energyMax>100,rewind:d.temporalRewind,pulse:d.glitchPulse}[e]||!1}let B="title";function k(e){B=e}const M={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title"};let re=.45;function br(e){re=Math.max(0,Math.min(1,e))}function P(e){return Math.floor(Math.random()*e)}function fe(e){return e[P(e.length)]}function ke(e,r,a){return Math.max(r,Math.min(a,e))}const _e=[1,1,2,3,5,8,13,21,34,55,89];function Sr(e){return _e[Math.min(e,_e.length-1)]}const er="glitch_peace_v4";function Tr(e){try{localStorage.setItem(er+"_scores",JSON.stringify(e))}catch{}}function rr(){try{const e=localStorage.getItem(er+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Ie(){return nr[C.gridSize]}function Mr(){return qe[C.difficulty]}function ar(){return Ie()*u+(Ie()-1)*H}function he(){return ar()+48}function ue(){return ar()+148}function wr(e){const r=Array.from({length:e},()=>new Array(e).fill(l.VOID)),a=Math.floor(e*e*.07);for(let t=0;t<a;t++){const n=1+P(e-2),s=1+P(e-2);r[n][s]=l.WALL}return r}function se(e,r,a,t,n){let s=0,m=0;for(;s<r&&m<9999;){m++;const f=P(t),h=P(t);if(e[f][h]===l.VOID){if(f<2&&h<2)continue;e[f][h]=a,s++}}}function Rr(e,r,a,t,n,s,m){const f=Mr(),h=wr(r);h[0][0]=l.VOID,r>1&&(h[0][1]=l.VOID,h[1][0]=l.VOID);const y=Sr(a+2)+(r-13>0?r-13:0),E=1+Math.floor(a/3);if(e.hazardSet.forEach((L,w)=>{const S=Math.round((e.hazardCounts[w]||4)*f.hazMul);se(h,S,L,r)}),se(h,y,l.PEACE,r),se(h,E,l.INSIGHT,r),e.specialTiles.forEach(L=>se(h,2,L,r)),m&&m.length>0&&se(h,3,l.MEMORY,r),e.id==="aztec")for(let L=0;L<r*2;L++){const w=1+P(r-2),S=1+P(r-2);h[w][S]===l.VOID&&(h[w][S]=l.WALL)}const p=e.id==="bedroom"?2:e.id==="summit"?1:0,Y=Math.min(e.enemyCount+Math.floor(a*.5)+p,10),i=Math.max(1,Y+(C.difficulty==="hard"?2:C.difficulty==="easy"?-1:0)),b=[],T=Math.max(2,Math.floor(r/5));for(let L=0;L<i;L++){let w,S,D=0;do w=T+P(r-T*2),S=T+P(r-T*2),D++;while((h[w][S]!==l.VOID||w<2&&S<2)&&D<400);b.push({y:w,x:S,timer:P(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+P(3),prevY:w,prevX:S,momentum:[0,0],type:"hunter"})}let O=null;if(a>=6&&(e.id==="summit"||e.id==="integration")){const L=Math.floor(r/2),w=Math.floor(r/2);h[w][L]=l.VOID,O={y:w,x:L,hp:5+a,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:h,enemies:b,boss:O,sz:r,level:a,ds:e,player:{y:0,x:0},hp:n!==void 0?Math.min(s,n+25):s,score:t||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:y,insightLeft:E,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+P(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function U(e,r,a,t,n,s){if(!(!C.particles||!e))for(let m=0;m<n;m++){const f=Math.PI*2*m/n+Math.random()*.6,h=s*(.6+Math.random()*.8);e.particles.push({x:r*(u+H)+u/2,y:a*(u+H)+u/2,vx:Math.cos(f)*h,vy:Math.sin(f)*h-1,r:2+Math.random()*3,color:t,life:20+P(16),maxLife:36})}}function Te(e,r,a,t){!C.particles||!e||(e.resonanceWave={x:r*(u+H)+u/2,y:a*(u+H)+u/2,r:0,maxR:200,color:t,alpha:.55})}function lr(e,r){C.particles&&e.echos.push({x:e.player.x*(u+H)+u/2,y:e.player.y*(u+H)+u/2,life:30,maxLife:30,size:u*.38,color:r==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}function Cr(e,r,a,t,n,s,m){const f=e,h=f.sz,y=qe[C.difficulty];if(!f||f.hp<=0)return;if(d.freeze&&d.freezeTimer>0){d.freezeTimer-=r;return}const E=f.slowMoves?1.5:1,p=y.eSpeedBase-f.level*30,Y=Math.max(y.eSpeedMin,p)*(t==="A"?.65:1)*E*(f.temporalEnemyMul??1);if(f.level>=3){if(n.splice(0,n.length,...n.filter(i=>i.life>0)),Math.random()<6e-4*f.level&&n.length<3){const i=P(h),b=P(h);f.grid[i][b]===l.VOID&&n.push({y:i,x:b,timer:0,life:5e3+P(4e3)})}for(const i of n)if(i.life-=r,i.timer+=r,i.timer>450){i.timer=0;const b=f.player.x-i.x,T=f.player.y-i.y,O=T>0?1:T<0?-1:0,L=b>0?1:b<0?-1:0,w=i.y+O,S=i.x+L;w>=0&&w<h&&S>=0&&S<h&&(i.y=w,i.x=S),i.y===f.player.y&&i.x===f.player.x&&(f.hp=Math.max(0,f.hp-8),i.life=0,f.shakeFrames=4,f.flashColor="#8800ff",f.flashAlpha=.18,s("CHAOS PHANTOM!","#aa00ff",35))}}if(f.boss&&f.boss.hp>0){const i=f.boss;if(i.timer+=r,i.phaseTimer-=r,i.phaseTimer<=0&&(i.phase=i.phase==="chase"?"orbit":"chase",i.phaseTimer=400+P(300)),i.timer>280){i.timer=0;let b=f.player.x,T=f.player.y;f.level>=8&&(b+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,T+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const O=T-i.y,L=b-i.x,w=O>0?1:O<0?-1:0,S=L>0?1:L<0?-1:0;if(w&&i.y+w>=0&&i.y+w<h?i.y+=w:S&&i.x+S>=0&&i.x+S<h&&(i.x+=S),i.y===f.player.y&&i.x===f.player.x){const D=Math.round(40*y.dmgMul*(t==="A"?1.3:1));f.hp=Math.max(0,f.hp-D),f.shakeFrames=14,f.flashColor="#ff00aa",f.flashAlpha=.45,U(f,f.player.x,f.player.y,"#ff00aa",22,5),s("BOSS! -"+D,"#ff00aa",50)}}}for(const i of f.enemies){if(i.stunTimer>0){i.stunTimer-=r;continue}if(i.timer+=r,i.timer<Y)continue;i.timer=0,i.prevY=i.y,i.prevX=i.x;const b=i.behavior||f.ds.enemyBehavior,T=f.player.x-i.x,O=f.player.y-i.y,L=Math.abs(T)+Math.abs(O);let w=!1;if(b==="wander"||L>h*.7){const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[D,R]of S){const A=i.y+D,o=i.x+R;if(A>=0&&A<h&&o>=0&&o<h&&f.grid[A][o]!==l.WALL){i.y=A,i.x=o,w=!0;break}}}else if(b==="patrol"){i.patrolAngle+=(Math.random()-.5)*.4;const S=Math.round(Math.sin(i.patrolAngle)),D=Math.round(Math.cos(i.patrolAngle)),R=i.y+ke(S,-1,1),A=i.x+ke(D,-1,1);if(R>=0&&R<h&&A>=0&&A<h&&f.grid[R][A]!==l.WALL&&(i.y=R,i.x=A,w=!0),L<5&&Math.random()<.7){const o=O>0?1:O<0?-1:0,g=T>0?1:T<0?-1:0,v=i.y+o,N=i.x+g;v>=0&&v<h&&N>=0&&N<h&&f.grid[v][N]!==l.WALL&&(i.y=v,i.x=N)}}else if(b==="orbit"){i.orbitAngle+=.25;const S=f.player.x+Math.round(Math.cos(i.orbitAngle)*i.orbitR),D=f.player.y+Math.round(Math.sin(i.orbitAngle)*i.orbitR),R=D-i.y>0?1:D-i.y<0?-1:0,A=S-i.x>0?1:S-i.x<0?-1:0;i.y+R>=0&&i.y+R<h&&i.x+A>=0&&i.x+A<h&&f.grid[i.y+R][i.x+A]!==l.WALL&&(i.y+=R,i.x+=A)}else if(b==="chase_fast"||b==="adaptive"||b==="predictive"){let S=f.player.x,D=f.player.y;b==="predictive"&&f.level>=7&&(S+=a.has("ArrowRight")||a.has("d")?1:a.has("ArrowLeft")||a.has("a")?-1:0,D+=a.has("ArrowDown")||a.has("s")?1:a.has("ArrowUp")||a.has("w")?-1:0);const R=S-i.x,A=D-i.y,o=Math.abs(A)>=Math.abs(R)?[[A>0?1:-1,0],[0,R>0?1:-1]]:[[0,R>0?1:-1],[A>0?1:-1,0]];for(const[g,v]of o){const N=i.y+g,I=i.x+v;if(N>=0&&N<h&&I>=0&&I<h&&f.grid[N][I]!==l.WALL){i.y=N,i.x=I,w=!0;break}}if(!w){const g=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[v,N]of g){const I=i.y+v,z=i.x+N;if(I>=0&&I<h&&z>=0&&z<h&&f.grid[I][z]!==l.WALL){i.y=I,i.x=z;break}}}}else if(b==="rush"){const S=Math.abs(O)>=Math.abs(T)?[[O>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[O>0?1:-1,0]];for(const[D,R]of S){const A=i.y+D,o=i.x+R;if(A>=0&&A<h&&o>=0&&o<h&&f.grid[A][o]!==l.WALL){i.y=A,i.x=o,w=!0;break}}if(!w){const D=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[R,A]of D){const o=i.y+R,g=i.x+A;if(o>=0&&o<h&&g>=0&&g<h&&f.grid[o][g]!==l.WALL){i.y=o,i.x=g;break}}}}else if(b==="scatter"){const S=Math.abs(O)>=Math.abs(T)?[[O>0?-1:1,0],[0,T>0?-1:1]]:[[0,T>0?-1:1],[O>0?-1:1,0]];for(const[D,R]of S){const A=i.y+D,o=i.x+R;if(A>=0&&A<h&&o>=0&&o<h&&f.grid[A][o]!==l.WALL){i.y=A,i.x=o,w=!0;break}}if(!w){const D=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[R,A]of D){const o=i.y+R,g=i.x+A;if(o>=0&&o<h&&g>=0&&g<h&&f.grid[o][g]!==l.WALL){i.y=o,i.x=g;break}}}}else{const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[D,R]of S){const A=i.y+D,o=i.x+R;if(A>=0&&A<h&&o>=0&&o<h&&f.grid[A][o]!==l.WALL){i.y=A,i.x=o;break}}}if(i.y===f.player.y&&i.x===f.player.x)if(d.shield&&d.shieldTimer>0)i.stunTimer=1300,s("SHIELD HELD!","#00ffcc",38),U(f,f.player.x,f.player.y,"#00ffcc",14,3);else{const S=Math.round(22*y.dmgMul*(t==="A"?1.3:1));f.hp=Math.max(0,f.hp-S),f.shakeFrames=8,f.flashColor="#ff2200",f.flashAlpha=.35,U(f,f.player.x,f.player.y,"#ff4400",16,4),i.stunTimer=900,d.shieldCount=0,d.comboCount=0,s("HIT! -"+S,"#ff4400",40),m(f,"panic")}for(const S of f.captureZones)Math.abs(i.x-f.player.x)<=S.r&&Math.abs(i.y-f.player.y)<=S.r&&(f.hp=Math.max(0,f.hp-5),s("CAPTURED!","#ff0044",25))}f.captureZones=f.captureZones.filter(i=>(i.timer--,i.timer>0))}function ge(e,r){window._emotionalField&&window._emotionalField.addEmotion(r,.6),d.emotion=r,e.slowMoves=r==="hopeless"||r==="despair"}function ae(e,r,a,t){e&&(e.msg=r,e.msgColor=a,e.msgTimer=t)}function Ir(e,r,a){const t=ie[r];if(t){if(e.archetypeActive=!0,e.archetypeType=r,e.archetypeTimer=180,d.archetypePower=t.power,d.archetypeDuration=180,ae(e,t.activationMsg,"#ffdd00",70),Te(e,e.player.x,e.player.y,"#ffdd00"),U(e,e.player.x,e.player.y,"#ffdd00",24,4),r==="child"){for(let n=0;n<e.sz;n++)for(let s=0;s<e.sz;s++)e.grid[n][s]===l.HIDDEN&&e.tileFlicker.push({y:n,x:s,t:200,reveal:!0});ae(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}r==="protector"&&(d.shield=!0,d.shieldTimer=30,U(e,e.player.x,e.player.y,"#88ccff",20,5)),r==="orb"&&(d.phaseShift=!0,d.phaseTimer=15),r==="captor"&&(d.temporalRewind=!0,d.rewindBuffer=d.rewindBuffer.slice(-3))}}function Ge(e){const r=d.archetypePower;if(!r)return;const a=e.sz;if(r==="wall_jump")for(const[t,n]of[[-2,0],[2,0],[0,-2],[0,2]]){const s=e.player.y+t,m=e.player.x+n;if(s>=0&&s<a&&m>=0&&m<a&&e.grid[s][m]!==l.WALL){lr(e,"B"),e.player.y=s,e.player.x=m,U(e,m,s,"#ffaa00",16,3),ae(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(r==="phase_walk")d.phaseShift=!0,d.phaseTimer=10,ae(e,"ORB PHASE ACTIVE","#aaddff",35);else if(r==="rewind")if(d.rewindBuffer.length>0){const t=d.rewindBuffer.pop();if(e.player.y=t.y,e.player.x=t.x,t.grid)for(let n=0;n<a;n++)for(let s=0;s<a;s++)e.grid[n][s]=t.grid[n][s];U(e,e.player.x,e.player.y,"#ffaadd",20,3),ae(e,"TEMPORAL REWIND","#ffaadd",40)}else ae(e,"NO REWIND MEMORY","#443344",30);else if(r==="shield_burst"){d.shield=!0,d.shieldTimer=25;for(const t of e.enemies)t.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),U(e,e.player.x,e.player.y,"#88ccff",30,6),ae(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function Pr(e,r,a,t,n,s,m,f){const h=e.sz,y=e.player.y+r,E=e.player.x+a;if(y<0||y>=h||E<0||E>=h)return!1;const p=e.grid[y][E];if(p===l.WALL&&!(d.phaseShift&&d.phaseTimer>0)||p===l.HIDDEN&&t==="A"&&!d.phaseShift)return!1;if(d.temporalRewind&&d.rewindBuffer.length<8){const i=e.grid.map(b=>[...b]);d.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:i})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),lr(e,t),C.particles&&e.trail.push({x:e.player.x*(u+H)+u/2,y:e.player.y*(u+H)+u/2,life:14,maxLife:14,color:t==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=y,e.player.x=E,d.phaseShift&&d.phaseTimer>0&&(d.phaseTimer--,d.phaseTimer<=0&&(d.phaseShift=!1,s("PHASE FADED","#445566",25))),d.shield&&d.shieldTimer>0&&(d.shieldTimer--,d.shieldTimer<=0&&(d.shield=!1,s("SHIELD FADED","#445566",25))),t==="A"?d.energy=Math.max(0,d.energy-.9):d.energy=Math.min(d.energyMax,d.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,d.archetypePower=null));const Y={dmgMul:C.difficulty==="hard"?1.45:C.difficulty==="easy"?.55:1};if(p===l.PEACE){const i=Math.round((150+e.level*20)*d.resonanceMultiplier);e.score+=i,e.hp=Math.min(d.maxHp,e.hp+Math.round(20*(e.healMul??1))),e.grid[y][E]=l.VOID,e.peaceLeft--,U(e,E,y,d.particleColor,18,3.5),d.shieldCount++,d.comboCount++,d.resonanceMultiplier=Math.min(4,1+d.comboCount*.25),d.glitchPulseCharge=Math.min(100,d.glitchPulseCharge+15),d.comboCount>=3&&!d.shield?(d.shield=!0,d.shieldTimer=20,Te(e,E,y,"#00ffcc"),U(e,E,y,"#00ffcc",26,5),s("SHIELD ACTIVE! ×"+d.resonanceMultiplier.toFixed(1),"#00ffcc",55)):s("+PEACE +"+i+(d.comboCount>1?" ×"+d.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),ge(e,"peace"),e.peaceLeft===0&&n()}else if(p===l.INSIGHT){const i=Math.round((300+e.level*50)*d.resonanceMultiplier*(e.insightMul??1));e.score+=i,f(m+1),e.grid[y][E]=l.VOID,e.insightLeft--,U(e,E,y,"#00eeff",24,4),Te(e,E,y,"#00eeff"),s("INSIGHT ◆×"+(m+1),"#00eeff",60);for(let b=0;b<h;b++)for(let T=0;T<h;T++)e.grid[b][T]===l.HIDDEN&&e.tileFlicker.push({y:b,x:T,t:100,reveal:!0});ge(e,"clarity")}else if(p===l.ARCHETYPE)e.grid[y][E]=l.VOID,Ir(e,e.ds.archetype||"orb");else if(p===l.TELEPORT){let i=0,b=P(h),T=P(h);for(;(e.grid[b][T]!==l.VOID||b===y&&T===E)&&i<200;)b=P(h),T=P(h),i++;e.player.y=b,e.player.x=T,e.grid[y][E]=l.VOID,U(e,T,b,"#00aaff",16,3),s("LEAP!","#00aaff",30)}else if(p===l.COVER){s("COVER","#446688",20);for(const i of e.enemies)Math.abs(i.y-y)+Math.abs(i.x-E)<=2&&(i.stunTimer=600)}else if(p===l.MEMORY)e.grid[y][E]=l.VOID,e.score+=50,s("MEMORY ECHO…","#88bbaa",30),U(e,E,y,"#88bbaa",10,2);else if(ee[p]&&ee[p].dmg>0)if(d.shield&&d.shieldTimer>0)s("SHIELDED","#00ffcc",20);else{const i=ee[p];let b=Math.round(i.dmg*Y.dmgMul*(t==="A"?1.25:1)*(e.dmgMul??1));if(p===l.RAGE&&i.push>0){const w=y+r*i.push,S=E+a*i.push;w>=0&&w<h&&S>=0&&S<h&&e.grid[w][S]!==l.WALL&&(e.player.y=w,e.player.x=S,s("-RAGE (pushed!)","#ff0066",40))}if(p===l.SELF_HARM&&(e.grid[y][E]=l.PAIN),p===l.HOPELESS&&ge(e,"hopeless"),p===l.DESPAIR&&Math.random()<.3){const w=[[1,0],[-1,0],[0,1],[0,-1]],[S,D]=fe(w),R=y+S,A=E+D;R>=0&&R<h&&A>=0&&A<h&&e.grid[R][A]===l.VOID&&(e.grid[R][A]=l.DESPAIR)}e.hp=Math.max(0,e.hp-b),e.shakeFrames=5;const T={[l.DESPAIR]:"#2244ff",[l.TERROR]:"#ff0000",[l.SELF_HARM]:"#660000",[l.RAGE]:"#ff0044",[l.HOPELESS]:"#004488",[l.GLITCH]:"#aa00ff",[l.TRAP]:"#ff8800",[l.PAIN]:"#440000"},O={[l.DESPAIR]:"#3355ff",[l.TERROR]:"#ff2222",[l.SELF_HARM]:"#880000",[l.RAGE]:"#ff0044",[l.HOPELESS]:"#004488",[l.GLITCH]:"#aa00ff",[l.TRAP]:"#ff8800",[l.PAIN]:"#440000"},L={[l.DESPAIR]:"-DESPAIR",[l.TERROR]:"-TERROR!",[l.SELF_HARM]:"-SELF·HARM",[l.RAGE]:"-RAGE",[l.HOPELESS]:"-HOPELESS",[l.GLITCH]:"-GLITCH",[l.TRAP]:"-TRAP",[l.PAIN]:"-PAIN"};e.flashColor=T[p]||"#ff0000",e.flashAlpha=.28,U(e,E,y,O[p]||"#ff2222",10,3),s((L[p]||"-HAZARD")+" -"+b,O[p]||"#ff3333",38),d.shieldCount=0,d.comboCount=0,d.resonanceMultiplier=1}return!0}function Dr(e,r){if(!e||d.glitchPulseCharge<100)return;d.glitchPulseCharge=0;let a=0;for(let t=0;t<e.sz;t++)for(let n=0;n<e.sz;n++)Math.abs(t-e.player.y)+Math.abs(n-e.player.x)<=3&&ee[e.grid[t][n]]?.dmg>0&&(e.grid[t][n]=l.VOID,a++);for(const t of e.enemies)Math.abs(t.y-e.player.y)+Math.abs(t.x-e.player.x)<=4&&(t.stunTimer=1800);Te(e,e.player.x,e.player.y,"#aa00ff"),U(e,e.player.x,e.player.y,"#aa00ff",32,6),r("GLITCH PULSE! "+a+" CLEARED","#aa00ff",55)}function vr(e,r){if(e.spreadTimer-=r,e.spreadTimer>0)return;e.spreadTimer=3e3+P(1e3);const a=e.sz,t=[];for(let n=0;n<a;n++)for(let s=0;s<a;s++){const m=e.grid[n][s];if((m===l.DESPAIR||m===l.HOPELESS)&&ee[m].spread)for(const[f,h]of[[1,0],[-1,0],[0,1],[0,-1]]){const y=n+f,E=s+h;y>=0&&y<a&&E>=0&&E<a&&e.grid[y][E]===l.VOID&&Math.random()<.2&&t.push({y,x:E,type:m})}}for(const n of t.slice(0,2))e.grid[n.y][n.x]=n.type}function Lr(e){return e==="A"?fr:sr}function Nr(e,r,a,t,n,s,m,f,h,y,E){const p=a;if(!p)return;const Y=p.sz,i=Y*u+(Y-1)*H,b=i+48,T=i+148,O=Lr(t),L=p.ds;e.clearRect(0,0,b,T),e.fillStyle=L.bgColor,e.fillRect(0,0,b,T);const w=e.createRadialGradient(b*.7,T*.3,0,b*.7,T*.3,b*.8);w.addColorStop(0,L.bgAccent+"33"),w.addColorStop(1,"transparent"),e.fillStyle=w,e.fillRect(0,0,b,T),t==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,b,T));for(let o=0;o<T;o+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,o,b,1);for(const o of n){const g=o.a*(.5+.5*Math.sin(r*8e-4+o.phase));e.globalAlpha=g,e.fillStyle="#ffffff",e.beginPath(),e.arc(o.x,o.y,o.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,y>0&&(e.fillStyle=`rgba(${t==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*T),b,2+Math.floor(Math.random()*4)));let S=0,D=0;p.shakeFrames>0&&(S=(Math.random()-.5)*9*(p.shakeFrames/10),D=(Math.random()-.5)*9*(p.shakeFrames/10),p.shakeFrames--);const R=(b-i)/2+S,A=100+D;for(const o of s)o.x+=o.dx,o.y+=o.dy,o.life--,o.life>o.maxLife*.85?o.alpha=Math.min(o.targetAlpha,(o.maxLife-o.life)/(o.maxLife*.15)*o.targetAlpha):o.life<o.maxLife*.15&&(o.alpha=Math.max(0,o.life/(o.maxLife*.15)*o.targetAlpha)),o.life<=0&&(o.life=200+Math.floor(Math.random()*400),o.maxLife=600),e.globalAlpha=o.alpha*(t==="A"?.7:1),e.fillStyle=t==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(o.text,o.x,o.y);e.globalAlpha=1,e.textAlign="left";for(let o=0;o<Y;o++)for(let g=0;g<Y;g++){const v=p.grid[o][g],N=p.tileFlicker.find(_=>_.y===o&&_.x===g),I=N&&N.reveal&&v===l.HIDDEN?l.INSIGHT:v,z=ee[I]||ee[l.VOID],K=O[I]||O[l.VOID],G=R+g*(u+H),V=A+o*(u+H);if(f&&(o===h.row||g===h.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):K.glow?(e.shadowColor=K.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=K.bg,e.beginPath(),e.roundRect(G,V,u,u,4),e.fill(),e.strokeStyle=K.bd,e.lineWidth=1,e.beginPath(),e.roundRect(G+.5,V+.5,u-1,u-1,4),e.stroke(),e.shadowBlur=0,I===l.PEACE){const _=(r*.05+o*6+g*4)%(u*2);if(_<u){const J=e.createLinearGradient(G,V+_-5,G,V+_+5);J.addColorStop(0,"rgba(0,255,140,0)"),J.addColorStop(.5,"rgba(0,255,140,0.45)"),J.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=J,e.fillRect(G,V,u,u)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(G+u/2,V+u/2,5+2*Math.sin(r*.006+g+o),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(I===l.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const _=r*.008+g*1.7+o*1.3;for(let J=0;J<4;J++){const ne=_+J*Math.PI*.5,X=7+2*Math.sin(r*.005+J);e.fillStyle=J%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(G+u/2+Math.cos(ne)*X,V+u/2+Math.sin(ne)*X,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(I===l.ARCHETYPE){const _=.5+.5*Math.sin(r*.01+g+o);e.shadowColor="#ffdd00",e.shadowBlur=16*_,e.fillStyle=`rgba(255,220,0,${.15*_})`,e.fillRect(G,V,u,u),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",G+u/2,V+u/2+6),e.shadowBlur=0,e.textAlign="left"}if(I===l.TELEPORT){const _=.5+.5*Math.sin(r*.012+g*2+o);e.shadowColor="#00aaff",e.shadowBlur=12*_,e.fillStyle=`rgba(0,170,255,${.2*_})`,e.fillRect(G,V,u,u),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",G+u/2,V+u/2+5),e.shadowBlur=0,e.textAlign="left"}if(I===l.MEMORY){const _=.3+.3*Math.sin(r*.004+g+o);e.globalAlpha=.4+.2*_,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(G,V,u,u),e.globalAlpha=1}z.sym&&I!==l.VOID&&I!==l.WALL&&I!==l.PEACE&&I!==l.INSIGHT&&I!==l.ARCHETYPE&&I!==l.TELEPORT&&I!==l.HIDDEN&&I!==l.MEMORY&&(e.fillStyle=K.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(z.sym,G+u/2,V+u/2+5),e.globalAlpha=1,e.textAlign="left"),(I===l.PEACE||I===l.INSIGHT)&&d.magnet&&Math.abs(o-p.player.y)+Math.abs(g-p.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(G+2,V+2,u-4,u-4,4),e.stroke())}p.tileFlicker=p.tileFlicker.filter(o=>(o.t--,o.t>0));for(const o of p.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(o.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(R+o.x*(u+H)+u/2,A+o.y*(u+H)+u/2,(o.r+.5)*(u+H),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const o of p.echos)e.globalAlpha=o.life/o.maxLife*.55,e.fillStyle=o.color,e.beginPath(),e.arc(R+o.x,A+o.y,o.size*(o.life/o.maxLife),0,Math.PI*2),e.fill(),o.life--;if(p.echos=p.echos.filter(o=>o.life>0),e.globalAlpha=1,C.particles){for(const o of p.trail)e.globalAlpha=o.life/o.maxLife*.48,e.fillStyle=o.color,e.shadowColor=o.color,e.shadowBlur=4,e.beginPath(),e.arc(R+o.x,A+o.y,4*(o.life/o.maxLife),0,Math.PI*2),e.fill(),o.life--;p.trail=p.trail.filter(o=>o.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const o of m){if(o.life<=0)continue;const g=R+o.x*(u+H),v=A+o.y*(u+H),N=.3+.25*Math.sin(Date.now()*.006+o.x);e.globalAlpha=N,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(g+8,v+8,u-16,u-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",g+u/2,v+u/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const o of p.enemies){const g=R+o.x*(u+H),v=A+o.y*(u+H),N=.6+.4*Math.sin(r*.007+o.x*1.3),I=o.stunTimer>0,z=o.type==="rush",K=I?"#8888ff":z?"#ff0066":t==="A"?"#ff0044":"#ff4400";e.shadowColor=K,e.shadowBlur=14*N,e.fillStyle=I?"#1c1c44":z?"#4a0022":t==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(g+5,v+5,u-10,u-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=I?"#4444aa":z?"#ff0066":t==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(g+u/2,v+12),e.lineTo(g+u-12,v+u-12),e.lineTo(g+12,v+u-12),e.closePath(),e.fill(),e.fillStyle=I?"#6666cc":"#ffcc00",e.beginPath(),e.arc(g+u/2,v+u/2+2,4,0,Math.PI*2),e.fill()}if(p.boss&&p.boss.hp>0){const o=p.boss,g=R+o.x*(u+H),v=A+o.y*(u+H),N=.5+.5*Math.sin(r*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*N,e.fillStyle="#330022",e.beginPath(),e.roundRect(g+1,v+1,u-2,u-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(g+u/2,v+u/2,u*.3+4*N,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+o.hp,g+u/2,v+u/2+4),e.textAlign="left",e.shadowBlur=0}{const o=R+p.player.x*(u+H),g=A+p.player.y*(u+H),v=.55+.45*Math.sin(r*.009),N=d.shield&&d.shieldTimer>0,I=d.phaseShift&&d.phaseTimer>0,z=d.emotion,G=t==="A"?"#ff0088":N?"#00ffff":I?"#00aaff":z==="panic"?"#ff0022":z==="hopeless"?"#0033aa":z==="peace"?"#00ffcc":z==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=G,e.shadowBlur=(N?36:d.aura?30:22)*v;const V=t==="A"?"#aa0055":"#005533",_=t==="A"?"#cc0077":"#00cc77",J=t==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=V,e.beginPath(),e.roundRect(o+4,g+4,u-8,u-8,8),e.fill(),e.fillStyle=_,e.beginPath(),e.roundRect(o+9,g+9,u-18,u-18,5),e.fill(),e.fillStyle=J,e.beginPath(),e.roundRect(o+15,g+15,u-30,u-30,3),e.fill(),p.archetypeActive){const X=ie[p.archetypeType||"orb"];e.strokeStyle=X.glow,e.lineWidth=2,e.shadowColor=X.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(o+1,g+1,u-2,u-2,8),e.stroke()}N&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(o,g,u,u,8),e.stroke()),I&&(e.globalAlpha=.4),d.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*v})`,e.lineWidth=3,e.beginPath(),e.arc(o+u/2,g+u/2,(u/2+7)*v,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=G,e.lineWidth=2;const ne=9;[[o,g],[o+u,g],[o,g+u],[o+u,g+u]].forEach(([X,me],Oe)=>{const He=Oe%2===0?1:-1,Be=Oe<2?1:-1;e.beginPath(),e.moveTo(X+He*2,me),e.lineTo(X+He*(2+ne),me),e.stroke(),e.beginPath(),e.moveTo(X,me+Be*2),e.lineTo(X,me+Be*(2+ne)),e.stroke()}),e.shadowBlur=0}if(C.particles){a.particles=a.particles.filter(o=>o.life>0);for(const o of a.particles)e.globalAlpha=Math.max(0,o.life/o.maxLife),e.fillStyle=o.color,e.shadowColor=o.color,e.shadowBlur=7,e.beginPath(),e.arc(R+o.x,A+o.y,o.r*(o.life/o.maxLife),0,Math.PI*2),e.fill(),o.x+=o.vx,o.y+=o.vy,o.vy+=.25,o.life--;e.globalAlpha=1,e.shadowBlur=0}if(p.resonanceWave){const o=p.resonanceWave;o.r+=7,o.alpha=Math.max(0,o.alpha-.55/o.maxR*7),e.strokeStyle=o.color,e.globalAlpha=o.alpha,e.lineWidth=2,e.shadowColor=o.color,e.shadowBlur=10,e.beginPath(),e.arc(R+o.x,A+o.y,o.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,o.r>=o.maxR&&(p.resonanceWave=null)}if(p.flashAlpha>0&&(e.fillStyle=p.flashColor,e.globalAlpha=p.flashAlpha,e.fillRect(R,A,i,i),e.globalAlpha=1,p.flashAlpha=Math.max(0,p.flashAlpha-.04)),t==="A"){const o=e.createRadialGradient(b/2,T/2,T*.25,b/2,T/2,T*.9);o.addColorStop(0,"rgba(80,0,20,0)"),o.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=o,e.fillRect(0,0,b,T)}}function Or(e,r,a){for(const t of r)e.globalAlpha=t.a*(.5+.5*Math.sin(a*8e-4+t.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.x,t.y,t.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function Hr(e,r,a,t,n,s){e.fillStyle="#02020a",e.fillRect(0,0,r,a);for(let f=0;f<a;f+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,f,r,1);Or(e,t,n),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",r/2,a/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",r/2,a/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",r/2,a/2-78);const m=a/2-55;hr.forEach((f,h)=>{const y=h===s,E=m+h*36;y&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(r/2-130,E-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(r/2-130,E-19,260,28)),e.fillStyle=y?"#00ff88":"#2a3a2a",e.shadowColor=y?"#00ff88":"transparent",e.shadowBlur=y?8:0,e.font=y?"bold 14px Courier New":"12px Courier New",e.fillText(f,r/2,E),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select",r/2,a-20),e.textAlign="left"}function Br(e,r,a,t){e.fillStyle="#02020a",e.fillRect(0,0,r,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",r/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",r/2,68);const n=Math.min(W.length,6),s=Math.max(0,Math.min(t-Math.floor(n/2),W.length-n));for(let m=0;m<n;m++){const f=s+m,h=W[f],y=f===t,E=95+m*55;if(y&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(r/2-160,E-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(r/2-160,E-18,320,46)),e.fillStyle=y?"#00ff88":"#2a3a2a",e.font=y?"bold 12px Courier New":"11px Courier New",e.fillText(f+1+".  "+h.name,r/2,E),e.fillStyle=y?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(h.subtitle+"  ·  "+h.emotion,r/2,E+16),y&&h.archetype&&ie[h.archetype]){const p=ie[h.archetype];e.fillStyle="#665522",e.fillText("archetype: "+p.name+" — "+p.powerDesc,r/2,E+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",r/2,a-20),e.textAlign="left"}function kr(e,r,a,t){e.fillStyle="#02020a",e.fillRect(0,0,r,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",r/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:pr,cur:C.gridSize},{label:"DIFFICULTY",opts:mr,cur:C.difficulty},{label:"PARTICLES",opts:["on","off"],cur:C.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((s,m)=>{const f=m===t,h=105+m*68;s.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(s.label,r/2,h)),s.opts.forEach((y,E)=>{const p=y===s.cur,Y=r/2+(E-(s.opts.length-1)/2)*110,i=h+24;e.fillStyle=f&&p?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(Y-44,i-16,88,24),e.strokeStyle=f&&p?"rgba(0,255,136,0.5)":p?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(Y-44,i-16,88,24),e.fillStyle=p?"#00ff88":"#334455",e.shadowColor=p?"#00ff88":"transparent",e.shadowBlur=p?5:0,e.font=p?"bold 11px Courier New":"10px Courier New",e.fillText(y.toUpperCase(),Y,i),e.shadowBlur=0}),f&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",r/2-154,h+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",r/2,a-20),e.textAlign="left"}function _r(e,r,a,t){e.fillStyle="#02020a",e.fillRect(0,0,r,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",r/2,50),e.shadowBlur=0,t.length?t.slice(0,8).forEach((n,s)=>{const m=95+s*38,f=s===0?"◈":s===1?"◇":"·";e.fillStyle=s===0?"#ffdd00":s===1?"#aaaaaa":s===2?"#cc8833":"#334455",e.font=s<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${f}  ${String(n.score).padStart(7,"0")}   LVL${String(n.level).padStart(2,"0")}   ${n.dreamscape}   ${n.date}`,r/2,m)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",r/2,a/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",r/2,a-20),e.textAlign="left"}function Gr(e,r,a,t,n,s){e.fillStyle="#02020a",e.fillRect(0,0,r,a),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",r/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+n,r/2,68),le.forEach((m,f)=>{const h=f===t,y=s(m.id),E=n>=m.cost&&!y,p=92+f*48;h&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(r/2-155,p-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(r/2-155,p-14,310,40)),e.fillStyle=y?"#00ff88":E?"#00ccdd":"#334455",e.shadowColor=y?"#00ff88":h?"#00ccdd":"transparent",e.shadowBlur=h&&!y?5:0,e.font="bold 11px Courier New",e.fillText(m.name,r/2-55,p),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(m.desc,r/2-55,p+14),e.fillStyle=y?"#005533":E?"#006677":"#221122",e.font="10px Courier New",e.fillText(y?"OWNED":"◆×"+m.cost,r/2+88,p+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",r/2,a-20),e.textAlign="left"}function Fr(e,r,a,t,n){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,r,a),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",r/2,a/2-80),e.shadowBlur=0,t&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(t.ds.name+"  ·  LEVEL "+t.level,r/2,a/2-58),e.fillStyle="#334455",e.fillText(t.ds.narrative,r/2,a/2-44)),ur.forEach((s,m)=>{const f=m===n,h=a/2-14+m*36;f&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(r/2-110,h-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(r/2-110,h-18,220,26)),e.fillStyle=f?"#00ff88":"#334433",e.shadowColor=f?"#00ff88":"transparent",e.shadowBlur=f?6:0,e.font=f?"bold 13px Courier New":"12px Courier New",e.fillText(s,r/2,h),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",r/2,a-20),e.textAlign="left"}function Ur(e,r,a,t,n){const s=1-t.timer/220,m=s<.1?s/.1:s>.9?(1-s)/.1:1,f=t.ds||W[0];e.fillStyle=f.bgColor||"#02020a",e.fillRect(0,0,r,a);for(let h=0;h<7;h++){const y=(n*.02+h*r/7)%r;e.strokeStyle=`rgba(0,255,136,${.02*m})`,e.lineWidth=1,e.beginPath(),e.moveTo(y,0),e.lineTo(y-100,a),e.stroke()}if(e.globalAlpha=m,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(t.text,r/2,a/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+f.name,r/2,a/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(f.narrative,r/2,a/2+24),f.archetype&&ie[f.archetype]){const h=ie[f.archetype];e.fillStyle=h.glow,e.shadowColor=h.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+h.name,r/2,a/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function zr(e,r,a,t,n,s,m,f){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,r,a),e.textAlign="center";const h=t?.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+(h?.name||"THE VOID"),r/2,a/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",r/2,a/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(t.score).padStart(7,"0"),r/2,a/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+t.level,r/2,a/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+s.length+"/"+W.length,r/2,a/2+14),e.fillText("REP "+(f>=0?"+":"")+f+"  ·  ◆×"+m,r/2,a/2+32),n.length>0){const E=n.findIndex(p=>p.score===t.score);E>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(E+1)+" ALL TIME",r/2,a/2+54))}const y=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*y})`,e.fillRect(r/2-110,a/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*y})`,e.strokeRect(r/2-110,a/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",r/2,a/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",r/2,a/2+120),e.textAlign="left"}const Fe=[{id:"joy",display:"Joy",valence:1,arousal:.7,coherence:.9},{id:"hope",display:"Hope",valence:.8,arousal:.5,coherence:.8},{id:"trust",display:"Trust",valence:.7,arousal:.4,coherence:.85},{id:"surprise",display:"Surprise",valence:.2,arousal:1,coherence:.5},{id:"fear",display:"Fear",valence:-.7,arousal:.9,coherence:.2},{id:"sadness",display:"Sadness",valence:-1,arousal:.3,coherence:.3},{id:"disgust",display:"Disgust",valence:-.8,arousal:.6,coherence:.1},{id:"anger",display:"Anger",valence:-.9,arousal:.8,coherence:.15},{id:"shame",display:"Shame",valence:-.95,arousal:.5,coherence:.05},{id:"anticipation",display:"Anticipation",valence:.3,arousal:.8,coherence:.6}],Vr=[{id:"FOCUSED_FORCE",label:"Focused Force",test:e=>e.coherence>.8&&e.valence>.5},{id:"CHAOS_BURST",label:"Chaos Burst",test:e=>e.distortion>.7&&e.coherence<.3},{id:"DEEP_INSIGHT",label:"Deep Insight",test:e=>e.coherence>.9&&e.valence>.7},{id:"NUMBNESS",label:"Numbness",test:e=>e.valence<-.7&&e.coherence<.2},{id:"SERENITY",label:"Serenity",test:e=>e.valence>.8&&e.coherence>.8},{id:"TURBULENCE",label:"Turbulence",test:e=>e.distortion>.5&&e.valence<0},{id:"EQUILIBRIUM",label:"Equilibrium",test:e=>Math.abs(e.valence)<.1&&e.coherence>.7}],Ue=[{id:"MIND",label:"Mind",test:e=>e.purgDepth<.2},{id:"PURGATORY",label:"Purgatory",test:e=>e.purgDepth>=.2&&e.purgDepth<.5},{id:"IMAGINATION",label:"Imagination",test:e=>e.purgDepth>=.5&&e.purgDepth<.7},{id:"HEAVEN",label:"Heaven",test:e=>e.purgDepth>=.7&&e.valence>.5},{id:"HELL",label:"Hell",test:e=>e.purgDepth>=.7&&e.valence<=.5}];class or{constructor(r={}){this.emotions={},Fe.forEach(a=>{this.emotions[a.id]=typeof r[a.id]=="number"?r[a.id]:0}),this.lastUpdate=Date.now(),this.weekdayCoherenceMul=1}getEmotionArray(){return Fe.map(r=>({...r,value:this.emotions[r.id]}))}getDominantEmotion(){return this.getEmotionArray().reduce((t,n)=>t.value>n.value?t:n)}get valence(){let r=this.getEmotionArray(),a=r.reduce((n,s)=>n+s.value*s.valence,0),t=r.reduce((n,s)=>n+s.value,0)||1;return a/t}get coherence(){let r=this.getEmotionArray(),a=r.reduce((n,s)=>n+s.value*s.coherence,0),t=r.reduce((n,s)=>n+s.value,0)||1;return a/t}get distortion(){let r=this.getEmotionArray();return r.reduce((t,n)=>t+n.value*n.arousal*(1-n.coherence),0)/r.length}get purgDepth(){return Math.max(0,Math.min(1,this.distortion))}get synergy(){for(let r of Vr)if(r.test(this))return r;return null}get realm(){for(let r of Ue)if(r.test(this))return r;return Ue[0]}decay(r=null){let a=Date.now(),t=r||(a-this.lastUpdate)/1e3;this.lastUpdate=a;let n=.05*this.weekdayCoherenceMul;for(let s in this.emotions)this.emotions[s]>0?this.emotions[s]=Math.max(0,this.emotions[s]-n*t):this.emotions[s]<0&&(this.emotions[s]=Math.min(0,this.emotions[s]+n*t))}setEmotion(r,a){this.emotions.hasOwnProperty(r)&&(this.emotions[r]=Math.max(-1,Math.min(1,a)))}addEmotion(r,a){this.emotions.hasOwnProperty(r)&&this.setEmotion(r,this.emotions[r]+a)}setAll(r){for(let a in r)this.setEmotion(a,r[a])}toJSON(){return{...this.emotions}}fromJSON(r){for(let a in r)this.setEmotion(a,r[a])}}const Wr=new Date("2025-01-29").getTime(),ye=29.53*24*60*60*1e3,ze=[{name:"New Moon",fraction:0,insightMul:1,enemyMul:.85,desc:"Seed — quiet spawns, tutorial-friendly"},{name:"Waxing Crescent",fraction:.13,insightMul:1.1,enemyMul:.9,desc:"Build — gentle challenge increase"},{name:"First Quarter",fraction:.25,insightMul:1.2,enemyMul:1,desc:"Momentum — balanced tension"},{name:"Waxing Gibbous",fraction:.38,insightMul:1.3,enemyMul:1.1,desc:"Amplify — insight tokens more common"},{name:"Full Moon",fraction:.5,insightMul:1.5,enemyMul:1.2,desc:"Illuminate — peak clarity and challenge"},{name:"Waning Gibbous",fraction:.63,insightMul:1.2,enemyMul:1.1,desc:"Release — pruning, closure rewards"},{name:"Last Quarter",fraction:.75,insightMul:1.1,enemyMul:1,desc:"Reflect — integration, story fragments"},{name:"Waning Crescent",fraction:.88,insightMul:1,enemyMul:.9,desc:"Rest — soft spawns, dreamscape teasers"}],Yr=[{planet:"Sun",coherenceMul:1.2,insightMul:1.1,themes:["Radiance","Will","Clarity"],desc:"Visibility bonuses, coherence stabilisation"},{planet:"Moon",coherenceMul:1.1,insightMul:1.05,themes:["Dream","Tide","Reflection"],desc:"Dreamscape bias, softer soundscape"},{planet:"Mars",coherenceMul:.85,insightMul:1.2,themes:["Trial","Courage","Initiation"],desc:"Enemies more aggressive, higher rewards"},{planet:"Mercury",coherenceMul:1.05,insightMul:1.35,themes:["Signal","Learning","Pathfinding"],desc:"Insight tokens more common, puzzles"},{planet:"Jupiter",coherenceMul:1.15,insightMul:1.25,themes:["Expansion","Wisdom","Fortune"],desc:"Map grows, upgrade shop richer"},{planet:"Venus",coherenceMul:1.25,insightMul:1.15,themes:["Harmony","Beauty","Love"],desc:"Healing nodes, softer hazards"},{planet:"Saturn",coherenceMul:.9,insightMul:1,themes:["Structure","Limits","Discipline"],desc:"Walls and boundaries, planning bonuses"}];function Zr(){return((Date.now()-Wr)%ye+ye)%ye/ye}function Ve(){const e=Zr();let r=ze[0];for(const a of ze)e>=a.fraction&&(r=a);return r}function We(){const e=new Date().getDay();return Yr[e]}class qr{constructor(){this._lunar=Ve(),this._planet=We(),this._lastRefresh=0}refresh(){this._lunar=Ve(),this._planet=We(),this._lastRefresh=Date.now()}getLunarPhase(){return this._lunar}getPlanetaryDay(){return this._planet}getEnemyMul(){const r=this._lunar.enemyMul,a=this._planet.planet==="Mars"?.1:0;return r+a}getInsightMul(){return this._lunar.insightMul*(this._planet.insightMul??1)}getCoherenceMul(){return this._planet.coherenceMul??1}getModifiers(){return{enemyMul:this.getEnemyMul(),insightMul:this.getInsightMul(),coherenceMul:this.getCoherenceMul(),lunarName:this._lunar.name,planetName:this._planet.planet,lunarDesc:this._lunar.desc,planetDesc:this._planet.desc,themes:this._planet.themes}}}const Le=new qr,oe=document.getElementById("c"),j=oe.getContext("2d"),ce=Math.min(window.devicePixelRatio||1,2);function Ne(){const e=he(),r=ue();oe.width=e*ce,oe.height=r*ce,oe.style.width=Math.min(e,window.innerWidth-16)+"px",oe.style.height="auto",j.setTransform(1,0,0,1,0,0),j.scale(ce,ce)}Ne();let c=null,q=null,Ye=0,Pe=0;window._insightTokens=Z;window._dreamIdx=C.dreamIdx;window._temporalSystem=Le;let Ze=0,Ee=500,Ae=!1,be={row:-1,col:-1,t:0},De=[],Me=[],ve=[],Se={text:"",timer:0,ds:null},pe=new or;window._emotionalField=pe;const x=new Set;function tr(e,r){Me=[];for(let a=0;a<30;a++)Me.push({x:Math.random()*e,y:Math.random()*r,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}function Jr(e,r){ve=[];for(let a=0;a<5;a++)ve.push({text:fe(dr),x:40+Math.random()*(e-80),y:90+Math.random()*(r-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+P(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}function F(e,r,a){c&&(c.msg=e,c.msgColor=r,c.msgTimer=a)}function $r(e,r,a){const t=rr();t.push({score:e,level:r,dreamscape:a?.name||"?",date:new Date().toLocaleDateString()}),t.sort((s,m)=>m.score-s.score);const n=t.slice(0,8);Ke(n),Tr(n)}function jr(e){const r=e.ds.environmentEvent,a=e.sz;if(r){if(r==="gravity_shift"){const[t,n]=fe([[-1,0],[1,0],[0,-1],[0,1]]),s=e.player.y+t,m=e.player.x+n;s>=0&&s<a&&m>=0&&m<a&&e.grid[s][m]!==5&&(e.player.y=s,e.player.x=m,F("GRAVITY SHIFTS…","#8888ff",40))}else if(r==="loop_reset"){for(let t=-2;t<=2;t++)for(let n=-2;n<=2;n++){const s=e.player.y+t,m=e.player.x+n;s>=0&&s<a&&m>=0&&m<a&&e.grid[s][m]===0&&Math.random()<.25&&(e.grid[s][m]=8)}F("THE LOOP TIGHTENS…","#ff8800",40)}else if(r==="capture_zones"){const t=fe(e.enemies);t&&(e.captureZones=[{x:t.x,y:t.y,r:2,timer:300}]),F("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(r==="rapid_spawn"){if(e.enemies.length<10){const t=2+P(a-4),n=2+P(a-4);e.enemies.push({y:t,x:n,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:t,prevX:n,momentum:[0,0],type:"rush"}),F("CHAOS ERUPTS!","#ff0044",40)}}else if(r==="wall_phase"){let t=0;for(let n=0;n<a&&t<4;n++)for(let s=0;s<a&&t<4;s++)e.grid[n][s]===5&&Math.random()<.3&&(e.grid[n][s]=10,t++);F("MEMBRANE DISSOLVES…","#00ccff",40)}else if(r==="glide_nodes"){let t=0,n=0;for(;t<2&&n<999;){n++;const s=P(a),m=P(a);e.grid[s][m]===0&&(e.grid[s][m]=12,t++)}F("GLIDE NODES APPEAR","#00aaff",40)}else if(r==="mashup"){const t=fe(W.filter(n=>n.id!==e.ds.id));if(t.hazardSet[0]){let n=0,s=0;for(;n<3&&s<999;){s++;const m=P(a),f=P(a);e.grid[m][f]===0&&(e.grid[m][f]=t.hazardSet[0],n++)}}F("DREAMSCAPES MERGE…","#ffaaff",40)}if(Math.random()<.4){const t=P(a);for(let n=0;n<a;n++)e.grid[t][n]===1?e.grid[t][n]=4:e.grid[t][n]===4&&Math.random()<.3&&(e.grid[t][n]=1);be={row:t,col:-1,t:50},Ae=!0}}}function ir(e,r,a,t){const n=(a||0)+1;Ne();const s=W[e%W.length];je(s.matrixDefault);const m=Rr(s,Ie(),n,r,t,d.maxHp,we);return Jr(he(),ue()),De=[],Ee=500+P(500),tr(he(),ue()),m}function te(e){Ar(),Er(),pe=new or,window._emotionalField=pe,Le.refresh(),C.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=C.dreamIdx,c=ir(C.dreamIdx,0,0,void 0),k("playing"),Pe=0,Xe(0),cancelAnimationFrame(q),q=requestAnimationFrame($)}function Xr(){const e=c,r=(C.dreamIdx+1)%W.length;C.dreamIdx=r,window._dreamIdx=r,gr(e.ds.id),Se={text:e.ds.completionText,subtext:W[r].narrative,timer:220,ds:W[r]},k("interlude"),setTimeout(()=>{Ne(),c=ir(r,e.score+400+e.level*60,e.level,e.hp),c.msg=W[r].name,c.msgColor="#ffdd00",c.msgTimer=90,B==="interlude"&&k("playing")},3600)}function Qr(e){const r=le.find(a=>a.id===e);!r||Z<r.cost||xe(e)||(Qe(r.cost),window._insightTokens=Z,e==="maxhp"&&(d.maxHp+=25,c&&(c.hp=Math.min(c.hp+25,d.maxHp))),e==="speed"&&(d.moveDelay=Math.max(55,d.moveDelay-15)),e==="magnet"&&(d.magnet=!0),e==="freeze"&&(d.freeze=!0),e==="aura"&&(d.aura=!0),e==="energy"&&(d.energyMax=Math.min(200,d.energyMax+30)),e==="rewind"&&(d.temporalRewind=!0),e==="pulse"&&(d.glitchPulse=!0))}function $(e){const r=e-Ye;Ye=e;const a=he(),t=ue();if(B==="title"){Hr(j,a,t,Me,e,M.menu),q=requestAnimationFrame($);return}if(B==="dreamselect"){Br(j,a,t,C.dreamIdx),q=requestAnimationFrame($);return}if(B==="options"){kr(j,a,t,M.opt),q=requestAnimationFrame($);return}if(B==="highscores"){_r(j,a,t,Ce),q=requestAnimationFrame($);return}if(B==="upgrade"){Gr(j,a,t,M.shop,Z,xe),q=requestAnimationFrame($);return}if(B==="dead"){zr(j,a,t,c,Ce,we,Z,$e),q=requestAnimationFrame($);return}if(B==="paused"){Fr(j,a,t,c,M.pause),q=requestAnimationFrame($);return}if(B==="interlude"){Ur(j,a,t,Se,e),Se.timer--,Se.timer<=0&&B==="interlude"&&k("playing"),q=requestAnimationFrame($);return}const n=c.slowMoves?d.moveDelay*1.5:d.moveDelay,s={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};if(e-Pe>n){for(const[h,[y,E]]of Object.entries(s))if(x.has(h)){Pr(c,y,E,Q,Xr,F,Z,p=>{for(;Z<p;)cr();window._insightTokens=Z}),Pe=e;break}}const m=Le.getModifiers(),f=(Q==="B"?1.2:.7)*m.coherenceMul;if(pe.decay(r/1e3*f),window._tmods=m,d.emotion=pe.getDominantEmotion().id,c.slowMoves=d.emotion==="hopeless"||d.emotion==="despair",c&&(c.temporalEnemyMul=m.enemyMul,c.insightMul=m.insightMul),window._emotionalField){const h=window._emotionalField.getDistortion?.()??.45,E=(1-(window._emotionalField.getValence?.()??0))/2;let p=h*.7+E*.3;Q==="A"?p=Math.min(1,p*1.2):p=p*.85,br(Math.max(0,Math.min(1,p))),window._purgDepth=re}if(c&&(c.purgDepth=re,c.dmgMul=re>=.8?1.3:re>=.5?1.15:1,c.healMul=re<=.2?1.25:re<=.35?1.1:1),yr(r),Q==="B"&&de>4e3&&Math.random()<2e-4*r&&(c.hp=Math.min(d.maxHp,c.hp+1)),Q==="A"&&de>2500&&Math.random()<3e-4*r&&(c.hp=Math.max(0,c.hp-1)),Ee-=r,Ee<=0&&(Ze=2+P(4),Ee=500+P(700)),Ae&&(be.t--,be.t<=0&&(Ae=!1)),c.environmentTimer-=r,c.environmentTimer<=0&&(c.environmentTimer=900+P(700),Math.random()<.6&&jr(c)),vr(c,r),Cr(c,r,x,Q,De,F,ge),c.hp<=0){$r(c.score,c.level,c.ds),k("dead"),q=requestAnimationFrame($);return}Nr(j,e,c,Q,Me,ve,De,Ae,be,Ze),q=requestAnimationFrame($)}window.addEventListener("keydown",e=>{if(x.add(e.key),B==="title"){e.key==="ArrowUp"&&(M.menu=(M.menu-1+5)%5),e.key==="ArrowDown"&&(M.menu=(M.menu+1)%5),(e.key==="Enter"||e.key===" ")&&(M.menu===0?te(C.dreamIdx):M.menu===1?k("dreamselect"):M.menu===2?(M.opt=0,k("options")):M.menu===3?k("highscores"):M.menu===4&&(M.shop=0,M.upgradeFrom="title",k("upgrade"))),e.preventDefault();return}if(B==="dreamselect"){e.key==="ArrowUp"&&(C.dreamIdx=(C.dreamIdx-1+W.length)%W.length),e.key==="ArrowDown"&&(C.dreamIdx=(C.dreamIdx+1)%W.length),e.key==="Enter"&&te(C.dreamIdx),e.key==="Escape"&&k("title"),e.preventDefault();return}if(B==="options"){if(e.key==="ArrowUp"&&(M.opt=(M.opt-1+4)%4),e.key==="ArrowDown"&&(M.opt=(M.opt+1)%4),e.key==="ArrowLeft"||e.key==="ArrowRight"){const a=e.key==="ArrowLeft"?-1:1;if(M.opt===0){const t=["small","medium","large"].indexOf(C.gridSize);C.gridSize=["small","medium","large"][(t+a+3)%3]}else if(M.opt===1){const t=["easy","normal","hard"].indexOf(C.difficulty);C.difficulty=["easy","normal","hard"][(t+a+3)%3]}else M.opt===2&&(C.particles=!C.particles)}(e.key==="Enter"||e.key==="Escape")&&(M.opt===3||e.key==="Escape")&&k(c?"paused":"title"),e.preventDefault();return}if(B==="highscores"){(e.key==="Enter"||e.key==="Escape")&&k("title"),e.preventDefault();return}if(B==="upgrade"){e.key==="ArrowUp"&&(M.shop=(M.shop-1+le.length)%le.length),e.key==="ArrowDown"&&(M.shop=(M.shop+1)%le.length),e.key==="Enter"&&Qr(le[M.shop].id),e.key==="Escape"&&k(M.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(B==="dead"){(e.key==="Enter"||e.key===" ")&&te(C.dreamIdx),e.key==="Escape"&&(k("title"),M.menu=0),e.preventDefault();return}if(B==="paused"){e.key==="ArrowUp"&&(M.pause=(M.pause-1+4)%4),e.key==="ArrowDown"&&(M.pause=(M.pause+1)%4),e.key==="Enter"&&(M.pause===0?k("playing"):M.pause===1?(M.opt=0,k("options")):M.pause===2?(M.shop=0,M.upgradeFrom="paused",k("upgrade")):(k("title"),M.menu=0,c=null)),e.key==="Escape"&&k("playing"),e.preventDefault();return}if(B==="playing"){if(e.key==="Escape"&&(M.pause=0,k("paused")),e.key==="Shift"&&!e.repeat){const a=Q==="A"?"B":"A";je(a),Xe(0);const t=a==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",n=a==="A"?"#ff0055":"#00ff88";F(t,n,55),C.particles&&U(c,c.player.x,c.player.y,n,22,4)}(e.key==="j"||e.key==="J")&&!e.repeat&&(c.archetypeActive||d.temporalRewind&&d.rewindBuffer.length>0?Ge(c):F("NO ARCHETYPE ACTIVE","#334455",25)),(e.key==="r"||e.key==="R")&&!e.repeat&&(d.glitchPulse&&d.glitchPulseCharge>=100?Dr(c,F):d.glitchPulse?F("CHARGING… "+Math.round(d.glitchPulseCharge)+"%","#660088",22):F("BUY GLITCH PULSE IN UPGRADES","#334455",28)),(e.key==="q"||e.key==="Q")&&!e.repeat&&d.freeze&&d.freezeTimer<=0&&(d.freezeTimer=2500,F("FREEZE ACTIVE!","#0088ff",50),U(c,c.player.x,c.player.y,"#0088ff",20,4)),(e.key==="c"||e.key==="C")&&!e.repeat&&(Z>=2?(Qe(2),window._insightTokens=Z,c.contZones||(c.contZones=[]),c.contZones.push({x:c.player.x,y:c.player.y,timer:240,maxTimer:240}),F("CONTAINMENT ZONE","#00ffcc",38)):F("NEED 2 ◆ FOR CONTAINMENT","#334455",28))}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>x.delete(e.key));function Re(e,r){const a=document.getElementById(e);if(!a)return;let t;a.addEventListener("touchstart",n=>{n.preventDefault(),x.add(r),B==="title"&&te(C.dreamIdx),t=()=>x.delete(r)},{passive:!1}),a.addEventListener("touchend",n=>{n.preventDefault(),t&&t()},{passive:!1}),a.addEventListener("mousedown",()=>{x.add(r),B==="title"&&te(C.dreamIdx)}),a.addEventListener("mouseup",()=>x.delete(r))}Re("btn-up","ArrowUp");Re("btn-down","ArrowDown");Re("btn-left","ArrowLeft");Re("btn-right","ArrowRight");oe.addEventListener("click",()=>{B==="title"&&te(C.dreamIdx)});Ke(rr());tr(he(),ue());q=requestAnimationFrame($);
