(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();const s={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},ie={[s.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[s.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[s.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[s.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[s.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[s.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[s.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[s.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[s.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[s.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[s.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[s.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[s.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[s.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[s.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[s.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[s.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},p=44,G=2,at={small:10,medium:13,large:17},Ye={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function qe(e){const t={};for(const[i,a]of Object.entries(ie))t[i]={bg:a.bg,bd:a.bd,glow:a.glow};if(e)for(const[i,a]of Object.entries(e))Object.assign(t[i],a);return t}const rt=qe(null),ot=qe({[s.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[s.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[s.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[s.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[s.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[s.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[s.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[s.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[s.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),fe={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},q=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[s.DESPAIR,s.TERROR,s.HOPELESS],hazardCounts:[6,5,4],specialTiles:[s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[s.RAGE,s.DESPAIR,s.GLITCH],hazardCounts:[5,6,5],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[s.TERROR,s.SELF_HARM,s.HOPELESS],hazardCounts:[4,3,5],specialTiles:[s.TELEPORT,s.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[s.ARCHETYPE,s.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[s.DESPAIR,s.TERROR,s.SELF_HARM,s.PAIN],hazardCounts:[7,6,4,3],specialTiles:[s.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[s.TERROR,s.RAGE,s.GLITCH],hazardCounts:[6,5,4],specialTiles:[s.COVER,s.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[s.TRAP,s.RAGE,s.DESPAIR,s.TERROR],hazardCounts:[6,4,5,4],specialTiles:[s.TRAP,s.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[s.HOPELESS,s.DESPAIR,s.GLITCH],hazardCounts:[4,4,4],specialTiles:[s.TELEPORT,s.ARCHETYPE,s.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[s.DESPAIR,s.TERROR,s.RAGE,s.HOPELESS,s.SELF_HARM,s.GLITCH,s.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[s.ARCHETYPE,s.TELEPORT,s.INSIGHT,s.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],se=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],lt=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],st=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],nt=["small","medium","large"],ft=["easy","normal","hard"],R={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let Te=[],$e=0,$=0,Re=[],me="B",ce=0;function Oe(e){me=e}function be(e){ce=e}function ht(e){ce+=e}function dt(e=1){$+=e}function Ze(e){$=Math.max(0,$-e)}function ut(e){Re.push(e)}function je(e){Te=e}function pt(){$e=0,$=0,Re=[],me="B",ce=0}const u={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function mt(){Object.assign(u,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function Xe(e){return{maxhp:u.maxHp>100,speed:u.moveDelay<120,magnet:u.magnet,freeze:u.freeze,aura:u.aura,energy:u.energyMax>100,rewind:u.temporalRewind,pulse:u.glitchPulse}[e]||!1}let O="title";typeof window<"u"&&(window.phase=O);function U(e){O=e,typeof window<"u"&&(window.phase=O)}const C={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title",selectedMode:"grid"};let ae=.45;function ct(e){ae=Math.max(0,Math.min(1,e))}function I(e){return Math.floor(Math.random()*e)}function de(e){return e[I(e.length)]}function Be(e,t,i){return Math.max(t,Math.min(i,e))}const ke=[1,1,2,3,5,8,13,21,34,55,89];function yt(e){return ke[Math.min(e,ke.length-1)]}const Je="glitch_peace_v4";function gt(e){try{localStorage.setItem(Je+"_scores",JSON.stringify(e))}catch{}}function Qe(){try{const e=localStorage.getItem(Je+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Ce(){return at[R.gridSize]}function wt(){return Ye[R.difficulty]}function Ke(){return Ce()*p+(Ce()-1)*G}function oe(){return Ke()+48}function le(){return Ke()+148}function St(e){const t=Array.from({length:e},()=>new Array(e).fill(s.VOID)),i=Math.floor(e*e*.07);for(let a=0;a<i;a++){const o=1+I(e-2),r=1+I(e-2);t[o][r]=s.WALL}return t}function he(e,t,i,a,o){let r=0,d=0;for(;r<t&&d<9999;){d++;const f=I(a),h=I(a);if(e[f][h]===s.VOID){if(f<2&&h<2)continue;e[f][h]=i,r++}}}function Mt(e,t,i,a,o,r,d){const f=wt(),h=St(t);h[0][0]=s.VOID,t>1&&(h[0][1]=s.VOID,h[1][0]=s.VOID);const y=yt(i+2)+(t-13>0?t-13:0),E=1+Math.floor(i/3);if(e.hazardSet.forEach((L,b)=>{const S=Math.round((e.hazardCounts[b]||4)*f.hazMul);he(h,S,L,t)}),he(h,y,s.PEACE,t),he(h,E,s.INSIGHT,t),e.specialTiles.forEach(L=>he(h,2,L,t)),d&&d.length>0&&he(h,3,s.MEMORY,t),e.id==="aztec")for(let L=0;L<t*2;L++){const b=1+I(t-2),S=1+I(t-2);h[b][S]===s.VOID&&(h[b][S]=s.WALL)}const m=e.id==="bedroom"?2:e.id==="summit"?1:0,N=Math.min(e.enemyCount+Math.floor(i*.5)+m,10),n=Math.max(1,N+(R.difficulty==="hard"?2:R.difficulty==="easy"?-1:0)),w=[],A=Math.max(2,Math.floor(t/5));for(let L=0;L<n;L++){let b,S,c=0;do b=A+I(t-A*2),S=A+I(t-A*2),c++;while((h[b][S]!==s.VOID||b<2&&S<2)&&c<400);w.push({y:b,x:S,timer:I(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+I(3),prevY:b,prevX:S,momentum:[0,0],type:"hunter"})}let P=null;if(i>=6&&(e.id==="summit"||e.id==="integration")){const L=Math.floor(t/2),b=Math.floor(t/2);h[b][L]=s.VOID,P={y:b,x:L,hp:5+i,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:h,enemies:w,boss:P,sz:t,level:i,ds:e,player:{y:0,x:0},hp:o!==void 0?Math.min(r,o+25):r,score:a||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:y,insightLeft:E,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+I(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function z(e,t,i,a,o,r){if(!(!R.particles||!e))for(let d=0;d<o;d++){const f=Math.PI*2*d/o+Math.random()*.6,h=r*(.6+Math.random()*.8);e.particles.push({x:t*(p+G)+p/2,y:i*(p+G)+p/2,vx:Math.cos(f)*h,vy:Math.sin(f)*h-1,r:2+Math.random()*3,color:a,life:20+I(16),maxLife:36})}}function Me(e,t,i,a){!R.particles||!e||(e.resonanceWave={x:t*(p+G)+p/2,y:i*(p+G)+p/2,r:0,maxR:200,color:a,alpha:.55})}function xe(e,t){R.particles&&e.echos.push({x:e.player.x*(p+G)+p/2,y:e.player.y*(p+G)+p/2,life:30,maxLife:30,size:p*.38,color:t==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}class Et{constructor(){this.audioContext=null,this.masterGain=null,this.enabled=!0,this.volume=.3,this.initialize()}initialize(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=this.volume,this.masterGain.connect(this.audioContext.destination)}catch(t){console.warn("Web Audio API not supported:",t),this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.masterGain&&(this.masterGain.gain.value=this.volume)}toggle(){return this.enabled=!this.enabled,this.enabled}playPeaceCollect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[523.25,659.25,783.99,1046.5].forEach((a,o)=>{const r=this.audioContext.createOscillator(),d=this.audioContext.createGain();r.type="sine",r.frequency.value=a,d.gain.setValueAtTime(0,t+o*.08),d.gain.linearRampToValueAtTime(.15,t+o*.08+.01),d.gain.exponentialRampToValueAtTime(.001,t+o*.08+.3),r.connect(d),d.connect(this.masterGain),r.start(t+o*.08),r.stop(t+o*.08+.3)})}playDamage(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,i=this.audioContext.createOscillator(),a=this.audioContext.createGain(),o=this.audioContext.createBiquadFilter();i.type="sawtooth",i.frequency.setValueAtTime(80,t),i.frequency.exponentialRampToValueAtTime(40,t+.15),o.type="lowpass",o.frequency.value=800,o.Q.value=5,a.gain.setValueAtTime(.25,t),a.gain.exponentialRampToValueAtTime(.001,t+.15),i.connect(o),o.connect(a),a.connect(this.masterGain),i.start(t),i.stop(t+.15)}playMatrixSwitch(t=!1){if(!this.enabled||!this.audioContext)return;this.resume();const i=this.audioContext.currentTime,a=this.audioContext.createOscillator(),o=this.audioContext.createGain();a.type="square",t?(a.frequency.setValueAtTime(400,i),a.frequency.exponentialRampToValueAtTime(200,i+.2)):(a.frequency.setValueAtTime(200,i),a.frequency.exponentialRampToValueAtTime(400,i+.2)),o.gain.setValueAtTime(.2,i),o.gain.exponentialRampToValueAtTime(.001,i+.2),a.connect(o),o.connect(this.masterGain),a.start(i),a.stop(i+.2)}playLevelComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;[261.63,329.63,392,523.25].forEach(a=>{const o=this.audioContext.createOscillator(),r=this.audioContext.createGain();o.type="sine",o.frequency.value=a,r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(.12,t+.05),r.gain.exponentialRampToValueAtTime(.001,t+.8),o.connect(r),r.connect(this.masterGain),o.start(t),o.stop(t+.8)})}playEnemyHit(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,i=this.audioContext.createOscillator(),a=this.audioContext.createGain(),o=this.audioContext.createBiquadFilter();i.type="triangle",i.frequency.setValueAtTime(150,t),i.frequency.exponentialRampToValueAtTime(50,t+.1),o.type="lowpass",o.frequency.value=400,a.gain.setValueAtTime(.3,t),a.gain.exponentialRampToValueAtTime(.001,t+.1),i.connect(o),o.connect(a),a.connect(this.masterGain),i.start(t),i.stop(t+.1)}playMenuNav(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,i=this.audioContext.createOscillator(),a=this.audioContext.createGain();i.type="sine",i.frequency.value=440,a.gain.setValueAtTime(.1,t),a.gain.exponentialRampToValueAtTime(.001,t+.05),i.connect(a),a.connect(this.masterGain),i.start(t),i.stop(t+.05)}playMenuSelect(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime,i=this.audioContext.createOscillator(),a=this.audioContext.createGain();i.type="square",i.frequency.value=880,a.gain.setValueAtTime(.15,t),a.gain.exponentialRampToValueAtTime(.001,t+.1),i.connect(a),a.connect(this.masterGain),i.start(t),i.stop(t+.1)}playArchetypePower(){if(!this.enabled||!this.audioContext)return;this.resume();const t=this.audioContext.currentTime;for(let i=0;i<5;i++){const a=this.audioContext.createOscillator(),o=this.audioContext.createGain();a.type="sine",a.frequency.value=220*(i+1);const r=t+i*.03;o.gain.setValueAtTime(.08,r),o.gain.exponentialRampToValueAtTime(.001,r+.2),a.connect(o),o.connect(this.masterGain),a.start(r),a.stop(r+.2)}}dispose(){this.audioContext&&this.audioContext.close()}}const Q=new Et;function At(e,t,i,a,o,r,d){const f=e,h=f.sz,y=Ye[R.difficulty];if(!f||f.hp<=0)return;if(u.freeze&&u.freezeTimer>0){u.freezeTimer-=t;return}const E=f.slowMoves?1.5:1,m=y.eSpeedBase-f.level*30,N=Math.max(y.eSpeedMin,m)*(a==="A"?.65:1)*E*(f.temporalEnemyMul??1);if(f.level>=3){if(o.splice(0,o.length,...o.filter(n=>n.life>0)),Math.random()<6e-4*f.level&&o.length<3){const n=I(h),w=I(h);f.grid[n][w]===s.VOID&&o.push({y:n,x:w,timer:0,life:5e3+I(4e3)})}for(const n of o)if(n.life-=t,n.timer+=t,n.timer>450){n.timer=0;const w=f.player.x-n.x,A=f.player.y-n.y,P=A>0?1:A<0?-1:0,L=w>0?1:w<0?-1:0,b=n.y+P,S=n.x+L;b>=0&&b<h&&S>=0&&S<h&&(n.y=b,n.x=S),n.y===f.player.y&&n.x===f.player.x&&(f.hp=Math.max(0,f.hp-8),n.life=0,f.shakeFrames=4,f.flashColor="#8800ff",f.flashAlpha=.18,r("CHAOS PHANTOM!","#aa00ff",35))}}if(f.boss&&f.boss.hp>0){const n=f.boss;if(n.timer+=t,n.phaseTimer-=t,n.phaseTimer<=0&&(n.phase=n.phase==="chase"?"orbit":"chase",n.phaseTimer=400+I(300)),n.timer>280){n.timer=0;let w=f.player.x,A=f.player.y;f.level>=8&&(w+=i.has("ArrowRight")||i.has("d")?1:i.has("ArrowLeft")||i.has("a")?-1:0,A+=i.has("ArrowDown")||i.has("s")?1:i.has("ArrowUp")||i.has("w")?-1:0);const P=A-n.y,L=w-n.x,b=P>0?1:P<0?-1:0,S=L>0?1:L<0?-1:0;if(b&&n.y+b>=0&&n.y+b<h?n.y+=b:S&&n.x+S>=0&&n.x+S<h&&(n.x+=S),n.y===f.player.y&&n.x===f.player.x){const c=Math.round(40*y.dmgMul*(a==="A"?1.3:1));f.hp=Math.max(0,f.hp-c),f.shakeFrames=14,f.flashColor="#ff00aa",f.flashAlpha=.45,z(f,f.player.x,f.player.y,"#ff00aa",22,5),r("BOSS! -"+c,"#ff00aa",50)}}}for(const n of f.enemies){if(n.stunTimer>0){n.stunTimer-=t;continue}if(n.timer+=t,n.timer<N)continue;n.timer=0,n.prevY=n.y,n.prevX=n.x;const w=n.behavior||f.ds.enemyBehavior,A=f.player.x-n.x,P=f.player.y-n.y,L=Math.abs(A)+Math.abs(P);let b=!1;if(w==="wander"||L>h*.7){const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[c,T]of S){const g=n.y+c,l=n.x+T;if(g>=0&&g<h&&l>=0&&l<h&&f.grid[g][l]!==s.WALL){n.y=g,n.x=l,b=!0;break}}}else if(w==="patrol"){n.patrolAngle+=(Math.random()-.5)*.4;const S=Math.round(Math.sin(n.patrolAngle)),c=Math.round(Math.cos(n.patrolAngle)),T=n.y+Be(S,-1,1),g=n.x+Be(c,-1,1);if(T>=0&&T<h&&g>=0&&g<h&&f.grid[T][g]!==s.WALL&&(n.y=T,n.x=g,b=!0),L<5&&Math.random()<.7){const l=P>0?1:P<0?-1:0,M=A>0?1:A<0?-1:0,D=n.y+l,H=n.x+M;D>=0&&D<h&&H>=0&&H<h&&f.grid[D][H]!==s.WALL&&(n.y=D,n.x=H)}}else if(w==="orbit"){n.orbitAngle+=.25;const S=f.player.x+Math.round(Math.cos(n.orbitAngle)*n.orbitR),c=f.player.y+Math.round(Math.sin(n.orbitAngle)*n.orbitR),T=c-n.y>0?1:c-n.y<0?-1:0,g=S-n.x>0?1:S-n.x<0?-1:0;n.y+T>=0&&n.y+T<h&&n.x+g>=0&&n.x+g<h&&f.grid[n.y+T][n.x+g]!==s.WALL&&(n.y+=T,n.x+=g)}else if(w==="chase_fast"||w==="adaptive"||w==="predictive"){let S=f.player.x,c=f.player.y;w==="predictive"&&f.level>=7&&(S+=i.has("ArrowRight")||i.has("d")?1:i.has("ArrowLeft")||i.has("a")?-1:0,c+=i.has("ArrowDown")||i.has("s")?1:i.has("ArrowUp")||i.has("w")?-1:0);const T=S-n.x,g=c-n.y,l=Math.abs(g)>=Math.abs(T)?[[g>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[g>0?1:-1,0]];for(const[M,D]of l){const H=n.y+M,v=n.x+D;if(H>=0&&H<h&&v>=0&&v<h&&f.grid[H][v]!==s.WALL){n.y=H,n.x=v,b=!0;break}}if(!b){const M=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[D,H]of M){const v=n.y+D,_=n.x+H;if(v>=0&&v<h&&_>=0&&_<h&&f.grid[v][_]!==s.WALL){n.y=v,n.x=_;break}}}}else if(w==="rush"){const S=Math.abs(P)>=Math.abs(A)?[[P>0?1:-1,0],[0,A>0?1:-1]]:[[0,A>0?1:-1],[P>0?1:-1,0]];for(const[c,T]of S){const g=n.y+c,l=n.x+T;if(g>=0&&g<h&&l>=0&&l<h&&f.grid[g][l]!==s.WALL){n.y=g,n.x=l,b=!0;break}}if(!b){const c=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[T,g]of c){const l=n.y+T,M=n.x+g;if(l>=0&&l<h&&M>=0&&M<h&&f.grid[l][M]!==s.WALL){n.y=l,n.x=M;break}}}}else if(w==="scatter"){const S=Math.abs(P)>=Math.abs(A)?[[P>0?-1:1,0],[0,A>0?-1:1]]:[[0,A>0?-1:1],[P>0?-1:1,0]];for(const[c,T]of S){const g=n.y+c,l=n.x+T;if(g>=0&&g<h&&l>=0&&l<h&&f.grid[g][l]!==s.WALL){n.y=g,n.x=l,b=!0;break}}if(!b){const c=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[T,g]of c){const l=n.y+T,M=n.x+g;if(l>=0&&l<h&&M>=0&&M<h&&f.grid[l][M]!==s.WALL){n.y=l,n.x=M;break}}}}else{const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[c,T]of S){const g=n.y+c,l=n.x+T;if(g>=0&&g<h&&l>=0&&l<h&&f.grid[g][l]!==s.WALL){n.y=g,n.x=l;break}}}if(n.y===f.player.y&&n.x===f.player.x)if(u.shield&&u.shieldTimer>0)n.stunTimer=1300,Q.playEnemyHit(),r("SHIELD HELD!","#00ffcc",38),z(f,f.player.x,f.player.y,"#00ffcc",14,3);else{const S=Math.round(22*y.dmgMul*(a==="A"?1.3:1));f.hp=Math.max(0,f.hp-S),Q.playDamage(),f.shakeFrames=8,f.flashColor="#ff2200",f.flashAlpha=.35,z(f,f.player.x,f.player.y,"#ff4400",16,4),n.stunTimer=900,u.shieldCount=0,u.comboCount=0,r("HIT! -"+S,"#ff4400",40),d(f,"panic")}for(const S of f.captureZones)Math.abs(n.x-f.player.x)<=S.r&&Math.abs(n.y-f.player.y)<=S.r&&(f.hp=Math.max(0,f.hp-5),r("CAPTURED!","#ff0044",25))}f.captureZones=f.captureZones.filter(n=>(n.timer--,n.timer>0))}function Se(e,t){window._emotionalField&&window._emotionalField.addEmotion(t,.6),u.emotion=t,e.slowMoves=t==="hopeless"||t==="despair"}function re(e,t,i,a){e&&(e.msg=t,e.msgColor=i,e.msgTimer=a)}function Tt(e,t,i){const a=fe[t];if(a){if(e.archetypeActive=!0,e.archetypeType=t,e.archetypeTimer=180,u.archetypePower=a.power,u.archetypeDuration=180,re(e,a.activationMsg,"#ffdd00",70),Me(e,e.player.x,e.player.y,"#ffdd00"),z(e,e.player.x,e.player.y,"#ffdd00",24,4),t==="child"){for(let o=0;o<e.sz;o++)for(let r=0;r<e.sz;r++)e.grid[o][r]===s.HIDDEN&&e.tileFlicker.push({y:o,x:r,t:200,reveal:!0});re(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}t==="protector"&&(u.shield=!0,u.shieldTimer=30,z(e,e.player.x,e.player.y,"#88ccff",20,5)),t==="orb"&&(u.phaseShift=!0,u.phaseTimer=15),t==="captor"&&(u.temporalRewind=!0,u.rewindBuffer=u.rewindBuffer.slice(-3))}}function Ge(e){const t=u.archetypePower;if(!t)return;const i=e.sz;if(t==="wall_jump")for(const[a,o]of[[-2,0],[2,0],[0,-2],[0,2]]){const r=e.player.y+a,d=e.player.x+o;if(r>=0&&r<i&&d>=0&&d<i&&e.grid[r][d]!==s.WALL){xe(e,"B"),e.player.y=r,e.player.x=d,z(e,d,r,"#ffaa00",16,3),re(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(t==="phase_walk")u.phaseShift=!0,u.phaseTimer=10,re(e,"ORB PHASE ACTIVE","#aaddff",35);else if(t==="rewind")if(u.rewindBuffer.length>0){const a=u.rewindBuffer.pop();if(e.player.y=a.y,e.player.x=a.x,a.grid)for(let o=0;o<i;o++)for(let r=0;r<i;r++)e.grid[o][r]=a.grid[o][r];z(e,e.player.x,e.player.y,"#ffaadd",20,3),re(e,"TEMPORAL REWIND","#ffaadd",40)}else re(e,"NO REWIND MEMORY","#443344",30);else if(t==="shield_burst"){u.shield=!0,u.shieldTimer=25;for(const a of e.enemies)a.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),z(e,e.player.x,e.player.y,"#88ccff",30,6),re(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function bt(e,t,i,a,o,r,d,f){const h=e.sz,y=e.player.y+t,E=e.player.x+i;if(y<0||y>=h||E<0||E>=h)return!1;const m=e.grid[y][E];if(m===s.WALL&&!(u.phaseShift&&u.phaseTimer>0)||m===s.HIDDEN&&a==="A"&&!u.phaseShift)return!1;if(u.temporalRewind&&u.rewindBuffer.length<8){const n=e.grid.map(w=>[...w]);u.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:n})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),xe(e,a),R.particles&&e.trail.push({x:e.player.x*(p+G)+p/2,y:e.player.y*(p+G)+p/2,life:14,maxLife:14,color:a==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=y,e.player.x=E,u.phaseShift&&u.phaseTimer>0&&(u.phaseTimer--,u.phaseTimer<=0&&(u.phaseShift=!1,r("PHASE FADED","#445566",25))),u.shield&&u.shieldTimer>0&&(u.shieldTimer--,u.shieldTimer<=0&&(u.shield=!1,r("SHIELD FADED","#445566",25))),a==="A"?u.energy=Math.max(0,u.energy-.9):u.energy=Math.min(u.energyMax,u.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,u.archetypePower=null));const N={dmgMul:R.difficulty==="hard"?1.45:R.difficulty==="easy"?.55:1};if(m===s.PEACE){Q.playPeaceCollect();const n=Math.round((150+e.level*20)*u.resonanceMultiplier);e.score+=n,e.hp=Math.min(u.maxHp,e.hp+Math.round(20*(e.healMul??1))),e.grid[y][E]=s.VOID,e.peaceLeft--,z(e,E,y,u.particleColor,18,3.5),u.shieldCount++,u.comboCount++,u.resonanceMultiplier=Math.min(4,1+u.comboCount*.25),u.glitchPulseCharge=Math.min(100,u.glitchPulseCharge+15),u.comboCount>=3&&!u.shield?(u.shield=!0,u.shieldTimer=20,Me(e,E,y,"#00ffcc"),z(e,E,y,"#00ffcc",26,5),r("SHIELD ACTIVE! ×"+u.resonanceMultiplier.toFixed(1),"#00ffcc",55)):r("+PEACE +"+n+(u.comboCount>1?" ×"+u.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),Se(e,"peace"),e.peaceLeft===0&&(Q.playLevelComplete(),o())}else if(m===s.INSIGHT){const n=Math.round((300+e.level*50)*u.resonanceMultiplier*(e.insightMul??1));e.score+=n,f(d+1),e.grid[y][E]=s.VOID,e.insightLeft--,z(e,E,y,"#00eeff",24,4),Me(e,E,y,"#00eeff"),r("INSIGHT ◆×"+(d+1),"#00eeff",60);for(let w=0;w<h;w++)for(let A=0;A<h;A++)e.grid[w][A]===s.HIDDEN&&e.tileFlicker.push({y:w,x:A,t:100,reveal:!0});Se(e,"clarity")}else if(m===s.ARCHETYPE)e.grid[y][E]=s.VOID,Tt(e,e.ds.archetype||"orb");else if(m===s.TELEPORT){let n=0,w=I(h),A=I(h);for(;(e.grid[w][A]!==s.VOID||w===y&&A===E)&&n<200;)w=I(h),A=I(h),n++;e.player.y=w,e.player.x=A,e.grid[y][E]=s.VOID,z(e,A,w,"#00aaff",16,3),r("LEAP!","#00aaff",30)}else if(m===s.COVER){r("COVER","#446688",20);for(const n of e.enemies)Math.abs(n.y-y)+Math.abs(n.x-E)<=2&&(n.stunTimer=600)}else if(m===s.MEMORY)e.grid[y][E]=s.VOID,e.score+=50,r("MEMORY ECHO…","#88bbaa",30),z(e,E,y,"#88bbaa",10,2);else if(ie[m]&&ie[m].dmg>0)if(u.shield&&u.shieldTimer>0)r("SHIELDED","#00ffcc",20);else{const n=ie[m];let w=Math.round(n.dmg*N.dmgMul*(a==="A"?1.25:1)*(e.dmgMul??1));if(m===s.RAGE&&n.push>0){const b=y+t*n.push,S=E+i*n.push;b>=0&&b<h&&S>=0&&S<h&&e.grid[b][S]!==s.WALL&&(e.player.y=b,e.player.x=S,r("-RAGE (pushed!)","#ff0066",40))}if(m===s.SELF_HARM&&(e.grid[y][E]=s.PAIN),m===s.HOPELESS&&Se(e,"hopeless"),m===s.DESPAIR&&Math.random()<.3){const b=[[1,0],[-1,0],[0,1],[0,-1]],[S,c]=de(b),T=y+S,g=E+c;T>=0&&T<h&&g>=0&&g<h&&e.grid[T][g]===s.VOID&&(e.grid[T][g]=s.DESPAIR)}e.hp=Math.max(0,e.hp-w),Q.playDamage(),e.shakeFrames=5;const A={[s.DESPAIR]:"#2244ff",[s.TERROR]:"#ff0000",[s.SELF_HARM]:"#660000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},P={[s.DESPAIR]:"#3355ff",[s.TERROR]:"#ff2222",[s.SELF_HARM]:"#880000",[s.RAGE]:"#ff0044",[s.HOPELESS]:"#004488",[s.GLITCH]:"#aa00ff",[s.TRAP]:"#ff8800",[s.PAIN]:"#440000"},L={[s.DESPAIR]:"-DESPAIR",[s.TERROR]:"-TERROR!",[s.SELF_HARM]:"-SELF·HARM",[s.RAGE]:"-RAGE",[s.HOPELESS]:"-HOPELESS",[s.GLITCH]:"-GLITCH",[s.TRAP]:"-TRAP",[s.PAIN]:"-PAIN"};e.flashColor=A[m]||"#ff0000",e.flashAlpha=.28,z(e,E,y,P[m]||"#ff2222",10,3),r((L[m]||"-HAZARD")+" -"+w,P[m]||"#ff3333",38),u.shieldCount=0,u.comboCount=0,u.resonanceMultiplier=1}return!0}function Ct(e,t){var a;if(!e||u.glitchPulseCharge<100)return;u.glitchPulseCharge=0;let i=0;for(let o=0;o<e.sz;o++)for(let r=0;r<e.sz;r++)Math.abs(o-e.player.y)+Math.abs(r-e.player.x)<=3&&((a=ie[e.grid[o][r]])==null?void 0:a.dmg)>0&&(e.grid[o][r]=s.VOID,i++);for(const o of e.enemies)Math.abs(o.y-e.player.y)+Math.abs(o.x-e.player.x)<=4&&(o.stunTimer=1800);Me(e,e.player.x,e.player.y,"#aa00ff"),z(e,e.player.x,e.player.y,"#aa00ff",32,6),t("GLITCH PULSE! "+i+" CLEARED","#aa00ff",55)}function Rt(e,t){if(e.spreadTimer-=t,e.spreadTimer>0)return;e.spreadTimer=3e3+I(1e3);const i=e.sz,a=[];for(let o=0;o<i;o++)for(let r=0;r<i;r++){const d=e.grid[o][r];if((d===s.DESPAIR||d===s.HOPELESS)&&ie[d].spread)for(const[f,h]of[[1,0],[-1,0],[0,1],[0,-1]]){const y=o+f,E=r+h;y>=0&&y<i&&E>=0&&E<i&&e.grid[y][E]===s.VOID&&Math.random()<.2&&a.push({y,x:E,type:d})}}for(const o of a.slice(0,2))e.grid[o.y][o.x]=o.type}function vt(e){return e==="A"?ot:rt}function Pt(e,t,i,a,o,r,d,f,h,y,E){const m=i;if(!m)return;const N=m.sz,n=N*p+(N-1)*G,w=n+48,A=n+148,P=vt(a),L=m.ds;e.clearRect(0,0,w,A),e.fillStyle=L.bgColor,e.fillRect(0,0,w,A);const b=e.createRadialGradient(w*.7,A*.3,0,w*.7,A*.3,w*.8);b.addColorStop(0,L.bgAccent+"33"),b.addColorStop(1,"transparent"),e.fillStyle=b,e.fillRect(0,0,w,A),a==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,w,A));for(let l=0;l<A;l+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,l,w,1);for(const l of o){const M=l.a*(.5+.5*Math.sin(t*8e-4+l.phase));e.globalAlpha=M,e.fillStyle="#ffffff",e.beginPath(),e.arc(l.x,l.y,l.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,y>0&&(e.fillStyle=`rgba(${a==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*A),w,2+Math.floor(Math.random()*4)));let S=0,c=0;m.shakeFrames>0&&(S=(Math.random()-.5)*9*(m.shakeFrames/10),c=(Math.random()-.5)*9*(m.shakeFrames/10),m.shakeFrames--);const T=(w-n)/2+S,g=100+c;for(const l of r)l.x+=l.dx,l.y+=l.dy,l.life--,l.life>l.maxLife*.85?l.alpha=Math.min(l.targetAlpha,(l.maxLife-l.life)/(l.maxLife*.15)*l.targetAlpha):l.life<l.maxLife*.15&&(l.alpha=Math.max(0,l.life/(l.maxLife*.15)*l.targetAlpha)),l.life<=0&&(l.life=200+Math.floor(Math.random()*400),l.maxLife=600),e.globalAlpha=l.alpha*(a==="A"?.7:1),e.fillStyle=a==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(l.text,l.x,l.y);e.globalAlpha=1,e.textAlign="left";for(let l=0;l<N;l++)for(let M=0;M<N;M++){const D=m.grid[l][M],H=m.tileFlicker.find(k=>k.y===l&&k.x===M),v=H&&H.reveal&&D===s.HIDDEN?s.INSIGHT:D,_=ie[v]||ie[s.VOID],V=P[v]||P[s.VOID],B=T+M*(p+G),F=g+l*(p+G);if(f&&(l===h.row||M===h.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):V.glow?(e.shadowColor=V.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=V.bg,e.beginPath(),e.roundRect(B,F,p,p,4),e.fill(),e.strokeStyle=V.bd,e.lineWidth=1,e.beginPath(),e.roundRect(B+.5,F+.5,p-1,p-1,4),e.stroke(),e.shadowBlur=0,v===s.PEACE){const k=(t*.05+l*6+M*4)%(p*2);if(k<p){const Y=e.createLinearGradient(B,F+k-5,B,F+k+5);Y.addColorStop(0,"rgba(0,255,140,0)"),Y.addColorStop(.5,"rgba(0,255,140,0.45)"),Y.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=Y,e.fillRect(B,F,p,p)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(B+p/2,F+p/2,5+2*Math.sin(t*.006+M+l),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(v===s.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const k=t*.008+M*1.7+l*1.3;for(let Y=0;Y<4;Y++){const x=k+Y*Math.PI*.5,K=7+2*Math.sin(t*.005+Y);e.fillStyle=Y%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(B+p/2+Math.cos(x)*K,F+p/2+Math.sin(x)*K,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(v===s.ARCHETYPE){const k=.5+.5*Math.sin(t*.01+M+l);e.shadowColor="#ffdd00",e.shadowBlur=16*k,e.fillStyle=`rgba(255,220,0,${.15*k})`,e.fillRect(B,F,p,p),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",B+p/2,F+p/2+6),e.shadowBlur=0,e.textAlign="left"}if(v===s.TELEPORT){const k=.5+.5*Math.sin(t*.012+M*2+l);e.shadowColor="#00aaff",e.shadowBlur=12*k,e.fillStyle=`rgba(0,170,255,${.2*k})`,e.fillRect(B,F,p,p),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",B+p/2,F+p/2+5),e.shadowBlur=0,e.textAlign="left"}if(v===s.MEMORY){const k=.3+.3*Math.sin(t*.004+M+l);e.globalAlpha=.4+.2*k,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(B,F,p,p),e.globalAlpha=1}_.sym&&v!==s.VOID&&v!==s.WALL&&v!==s.PEACE&&v!==s.INSIGHT&&v!==s.ARCHETYPE&&v!==s.TELEPORT&&v!==s.HIDDEN&&v!==s.MEMORY&&(e.fillStyle=V.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(_.sym,B+p/2,F+p/2+5),e.globalAlpha=1,e.textAlign="left"),(v===s.PEACE||v===s.INSIGHT)&&u.magnet&&Math.abs(l-m.player.y)+Math.abs(M-m.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(B+2,F+2,p-4,p-4,4),e.stroke())}m.tileFlicker=m.tileFlicker.filter(l=>(l.t--,l.t>0));for(const l of m.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(l.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(T+l.x*(p+G)+p/2,g+l.y*(p+G)+p/2,(l.r+.5)*(p+G),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const l of m.echos)e.globalAlpha=l.life/l.maxLife*.55,e.fillStyle=l.color,e.beginPath(),e.arc(T+l.x,g+l.y,l.size*(l.life/l.maxLife),0,Math.PI*2),e.fill(),l.life--;if(m.echos=m.echos.filter(l=>l.life>0),e.globalAlpha=1,R.particles){for(const l of m.trail)e.globalAlpha=l.life/l.maxLife*.48,e.fillStyle=l.color,e.shadowColor=l.color,e.shadowBlur=4,e.beginPath(),e.arc(T+l.x,g+l.y,4*(l.life/l.maxLife),0,Math.PI*2),e.fill(),l.life--;m.trail=m.trail.filter(l=>l.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const l of d){if(l.life<=0)continue;const M=T+l.x*(p+G),D=g+l.y*(p+G),H=.3+.25*Math.sin(Date.now()*.006+l.x);e.globalAlpha=H,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(M+8,D+8,p-16,p-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",M+p/2,D+p/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const l of m.enemies){const M=T+l.x*(p+G),D=g+l.y*(p+G),H=.6+.4*Math.sin(t*.007+l.x*1.3),v=l.stunTimer>0,_=l.type==="rush",V=v?"#8888ff":_?"#ff0066":a==="A"?"#ff0044":"#ff4400";e.shadowColor=V,e.shadowBlur=14*H,e.fillStyle=v?"#1c1c44":_?"#4a0022":a==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(M+5,D+5,p-10,p-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=v?"#4444aa":_?"#ff0066":a==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(M+p/2,D+12),e.lineTo(M+p-12,D+p-12),e.lineTo(M+12,D+p-12),e.closePath(),e.fill(),e.fillStyle=v?"#6666cc":"#ffcc00",e.beginPath(),e.arc(M+p/2,D+p/2+2,4,0,Math.PI*2),e.fill()}if(m.boss&&m.boss.hp>0){const l=m.boss,M=T+l.x*(p+G),D=g+l.y*(p+G),H=.5+.5*Math.sin(t*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*H,e.fillStyle="#330022",e.beginPath(),e.roundRect(M+1,D+1,p-2,p-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(M+p/2,D+p/2,p*.3+4*H,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+l.hp,M+p/2,D+p/2+4),e.textAlign="left",e.shadowBlur=0}{const l=T+m.player.x*(p+G),M=g+m.player.y*(p+G),D=.55+.45*Math.sin(t*.009),H=u.shield&&u.shieldTimer>0,v=u.phaseShift&&u.phaseTimer>0,_=u.emotion,B=a==="A"?"#ff0088":H?"#00ffff":v?"#00aaff":_==="panic"?"#ff0022":_==="hopeless"?"#0033aa":_==="peace"?"#00ffcc":_==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=B,e.shadowBlur=(H?36:u.aura?30:22)*D;const F=a==="A"?"#aa0055":"#005533",k=a==="A"?"#cc0077":"#00cc77",Y=a==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=F,e.beginPath(),e.roundRect(l+4,M+4,p-8,p-8,8),e.fill(),e.fillStyle=k,e.beginPath(),e.roundRect(l+9,M+9,p-18,p-18,5),e.fill(),e.fillStyle=Y,e.beginPath(),e.roundRect(l+15,M+15,p-30,p-30,3),e.fill(),m.archetypeActive){const K=fe[m.archetypeType||"orb"];e.strokeStyle=K.glow,e.lineWidth=2,e.shadowColor=K.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(l+1,M+1,p-2,p-2,8),e.stroke()}H&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(l,M,p,p,8),e.stroke()),v&&(e.globalAlpha=.4),u.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*D})`,e.lineWidth=3,e.beginPath(),e.arc(l+p/2,M+p/2,(p/2+7)*D,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=B,e.lineWidth=2;const x=9;[[l,M],[l+p,M],[l,M+p],[l+p,M+p]].forEach(([K,ye],Le)=>{const Ne=Le%2===0?1:-1,He=Le<2?1:-1;e.beginPath(),e.moveTo(K+Ne*2,ye),e.lineTo(K+Ne*(2+x),ye),e.stroke(),e.beginPath(),e.moveTo(K,ye+He*2),e.lineTo(K,ye+He*(2+x)),e.stroke()}),e.shadowBlur=0}if(R.particles){i.particles=i.particles.filter(l=>l.life>0);for(const l of i.particles)e.globalAlpha=Math.max(0,l.life/l.maxLife),e.fillStyle=l.color,e.shadowColor=l.color,e.shadowBlur=7,e.beginPath(),e.arc(T+l.x,g+l.y,l.r*(l.life/l.maxLife),0,Math.PI*2),e.fill(),l.x+=l.vx,l.y+=l.vy,l.vy+=.25,l.life--;e.globalAlpha=1,e.shadowBlur=0}if(m.resonanceWave){const l=m.resonanceWave;l.r+=7,l.alpha=Math.max(0,l.alpha-.55/l.maxR*7),e.strokeStyle=l.color,e.globalAlpha=l.alpha,e.lineWidth=2,e.shadowColor=l.color,e.shadowBlur=10,e.beginPath(),e.arc(T+l.x,g+l.y,l.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,l.r>=l.maxR&&(m.resonanceWave=null)}if(m.flashAlpha>0&&(e.fillStyle=m.flashColor,e.globalAlpha=m.flashAlpha,e.fillRect(T,g,n,n),e.globalAlpha=1,m.flashAlpha=Math.max(0,m.flashAlpha-.04)),a==="A"){const l=e.createRadialGradient(w/2,A/2,A*.25,w/2,A/2,A*.9);l.addColorStop(0,"rgba(80,0,20,0)"),l.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=l,e.fillRect(0,0,w,A)}It(e,m,w,A,n,T,g,a)}function It(e,t,i,a,o,r,d,f){const h=u,y=118,E={awe:"#ccddff",grief:"#4466aa",anger:"#ff4422",curiosity:"#ffcc00",shame:"#aa4488",tenderness:"#ffaabb",fear:"#cc2244",joy:"#00ffcc",despair:"#2233ff",hope:"#88ffcc",peace:"#00ff88",clarity:"#00eeff",panic:"#ff0022",neutral:"#334455"};function m(c){return c==null&&(c=.45),c<.15?{name:"HEAVEN",color:"#aaffcc"}:c<.35?{name:"IMAGINATION",color:"#aaddff"}:c<.55?{name:"MIND",color:"#00ff88"}:c<.75?{name:"PURGATORY",color:"#ff8800"}:{name:"HELL",color:"#ff2200"}}function N(c,T,g){var x;if(!g)return;const l=typeof g.getDominantEmotion=="function"?g.getDominantEmotion().id||"neutral":((x=g.getDominant)==null?void 0:x.call(g))??"neutral",M=typeof g.coherence=="number"?g.coherence:typeof g.getCoherence=="function"?g.getCoherence():.5,D=typeof g.distortion=="number"?g.distortion:typeof g.getDistortion=="function"?g.getDistortion():0,H=typeof g.synergy=="object"&&g.synergy?g.synergy.label:typeof g.getSynergy=="function"?g.getSynergy():null,v=E[l]||"#334455",_=50,V=88;c.font="8px Courier New",c.textAlign="left",c.fillStyle="#223322",c.fillText("EM",14,_+9),c.fillStyle=v,c.shadowColor=v,c.shadowBlur=4,c.font="bold 9px Courier New",c.fillText(l.toUpperCase(),32,_+9),c.shadowBlur=0;const B=32,F=_+12;c.fillStyle="#0a0a1a",c.fillRect(B,F,V,5),c.fillStyle="#0055cc",c.shadowColor="#0055cc",c.shadowBlur=3,c.fillRect(B,F,V*Math.min(1,M),5),c.shadowBlur=0,c.strokeStyle="rgba(0,80,200,0.18)",c.lineWidth=1,c.strokeRect(B,F,V,5);const k=_+19;c.fillStyle="#1a0a00",c.fillRect(B,k,V,5);const Y=D>.6?"#ff2200":"#ff8800";c.fillStyle=Y,c.shadowColor=Y,c.shadowBlur=3,c.fillRect(B,k,V*Math.min(1,D),5),c.shadowBlur=0,c.strokeStyle="rgba(200,80,0,0.18)",c.strokeRect(B,k,V,5),c.font="6px Courier New",c.fillStyle="#223344",c.fillText("COH",B+V+3,F+5),c.fillStyle="#332211",c.fillText("DIS",B+V+3,k+5),H&&(c.font="bold 7px Courier New",c.textAlign="center",c.fillStyle="#ffdd00",c.shadowColor="#ffdd00",c.shadowBlur=6,c.fillText("⟡ "+H.replace(/_/g," "),T/2,_+10),c.shadowBlur=0),c.textAlign="left"}e.fillStyle="#070714",e.fillRect(0,0,i,y),e.strokeStyle="rgba(255,255,255,0.04)",e.lineWidth=1,e.beginPath(),e.moveTo(0,y),e.lineTo(i,y),e.stroke(),e.fillStyle=t.ds.bgAccent+"88",e.fillRect(0,0,i,16),e.fillStyle="#334455",e.font="8px Courier New",e.textAlign="center",e.fillText(t.ds.name+"  ·  "+t.ds.emotion,i/2,11),e.textAlign="left",e.fillStyle="#ff00ff",e.font="bold 10px Courier New",e.fillText("PHASE: "+(window.phase||"unknown"),8,10);const n=138;e.fillStyle="#333",e.font="9px Courier New",e.fillText("HP",14,30),e.fillStyle="#0e0e1e",e.fillRect(32,20,n,13);const w=t.hp/h.maxHp,A=w>.6?"#00ff88":w>.3?"#ffaa00":"#ff3333";e.fillStyle=A,e.shadowColor=A,e.shadowBlur=5,e.fillRect(32,20,n*w,13),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.06)",e.strokeRect(32,20,n,13),e.fillStyle="#444",e.font="8px Courier New",e.fillText(t.hp+"/"+h.maxHp,32+n+4,30);const P=138;e.fillStyle="#222",e.font="8px Courier New",e.fillText("EN",14,50),e.fillStyle="#0a0a1a",e.fillRect(32,41,P,9);const L=f==="A"?"#ff0055":"#0088ff";if(e.fillStyle=L,e.shadowColor=L,e.shadowBlur=4,e.fillRect(32,41,P*(h.energy/h.energyMax),9),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.04)",e.strokeRect(32,41,P,9),h.glitchPulse){e.fillStyle="#220a22",e.fillRect(32,53,P,6);const c=h.glitchPulseCharge/100;e.fillStyle=c>=1?"#ff00ff":"#660088",e.fillRect(32,53,P*c,6),e.strokeStyle="rgba(150,0,200,0.2)",e.strokeRect(32,53,P,6),e.fillStyle=c>=1?"#ff00ff":"#553355",e.font="7px Courier New",e.fillText("PULSE"+(c>=1?" READY":""),32+P+4,59)}N(e,i,window._emotionalField||null),t.archetypeActive&&t.archetypeType?(e.fillStyle="#ffdd00",e.font="8px Courier New",e.fillText("[ARCH ACTIVE]",14,82)):h.shield&&h.shieldTimer>0?(e.fillStyle="#00ffff",e.font="8px Courier New",e.fillText("SHIELD×"+h.shieldTimer,14,82)):h.shieldCount>0&&(e.fillStyle="#334455",e.font="8px Courier New",e.fillText("streak "+h.shieldCount+"/3",14,82)),h.comboCount>1&&(e.fillStyle="#ffcc00",e.shadowColor="#ffcc00",e.shadowBlur=6,e.font="8px Courier New",e.fillText("COMBO ×"+h.resonanceMultiplier.toFixed(1),14,96),e.shadowBlur=0),e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=5,e.font="9px Courier New",e.fillText("◆×"+(window._insightTokens||0),14,108),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 19px Courier New",e.textAlign="center",e.fillText(String(t.score).padStart(7,"0"),i/2,36),e.shadowBlur=0,e.fillStyle="#222838",e.font="8px Courier New",e.fillText("SCORE",i/2,50);const b=f==="A"?"#ff0055":"#00aa55";e.fillStyle=b,e.shadowColor=b,e.shadowBlur=7,e.font="bold 10px Courier New",e.fillText("MTX·"+f,i/2-16,64),e.shadowBlur=0,e.textAlign="right",e.fillStyle="#445566",e.font="10px Courier New",e.fillText("LVL "+t.level,i-12,30),e.fillStyle="#005533",e.fillText("◈×"+t.peaceLeft,i-12,46),e.fillStyle="#223344",e.font="8px Courier New",e.fillText((window._dreamIdx+1||1)+"/10 DREAMS",i-12,72),e.textAlign="left",t.msg&&t.msgTimer>0&&(e.globalAlpha=Math.min(1,t.msgTimer/18),e.font="bold 16px Courier New",e.textAlign="center",e.fillStyle=t.msgColor,e.shadowColor=t.msgColor,e.shadowBlur=16,e.fillText(t.msg,i/2,d-16),e.textAlign="left",e.globalAlpha=1,e.shadowBlur=0,t.msgTimer--),e.fillStyle="#070714",e.fillRect(0,a-28,i,28),e.strokeStyle="rgba(255,255,255,0.03)",e.beginPath(),e.moveTo(0,a-28),e.lineTo(i,a-28),e.stroke();const S=m(window._purgDepth);e.font="bold 8px Courier New",e.textAlign="left",e.fillStyle=S.color,e.shadowColor=S.color,e.shadowBlur=5,e.fillText(S.name,14,a-11),e.shadowBlur=0,e.fillStyle="#1a1a2a",e.font="7px Courier New",e.textAlign="right",e.fillText("WASD SHIFT=MTX ESC=pause J R Q C",i-10,a-11),e.textAlign="left"}function Dt(e,t,i){for(const a of t)e.globalAlpha=a.a*(.5+.5*Math.sin(i*8e-4+a.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(a.x,a.y,a.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function Lt(e,t,i,a,o,r,d="grid"){e.fillStyle="#02020a",e.fillRect(0,0,t,i);for(let y=0;y<i;y+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,y,t,1);Dt(e,a,o),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",t/2,i/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",t/2,i/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",t/2,i/2-78);const f=d==="grid"?"⊞ GRID MODE":d==="shooter"?"◎ SHOOTER MODE":d.toUpperCase();e.fillStyle="#334455",e.font="10px Courier New",e.fillText("MODE: "+f+" (press M to change)",t/2,i/2-60);const h=i/2-40;lt.forEach((y,E)=>{const m=E===r,N=h+E*36;m&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-130,N-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(t/2-130,N-19,260,28)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.shadowColor=m?"#00ff88":"transparent",e.shadowBlur=m?8:0,e.font=m?"bold 14px Courier New":"12px Courier New",e.fillText(y,t/2,N),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  M mode",t/2,i-20),e.textAlign="left"}function Nt(e,t,i,a){e.fillStyle="#02020a",e.fillRect(0,0,t,i),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",t/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",t/2,68);const o=Math.min(q.length,6),r=Math.max(0,Math.min(a-Math.floor(o/2),q.length-o));for(let d=0;d<o;d++){const f=r+d,h=q[f],y=f===a,E=95+d*55;if(y&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(t/2-160,E-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(t/2-160,E-18,320,46)),e.fillStyle=y?"#00ff88":"#2a3a2a",e.font=y?"bold 12px Courier New":"11px Courier New",e.fillText(f+1+".  "+h.name,t/2,E),e.fillStyle=y?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(h.subtitle+"  ·  "+h.emotion,t/2,E+16),y&&h.archetype&&fe[h.archetype]){const m=fe[h.archetype];e.fillStyle="#665522",e.fillText("archetype: "+m.name+" — "+m.powerDesc,t/2,E+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",t/2,i-20),e.textAlign="left"}function Ht(e,t,i,a){e.fillStyle="#02020a",e.fillRect(0,0,t,i),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",t/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:nt,cur:R.gridSize},{label:"DIFFICULTY",opts:ft,cur:R.difficulty},{label:"PARTICLES",opts:["on","off"],cur:R.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((r,d)=>{const f=d===a,h=105+d*68;r.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(r.label,t/2,h)),r.opts.forEach((y,E)=>{const m=y===r.cur,N=t/2+(E-(r.opts.length-1)/2)*110,n=h+24;e.fillStyle=f&&m?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(N-44,n-16,88,24),e.strokeStyle=f&&m?"rgba(0,255,136,0.5)":m?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(N-44,n-16,88,24),e.fillStyle=m?"#00ff88":"#334455",e.shadowColor=m?"#00ff88":"transparent",e.shadowBlur=m?5:0,e.font=m?"bold 11px Courier New":"10px Courier New",e.fillText(y.toUpperCase(),N,n),e.shadowBlur=0}),f&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",t/2-154,h+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",t/2,i-20),e.textAlign="left"}function Ot(e,t,i,a){e.fillStyle="#02020a",e.fillRect(0,0,t,i),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",t/2,50),e.shadowBlur=0,a.length?a.slice(0,8).forEach((o,r)=>{const d=95+r*38,f=r===0?"◈":r===1?"◇":"·";e.fillStyle=r===0?"#ffdd00":r===1?"#aaaaaa":r===2?"#cc8833":"#334455",e.font=r<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${f}  ${String(o.score).padStart(7,"0")}   LVL${String(o.level).padStart(2,"0")}   ${o.dreamscape}   ${o.date}`,t/2,d)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",t/2,i/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",t/2,i-20),e.textAlign="left"}function Bt(e,t,i,a,o,r){e.fillStyle="#02020a",e.fillRect(0,0,t,i),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",t/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+o,t/2,68),se.forEach((d,f)=>{const h=f===a,y=r(d.id),E=o>=d.cost&&!y,m=92+f*48;h&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(t/2-155,m-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(t/2-155,m-14,310,40)),e.fillStyle=y?"#00ff88":E?"#00ccdd":"#334455",e.shadowColor=y?"#00ff88":h?"#00ccdd":"transparent",e.shadowBlur=h&&!y?5:0,e.font="bold 11px Courier New",e.fillText(d.name,t/2-55,m),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(d.desc,t/2-55,m+14),e.fillStyle=y?"#005533":E?"#006677":"#221122",e.font="10px Courier New",e.fillText(y?"OWNED":"◆×"+d.cost,t/2+88,m+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",t/2,i-20),e.textAlign="left"}function kt(e,t,i,a,o){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,t,i),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",t/2,i/2-80),e.shadowBlur=0,a&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(a.ds.name+"  ·  LEVEL "+a.level,t/2,i/2-58),e.fillStyle="#334455",e.fillText(a.ds.narrative,t/2,i/2-44)),st.forEach((r,d)=>{const f=d===o,h=i/2-14+d*36;f&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(t/2-110,h-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(t/2-110,h-18,220,26)),e.fillStyle=f?"#00ff88":"#334433",e.shadowColor=f?"#00ff88":"transparent",e.shadowBlur=f?6:0,e.font=f?"bold 13px Courier New":"12px Courier New",e.fillText(r,t/2,h),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",t/2,i-20),e.textAlign="left"}function Gt(e,t,i,a,o){const r=1-a.timer/220,d=r<.1?r/.1:r>.9?(1-r)/.1:1,f=a.ds||q[0];e.fillStyle=f.bgColor||"#02020a",e.fillRect(0,0,t,i);for(let h=0;h<7;h++){const y=(o*.02+h*t/7)%t;e.strokeStyle=`rgba(0,255,136,${.02*d})`,e.lineWidth=1,e.beginPath(),e.moveTo(y,0),e.lineTo(y-100,i),e.stroke()}if(e.globalAlpha=d,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(a.text,t/2,i/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+f.name,t/2,i/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(f.narrative,t/2,i/2+24),f.archetype&&fe[f.archetype]){const h=fe[f.archetype];e.fillStyle=h.glow,e.shadowColor=h.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+h.name,t/2,i/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function _t(e,t,i,a,o,r,d,f){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,t,i),e.textAlign="center";const h=a==null?void 0:a.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+((h==null?void 0:h.name)||"THE VOID"),t/2,i/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",t/2,i/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(a.score).padStart(7,"0"),t/2,i/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+a.level,t/2,i/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+r.length+"/"+q.length,t/2,i/2+14),e.fillText("REP "+(f>=0?"+":"")+f+"  ·  ◆×"+d,t/2,i/2+32),o.length>0){const E=o.findIndex(m=>m.score===a.score);E>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(E+1)+" ALL TIME",t/2,i/2+54))}const y=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*y})`,e.fillRect(t/2-110,i/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*y})`,e.strokeRect(t/2-110,i/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",t/2,i/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",t/2,i/2+120),e.textAlign="left"}const _e=[{id:"joy",display:"Joy",valence:1,arousal:.7,coherence:.9},{id:"hope",display:"Hope",valence:.8,arousal:.5,coherence:.8},{id:"trust",display:"Trust",valence:.7,arousal:.4,coherence:.85},{id:"surprise",display:"Surprise",valence:.2,arousal:1,coherence:.5},{id:"fear",display:"Fear",valence:-.7,arousal:.9,coherence:.2},{id:"sadness",display:"Sadness",valence:-1,arousal:.3,coherence:.3},{id:"disgust",display:"Disgust",valence:-.8,arousal:.6,coherence:.1},{id:"anger",display:"Anger",valence:-.9,arousal:.8,coherence:.15},{id:"shame",display:"Shame",valence:-.95,arousal:.5,coherence:.05},{id:"anticipation",display:"Anticipation",valence:.3,arousal:.8,coherence:.6}],Ft=[{id:"FOCUSED_FORCE",label:"Focused Force",test:e=>e.coherence>.8&&e.valence>.5},{id:"CHAOS_BURST",label:"Chaos Burst",test:e=>e.distortion>.7&&e.coherence<.3},{id:"DEEP_INSIGHT",label:"Deep Insight",test:e=>e.coherence>.9&&e.valence>.7},{id:"NUMBNESS",label:"Numbness",test:e=>e.valence<-.7&&e.coherence<.2},{id:"SERENITY",label:"Serenity",test:e=>e.valence>.8&&e.coherence>.8},{id:"TURBULENCE",label:"Turbulence",test:e=>e.distortion>.5&&e.valence<0},{id:"EQUILIBRIUM",label:"Equilibrium",test:e=>Math.abs(e.valence)<.1&&e.coherence>.7}],Fe=[{id:"MIND",label:"Mind",test:e=>e.purgDepth<.2},{id:"PURGATORY",label:"Purgatory",test:e=>e.purgDepth>=.2&&e.purgDepth<.5},{id:"IMAGINATION",label:"Imagination",test:e=>e.purgDepth>=.5&&e.purgDepth<.7},{id:"HEAVEN",label:"Heaven",test:e=>e.purgDepth>=.7&&e.valence>.5},{id:"HELL",label:"Hell",test:e=>e.purgDepth>=.7&&e.valence<=.5}];class et{constructor(t={}){this.emotions={},_e.forEach(i=>{this.emotions[i.id]=typeof t[i.id]=="number"?t[i.id]:0}),this.lastUpdate=Date.now(),this.weekdayCoherenceMul=1}getEmotionArray(){return _e.map(t=>({...t,value:this.emotions[t.id]}))}getDominantEmotion(){return this.getEmotionArray().reduce((a,o)=>a.value>o.value?a:o)}get valence(){let t=this.getEmotionArray(),i=t.reduce((o,r)=>o+r.value*r.valence,0),a=t.reduce((o,r)=>o+r.value,0)||1;return i/a}get coherence(){let t=this.getEmotionArray(),i=t.reduce((o,r)=>o+r.value*r.coherence,0),a=t.reduce((o,r)=>o+r.value,0)||1;return i/a}get distortion(){let t=this.getEmotionArray();return t.reduce((a,o)=>a+o.value*o.arousal*(1-o.coherence),0)/t.length}get purgDepth(){return Math.max(0,Math.min(1,this.distortion))}get synergy(){for(let t of Ft)if(t.test(this))return t;return null}get realm(){for(let t of Fe)if(t.test(this))return t;return Fe[0]}decay(t=null){let i=Date.now(),a=t||(i-this.lastUpdate)/1e3;this.lastUpdate=i;let o=.05*this.weekdayCoherenceMul;for(let r in this.emotions)this.emotions[r]>0?this.emotions[r]=Math.max(0,this.emotions[r]-o*a):this.emotions[r]<0&&(this.emotions[r]=Math.min(0,this.emotions[r]+o*a))}setEmotion(t,i){this.emotions.hasOwnProperty(t)&&(this.emotions[t]=Math.max(-1,Math.min(1,i)))}addEmotion(t,i){this.emotions.hasOwnProperty(t)&&this.setEmotion(t,this.emotions[t]+i)}setAll(t){for(let i in t)this.setEmotion(i,t[i])}toJSON(){return{...this.emotions}}fromJSON(t){for(let i in t)this.setEmotion(i,t[i])}}const Ut=new Date("2025-01-29").getTime(),ge=29.53*24*60*60*1e3,Ue=[{name:"New Moon",fraction:0,insightMul:1,enemyMul:.85,desc:"Seed — quiet spawns, tutorial-friendly"},{name:"Waxing Crescent",fraction:.13,insightMul:1.1,enemyMul:.9,desc:"Build — gentle challenge increase"},{name:"First Quarter",fraction:.25,insightMul:1.2,enemyMul:1,desc:"Momentum — balanced tension"},{name:"Waxing Gibbous",fraction:.38,insightMul:1.3,enemyMul:1.1,desc:"Amplify — insight tokens more common"},{name:"Full Moon",fraction:.5,insightMul:1.5,enemyMul:1.2,desc:"Illuminate — peak clarity and challenge"},{name:"Waning Gibbous",fraction:.63,insightMul:1.2,enemyMul:1.1,desc:"Release — pruning, closure rewards"},{name:"Last Quarter",fraction:.75,insightMul:1.1,enemyMul:1,desc:"Reflect — integration, story fragments"},{name:"Waning Crescent",fraction:.88,insightMul:1,enemyMul:.9,desc:"Rest — soft spawns, dreamscape teasers"}],Vt=[{planet:"Sun",coherenceMul:1.2,insightMul:1.1,themes:["Radiance","Will","Clarity"],desc:"Visibility bonuses, coherence stabilisation"},{planet:"Moon",coherenceMul:1.1,insightMul:1.05,themes:["Dream","Tide","Reflection"],desc:"Dreamscape bias, softer soundscape"},{planet:"Mars",coherenceMul:.85,insightMul:1.2,themes:["Trial","Courage","Initiation"],desc:"Enemies more aggressive, higher rewards"},{planet:"Mercury",coherenceMul:1.05,insightMul:1.35,themes:["Signal","Learning","Pathfinding"],desc:"Insight tokens more common, puzzles"},{planet:"Jupiter",coherenceMul:1.15,insightMul:1.25,themes:["Expansion","Wisdom","Fortune"],desc:"Map grows, upgrade shop richer"},{planet:"Venus",coherenceMul:1.25,insightMul:1.15,themes:["Harmony","Beauty","Love"],desc:"Healing nodes, softer hazards"},{planet:"Saturn",coherenceMul:.9,insightMul:1,themes:["Structure","Limits","Discipline"],desc:"Walls and boundaries, planning bonuses"}];function Wt(){return((Date.now()-Ut)%ge+ge)%ge/ge}function Ve(){const e=Wt();let t=Ue[0];for(const i of Ue)e>=i.fraction&&(t=i);return t}function We(){const e=new Date().getDay();return Vt[e]}class zt{constructor(){this._lunar=Ve(),this._planet=We(),this._lastRefresh=0}refresh(){this._lunar=Ve(),this._planet=We(),this._lastRefresh=Date.now()}getLunarPhase(){return this._lunar}getPlanetaryDay(){return this._planet}getEnemyMul(){const t=this._lunar.enemyMul,i=this._planet.planet==="Mars"?.1:0;return t+i}getInsightMul(){return this._lunar.insightMul*(this._planet.insightMul??1)}getCoherenceMul(){return this._planet.coherenceMul??1}getModifiers(){return{enemyMul:this.getEnemyMul(),insightMul:this.getInsightMul(),coherenceMul:this.getCoherenceMul(),lunarName:this._lunar.name,planetName:this._planet.planet,lunarDesc:this._lunar.desc,planetDesc:this._planet.desc,themes:this._planet.themes}}}const ve=new zt;class Yt{constructor(){this.activeDirection=null,this.holdStartTime=0,this.holdDuration=1e3,this.isHazard=!1,this.cancelled=!1}isHazardTile(t){return[1,2,3,8,9,14,16].includes(t)}startMove(t,i,a){return this.activeDirection=t,this.holdStartTime=a,this.isHazard=this.isHazardTile(i),this.cancelled=!1,this.isHazard?{ready:!1,progress:0}:{ready:!0,progress:1}}update(t){if(!this.activeDirection||this.cancelled)return{ready:!1,progress:0,cancelled:this.cancelled};if(!this.isHazard)return{ready:!0,progress:1,cancelled:!1};const i=t-this.holdStartTime,a=Math.min(1,i/this.holdDuration);return{ready:a>=1,progress:a,cancelled:!1}}cancel(){this.cancelled=!0,this.activeDirection=null,this.holdStartTime=0,this.isHazard=!1}reset(){this.activeDirection=null,this.holdStartTime=0,this.isHazard=!1,this.cancelled=!1}getProgress(){if(!this.activeDirection||!this.isHazard||this.cancelled)return 0;const t=Date.now()-this.holdStartTime;return Math.min(1,t/this.holdDuration)}isHolding(){return this.activeDirection!==null&&!this.cancelled&&this.isHazard}}class qt{constructor(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}calculateHPDelta(t,i){const a=i.dmgMul||1,o=i.healMul||1;switch(t){case 1:return-8*a;case 2:return-12*a;case 3:return-15*a;case 4:return 5*o;case 8:return-10*a;case 9:return-6*a;case 14:return-20*a;case 16:return-18*a;default:return 0}}update(t,i,a=3){if(!t||!i){this.active=!1,this.ghostPath=[];return}this.active=!0,this.direction=t,this.ghostPath=[];const[o,r]=t;let d=i.hp,f=i.player.y,h=i.player.x;const y=i.sz;for(let E=0;E<a;E++){const m=f+o,N=h+r;if(m<0||m>=y||N<0||N>=y)break;const n=i.grid[m][N];if(n===5)break;const w=this.calculateHPDelta(n,i);d+=w,this.ghostPath.push({y:m,x:N,tile:n,hpDelta:w,projectedHP:d}),f=m,h=N}this.projectedHP=d}deactivate(){this.active=!1,this.direction=null,this.ghostPath=[],this.projectedHP=0}getGhostPath(){return this.active?this.ghostPath:[]}getTotalDelta(t){return!this.active||this.ghostPath.length===0?0:this.projectedHP-t}isActive(){return this.active&&this.ghostPath.length>0}}class $t{constructor(t){this.modes=new Map,this.instances=new Map,this.currentMode=null,this.currentModeName=null,this.sharedSystems=t,this.config={}}registerMode(t,i){this.modes.has(t)&&console.warn(`Mode '${t}' already registered, overwriting`),this.modes.set(t,i)}getModeInstance(t){if(!this.modes.has(t))return console.error(`Mode '${t}' not registered`),null;if(!this.instances.has(t)){const i=this.modes.get(t),a=new i(this.sharedSystems);this.instances.set(t,a)}return this.instances.get(t)}switchMode(t,i={}){const a=this.getModeInstance(t);return a?(this.currentMode&&this.currentMode.cleanup(),this.currentMode=a,this.currentModeName=t,this.config[t]=i,this.currentMode.init(i),console.log(`[ModeManager] Switched to mode: ${t}`),!0):!1}getCurrentModeName(){return this.currentModeName}getCurrentMode(){return this.currentMode}update(t,i,a,o){return this.currentMode?this.currentMode.update(t,i,a,o):null}render(t,i,a){this.currentMode&&this.currentMode.render(t,i,a)}handleInput(t,i,a){return this.currentMode?this.currentMode.handleInput(t,i,a):!1}getAvailableModes(){return Array.from(this.modes.keys())}hasMode(t){return this.modes.has(t)}getState(){const t={currentMode:this.currentModeName,configs:this.config,modeStates:{}};for(const[i,a]of this.instances.entries())t.modeStates[i]=a.getState();return t}restoreState(t){if(t){if(this.config=t.configs||{},t.modeStates)for(const[i,a]of Object.entries(t.modeStates)){const o=this.getModeInstance(i);o&&o.restoreState(a)}if(t.currentMode){const i=this.config[t.currentMode]||{};this.switchMode(t.currentMode,i)}}}notifyEmotionChange(t){for(const i of this.instances.values())i.isActive&&i.onEmotionChange(t)}notifyTemporalUpdate(t){for(const i of this.instances.values())i.isActive&&i.onTemporalUpdate(t)}}class tt{constructor(t){this.emotionalField=t.emotionalField,this.temporalSystem=t.temporalSystem,this.sfxManager=t.sfxManager,this.impulseBuffer=t.impulseBuffer,this.consequencePreview=t.consequencePreview,this.name="base",this.isActive=!1}init(t){this.isActive=!0}update(t,i,a,o){return null}render(t,i,a){}handleInput(t,i,a){return!1}cleanup(){this.isActive=!1}getState(){return{name:this.name}}restoreState(t){}getConfigOptions(){return[]}onEmotionChange(t){}onTemporalUpdate(t){}}class Zt extends tt{constructor(t){super(t),this.name="grid",this.game=null,this.lastMove=0,this.glitchFrames=0,this.glitchTimer=500,this.anomalyActive=!1,this.anomalyData={row:-1,col:-1,t:0},this.hallucinations=[],this.backgroundStars=[],this.visions=[],this.interludeState={text:"",subtext:"",timer:0,ds:null}}init(t){super.init(t),this.startGame(t.dreamIdx||0,t.prevScore,t.prevLevel,t.prevHp),this.initStars(oe(),le()),this.spawnVisions(oe(),le())}startGame(t,i=0,a=0,o=void 0){R.dreamIdx=t||0;const r=(a||0)+1,d=q[R.dreamIdx%q.length];Oe(d.matrixDefault),this.game=Mt(d,Ce(),r,i,o,u.maxHp,window._dreamHistory||[]),this.spawnVisions(oe(),le()),this.hallucinations=[],this.glitchTimer=500+I(500),this.initStars(oe(),le()),this.lastMove=0,be(0),window._game=this.game,window._insightTokens=$,window._dreamIdx=R.dreamIdx}initStars(t,i){this.backgroundStars=[];for(let a=0;a<30;a++)this.backgroundStars.push({x:Math.random()*t,y:Math.random()*i,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}spawnVisions(t,i){const a=["EMERGE","DISSOLVE","REMEMBER","FORGET","AWAKEN","DREAM","HEAL","FLOW"];this.visions=[];for(let o=0;o<5;o++)this.visions.push({text:de(a),x:40+Math.random()*(t-80),y:90+Math.random()*(i-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+I(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}update(t,i,a,o){var A,P,L,b;if(!this.game)return null;const r=this.game,d=r.slowMoves?u.moveDelay*1.5:u.moveDelay,f={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};if(o-this.lastMove>d){for(const[S,[c,T]]of Object.entries(f))if(i.has(S)){bt(r,c,T,a,()=>this.nextDreamscape(),(l,M,D)=>{r&&(r.msg=l,r.msgColor=M,r.msgTimer=D)},$,l=>{for(;$<l;)dt();window._insightTokens=$}),this.lastMove=o;break}}const h=this.temporalSystem.getModifiers(),y=(a==="B"?1.2:.7)*h.coherenceMul;this.emotionalField.decay(t/1e3*y),window._tmods=h,u.emotion=this.emotionalField.getDominantEmotion().id,r.slowMoves=u.emotion==="hopeless"||u.emotion==="despair",r.temporalEnemyMul=h.enemyMul,r.insightMul=h.insightMul;const E=((P=(A=this.emotionalField).getDistortion)==null?void 0:P.call(A))??.45,N=(1-(((b=(L=this.emotionalField).getValence)==null?void 0:b.call(L))??0))/2;let n=E*.7+N*.3;a==="A"?n=Math.min(1,n*1.2):n=n*.85,ct(Math.max(0,Math.min(1,n))),window._purgDepth=ae,r.purgDepth=ae,r.dmgMul=ae>=.8?1.3:ae>=.5?1.15:1,r.healMul=ae<=.2?1.25:ae<=.35?1.1:1,ht(t),a==="B"&&ce>4e3&&Math.random()<2e-4*t&&(r.hp=Math.min(u.maxHp,r.hp+1)),a==="A"&&ce>2500&&Math.random()<3e-4*t&&(r.hp=Math.max(0,r.hp-1)),this.glitchTimer-=t,this.glitchTimer<=0&&(this.glitchFrames=2+I(4),this.glitchTimer=500+I(700)),this.anomalyActive&&(this.anomalyData.t--,this.anomalyData.t<=0&&(this.anomalyActive=!1)),r.environmentTimer-=t,r.environmentTimer<=0&&(r.environmentTimer=900+I(700),Math.random()<.6&&this.triggerEnvironmentEvent(r)),Rt(r,t);const w=(S,c,T)=>{r&&(r.msg=S,r.msgColor=c,r.msgTimer=T)};return At(r,t,i,a,this.hallucinations,w,Se),r.hp<=0?{phase:"dead",data:{game:r}}:null}render(t,i,a){this.game&&Pt(t,i,this.game,me,this.backgroundStars,this.visions,this.hallucinations,this.anomalyActive,this.anomalyData,this.glitchFrames,a.DPR||1)}handleInput(t,i,a){if(i!=="keydown"||!this.game)return!1;const o=this.game,r=(d,f,h)=>{o&&(o.msg=d,o.msgColor=f,o.msgTimer=h)};if(t==="Shift"&&!a.repeat){const d=me==="A"?"B":"A";Oe(d),be(0),this.sfxManager.playMatrixSwitch(d==="A");const f=d==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",h=d==="A"?"#ff0055":"#00ff88";return r(f,h,55),R.particles&&z(o,o.player.x,o.player.y,h,22,4),!0}return(t==="j"||t==="J")&&!a.repeat?(o.archetypeActive?(Ge(o),this.sfxManager.playArchetypePower()):u.temporalRewind&&u.rewindBuffer.length>0?(Ge(o),this.sfxManager.playArchetypePower()):r("NO ARCHETYPE ACTIVE","#334455",25),!0):(t==="r"||t==="R")&&!a.repeat?(u.glitchPulse&&u.glitchPulseCharge>=100?Ct(o,r):u.glitchPulse?r("CHARGING… "+Math.round(u.glitchPulseCharge)+"%","#660088",22):r("BUY GLITCH PULSE IN UPGRADES","#334455",28),!0):(t==="q"||t==="Q")&&!a.repeat?(u.freeze&&u.freezeTimer<=0&&(u.freezeTimer=2500,r("FREEZE ACTIVE!","#0088ff",50),z(o,o.player.x,o.player.y,"#0088ff",20,4)),!0):(t==="c"||t==="C")&&!a.repeat?($>=2?(Ze(2),window._insightTokens=$,o.contZones||(o.contZones=[]),o.contZones.push({x:o.player.x,y:o.player.y,timer:240,maxTimer:240}),r("CONTAINMENT ZONE","#00ffcc",38)):r("NEED 2 ◆ FOR CONTAINMENT","#334455",28),!0):!1}nextDreamscape(){const t=this.game,i=(R.dreamIdx+1)%q.length;return R.dreamIdx=i,window._dreamIdx=i,ut(t.ds.id),this.interludeState={text:t.ds.completionText,subtext:q[i].narrative,timer:220,ds:q[i]},{phase:"interlude",data:{interludeState:this.interludeState}}}triggerEnvironmentEvent(t){const i=t.ds.environmentEvent,a=t.sz;if(!i)return;const o=(r,d,f)=>{t.msg=r,t.msgColor=d,t.msgTimer=f};if(i==="gravity_shift"){const[r,d]=de([[-1,0],[1,0],[0,-1],[0,1]]),f=t.player.y+r,h=t.player.x+d;f>=0&&f<a&&h>=0&&h<a&&t.grid[f][h]!==5&&(t.player.y=f,t.player.x=h,o("GRAVITY SHIFTS…","#8888ff",40))}else if(i==="loop_reset"){for(let r=-2;r<=2;r++)for(let d=-2;d<=2;d++){const f=t.player.y+r,h=t.player.x+d;f>=0&&f<a&&h>=0&&h<a&&t.grid[f][h]===0&&Math.random()<.25&&(t.grid[f][h]=8)}o("THE LOOP TIGHTENS…","#ff8800",40)}else if(i==="capture_zones"){const r=de(t.enemies);r&&(t.captureZones=[{x:r.x,y:r.y,r:2,timer:300}]),o("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(i==="rapid_spawn"){if(t.enemies.length<10){const r=2+I(a-4),d=2+I(a-4);t.enemies.push({y:r,x:d,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:r,prevX:d,momentum:[0,0],type:"rush"}),o("CHAOS ERUPTS!","#ff0044",40)}}else if(i==="wall_phase"){let r=0;for(let d=0;d<a&&r<4;d++)for(let f=0;f<a&&r<4;f++)t.grid[d][f]===5&&Math.random()<.3&&(t.grid[d][f]=10,r++);o("MEMBRANE DISSOLVES…","#00ccff",40)}else if(i==="glide_nodes"){let r=0,d=0;for(;r<2&&d<999;){d++;const f=I(a),h=I(a);t.grid[f][h]===0&&(t.grid[f][h]=12,r++)}o("GLIDE NODES APPEAR","#00aaff",40)}else if(i==="mashup"){const r=de(q.filter(d=>d.id!==t.ds.id));if(r.hazardSet[0]){let d=0,f=0;for(;d<3&&f<999;){f++;const h=I(a),y=I(a);t.grid[h][y]===0&&(t.grid[h][y]=r.hazardSet[0],d++)}}o("DREAMSCAPES MERGE…","#ffaaff",40)}if(Math.random()<.4){const r=I(a);for(let d=0;d<a;d++)t.grid[r][d]===1?t.grid[r][d]=4:t.grid[r][d]===4&&Math.random()<.3&&(t.grid[r][d]=1);this.anomalyData={row:r,col:-1,t:50},this.anomalyActive=!0}}cleanup(){super.cleanup(),this.game=null,window._game=null}getState(){return{name:this.name,game:this.game,dreamIdx:R.dreamIdx}}}class jt extends tt{constructor(t){super(t),this.name="shooter",this.player={x:0,y:0,vx:0,vy:0,angle:0,health:100,maxHealth:100,speed:200,radius:15,score:0},this.bullets=[],this.fireRate=.25,this.timeSinceLastShot=0,this.bulletSpeed=400,this.bulletDamage=10,this.enemies=[],this.wave=1,this.enemiesPerWave=5,this.waveTimer=0,this.waveDelay=3,this.powerUps=[],this.activePowerUps=[],this.mouseX=0,this.mouseY=0,this.isShooting=!1,this.worldWidth=800,this.worldHeight=600,this.camera={x:0,y:0}}init(t={}){super.init(t),this.player.x=this.worldWidth/2,this.player.y=this.worldHeight/2,this.player.vx=0,this.player.vy=0,this.player.health=this.player.maxHealth,this.player.score=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps=[],this.wave=1,this.waveTimer=0,this.spawnWave(),this.timeSinceLastShot=0,console.log("[ShooterMode] Initialized")}update(t,i,a,o){const r=t/1e3;if(this.updatePlayerMovement(r,i),this.updateShooting(r),this.updateBullets(r),this.updateEnemies(r),this.updatePowerUps(r),this.checkCollisions(),this.updateWaveSpawning(r),this.updateCamera(),this.player.health<=0)return{phase:"dead",data:{score:this.player.score,mode:"shooter"}};const d=(this.bullets.length+this.enemies.length)/20;return this.emotionalField.decay(d),null}updatePlayerMovement(t,i){let a=0,o=0;if((i.has("w")||i.has("W")||i.has("ArrowUp"))&&(o-=1),(i.has("s")||i.has("S")||i.has("ArrowDown"))&&(o+=1),(i.has("a")||i.has("A")||i.has("ArrowLeft"))&&(a-=1),(i.has("d")||i.has("D")||i.has("ArrowRight"))&&(a+=1),a!==0&&o!==0){const r=Math.sqrt(a*a+o*o);a/=r,o/=r}this.player.vx=a*this.player.speed,this.player.vy=o*this.player.speed,this.player.x+=this.player.vx*t,this.player.y+=this.player.vy*t,this.player.x=Math.max(this.player.radius,Math.min(this.worldWidth-this.player.radius,this.player.x)),this.player.y=Math.max(this.player.radius,Math.min(this.worldHeight-this.player.radius,this.player.y))}updateShooting(t){this.timeSinceLastShot+=t,this.isShooting&&this.timeSinceLastShot>=this.fireRate&&(this.shoot(),this.timeSinceLastShot=0)}shoot(){const t=this.player.angle,i={x:this.player.x,y:this.player.y,vx:Math.cos(t)*this.bulletSpeed,vy:Math.sin(t)*this.bulletSpeed,damage:this.bulletDamage,radius:3,age:0,maxAge:2};this.bullets.push(i),this.sfxManager&&this.sfxManager.playMenuSelect()}updateBullets(t){for(let i=this.bullets.length-1;i>=0;i--){const a=this.bullets[i];a.x+=a.vx*t,a.y+=a.vy*t,a.age+=t,(a.age>a.maxAge||a.x<0||a.x>this.worldWidth||a.y<0||a.y>this.worldHeight)&&this.bullets.splice(i,1)}}updateEnemies(t){for(let i=this.enemies.length-1;i>=0;i--){const a=this.enemies[i],o=this.player.x-a.x,r=this.player.y-a.y,d=Math.sqrt(o*o+r*r);d>0&&(a.x+=o/d*a.speed*t,a.y+=r/d*a.speed*t),a.health<=0&&(this.enemies.splice(i,1),this.player.score+=10,Math.random()<.2&&this.spawnPowerUp(a.x,a.y))}}updatePowerUps(t){for(let i=this.powerUps.length-1;i>=0;i--){const a=this.powerUps[i];a.age+=t,a.age>10&&this.powerUps.splice(i,1)}for(let i=this.activePowerUps.length-1;i>=0;i--){const a=this.activePowerUps[i];a.timeLeft-=t,a.timeLeft<=0&&(this.deactivatePowerUp(a),this.activePowerUps.splice(i,1))}}checkCollisions(){for(let t=this.bullets.length-1;t>=0;t--){const i=this.bullets[t];for(let a=this.enemies.length-1;a>=0;a--){const o=this.enemies[a],r=i.x-o.x,d=i.y-o.y;if(Math.sqrt(r*r+d*d)<i.radius+o.radius){o.health-=i.damage,this.bullets.splice(t,1),this.sfxManager&&this.sfxManager.playEnemyHit();break}}}for(const t of this.enemies){const i=this.player.x-t.x,a=this.player.y-t.y,o=Math.sqrt(i*i+a*a);if(o<this.player.radius+t.radius&&(this.player.health-=t.damage*.016,o>0)){const r=i/o*50*.016,d=a/o*50*.016;this.player.x+=r,this.player.y+=d}}for(let t=this.powerUps.length-1;t>=0;t--){const i=this.powerUps[t],a=this.player.x-i.x,o=this.player.y-i.y;Math.sqrt(a*a+o*o)<this.player.radius+i.radius&&(this.collectPowerUp(i),this.powerUps.splice(t,1))}}spawnWave(){const t=this.enemiesPerWave+Math.floor(this.wave/2);for(let i=0;i<t;i++){const a=Math.floor(Math.random()*4);let o,r;switch(a){case 0:o=Math.random()*this.worldWidth,r=-20;break;case 1:o=this.worldWidth+20,r=Math.random()*this.worldHeight;break;case 2:o=Math.random()*this.worldWidth,r=this.worldHeight+20;break;case 3:o=-20,r=Math.random()*this.worldHeight;break}this.enemies.push({x:o,y:r,health:30+this.wave*5,maxHealth:30+this.wave*5,speed:50+this.wave*2,radius:12,damage:10})}console.log(`[ShooterMode] Wave ${this.wave} spawned: ${t} enemies`)}updateWaveSpawning(t){this.enemies.length===0?(this.waveTimer+=t,this.waveTimer>=this.waveDelay&&(this.wave++,this.waveTimer=0,this.spawnWave())):this.waveTimer=0}spawnPowerUp(t,i){const a=["health","speed","rapidfire","shield"],o=a[Math.floor(Math.random()*a.length)];this.powerUps.push({x:t,y:i,type:o,radius:10,age:0})}collectPowerUp(t){switch(this.sfxManager&&this.sfxManager.playPeaceCollect(),t.type){case"health":this.player.health=Math.min(this.player.maxHealth,this.player.health+30);break;case"speed":this.activePowerUps.push({type:"speed",timeLeft:5}),this.player.speed=300;break;case"rapidfire":this.activePowerUps.push({type:"rapidfire",timeLeft:5}),this.fireRate=.1;break;case"shield":this.activePowerUps.push({type:"shield",timeLeft:8});break}}deactivatePowerUp(t){switch(t.type){case"speed":this.player.speed=200;break;case"rapidfire":this.fireRate=.25;break}}updateCamera(){this.camera.x=this.player.x-400,this.camera.y=this.player.y-300}render(t,i,a){const o=t.canvas,r=o.width,d=o.height;t.fillStyle="#0a0a0f",t.fillRect(0,0,r,d),t.save(),t.translate(-this.camera.x,-this.camera.y),t.strokeStyle="#333",t.lineWidth=2,t.strokeRect(0,0,this.worldWidth,this.worldHeight);for(const f of this.powerUps)this.drawPowerUp(t,f);t.fillStyle="#00ffff";for(const f of this.bullets)t.beginPath(),t.arc(f.x,f.y,f.radius,0,Math.PI*2),t.fill();for(const f of this.enemies)this.drawEnemy(t,f);this.drawPlayer(t),t.restore(),this.drawHUD(t,r,d)}drawPlayer(t){const i=this.player;t.fillStyle="#00ff88",t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.PI*2),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x+Math.cos(i.angle)*(i.radius+5),i.y+Math.sin(i.angle)*(i.radius+5)),t.stroke()}drawEnemy(t,i){t.fillStyle="#ff3366",t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.PI*2),t.fill();const a=i.radius*2,o=3,r=i.health/i.maxHealth;t.fillStyle="#333",t.fillRect(i.x-a/2,i.y-i.radius-8,a,o),t.fillStyle="#00ff00",t.fillRect(i.x-a/2,i.y-i.radius-8,a*r,o)}drawPowerUp(t,i){const a={health:"#00ff00",speed:"#ffff00",rapidfire:"#ff8800",shield:"#0088ff"};t.fillStyle=a[i.type]||"#ffffff",t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.PI*2),t.fill();const o=Math.sin(i.age*5)*3;t.strokeStyle=a[i.type]||"#ffffff",t.lineWidth=2,t.beginPath(),t.arc(i.x,i.y,i.radius+o,0,Math.PI*2),t.stroke()}drawHUD(t,i,a){t.fillStyle="#ffffff",t.font="16px monospace";const o=Math.max(0,this.player.health/this.player.maxHealth);t.fillStyle=o>.5?"#00ff00":o>.25?"#ffff00":"#ff0000",t.fillText(`HP: ${Math.ceil(this.player.health)}`,10,20),t.fillStyle="#ffffff",t.fillText(`Score: ${this.player.score}`,10,40),t.fillText(`Wave: ${this.wave}`,10,60),t.fillText(`Enemies: ${this.enemies.length}`,10,80);let r=100;for(const d of this.activePowerUps)t.fillStyle="#ffff00",t.fillText(`${d.type.toUpperCase()}: ${Math.ceil(d.timeLeft)}s`,10,r),r+=20}handleInput(t,i,a){if(a&&a.type==="mousemove"){const o=a.target.getBoundingClientRect();this.mouseX=a.clientX-o.left+this.camera.x,this.mouseY=a.clientY-o.top+this.camera.y;const r=this.mouseX-this.player.x,d=this.mouseY-this.player.y;return this.player.angle=Math.atan2(d,r),!0}return i==="mousedown"?(this.isShooting=!0,!0):i==="mouseup"?(this.isShooting=!1,!0):!1}cleanup(){super.cleanup(),this.bullets=[],this.enemies=[],this.powerUps=[],this.activePowerUps=[],console.log("[ShooterMode] Cleaned up")}getState(){return{name:this.name,player:{...this.player},wave:this.wave,score:this.player.score}}restoreState(t){t.player&&(this.player={...this.player,...t.player}),t.wave&&(this.wave=t.wave)}}const ee=document.getElementById("c"),J=ee.getContext("2d"),ue=Math.min(window.devicePixelRatio||1,2);function Pe(){const e=oe(),t=le();ee.width=e*ue,ee.height=t*ue,ee.style.width=Math.min(e,window.innerWidth-16)+"px",ee.style.height="auto",J.setTransform(1,0,0,1,0,0),J.scale(ue,ue)}Pe();let W=null;window._game=W;let Z=null,ze=0;window._insightTokens=$;window._dreamIdx=R.dreamIdx;window._temporalSystem=ve;let Xt=0,Jt=!1,Qt={row:-1,col:-1,t:0},Kt=[],Ee=[],xt=[],we={text:"",timer:0,ds:null},pe=new et;window._emotionalField=pe;let Ie=new Yt,De=new qt;window._impulseBuffer=Ie;window._consequencePreview=De;const te=new Set;window._keys=te;function ei(e,t){Ee=[];for(let i=0;i<30;i++)Ee.push({x:Math.random()*e,y:Math.random()*t,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}const it={emotionalField:pe,temporalSystem:ve,sfxManager:Q,impulseBuffer:Ie,consequencePreview:De},j=new $t(it);j.registerMode("grid",Zt);j.registerMode("shooter",jt);window._modeManager=j;function ti(e,t,i){const a=Qe();a.push({score:e,level:t,dreamscape:(i==null?void 0:i.name)||"?",date:new Date().toLocaleDateString()}),a.sort((r,d)=>d.score-r.score);const o=a.slice(0,8);je(o),gt(o)}function ne(e,t=null){mt(),pt(),pe=new et,window._emotionalField=pe,ve.refresh(),Ie.reset(),De.deactivate(),Q.resume(),it.emotionalField=pe;const i=t||C.selectedMode||"grid";Pe(),R.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=R.dreamIdx,j.switchMode(i,{dreamIdx:R.dreamIdx,prevScore:0,prevLevel:0,prevHp:void 0}),W=window._game,U("playing"),be(0),cancelAnimationFrame(Z),Z=requestAnimationFrame(X)}function ii(e){const t=se.find(i=>i.id===e);!t||$<t.cost||Xe(e)||(Ze(t.cost),window._insightTokens=$,e==="maxhp"&&(u.maxHp+=25,W&&(W.hp=Math.min(W.hp+25,u.maxHp))),e==="speed"&&(u.moveDelay=Math.max(55,u.moveDelay-15)),e==="magnet"&&(u.magnet=!0),e==="freeze"&&(u.freeze=!0),e==="aura"&&(u.aura=!0),e==="energy"&&(u.energyMax=Math.min(200,u.energyMax+30)),e==="rewind"&&(u.temporalRewind=!0),e==="pulse"&&(u.glitchPulse=!0))}function X(e){const t=e-ze;ze=e;const i=oe(),a=le();if(O==="title"){Lt(J,i,a,Ee,e,C.menu,C.selectedMode),Z=requestAnimationFrame(X);return}if(O==="dreamselect"){Nt(J,i,a,R.dreamIdx),Z=requestAnimationFrame(X);return}if(O==="options"){Ht(J,i,a,C.opt),Z=requestAnimationFrame(X);return}if(O==="highscores"){Ot(J,i,a,Te),Z=requestAnimationFrame(X);return}if(O==="upgrade"){Bt(J,i,a,C.shop,$,Xe),Z=requestAnimationFrame(X);return}if(O==="dead"){_t(J,i,a,W,Te,Re,$,$e),Z=requestAnimationFrame(X);return}if(O==="paused"){kt(J,i,a,W,C.pause),Z=requestAnimationFrame(X);return}if(O==="interlude"){Gt(J,i,a,we,e),we.timer--,we.timer<=0&&O==="interlude"&&U("playing"),Z=requestAnimationFrame(X);return}const o=j.update(t,te,me,e);if(o){if(o.phase==="dead"){W=window._game,ti(W.score,W.level,W.ds),U("dead"),Z=requestAnimationFrame(X);return}else if(o.phase==="interlude"){we=o.data.interludeState,U("interlude"),setTimeout(()=>{const r=window._game,d=R.dreamIdx;Pe(),j.switchMode("grid",{dreamIdx:d,prevScore:r.score+400+r.level*60,prevLevel:r.level,prevHp:r.hp}),W=window._game,W.msg=q[d].name,W.msgColor="#ffdd00",W.msgTimer=90,O==="interlude"&&U("playing")},3600),Z=requestAnimationFrame(X);return}}j.render(J,e,{DPR:ue,backgroundStars:Ee,visions:xt,hallucinations:Kt,anomalyActive:Jt,anomalyData:Qt,glitchFrames:Xt}),Z=requestAnimationFrame(X)}window.addEventListener("keydown",e=>{if(te.add(e.key),O==="title"){if(e.key==="ArrowUp"&&(C.menu=(C.menu-1+5)%5,Q.playMenuNav()),e.key==="ArrowDown"&&(C.menu=(C.menu+1)%5,Q.playMenuNav()),e.key==="m"||e.key==="M"){const i=["grid","shooter"],a=i.indexOf(C.selectedMode);C.selectedMode=i[(a+1)%i.length],Q.playMenuNav(),console.log(`[Mode] Selected: ${C.selectedMode}`)}(e.key==="Enter"||e.key===" ")&&(Q.playMenuSelect(),C.menu===0?ne(R.dreamIdx):C.menu===1?U("dreamselect"):C.menu===2?(C.opt=0,U("options")):C.menu===3?U("highscores"):C.menu===4&&(C.shop=0,C.upgradeFrom="title",U("upgrade"))),e.preventDefault();return}if(O==="dreamselect"){e.key==="ArrowUp"&&(R.dreamIdx=(R.dreamIdx-1+q.length)%q.length),e.key==="ArrowDown"&&(R.dreamIdx=(R.dreamIdx+1)%q.length),e.key==="Enter"&&ne(R.dreamIdx),e.key==="Escape"&&U("title"),e.preventDefault();return}if(O==="options"){if(e.key==="ArrowUp"&&(C.opt=(C.opt-1+4)%4),e.key==="ArrowDown"&&(C.opt=(C.opt+1)%4),e.key==="ArrowLeft"||e.key==="ArrowRight"){const i=e.key==="ArrowLeft"?-1:1;if(C.opt===0){const a=["small","medium","large"].indexOf(R.gridSize);R.gridSize=["small","medium","large"][(a+i+3)%3]}else if(C.opt===1){const a=["easy","normal","hard"].indexOf(R.difficulty);R.difficulty=["easy","normal","hard"][(a+i+3)%3]}else C.opt===2&&(R.particles=!R.particles)}(e.key==="Enter"||e.key==="Escape")&&(C.opt===3||e.key==="Escape")&&U(W?"paused":"title"),e.preventDefault();return}if(O==="highscores"){(e.key==="Enter"||e.key==="Escape")&&U("title"),e.preventDefault();return}if(O==="upgrade"){e.key==="ArrowUp"&&(C.shop=(C.shop-1+se.length)%se.length),e.key==="ArrowDown"&&(C.shop=(C.shop+1)%se.length),e.key==="Enter"&&ii(se[C.shop].id),e.key==="Escape"&&U(C.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(O==="dead"){(e.key==="Enter"||e.key===" ")&&ne(R.dreamIdx),e.key==="Escape"&&(U("title"),C.menu=0),e.preventDefault();return}if(O==="paused"){e.key==="ArrowUp"&&(C.pause=(C.pause-1+4)%4),e.key==="ArrowDown"&&(C.pause=(C.pause+1)%4),e.key==="Enter"&&(C.pause===0?U("playing"):C.pause===1?(C.opt=0,U("options")):C.pause===2?(C.shop=0,C.upgradeFrom="paused",U("upgrade")):(U("title"),C.menu=0,W=null)),e.key==="Escape"&&U("playing"),e.preventDefault();return}O==="playing"&&(j.handleInput(e.key,"keydown",e)||e.key==="Escape"&&(C.pause=0,U("paused"))),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>te.delete(e.key));ee.addEventListener("mousemove",e=>{O==="playing"&&j.currentMode&&j.handleInput(null,"mousemove",e)});ee.addEventListener("mousedown",e=>{O==="playing"&&j.currentMode?j.handleInput(null,"mousedown",e):O==="title"&&ne(R.dreamIdx)});ee.addEventListener("mouseup",e=>{O==="playing"&&j.currentMode&&j.handleInput(null,"mouseup",e)});function Ae(e,t){const i=document.getElementById(e);if(!i)return;let a;i.addEventListener("touchstart",o=>{o.preventDefault(),te.add(t),O==="title"&&ne(R.dreamIdx),a=()=>te.delete(t)},{passive:!1}),i.addEventListener("touchend",o=>{o.preventDefault(),a&&a()},{passive:!1}),i.addEventListener("mousedown",()=>{te.add(t),O==="title"&&ne(R.dreamIdx)}),i.addEventListener("mouseup",()=>te.delete(t))}Ae("btn-up","ArrowUp");Ae("btn-down","ArrowDown");Ae("btn-left","ArrowLeft");Ae("btn-right","ArrowRight");je(Qe());ei(oe(),le());Z=requestAnimationFrame(X);
