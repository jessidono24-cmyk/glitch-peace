(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))i(f);new MutationObserver(f=>{for(const s of f)if(s.type==="childList")for(const y of s.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&i(y)}).observe(document,{childList:!0,subtree:!0});function r(f){const s={};return f.integrity&&(s.integrity=f.integrity),f.referrerPolicy&&(s.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?s.credentials="include":f.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(f){if(f.ep)return;f.ep=!0;const s=r(f);fetch(f.href,s)}})();const o={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},ee={[o.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[o.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[o.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[o.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[o.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[o.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[o.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[o.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[o.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[o.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[o.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[o.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[o.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[o.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[o.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[o.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[o.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},p=44,H=2,Ke={small:10,medium:13,large:17},Ge={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function Fe(e){const l={};for(const[r,i]of Object.entries(ee))l[r]={bg:i.bg,bd:i.bd,glow:i.glow};if(e)for(const[r,i]of Object.entries(e))Object.assign(l[r],i);return l}const Qe=Fe(null),xe=Fe({[o.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[o.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[o.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[o.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[o.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[o.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[o.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[o.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[o.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),ie={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},Y=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[o.DESPAIR,o.TERROR,o.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[o.DESPAIR,o.TERROR,o.HOPELESS],hazardCounts:[6,5,4],specialTiles:[o.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[o.RAGE,o.DESPAIR,o.GLITCH],hazardCounts:[5,6,5],specialTiles:[o.TRAP,o.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[o.TERROR,o.SELF_HARM,o.HOPELESS],hazardCounts:[4,3,5],specialTiles:[o.TELEPORT,o.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[o.TERROR,o.RAGE,o.HOPELESS,o.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[o.ARCHETYPE,o.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[o.DESPAIR,o.TERROR,o.SELF_HARM,o.PAIN],hazardCounts:[7,6,4,3],specialTiles:[o.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[o.TERROR,o.RAGE,o.GLITCH],hazardCounts:[6,5,4],specialTiles:[o.COVER,o.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[o.TRAP,o.RAGE,o.DESPAIR,o.TERROR],hazardCounts:[6,4,5,4],specialTiles:[o.TRAP,o.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[o.HOPELESS,o.DESPAIR,o.GLITCH],hazardCounts:[4,4,4],specialTiles:[o.TELEPORT,o.ARCHETYPE,o.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[o.DESPAIR,o.TERROR,o.RAGE,o.HOPELESS,o.SELF_HARM,o.GLITCH,o.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[o.ARCHETYPE,o.TELEPORT,o.INSIGHT,o.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],re=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],el=["memory…","choice…","echo…","void…","self…","signal…","fragment…","persist…","clarity…","dissolve…","boundary…","witness…","anchor…","pattern…","emergence…","dragon…","guide…","orb…","fear…","hope…"],ll=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],rl=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],ol=["small","medium","large"],al=["easy","normal","hard"],M={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let we=[],_e=0,Z=0,Te=[],Q="B",se=0;function ze(e){Q=e}function Ve(e){se=e}function il(e){se+=e}function tl(e=1){Z+=e}function Ue(e){Z=Math.max(0,Z-e)}function nl(e){Te.push(e)}function We(e){we=e}function fl(){_e=0,Z=0,Te=[],Q="B",se=0}const h={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function sl(){Object.assign(h,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function Ye(e){return{maxhp:h.maxHp>100,speed:h.moveDelay<120,magnet:h.magnet,freeze:h.freeze,aura:h.aura,energy:h.energyMax>100,rewind:h.temporalRewind,pulse:h.glitchPulse}[e]||!1}let B="title";function k(e){B=e}const R={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title"};function P(e){return Math.floor(Math.random()*e)}function fe(e){return e[P(e.length)]}function Ne(e,l,r){return Math.max(l,Math.min(r,e))}const Oe=[1,1,2,3,5,8,13,21,34,55,89];function dl(e){return Oe[Math.min(e,Oe.length-1)]}const Ze="glitch_peace_v4";function hl(e){try{localStorage.setItem(Ze+"_scores",JSON.stringify(e))}catch{}}function qe(){try{const e=localStorage.getItem(Ze+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Re(){return Ke[M.gridSize]}function pl(){return Ge[M.difficulty]}function $e(){return Re()*p+(Re()-1)*H}function de(){return $e()+48}function he(){return $e()+148}function ul(e){const l=Array.from({length:e},()=>new Array(e).fill(o.VOID)),r=Math.floor(e*e*.07);for(let i=0;i<r;i++){const f=1+P(e-2),s=1+P(e-2);l[f][s]=o.WALL}return l}function ne(e,l,r,i,f){let s=0,y=0;for(;s<l&&y<9999;){y++;const n=P(i),d=P(i);if(e[n][d]===o.VOID){if(n<2&&d<2)continue;e[n][d]=r,s++}}}function yl(e,l,r,i,f,s,y){const n=pl(),d=ul(l);d[0][0]=o.VOID,l>1&&(d[0][1]=o.VOID,d[1][0]=o.VOID);const m=dl(r+2)+(l-13>0?l-13:0),E=1+Math.floor(r/3);if(e.hazardSet.forEach((N,C)=>{const b=Math.round((e.hazardCounts[C]||4)*n.hazMul);ne(d,b,N,l)}),ne(d,m,o.PEACE,l),ne(d,E,o.INSIGHT,l),e.specialTiles.forEach(N=>ne(d,2,N,l)),y&&y.length>0&&ne(d,3,o.MEMORY,l),e.id==="aztec")for(let N=0;N<l*2;N++){const C=1+P(l-2),b=1+P(l-2);d[C][b]===o.VOID&&(d[C][b]=o.WALL)}const u=e.id==="bedroom"?2:e.id==="summit"?1:0,F=Math.min(e.enemyCount+Math.floor(r*.5)+u,10),t=Math.max(1,F+(M.difficulty==="hard"?2:M.difficulty==="easy"?-1:0)),A=[],T=Math.max(2,Math.floor(l/5));for(let N=0;N<t;N++){let C,b,D=0;do C=T+P(l-T*2),b=T+P(l-T*2),D++;while((d[C][b]!==o.VOID||C<2&&b<2)&&D<400);A.push({y:C,x:b,timer:P(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+P(3),prevY:C,prevX:b,momentum:[0,0],type:"hunter"})}let L=null;if(r>=6&&(e.id==="summit"||e.id==="integration")){const N=Math.floor(l/2),C=Math.floor(l/2);d[C][N]=o.VOID,L={y:C,x:N,hp:5+r,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:d,enemies:A,boss:L,sz:l,level:r,ds:e,player:{y:0,x:0},hp:f!==void 0?Math.min(s,f+25):s,score:i||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:m,insightLeft:E,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+P(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function V(e,l,r,i,f,s){if(!(!M.particles||!e))for(let y=0;y<f;y++){const n=Math.PI*2*y/f+Math.random()*.6,d=s*(.6+Math.random()*.8);e.particles.push({x:l*(p+H)+p/2,y:r*(p+H)+p/2,vx:Math.cos(n)*d,vy:Math.sin(n)*d-1,r:2+Math.random()*3,color:i,life:20+P(16),maxLife:36})}}function Se(e,l,r,i){!M.particles||!e||(e.resonanceWave={x:l*(p+H)+p/2,y:r*(p+H)+p/2,r:0,maxR:200,color:i,alpha:.55})}function Je(e,l){M.particles&&e.echos.push({x:e.player.x*(p+H)+p/2,y:e.player.y*(p+H)+p/2,life:30,maxLife:30,size:p*.38,color:l==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}function ml(e,l,r,i,f,s,y){const n=e,d=n.sz,m=Ge[M.difficulty];if(!n||n.hp<=0)return;if(h.freeze&&h.freezeTimer>0){h.freezeTimer-=l;return}const E=n.slowMoves?1.5:1,u=m.eSpeedBase-n.level*30,F=Math.max(m.eSpeedMin,u)*(i==="A"?.65:1)*E;if(n.level>=3){if(f.splice(0,f.length,...f.filter(t=>t.life>0)),Math.random()<6e-4*n.level&&f.length<3){const t=P(d),A=P(d);n.grid[t][A]===o.VOID&&f.push({y:t,x:A,timer:0,life:5e3+P(4e3)})}for(const t of f)if(t.life-=l,t.timer+=l,t.timer>450){t.timer=0;const A=n.player.x-t.x,T=n.player.y-t.y,L=T>0?1:T<0?-1:0,N=A>0?1:A<0?-1:0,C=t.y+L,b=t.x+N;C>=0&&C<d&&b>=0&&b<d&&(t.y=C,t.x=b),t.y===n.player.y&&t.x===n.player.x&&(n.hp=Math.max(0,n.hp-8),t.life=0,n.shakeFrames=4,n.flashColor="#8800ff",n.flashAlpha=.18,s("CHAOS PHANTOM!","#aa00ff",35))}}if(n.boss&&n.boss.hp>0){const t=n.boss;if(t.timer+=l,t.phaseTimer-=l,t.phaseTimer<=0&&(t.phase=t.phase==="chase"?"orbit":"chase",t.phaseTimer=400+P(300)),t.timer>280){t.timer=0;let A=n.player.x,T=n.player.y;n.level>=8&&(A+=r.has("ArrowRight")||r.has("d")?1:r.has("ArrowLeft")||r.has("a")?-1:0,T+=r.has("ArrowDown")||r.has("s")?1:r.has("ArrowUp")||r.has("w")?-1:0);const L=T-t.y,N=A-t.x,C=L>0?1:L<0?-1:0,b=N>0?1:N<0?-1:0;if(C&&t.y+C>=0&&t.y+C<d?t.y+=C:b&&t.x+b>=0&&t.x+b<d&&(t.x+=b),t.y===n.player.y&&t.x===n.player.x){const D=Math.round(40*m.dmgMul*(i==="A"?1.3:1));n.hp=Math.max(0,n.hp-D),n.shakeFrames=14,n.flashColor="#ff00aa",n.flashAlpha=.45,V(n,n.player.x,n.player.y,"#ff00aa",22,5),s("BOSS! -"+D,"#ff00aa",50)}}}for(const t of n.enemies){if(t.stunTimer>0){t.stunTimer-=l;continue}if(t.timer+=l,t.timer<F)continue;t.timer=0,t.prevY=t.y,t.prevX=t.x;const A=t.behavior||n.ds.enemyBehavior,T=n.player.x-t.x,L=n.player.y-t.y,N=Math.abs(T)+Math.abs(L);let C=!1;if(A==="wander"||N>d*.7){const b=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[D,w]of b){const g=t.y+D,a=t.x+w;if(g>=0&&g<d&&a>=0&&a<d&&n.grid[g][a]!==o.WALL){t.y=g,t.x=a,C=!0;break}}}else if(A==="patrol"){t.patrolAngle+=(Math.random()-.5)*.4;const b=Math.round(Math.sin(t.patrolAngle)),D=Math.round(Math.cos(t.patrolAngle)),w=t.y+Ne(b,-1,1),g=t.x+Ne(D,-1,1);if(w>=0&&w<d&&g>=0&&g<d&&n.grid[w][g]!==o.WALL&&(t.y=w,t.x=g,C=!0),N<5&&Math.random()<.7){const a=L>0?1:L<0?-1:0,S=T>0?1:T<0?-1:0,v=t.y+a,O=t.x+S;v>=0&&v<d&&O>=0&&O<d&&n.grid[v][O]!==o.WALL&&(t.y=v,t.x=O)}}else if(A==="orbit"){t.orbitAngle+=.25;const b=n.player.x+Math.round(Math.cos(t.orbitAngle)*t.orbitR),D=n.player.y+Math.round(Math.sin(t.orbitAngle)*t.orbitR),w=D-t.y>0?1:D-t.y<0?-1:0,g=b-t.x>0?1:b-t.x<0?-1:0;t.y+w>=0&&t.y+w<d&&t.x+g>=0&&t.x+g<d&&n.grid[t.y+w][t.x+g]!==o.WALL&&(t.y+=w,t.x+=g)}else if(A==="chase_fast"||A==="adaptive"||A==="predictive"){let b=n.player.x,D=n.player.y;A==="predictive"&&n.level>=7&&(b+=r.has("ArrowRight")||r.has("d")?1:r.has("ArrowLeft")||r.has("a")?-1:0,D+=r.has("ArrowDown")||r.has("s")?1:r.has("ArrowUp")||r.has("w")?-1:0);const w=b-t.x,g=D-t.y,a=Math.abs(g)>=Math.abs(w)?[[g>0?1:-1,0],[0,w>0?1:-1]]:[[0,w>0?1:-1],[g>0?1:-1,0]];for(const[S,v]of a){const O=t.y+S,I=t.x+v;if(O>=0&&O<d&&I>=0&&I<d&&n.grid[O][I]!==o.WALL){t.y=O,t.x=I,C=!0;break}}if(!C){const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[v,O]of S){const I=t.y+v,U=t.x+O;if(I>=0&&I<d&&U>=0&&U<d&&n.grid[I][U]!==o.WALL){t.y=I,t.x=U;break}}}}else if(A==="rush"){const b=Math.abs(L)>=Math.abs(T)?[[L>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[L>0?1:-1,0]];for(const[D,w]of b){const g=t.y+D,a=t.x+w;if(g>=0&&g<d&&a>=0&&a<d&&n.grid[g][a]!==o.WALL){t.y=g,t.x=a,C=!0;break}}if(!C){const D=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[w,g]of D){const a=t.y+w,S=t.x+g;if(a>=0&&a<d&&S>=0&&S<d&&n.grid[a][S]!==o.WALL){t.y=a,t.x=S;break}}}}else if(A==="scatter"){const b=Math.abs(L)>=Math.abs(T)?[[L>0?-1:1,0],[0,T>0?-1:1]]:[[0,T>0?-1:1],[L>0?-1:1,0]];for(const[D,w]of b){const g=t.y+D,a=t.x+w;if(g>=0&&g<d&&a>=0&&a<d&&n.grid[g][a]!==o.WALL){t.y=g,t.x=a,C=!0;break}}if(!C){const D=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[w,g]of D){const a=t.y+w,S=t.x+g;if(a>=0&&a<d&&S>=0&&S<d&&n.grid[a][S]!==o.WALL){t.y=a,t.x=S;break}}}}else{const b=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[D,w]of b){const g=t.y+D,a=t.x+w;if(g>=0&&g<d&&a>=0&&a<d&&n.grid[g][a]!==o.WALL){t.y=g,t.x=a;break}}}if(t.y===n.player.y&&t.x===n.player.x)if(h.shield&&h.shieldTimer>0)t.stunTimer=1300,s("SHIELD HELD!","#00ffcc",38),V(n,n.player.x,n.player.y,"#00ffcc",14,3);else{const b=Math.round(22*m.dmgMul*(i==="A"?1.3:1));n.hp=Math.max(0,n.hp-b),n.shakeFrames=8,n.flashColor="#ff2200",n.flashAlpha=.35,V(n,n.player.x,n.player.y,"#ff4400",16,4),t.stunTimer=900,h.shieldCount=0,h.comboCount=0,s("HIT! -"+b,"#ff4400",40),y(n,"panic")}for(const b of n.captureZones)Math.abs(t.x-n.player.x)<=b.r&&Math.abs(t.y-n.player.y)<=b.r&&(n.hp=Math.max(0,n.hp-5),s("CAPTURED!","#ff0044",25))}n.captureZones=n.captureZones.filter(t=>(t.timer--,t.timer>0))}function ye(e,l){h.emotion=l,h.emotionTimer=120,e.emotionTimer=120,e.slowMoves=l==="hopeless"||l==="despair"}function le(e,l,r,i){e&&(e.msg=l,e.msgColor=r,e.msgTimer=i)}function El(e,l,r){const i=ie[l];if(i){if(e.archetypeActive=!0,e.archetypeType=l,e.archetypeTimer=180,h.archetypePower=i.power,h.archetypeDuration=180,le(e,i.activationMsg,"#ffdd00",70),Se(e,e.player.x,e.player.y,"#ffdd00"),V(e,e.player.x,e.player.y,"#ffdd00",24,4),l==="child"){for(let f=0;f<e.sz;f++)for(let s=0;s<e.sz;s++)e.grid[f][s]===o.HIDDEN&&e.tileFlicker.push({y:f,x:s,t:200,reveal:!0});le(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}l==="protector"&&(h.shield=!0,h.shieldTimer=30,V(e,e.player.x,e.player.y,"#88ccff",20,5)),l==="orb"&&(h.phaseShift=!0,h.phaseTimer=15),l==="captor"&&(h.temporalRewind=!0,h.rewindBuffer=h.rewindBuffer.slice(-3))}}function He(e){const l=h.archetypePower;if(!l)return;const r=e.sz;if(l==="wall_jump")for(const[i,f]of[[-2,0],[2,0],[0,-2],[0,2]]){const s=e.player.y+i,y=e.player.x+f;if(s>=0&&s<r&&y>=0&&y<r&&e.grid[s][y]!==o.WALL){Je(e,"B"),e.player.y=s,e.player.x=y,V(e,y,s,"#ffaa00",16,3),le(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(l==="phase_walk")h.phaseShift=!0,h.phaseTimer=10,le(e,"ORB PHASE ACTIVE","#aaddff",35);else if(l==="rewind")if(h.rewindBuffer.length>0){const i=h.rewindBuffer.pop();if(e.player.y=i.y,e.player.x=i.x,i.grid)for(let f=0;f<r;f++)for(let s=0;s<r;s++)e.grid[f][s]=i.grid[f][s];V(e,e.player.x,e.player.y,"#ffaadd",20,3),le(e,"TEMPORAL REWIND","#ffaadd",40)}else le(e,"NO REWIND MEMORY","#443344",30);else if(l==="shield_burst"){h.shield=!0,h.shieldTimer=25;for(const i of e.enemies)i.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),V(e,e.player.x,e.player.y,"#88ccff",30,6),le(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function Al(e,l,r,i,f,s,y,n){const d=e.sz,m=e.player.y+l,E=e.player.x+r;if(m<0||m>=d||E<0||E>=d)return!1;const u=e.grid[m][E];if(u===o.WALL&&!(h.phaseShift&&h.phaseTimer>0)||u===o.HIDDEN&&i==="A"&&!h.phaseShift)return!1;if(h.temporalRewind&&h.rewindBuffer.length<8){const t=e.grid.map(A=>[...A]);h.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:t})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),Je(e,i),M.particles&&e.trail.push({x:e.player.x*(p+H)+p/2,y:e.player.y*(p+H)+p/2,life:14,maxLife:14,color:i==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=m,e.player.x=E,h.phaseShift&&h.phaseTimer>0&&(h.phaseTimer--,h.phaseTimer<=0&&(h.phaseShift=!1,s("PHASE FADED","#445566",25))),h.shield&&h.shieldTimer>0&&(h.shieldTimer--,h.shieldTimer<=0&&(h.shield=!1,s("SHIELD FADED","#445566",25))),i==="A"?h.energy=Math.max(0,h.energy-.9):h.energy=Math.min(h.energyMax,h.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,h.archetypePower=null));const F={dmgMul:M.difficulty==="hard"?1.45:M.difficulty==="easy"?.55:1};if(u===o.PEACE){const t=Math.round((150+e.level*20)*h.resonanceMultiplier);e.score+=t,e.hp=Math.min(h.maxHp,e.hp+20),e.grid[m][E]=o.VOID,e.peaceLeft--,V(e,E,m,h.particleColor,18,3.5),h.shieldCount++,h.comboCount++,h.resonanceMultiplier=Math.min(4,1+h.comboCount*.25),h.glitchPulseCharge=Math.min(100,h.glitchPulseCharge+15),h.comboCount>=3&&!h.shield?(h.shield=!0,h.shieldTimer=20,Se(e,E,m,"#00ffcc"),V(e,E,m,"#00ffcc",26,5),s("SHIELD ACTIVE! ×"+h.resonanceMultiplier.toFixed(1),"#00ffcc",55)):s("+PEACE +"+t+(h.comboCount>1?" ×"+h.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),ye(e,"peace"),e.peaceLeft===0&&f()}else if(u===o.INSIGHT){const t=Math.round((300+e.level*50)*h.resonanceMultiplier);e.score+=t,n(y+1),e.grid[m][E]=o.VOID,e.insightLeft--,V(e,E,m,"#00eeff",24,4),Se(e,E,m,"#00eeff"),s("INSIGHT ◆×"+(y+1),"#00eeff",60);for(let A=0;A<d;A++)for(let T=0;T<d;T++)e.grid[A][T]===o.HIDDEN&&e.tileFlicker.push({y:A,x:T,t:100,reveal:!0});ye(e,"clarity")}else if(u===o.ARCHETYPE)e.grid[m][E]=o.VOID,El(e,e.ds.archetype||"orb");else if(u===o.TELEPORT){let t=0,A=P(d),T=P(d);for(;(e.grid[A][T]!==o.VOID||A===m&&T===E)&&t<200;)A=P(d),T=P(d),t++;e.player.y=A,e.player.x=T,e.grid[m][E]=o.VOID,V(e,T,A,"#00aaff",16,3),s("LEAP!","#00aaff",30)}else if(u===o.COVER){s("COVER","#446688",20);for(const t of e.enemies)Math.abs(t.y-m)+Math.abs(t.x-E)<=2&&(t.stunTimer=600)}else if(u===o.MEMORY)e.grid[m][E]=o.VOID,e.score+=50,s("MEMORY ECHO…","#88bbaa",30),V(e,E,m,"#88bbaa",10,2);else if(ee[u]&&ee[u].dmg>0)if(h.shield&&h.shieldTimer>0)s("SHIELDED","#00ffcc",20);else{const t=ee[u];let A=Math.round(t.dmg*F.dmgMul*(i==="A"?1.25:1));if(u===o.RAGE&&t.push>0){const C=m+l*t.push,b=E+r*t.push;C>=0&&C<d&&b>=0&&b<d&&e.grid[C][b]!==o.WALL&&(e.player.y=C,e.player.x=b,s("-RAGE (pushed!)","#ff0066",40))}if(u===o.SELF_HARM&&(e.grid[m][E]=o.PAIN),u===o.HOPELESS&&ye(e,"hopeless"),u===o.DESPAIR&&Math.random()<.3){const C=[[1,0],[-1,0],[0,1],[0,-1]],[b,D]=fe(C),w=m+b,g=E+D;w>=0&&w<d&&g>=0&&g<d&&e.grid[w][g]===o.VOID&&(e.grid[w][g]=o.DESPAIR)}e.hp=Math.max(0,e.hp-A),e.shakeFrames=5;const T={[o.DESPAIR]:"#2244ff",[o.TERROR]:"#ff0000",[o.SELF_HARM]:"#660000",[o.RAGE]:"#ff0044",[o.HOPELESS]:"#004488",[o.GLITCH]:"#aa00ff",[o.TRAP]:"#ff8800",[o.PAIN]:"#440000"},L={[o.DESPAIR]:"#3355ff",[o.TERROR]:"#ff2222",[o.SELF_HARM]:"#880000",[o.RAGE]:"#ff0044",[o.HOPELESS]:"#004488",[o.GLITCH]:"#aa00ff",[o.TRAP]:"#ff8800",[o.PAIN]:"#440000"},N={[o.DESPAIR]:"-DESPAIR",[o.TERROR]:"-TERROR!",[o.SELF_HARM]:"-SELF·HARM",[o.RAGE]:"-RAGE",[o.HOPELESS]:"-HOPELESS",[o.GLITCH]:"-GLITCH",[o.TRAP]:"-TRAP",[o.PAIN]:"-PAIN"};e.flashColor=T[u]||"#ff0000",e.flashAlpha=.28,V(e,E,m,L[u]||"#ff2222",10,3),s((N[u]||"-HAZARD")+" -"+A,L[u]||"#ff3333",38),h.shieldCount=0,h.comboCount=0,h.resonanceMultiplier=1}return!0}function gl(e,l){if(!e||h.glitchPulseCharge<100)return;h.glitchPulseCharge=0;let r=0;for(let i=0;i<e.sz;i++)for(let f=0;f<e.sz;f++)Math.abs(i-e.player.y)+Math.abs(f-e.player.x)<=3&&ee[e.grid[i][f]]?.dmg>0&&(e.grid[i][f]=o.VOID,r++);for(const i of e.enemies)Math.abs(i.y-e.player.y)+Math.abs(i.x-e.player.x)<=4&&(i.stunTimer=1800);Se(e,e.player.x,e.player.y,"#aa00ff"),V(e,e.player.x,e.player.y,"#aa00ff",32,6),l("GLITCH PULSE! "+r+" CLEARED","#aa00ff",55)}function Sl(e,l){if(e.spreadTimer-=l,e.spreadTimer>0)return;e.spreadTimer=3e3+P(1e3);const r=e.sz,i=[];for(let f=0;f<r;f++)for(let s=0;s<r;s++){const y=e.grid[f][s];if((y===o.DESPAIR||y===o.HOPELESS)&&ee[y].spread)for(const[n,d]of[[1,0],[-1,0],[0,1],[0,-1]]){const m=f+n,E=s+d;m>=0&&m<r&&E>=0&&E<r&&e.grid[m][E]===o.VOID&&Math.random()<.2&&i.push({y:m,x:E,type:y})}}for(const f of i.slice(0,2))e.grid[f.y][f.x]=f.type}function cl(e){return e==="A"?xe:Qe}function Tl(e,l,r,i,f,s,y,n,d,m,E){const u=r;if(!u)return;const F=u.sz,t=F*p+(F-1)*H,A=t+48,T=t+148,L=cl(i),N=u.ds;e.clearRect(0,0,A,T),e.fillStyle=N.bgColor,e.fillRect(0,0,A,T);const C=e.createRadialGradient(A*.7,T*.3,0,A*.7,T*.3,A*.8);C.addColorStop(0,N.bgAccent+"33"),C.addColorStop(1,"transparent"),e.fillStyle=C,e.fillRect(0,0,A,T),i==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,A,T));for(let a=0;a<T;a+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,a,A,1);for(const a of f){const S=a.a*(.5+.5*Math.sin(l*8e-4+a.phase));e.globalAlpha=S,e.fillStyle="#ffffff",e.beginPath(),e.arc(a.x,a.y,a.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,m>0&&(e.fillStyle=`rgba(${i==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*T),A,2+Math.floor(Math.random()*4)));let b=0,D=0;u.shakeFrames>0&&(b=(Math.random()-.5)*9*(u.shakeFrames/10),D=(Math.random()-.5)*9*(u.shakeFrames/10),u.shakeFrames--);const w=(A-t)/2+b,g=100+D;for(const a of s)a.x+=a.dx,a.y+=a.dy,a.life--,a.life>a.maxLife*.85?a.alpha=Math.min(a.targetAlpha,(a.maxLife-a.life)/(a.maxLife*.15)*a.targetAlpha):a.life<a.maxLife*.15&&(a.alpha=Math.max(0,a.life/(a.maxLife*.15)*a.targetAlpha)),a.life<=0&&(a.life=200+Math.floor(Math.random()*400),a.maxLife=600),e.globalAlpha=a.alpha*(i==="A"?.7:1),e.fillStyle=i==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(a.text,a.x,a.y);e.globalAlpha=1,e.textAlign="left";for(let a=0;a<F;a++)for(let S=0;S<F;S++){const v=u.grid[a][S],O=u.tileFlicker.find(G=>G.y===a&&G.x===S),I=O&&O.reveal&&v===o.HIDDEN?o.INSIGHT:v,U=ee[I]||ee[o.VOID],K=L[I]||L[o.VOID],_=w+S*(p+H),W=g+a*(p+H);if(n&&(a===d.row||S===d.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):K.glow?(e.shadowColor=K.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=K.bg,e.beginPath(),e.roundRect(_,W,p,p,4),e.fill(),e.strokeStyle=K.bd,e.lineWidth=1,e.beginPath(),e.roundRect(_+.5,W+.5,p-1,p-1,4),e.stroke(),e.shadowBlur=0,I===o.PEACE){const G=(l*.05+a*6+S*4)%(p*2);if(G<p){const $=e.createLinearGradient(_,W+G-5,_,W+G+5);$.addColorStop(0,"rgba(0,255,140,0)"),$.addColorStop(.5,"rgba(0,255,140,0.45)"),$.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=$,e.fillRect(_,W,p,p)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(_+p/2,W+p/2,5+2*Math.sin(l*.006+S+a),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(I===o.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const G=l*.008+S*1.7+a*1.3;for(let $=0;$<4;$++){const te=G+$*Math.PI*.5,X=7+2*Math.sin(l*.005+$);e.fillStyle=$%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(_+p/2+Math.cos(te)*X,W+p/2+Math.sin(te)*X,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(I===o.ARCHETYPE){const G=.5+.5*Math.sin(l*.01+S+a);e.shadowColor="#ffdd00",e.shadowBlur=16*G,e.fillStyle=`rgba(255,220,0,${.15*G})`,e.fillRect(_,W,p,p),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",_+p/2,W+p/2+6),e.shadowBlur=0,e.textAlign="left"}if(I===o.TELEPORT){const G=.5+.5*Math.sin(l*.012+S*2+a);e.shadowColor="#00aaff",e.shadowBlur=12*G,e.fillStyle=`rgba(0,170,255,${.2*G})`,e.fillRect(_,W,p,p),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",_+p/2,W+p/2+5),e.shadowBlur=0,e.textAlign="left"}if(I===o.MEMORY){const G=.3+.3*Math.sin(l*.004+S+a);e.globalAlpha=.4+.2*G,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(_,W,p,p),e.globalAlpha=1}U.sym&&I!==o.VOID&&I!==o.WALL&&I!==o.PEACE&&I!==o.INSIGHT&&I!==o.ARCHETYPE&&I!==o.TELEPORT&&I!==o.HIDDEN&&I!==o.MEMORY&&(e.fillStyle=K.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(U.sym,_+p/2,W+p/2+5),e.globalAlpha=1,e.textAlign="left"),(I===o.PEACE||I===o.INSIGHT)&&h.magnet&&Math.abs(a-u.player.y)+Math.abs(S-u.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(_+2,W+2,p-4,p-4,4),e.stroke())}u.tileFlicker=u.tileFlicker.filter(a=>(a.t--,a.t>0));for(const a of u.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(a.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(w+a.x*(p+H)+p/2,g+a.y*(p+H)+p/2,(a.r+.5)*(p+H),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const a of u.echos)e.globalAlpha=a.life/a.maxLife*.55,e.fillStyle=a.color,e.beginPath(),e.arc(w+a.x,g+a.y,a.size*(a.life/a.maxLife),0,Math.PI*2),e.fill(),a.life--;if(u.echos=u.echos.filter(a=>a.life>0),e.globalAlpha=1,M.particles){for(const a of u.trail)e.globalAlpha=a.life/a.maxLife*.48,e.fillStyle=a.color,e.shadowColor=a.color,e.shadowBlur=4,e.beginPath(),e.arc(w+a.x,g+a.y,4*(a.life/a.maxLife),0,Math.PI*2),e.fill(),a.life--;u.trail=u.trail.filter(a=>a.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const a of y){if(a.life<=0)continue;const S=w+a.x*(p+H),v=g+a.y*(p+H),O=.3+.25*Math.sin(Date.now()*.006+a.x);e.globalAlpha=O,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(S+8,v+8,p-16,p-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",S+p/2,v+p/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const a of u.enemies){const S=w+a.x*(p+H),v=g+a.y*(p+H),O=.6+.4*Math.sin(l*.007+a.x*1.3),I=a.stunTimer>0,U=a.type==="rush",K=I?"#8888ff":U?"#ff0066":i==="A"?"#ff0044":"#ff4400";e.shadowColor=K,e.shadowBlur=14*O,e.fillStyle=I?"#1c1c44":U?"#4a0022":i==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(S+5,v+5,p-10,p-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=I?"#4444aa":U?"#ff0066":i==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(S+p/2,v+12),e.lineTo(S+p-12,v+p-12),e.lineTo(S+12,v+p-12),e.closePath(),e.fill(),e.fillStyle=I?"#6666cc":"#ffcc00",e.beginPath(),e.arc(S+p/2,v+p/2+2,4,0,Math.PI*2),e.fill()}if(u.boss&&u.boss.hp>0){const a=u.boss,S=w+a.x*(p+H),v=g+a.y*(p+H),O=.5+.5*Math.sin(l*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*O,e.fillStyle="#330022",e.beginPath(),e.roundRect(S+1,v+1,p-2,p-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(S+p/2,v+p/2,p*.3+4*O,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+a.hp,S+p/2,v+p/2+4),e.textAlign="left",e.shadowBlur=0}{const a=w+u.player.x*(p+H),S=g+u.player.y*(p+H),v=.55+.45*Math.sin(l*.009),O=h.shield&&h.shieldTimer>0,I=h.phaseShift&&h.phaseTimer>0,U=h.emotion,_=i==="A"?"#ff0088":O?"#00ffff":I?"#00aaff":U==="panic"?"#ff0022":U==="hopeless"?"#0033aa":U==="peace"?"#00ffcc":U==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=_,e.shadowBlur=(O?36:h.aura?30:22)*v;const W=i==="A"?"#aa0055":"#005533",G=i==="A"?"#cc0077":"#00cc77",$=i==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=W,e.beginPath(),e.roundRect(a+4,S+4,p-8,p-8,8),e.fill(),e.fillStyle=G,e.beginPath(),e.roundRect(a+9,S+9,p-18,p-18,5),e.fill(),e.fillStyle=$,e.beginPath(),e.roundRect(a+15,S+15,p-30,p-30,3),e.fill(),u.archetypeActive){const X=ie[u.archetypeType||"orb"];e.strokeStyle=X.glow,e.lineWidth=2,e.shadowColor=X.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(a+1,S+1,p-2,p-2,8),e.stroke()}O&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(a,S,p,p,8),e.stroke()),I&&(e.globalAlpha=.4),h.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*v})`,e.lineWidth=3,e.beginPath(),e.arc(a+p/2,S+p/2,(p/2+7)*v,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=_,e.lineWidth=2;const te=9;[[a,S],[a+p,S],[a,S+p],[a+p,S+p]].forEach(([X,pe],De)=>{const Le=De%2===0?1:-1,ve=De<2?1:-1;e.beginPath(),e.moveTo(X+Le*2,pe),e.lineTo(X+Le*(2+te),pe),e.stroke(),e.beginPath(),e.moveTo(X,pe+ve*2),e.lineTo(X,pe+ve*(2+te)),e.stroke()}),e.shadowBlur=0}if(M.particles){r.particles=r.particles.filter(a=>a.life>0);for(const a of r.particles)e.globalAlpha=Math.max(0,a.life/a.maxLife),e.fillStyle=a.color,e.shadowColor=a.color,e.shadowBlur=7,e.beginPath(),e.arc(w+a.x,g+a.y,a.r*(a.life/a.maxLife),0,Math.PI*2),e.fill(),a.x+=a.vx,a.y+=a.vy,a.vy+=.25,a.life--;e.globalAlpha=1,e.shadowBlur=0}if(u.resonanceWave){const a=u.resonanceWave;a.r+=7,a.alpha=Math.max(0,a.alpha-.55/a.maxR*7),e.strokeStyle=a.color,e.globalAlpha=a.alpha,e.lineWidth=2,e.shadowColor=a.color,e.shadowBlur=10,e.beginPath(),e.arc(w+a.x,g+a.y,a.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,a.r>=a.maxR&&(u.resonanceWave=null)}if(u.flashAlpha>0&&(e.fillStyle=u.flashColor,e.globalAlpha=u.flashAlpha,e.fillRect(w,g,t,t),e.globalAlpha=1,u.flashAlpha=Math.max(0,u.flashAlpha-.04)),i==="A"){const a=e.createRadialGradient(A/2,T/2,T*.25,A/2,T/2,T*.9);a.addColorStop(0,"rgba(80,0,20,0)"),a.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=a,e.fillRect(0,0,A,T)}bl(e,u,A,T,t,w,g,i)}function bl(e,l,r,i,f,s,y,n){const d=h,m=92;e.fillStyle="#070714",e.fillRect(0,0,r,m),e.strokeStyle="rgba(255,255,255,0.04)",e.lineWidth=1,e.beginPath(),e.moveTo(0,m),e.lineTo(r,m),e.stroke(),e.fillStyle=l.ds.bgAccent+"88",e.fillRect(0,0,r,16),e.fillStyle="#334455",e.font="8px Courier New",e.textAlign="center",e.fillText(l.ds.name+"  ·  "+l.ds.emotion,r/2,11),e.textAlign="left";const E=138;e.fillStyle="#333",e.font="9px Courier New",e.fillText("HP",14,30),e.fillStyle="#0e0e1e",e.fillRect(32,20,E,13);const u=l.hp/d.maxHp,F=u>.6?"#00ff88":u>.3?"#ffaa00":"#ff3333";e.fillStyle=F,e.shadowColor=F,e.shadowBlur=5,e.fillRect(32,20,E*u,13),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.06)",e.strokeRect(32,20,E,13),e.fillStyle="#444",e.font="8px Courier New",e.fillText(l.hp+"/"+d.maxHp,32+E+4,30);const t=138;e.fillStyle="#222",e.font="8px Courier New",e.fillText("EN",14,50),e.fillStyle="#0a0a1a",e.fillRect(32,41,t,9);const A=n==="A"?"#ff0055":"#0088ff";if(e.fillStyle=A,e.shadowColor=A,e.shadowBlur=4,e.fillRect(32,41,t*(d.energy/d.energyMax),9),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.04)",e.strokeRect(32,41,t,9),d.glitchPulse){e.fillStyle="#220a22",e.fillRect(32,53,t,6);const L=d.glitchPulseCharge/100;e.fillStyle=L>=1?"#ff00ff":"#660088",e.fillRect(32,53,t*L,6),e.strokeStyle="rgba(150,0,200,0.2)",e.strokeRect(32,53,t,6),e.fillStyle=L>=1?"#ff00ff":"#553355",e.font="7px Courier New",e.fillText("PULSE"+(L>=1?" READY":""),32+t+4,59)}l.archetypeActive&&l.archetypeType?(e.fillStyle="#ffdd00",e.font="8px Courier New",e.fillText("[ARCH ACTIVE]",14,68)):d.shield&&d.shieldTimer>0?(e.fillStyle="#00ffff",e.font="8px Courier New",e.fillText("SHIELD×"+d.shieldTimer,14,68)):d.shieldCount>0&&(e.fillStyle="#334455",e.font="8px Courier New",e.fillText("streak "+d.shieldCount+"/3",14,68)),d.comboCount>1&&(e.fillStyle="#ffcc00",e.shadowColor="#ffcc00",e.shadowBlur=6,e.font="8px Courier New",e.fillText("COMBO ×"+d.resonanceMultiplier.toFixed(1),14,80),e.shadowBlur=0),e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=5,e.font="9px Courier New",e.fillText("◆×"+(window._insightTokens||0),14,90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 19px Courier New",e.textAlign="center",e.fillText(String(l.score).padStart(7,"0"),r/2,38),e.shadowBlur=0,e.fillStyle="#222838",e.font="8px Courier New",e.fillText("SCORE",r/2,52);const T=n==="A"?"#ff0055":"#00aa55";e.fillStyle=T,e.shadowColor=T,e.shadowBlur=7,e.font="bold 10px Courier New",e.fillText("MTX·"+n,r/2-16,68),e.shadowBlur=0,e.textAlign="right",e.fillStyle="#445566",e.font="10px Courier New",e.fillText("LVL "+l.level,r-12,30),e.fillStyle="#005533",e.fillText("◈×"+l.peaceLeft,r-12,44),e.fillStyle="#223344",e.font="8px Courier New",e.fillText((window._dreamIdx+1||1)+"/10 DREAMS",r-12,58),e.textAlign="left",l.msg&&l.msgTimer>0&&(e.globalAlpha=Math.min(1,l.msgTimer/18),e.font="bold 16px Courier New",e.textAlign="center",e.fillStyle=l.msgColor,e.shadowColor=l.msgColor,e.shadowBlur=16,e.fillText(l.msg,r/2,y-16),e.textAlign="left",e.globalAlpha=1,e.shadowBlur=0,l.msgTimer--),e.fillStyle="#070714",e.fillRect(0,i-28,r,28),e.strokeStyle="rgba(255,255,255,0.03)",e.beginPath(),e.moveTo(0,i-28),e.lineTo(r,i-28),e.stroke(),e.fillStyle="#1a1a2a",e.font="8px Courier New",e.textAlign="center",e.fillText("WASD/ARROWS · SHIFT=matrix · ESC=pause · J=arch · R=pulse · Q=freeze · C=contain",r/2,i-11),e.textAlign="left"}function wl(e,l,r){for(const i of l)e.globalAlpha=i.a*(.5+.5*Math.sin(r*8e-4+i.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(i.x,i.y,i.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function Rl(e,l,r,i,f,s){e.fillStyle="#02020a",e.fillRect(0,0,l,r);for(let n=0;n<r;n+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,n,l,1);wl(e,i,f),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",l/2,r/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",l/2,r/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",l/2,r/2-78);const y=r/2-55;ll.forEach((n,d)=>{const m=d===s,E=y+d*36;m&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(l/2-130,E-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(l/2-130,E-19,260,28)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.shadowColor=m?"#00ff88":"transparent",e.shadowBlur=m?8:0,e.font=m?"bold 14px Courier New":"12px Courier New",e.fillText(n,l/2,E),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select",l/2,r-20),e.textAlign="left"}function Cl(e,l,r,i){e.fillStyle="#02020a",e.fillRect(0,0,l,r),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",l/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",l/2,68);const f=Math.min(Y.length,6),s=Math.max(0,Math.min(i-Math.floor(f/2),Y.length-f));for(let y=0;y<f;y++){const n=s+y,d=Y[n],m=n===i,E=95+y*55;if(m&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(l/2-160,E-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(l/2-160,E-18,320,46)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.font=m?"bold 12px Courier New":"11px Courier New",e.fillText(n+1+".  "+d.name,l/2,E),e.fillStyle=m?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(d.subtitle+"  ·  "+d.emotion,l/2,E+16),m&&d.archetype&&ie[d.archetype]){const u=ie[d.archetype];e.fillStyle="#665522",e.fillText("archetype: "+u.name+" — "+u.powerDesc,l/2,E+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",l/2,r-20),e.textAlign="left"}function Ml(e,l,r,i){e.fillStyle="#02020a",e.fillRect(0,0,l,r),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",l/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:ol,cur:M.gridSize},{label:"DIFFICULTY",opts:al,cur:M.difficulty},{label:"PARTICLES",opts:["on","off"],cur:M.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((s,y)=>{const n=y===i,d=105+y*68;s.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(s.label,l/2,d)),s.opts.forEach((m,E)=>{const u=m===s.cur,F=l/2+(E-(s.opts.length-1)/2)*110,t=d+24;e.fillStyle=n&&u?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(F-44,t-16,88,24),e.strokeStyle=n&&u?"rgba(0,255,136,0.5)":u?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(F-44,t-16,88,24),e.fillStyle=u?"#00ff88":"#334455",e.shadowColor=u?"#00ff88":"transparent",e.shadowBlur=u?5:0,e.font=u?"bold 11px Courier New":"10px Courier New",e.fillText(m.toUpperCase(),F,t),e.shadowBlur=0}),n&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",l/2-154,d+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",l/2,r-20),e.textAlign="left"}function Il(e,l,r,i){e.fillStyle="#02020a",e.fillRect(0,0,l,r),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",l/2,50),e.shadowBlur=0,i.length?i.slice(0,8).forEach((f,s)=>{const y=95+s*38,n=s===0?"◈":s===1?"◇":"·";e.fillStyle=s===0?"#ffdd00":s===1?"#aaaaaa":s===2?"#cc8833":"#334455",e.font=s<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${n}  ${String(f.score).padStart(7,"0")}   LVL${String(f.level).padStart(2,"0")}   ${f.dreamscape}   ${f.date}`,l/2,y)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",l/2,r/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",l/2,r-20),e.textAlign="left"}function Pl(e,l,r,i,f,s){e.fillStyle="#02020a",e.fillRect(0,0,l,r),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",l/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+f,l/2,68),re.forEach((y,n)=>{const d=n===i,m=s(y.id),E=f>=y.cost&&!m,u=92+n*48;d&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(l/2-155,u-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(l/2-155,u-14,310,40)),e.fillStyle=m?"#00ff88":E?"#00ccdd":"#334455",e.shadowColor=m?"#00ff88":d?"#00ccdd":"transparent",e.shadowBlur=d&&!m?5:0,e.font="bold 11px Courier New",e.fillText(y.name,l/2-55,u),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(y.desc,l/2-55,u+14),e.fillStyle=m?"#005533":E?"#006677":"#221122",e.font="10px Courier New",e.fillText(m?"OWNED":"◆×"+y.cost,l/2+88,u+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",l/2,r-20),e.textAlign="left"}function Dl(e,l,r,i,f){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,l,r),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",l/2,r/2-80),e.shadowBlur=0,i&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(i.ds.name+"  ·  LEVEL "+i.level,l/2,r/2-58),e.fillStyle="#334455",e.fillText(i.ds.narrative,l/2,r/2-44)),rl.forEach((s,y)=>{const n=y===f,d=r/2-14+y*36;n&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(l/2-110,d-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(l/2-110,d-18,220,26)),e.fillStyle=n?"#00ff88":"#334433",e.shadowColor=n?"#00ff88":"transparent",e.shadowBlur=n?6:0,e.font=n?"bold 13px Courier New":"12px Courier New",e.fillText(s,l/2,d),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",l/2,r-20),e.textAlign="left"}function Ll(e,l,r,i,f){const s=1-i.timer/220,y=s<.1?s/.1:s>.9?(1-s)/.1:1,n=i.ds||Y[0];e.fillStyle=n.bgColor||"#02020a",e.fillRect(0,0,l,r);for(let d=0;d<7;d++){const m=(f*.02+d*l/7)%l;e.strokeStyle=`rgba(0,255,136,${.02*y})`,e.lineWidth=1,e.beginPath(),e.moveTo(m,0),e.lineTo(m-100,r),e.stroke()}if(e.globalAlpha=y,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(i.text,l/2,r/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+n.name,l/2,r/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(n.narrative,l/2,r/2+24),n.archetype&&ie[n.archetype]){const d=ie[n.archetype];e.fillStyle=d.glow,e.shadowColor=d.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+d.name,l/2,r/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function vl(e,l,r,i,f,s,y,n){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,l,r),e.textAlign="center";const d=i?.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+(d?.name||"THE VOID"),l/2,r/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",l/2,r/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(i.score).padStart(7,"0"),l/2,r/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+i.level,l/2,r/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+s.length+"/"+Y.length,l/2,r/2+14),e.fillText("REP "+(n>=0?"+":"")+n+"  ·  ◆×"+y,l/2,r/2+32),f.length>0){const E=f.findIndex(u=>u.score===i.score);E>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(E+1)+" ALL TIME",l/2,r/2+54))}const m=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*m})`,e.fillRect(l/2-110,r/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*m})`,e.strokeRect(l/2-110,r/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",l/2,r/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",l/2,r/2+120),e.textAlign="left"}const oe=document.getElementById("c"),j=oe.getContext("2d"),ue=Math.min(window.devicePixelRatio||1,2);function Pe(){const e=de(),l=he();oe.width=e*ue,oe.height=l*ue,oe.style.width=Math.min(e,window.innerWidth-16)+"px",oe.style.height="auto",j.setTransform(1,0,0,1,0,0),j.scale(ue,ue)}Pe();let c=null,q=null,Be=0,Ce=0;window._insightTokens=Z;window._dreamIdx=M.dreamIdx;let ke=0,me=500,Ee=!1,Ae={row:-1,col:-1,t:0},Me=[],ce=[],Ie=[],ge={text:"",timer:0,ds:null};const x=new Set;function je(e,l){ce=[];for(let r=0;r<30;r++)ce.push({x:Math.random()*e,y:Math.random()*l,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}function Nl(e,l){Ie=[];for(let r=0;r<5;r++)Ie.push({text:fe(el),x:40+Math.random()*(e-80),y:90+Math.random()*(l-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+P(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}function z(e,l,r){c&&(c.msg=e,c.msgColor=l,c.msgTimer=r)}function Ol(e,l,r){const i=qe();i.push({score:e,level:l,dreamscape:r?.name||"?",date:new Date().toLocaleDateString()}),i.sort((s,y)=>y.score-s.score);const f=i.slice(0,8);We(f),hl(f)}function Hl(e){const l=e.ds.environmentEvent,r=e.sz;if(l){if(l==="gravity_shift"){const[i,f]=fe([[-1,0],[1,0],[0,-1],[0,1]]),s=e.player.y+i,y=e.player.x+f;s>=0&&s<r&&y>=0&&y<r&&e.grid[s][y]!==5&&(e.player.y=s,e.player.x=y,z("GRAVITY SHIFTS…","#8888ff",40))}else if(l==="loop_reset"){for(let i=-2;i<=2;i++)for(let f=-2;f<=2;f++){const s=e.player.y+i,y=e.player.x+f;s>=0&&s<r&&y>=0&&y<r&&e.grid[s][y]===0&&Math.random()<.25&&(e.grid[s][y]=8)}z("THE LOOP TIGHTENS…","#ff8800",40)}else if(l==="capture_zones"){const i=fe(e.enemies);i&&(e.captureZones=[{x:i.x,y:i.y,r:2,timer:300}]),z("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(l==="rapid_spawn"){if(e.enemies.length<10){const i=2+P(r-4),f=2+P(r-4);e.enemies.push({y:i,x:f,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:i,prevX:f,momentum:[0,0],type:"rush"}),z("CHAOS ERUPTS!","#ff0044",40)}}else if(l==="wall_phase"){let i=0;for(let f=0;f<r&&i<4;f++)for(let s=0;s<r&&i<4;s++)e.grid[f][s]===5&&Math.random()<.3&&(e.grid[f][s]=10,i++);z("MEMBRANE DISSOLVES…","#00ccff",40)}else if(l==="glide_nodes"){let i=0,f=0;for(;i<2&&f<999;){f++;const s=P(r),y=P(r);e.grid[s][y]===0&&(e.grid[s][y]=12,i++)}z("GLIDE NODES APPEAR","#00aaff",40)}else if(l==="mashup"){const i=fe(Y.filter(f=>f.id!==e.ds.id));if(i.hazardSet[0]){let f=0,s=0;for(;f<3&&s<999;){s++;const y=P(r),n=P(r);e.grid[y][n]===0&&(e.grid[y][n]=i.hazardSet[0],f++)}}z("DREAMSCAPES MERGE…","#ffaaff",40)}if(Math.random()<.4){const i=P(r);for(let f=0;f<r;f++)e.grid[i][f]===1?e.grid[i][f]=4:e.grid[i][f]===4&&Math.random()<.3&&(e.grid[i][f]=1);Ae={row:i,col:-1,t:50},Ee=!0}}}function Xe(e,l,r,i){const f=(r||0)+1;Pe();const s=Y[e%Y.length];ze(s.matrixDefault);const y=yl(s,Re(),f,l,i,h.maxHp,Te);return Nl(de(),he()),Me=[],me=500+P(500),je(de(),he()),y}function ae(e){sl(),fl(),M.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=M.dreamIdx,c=Xe(M.dreamIdx,0,0,void 0),k("playing"),Ce=0,Ve(0),cancelAnimationFrame(q),q=requestAnimationFrame(J)}function Bl(){const e=c,l=(M.dreamIdx+1)%Y.length;M.dreamIdx=l,window._dreamIdx=l,nl(e.ds.id),ge={text:e.ds.completionText,subtext:Y[l].narrative,timer:220,ds:Y[l]},k("interlude"),setTimeout(()=>{Pe(),c=Xe(l,e.score+400+e.level*60,e.level,e.hp),c.msg=Y[l].name,c.msgColor="#ffdd00",c.msgTimer=90,B==="interlude"&&k("playing")},3600)}function kl(e){const l=re.find(r=>r.id===e);!l||Z<l.cost||Ye(e)||(Ue(l.cost),window._insightTokens=Z,e==="maxhp"&&(h.maxHp+=25,c&&(c.hp=Math.min(c.hp+25,h.maxHp))),e==="speed"&&(h.moveDelay=Math.max(55,h.moveDelay-15)),e==="magnet"&&(h.magnet=!0),e==="freeze"&&(h.freeze=!0),e==="aura"&&(h.aura=!0),e==="energy"&&(h.energyMax=Math.min(200,h.energyMax+30)),e==="rewind"&&(h.temporalRewind=!0),e==="pulse"&&(h.glitchPulse=!0))}function J(e){const l=e-Be;Be=e;const r=de(),i=he();if(B==="title"){Rl(j,r,i,ce,e,R.menu),q=requestAnimationFrame(J);return}if(B==="dreamselect"){Cl(j,r,i,M.dreamIdx),q=requestAnimationFrame(J);return}if(B==="options"){Ml(j,r,i,R.opt),q=requestAnimationFrame(J);return}if(B==="highscores"){Il(j,r,i,we),q=requestAnimationFrame(J);return}if(B==="upgrade"){Pl(j,r,i,R.shop,Z,Ye),q=requestAnimationFrame(J);return}if(B==="dead"){vl(j,r,i,c,we,Te,Z,_e),q=requestAnimationFrame(J);return}if(B==="paused"){Dl(j,r,i,c,R.pause),q=requestAnimationFrame(J);return}if(B==="interlude"){Ll(j,r,i,ge,e),ge.timer--,ge.timer<=0&&B==="interlude"&&k("playing"),q=requestAnimationFrame(J);return}const f=c.slowMoves?h.moveDelay*1.5:h.moveDelay,s={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};if(e-Ce>f){for(const[y,[n,d]]of Object.entries(s))if(x.has(y)){Al(c,n,d,Q,Bl,z,Z,m=>{for(;Z<m;)tl();window._insightTokens=Z}),Ce=e;break}}if(c.emotionTimer>0&&(c.emotionTimer--,c.emotionTimer<=0&&(c.slowMoves=!1,h.emotion="neutral")),il(l),Q==="B"&&se>4e3&&Math.random()<2e-4*l&&(c.hp=Math.min(h.maxHp,c.hp+1)),Q==="A"&&se>2500&&Math.random()<3e-4*l&&(c.hp=Math.max(0,c.hp-1)),me-=l,me<=0&&(ke=2+P(4),me=500+P(700)),Ee&&(Ae.t--,Ae.t<=0&&(Ee=!1)),c.environmentTimer-=l,c.environmentTimer<=0&&(c.environmentTimer=900+P(700),Math.random()<.6&&Hl(c)),Sl(c,l),ml(c,l,x,Q,Me,z,ye),c.hp<=0){Ol(c.score,c.level,c.ds),k("dead"),q=requestAnimationFrame(J);return}Tl(j,e,c,Q,ce,Ie,Me,Ee,Ae,ke),q=requestAnimationFrame(J)}window.addEventListener("keydown",e=>{if(x.add(e.key),B==="title"){e.key==="ArrowUp"&&(R.menu=(R.menu-1+5)%5),e.key==="ArrowDown"&&(R.menu=(R.menu+1)%5),(e.key==="Enter"||e.key===" ")&&(R.menu===0?ae(M.dreamIdx):R.menu===1?k("dreamselect"):R.menu===2?(R.opt=0,k("options")):R.menu===3?k("highscores"):R.menu===4&&(R.shop=0,R.upgradeFrom="title",k("upgrade"))),e.preventDefault();return}if(B==="dreamselect"){e.key==="ArrowUp"&&(M.dreamIdx=(M.dreamIdx-1+Y.length)%Y.length),e.key==="ArrowDown"&&(M.dreamIdx=(M.dreamIdx+1)%Y.length),e.key==="Enter"&&ae(M.dreamIdx),e.key==="Escape"&&k("title"),e.preventDefault();return}if(B==="options"){if(e.key==="ArrowUp"&&(R.opt=(R.opt-1+4)%4),e.key==="ArrowDown"&&(R.opt=(R.opt+1)%4),e.key==="ArrowLeft"||e.key==="ArrowRight"){const r=e.key==="ArrowLeft"?-1:1;if(R.opt===0){const i=["small","medium","large"].indexOf(M.gridSize);M.gridSize=["small","medium","large"][(i+r+3)%3]}else if(R.opt===1){const i=["easy","normal","hard"].indexOf(M.difficulty);M.difficulty=["easy","normal","hard"][(i+r+3)%3]}else R.opt===2&&(M.particles=!M.particles)}(e.key==="Enter"||e.key==="Escape")&&(R.opt===3||e.key==="Escape")&&k(c?"paused":"title"),e.preventDefault();return}if(B==="highscores"){(e.key==="Enter"||e.key==="Escape")&&k("title"),e.preventDefault();return}if(B==="upgrade"){e.key==="ArrowUp"&&(R.shop=(R.shop-1+re.length)%re.length),e.key==="ArrowDown"&&(R.shop=(R.shop+1)%re.length),e.key==="Enter"&&kl(re[R.shop].id),e.key==="Escape"&&k(R.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(B==="dead"){(e.key==="Enter"||e.key===" ")&&ae(M.dreamIdx),e.key==="Escape"&&(k("title"),R.menu=0),e.preventDefault();return}if(B==="paused"){e.key==="ArrowUp"&&(R.pause=(R.pause-1+4)%4),e.key==="ArrowDown"&&(R.pause=(R.pause+1)%4),e.key==="Enter"&&(R.pause===0?k("playing"):R.pause===1?(R.opt=0,k("options")):R.pause===2?(R.shop=0,R.upgradeFrom="paused",k("upgrade")):(k("title"),R.menu=0,c=null)),e.key==="Escape"&&k("playing"),e.preventDefault();return}if(B==="playing"){if(e.key==="Escape"&&(R.pause=0,k("paused")),e.key==="Shift"&&!e.repeat){const r=Q==="A"?"B":"A";ze(r),Ve(0);const i=r==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",f=r==="A"?"#ff0055":"#00ff88";z(i,f,55),M.particles&&V(c,c.player.x,c.player.y,f,22,4)}(e.key==="j"||e.key==="J")&&!e.repeat&&(c.archetypeActive||h.temporalRewind&&h.rewindBuffer.length>0?He(c):z("NO ARCHETYPE ACTIVE","#334455",25)),(e.key==="r"||e.key==="R")&&!e.repeat&&(h.glitchPulse&&h.glitchPulseCharge>=100?gl(c,z):h.glitchPulse?z("CHARGING… "+Math.round(h.glitchPulseCharge)+"%","#660088",22):z("BUY GLITCH PULSE IN UPGRADES","#334455",28)),(e.key==="q"||e.key==="Q")&&!e.repeat&&h.freeze&&h.freezeTimer<=0&&(h.freezeTimer=2500,z("FREEZE ACTIVE!","#0088ff",50),V(c,c.player.x,c.player.y,"#0088ff",20,4)),(e.key==="c"||e.key==="C")&&!e.repeat&&(Z>=2?(Ue(2),window._insightTokens=Z,c.contZones||(c.contZones=[]),c.contZones.push({x:c.player.x,y:c.player.y,timer:240,maxTimer:240}),z("CONTAINMENT ZONE","#00ffcc",38)):z("NEED 2 ◆ FOR CONTAINMENT","#334455",28))}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>x.delete(e.key));function be(e,l){const r=document.getElementById(e);if(!r)return;let i;r.addEventListener("touchstart",f=>{f.preventDefault(),x.add(l),B==="title"&&ae(M.dreamIdx),i=()=>x.delete(l)},{passive:!1}),r.addEventListener("touchend",f=>{f.preventDefault(),i&&i()},{passive:!1}),r.addEventListener("mousedown",()=>{x.add(l),B==="title"&&ae(M.dreamIdx)}),r.addEventListener("mouseup",()=>x.delete(l))}be("btn-up","ArrowUp");be("btn-down","ArrowDown");be("btn-left","ArrowLeft");be("btn-right","ArrowRight");oe.addEventListener("click",()=>{B==="title"&&ae(M.dreamIdx)});We(qe());je(de(),he());q=requestAnimationFrame(J);
