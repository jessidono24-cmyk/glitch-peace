(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))t(f);new MutationObserver(f=>{for(const s of f)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&t(u)}).observe(document,{childList:!0,subtree:!0});function o(f){const s={};return f.integrity&&(s.integrity=f.integrity),f.referrerPolicy&&(s.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?s.credentials="include":f.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(f){if(f.ep)return;f.ep=!0;const s=o(f);fetch(f.href,s)}})();const a={VOID:0,DESPAIR:1,TERROR:2,SELF_HARM:3,PEACE:4,WALL:5,INSIGHT:6,HIDDEN:7,RAGE:8,HOPELESS:9,GLITCH:10,ARCHETYPE:11,TELEPORT:12,COVER:13,TRAP:14,MEMORY:15,PAIN:16},ee={[a.VOID]:{dmg:0,spread:!1,push:0,bg:"#06060f",bd:"rgba(255,255,255,0.04)",glow:null,sym:""},[a.DESPAIR]:{dmg:8,spread:!0,push:0,bg:"#0d0d55",bd:"#1a1aff",glow:"#2233ff",sym:"↓"},[a.TERROR]:{dmg:20,spread:!1,push:0,bg:"#500000",bd:"#cc1111",glow:"#ff2222",sym:"!"},[a.SELF_HARM]:{dmg:14,spread:!1,push:0,bg:"#360000",bd:"#880000",glow:"#aa0000",sym:"✕"},[a.PEACE]:{dmg:0,spread:!1,push:0,bg:"#002810",bd:"#00ff88",glow:"#00ffcc",sym:"◈"},[a.WALL]:{dmg:0,spread:!1,push:0,bg:"#0e0e18",bd:"#252535",glow:null,sym:""},[a.INSIGHT]:{dmg:0,spread:!1,push:0,bg:"#001a18",bd:"#00ddbb",glow:"#00ffee",sym:"◆"},[a.HIDDEN]:{dmg:0,spread:!1,push:0,bg:"#04040a",bd:"rgba(0,200,100,0.08)",glow:null,sym:""},[a.RAGE]:{dmg:18,spread:!1,push:2,bg:"#3a0010",bd:"#cc0044",glow:"#ff0066",sym:"▲"},[a.HOPELESS]:{dmg:12,spread:!0,push:0,bg:"#002040",bd:"#0044cc",glow:"#0066ff",sym:"~"},[a.GLITCH]:{dmg:5,spread:!1,push:0,bg:"#1a0a1a",bd:"#aa00ff",glow:"#dd00ff",sym:"?"},[a.ARCHETYPE]:{dmg:0,spread:!1,push:0,bg:"#0a1a0a",bd:"#ffdd00",glow:"#ffee44",sym:"☆"},[a.TELEPORT]:{dmg:0,spread:!1,push:0,bg:"#001820",bd:"#00aaff",glow:"#00ccff",sym:"⇒"},[a.COVER]:{dmg:0,spread:!1,push:0,bg:"#101018",bd:"#446688",glow:null,sym:"▪"},[a.TRAP]:{dmg:16,spread:!1,push:1,bg:"#1a0800",bd:"#cc6600",glow:"#ff8800",sym:"×"},[a.MEMORY]:{dmg:0,spread:!1,push:0,bg:"#06060a",bd:"rgba(100,200,150,0.2)",glow:null,sym:"·"},[a.PAIN]:{dmg:6,spread:!1,push:0,bg:"#200808",bd:"#661111",glow:"#880000",sym:"·"}},p=44,H=2,Ke={small:10,medium:13,large:17},Ge={easy:{eSpeedBase:950,eSpeedMin:350,dmgMul:.55,hazMul:.7},normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1,hazMul:1},hard:{eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35}};function Fe(e){const l={};for(const[o,t]of Object.entries(ee))l[o]={bg:t.bg,bd:t.bd,glow:t.glow};if(e)for(const[o,t]of Object.entries(e))Object.assign(l[o],t);return l}const Qe=Fe(null),xe=Fe({[a.VOID]:{bg:"#0a0208",bd:"rgba(180,30,60,0.05)"},[a.DESPAIR]:{bg:"#220011",bd:"#aa0044",glow:"#dd1155"},[a.TERROR]:{bg:"#600010",bd:"#ee0022",glow:"#ff3333"},[a.SELF_HARM]:{bg:"#440008",bd:"#aa0011",glow:"#cc0022"},[a.PEACE]:{bg:"#001408",bd:"#00aa44",glow:"#00dd66"},[a.INSIGHT]:{bg:"#000a18",bd:"#0088cc",glow:"#00aaff"},[a.RAGE]:{bg:"#500008",bd:"#ee1133",glow:"#ff2244"},[a.HOPELESS]:{bg:"#001025",bd:"#0033aa",glow:"#0055dd"},[a.GLITCH]:{bg:"#1a0028",bd:"#cc00ff",glow:"#ff00ff"}}),le={dragon:{name:"DRAGON",color:"#ffaa00",glow:"#ff8800",power:"wall_jump",powerDesc:"DRAGON LEAP — jump 2 tiles (J)",activationMsg:"Dragon grants you passage…",completionBonus:"dragon protection persists…"},child:{name:"CHILD GUIDE",color:"#aaffcc",glow:"#00ffaa",power:"reveal",powerDesc:"CHILD SIGHT — hidden nodes revealed",activationMsg:"Child guide illuminates the path…",completionBonus:"child's sight lingers…"},orb:{name:"ORB / SHEEP",color:"#aaddff",glow:"#00ccff",power:"phase_walk",powerDesc:"ORB PHASE — walk through walls (J)",activationMsg:"Orb opens the membrane…",completionBonus:"orb carries you forward…"},captor:{name:"CAPTOR-TEACHER",color:"#ffaadd",glow:"#dd0088",power:"rewind",powerDesc:"REWIND — undo last 3 moves (J)",activationMsg:"Captor shows you the loop…",completionBonus:"you learned from the captor…"},protector:{name:"PROTECTOR",color:"#88ccff",glow:"#4488ff",power:"shield_burst",powerDesc:"PROTECT — shield burst (J)",activationMsg:"Protector stands between…",completionBonus:"protection endures…"}},Y=[{id:"void",name:"VOID STATE",subtitle:"raw survival · awakening",matrixDefault:"B",bgColor:"#03030a",bgAccent:"#001a0a",emotion:"numbness",archetype:null,hazardSet:[a.DESPAIR,a.TERROR,a.SELF_HARM],hazardCounts:[8,5,4],specialTiles:[],enemyBehavior:"wander",enemyCount:3,environmentEvent:null,narrative:"the void holds you… begin",completionText:"you surfaced from the void…"},{id:"mountain_dragon",name:"MOUNTAIN DRAGON REALM",subtitle:"initiation · fear · guardian presence",matrixDefault:"B",bgColor:"#020508",bgAccent:"#0a0518",emotion:"fear",archetype:"dragon",hazardSet:[a.DESPAIR,a.TERROR,a.HOPELESS],hazardCounts:[6,5,4],specialTiles:[a.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"gravity_shift",narrative:"the dragon watches… do not falter",completionText:"dragon acknowledged your courage…"},{id:"courtyard",name:"MOUNTAIN COURTYARD OF OJOS",subtitle:"loop · language puzzles · captor-teacher",matrixDefault:"A",bgColor:"#080502",bgAccent:"#180a00",emotion:"frustration",archetype:"captor",hazardSet:[a.RAGE,a.DESPAIR,a.GLITCH],hazardCounts:[5,6,5],specialTiles:[a.TRAP,a.ARCHETYPE],enemyBehavior:"patrol",enemyCount:4,environmentEvent:"loop_reset",narrative:"the courtyard repeats… find the door",completionText:"you escaped the captor's loop… empathy found"},{id:"leaping_field",name:"LEAPING FIELD",subtitle:"mobility · orb-sheep guide · vulnerability",matrixDefault:"B",bgColor:"#020a06",bgAccent:"#002210",emotion:"vulnerability",archetype:"orb",hazardSet:[a.TERROR,a.SELF_HARM,a.HOPELESS],hazardCounts:[4,3,5],specialTiles:[a.TELEPORT,a.ARCHETYPE],enemyBehavior:"orbit",enemyCount:3,environmentEvent:"glide_nodes",narrative:"the orb drifts ahead… follow",completionText:"you leapt where fear said stay…"},{id:"summit",name:"MOUNTAIN SUMMIT REALM",subtitle:"high stakes · multi-plane · dragon guardian",matrixDefault:"B",bgColor:"#04050a",bgAccent:"#080418",emotion:"exhaustion",archetype:"dragon",hazardSet:[a.TERROR,a.RAGE,a.HOPELESS,a.SELF_HARM],hazardCounts:[5,4,5,3],specialTiles:[a.ARCHETYPE,a.HIDDEN],enemyBehavior:"adaptive",enemyCount:5,environmentEvent:"line_of_sight",narrative:"the summit demands everything…",completionText:"from the peak, the path below is clear…"},{id:"neighborhood",name:"CHILDHOOD NEIGHBORHOOD",subtitle:"pursuit · panic · early hazard",matrixDefault:"A",bgColor:"#080408",bgAccent:"#150510",emotion:"panic",archetype:null,hazardSet:[a.DESPAIR,a.TERROR,a.SELF_HARM,a.PAIN],hazardCounts:[7,6,4,3],specialTiles:[a.MEMORY],enemyBehavior:"chase_fast",enemyCount:5,environmentEvent:"capture_zones",narrative:"they are close… run",completionText:"you outran the pursuing shadow…"},{id:"bedroom",name:"MODERN BEDROOM GUNFIGHT",subtitle:"reflex · cover · sudden chaos",matrixDefault:"A",bgColor:"#050508",bgAccent:"#0a0a18",emotion:"chaos",archetype:"protector",hazardSet:[a.TERROR,a.RAGE,a.GLITCH],hazardCounts:[6,5,4],specialTiles:[a.COVER,a.ARCHETYPE],enemyBehavior:"rush",enemyCount:6,environmentEvent:"rapid_spawn",narrative:"chaos erupts… find cover",completionText:"protector stood firm… chaos receded"},{id:"aztec",name:"AZTEC / MAYAN CHASE",subtitle:"labyrinth · traps · captor-teacher",matrixDefault:"A",bgColor:"#080400",bgAccent:"#1a0800",emotion:"anxiety",archetype:"captor",hazardSet:[a.TRAP,a.RAGE,a.DESPAIR,a.TERROR],hazardCounts:[6,4,5,4],specialTiles:[a.TRAP,a.ARCHETYPE],enemyBehavior:"labyrinth",enemyCount:4,environmentEvent:"dead_ends",narrative:"the stone corridors close in…",completionText:"you traced the ancient path… free"},{id:"orb_escape",name:"ORB ESCAPE EVENT",subtitle:"flight · wall-phase · fleeting hope",matrixDefault:"B",bgColor:"#010a08",bgAccent:"#002018",emotion:"hope",archetype:"orb",hazardSet:[a.HOPELESS,a.DESPAIR,a.GLITCH],hazardCounts:[4,4,4],specialTiles:[a.TELEPORT,a.ARCHETYPE,a.INSIGHT],enemyBehavior:"scatter",enemyCount:3,environmentEvent:"wall_phase",narrative:"the orb leads through the membrane…",completionText:"you passed through… the other side holds"},{id:"integration",name:"DREAMSCAPE INTEGRATION",subtitle:"all matrices · sovereignty · final emergence",matrixDefault:"B",bgColor:"#020208",bgAccent:"#080418",emotion:"integration",archetype:"all",hazardSet:[a.DESPAIR,a.TERROR,a.RAGE,a.HOPELESS,a.SELF_HARM,a.GLITCH,a.TRAP],hazardCounts:[5,4,4,4,3,3,3],specialTiles:[a.ARCHETYPE,a.TELEPORT,a.INSIGHT,a.HIDDEN],enemyBehavior:"predictive",enemyCount:7,environmentEvent:"mashup",narrative:"all dreamscapes converge… integrate",completionText:"SA · MCA · MNF · SC — the sovereignty is yours"}],oe=[{id:"maxhp",name:"+MAX HP",cost:3,desc:"max HP +25"},{id:"speed",name:"+MOVE SPEED",cost:2,desc:"faster movement"},{id:"magnet",name:"PEACE MAGNET",cost:4,desc:"attract nearby ◈"},{id:"freeze",name:"ENEMY FREEZE",cost:5,desc:"Q: freeze all enemies"},{id:"aura",name:"GLOW AURA",cost:2,desc:"cosmetic pulse aura"},{id:"energy",name:"+ENERGY MAX",cost:3,desc:"energy bar +30"},{id:"rewind",name:"TEMPORAL REWIND",cost:6,desc:"J: undo last 3 moves"},{id:"pulse",name:"GLITCH PULSE",cost:5,desc:"charged clear (R)"}],el=["memory…","choice…","echo…","void…","self…","signal…","fragment…","persist…","clarity…","dissolve…","boundary…","witness…","anchor…","pattern…","emergence…","dragon…","guide…","orb…","fear…","hope…"],ll=["▶  START JOURNEY","SELECT DREAMSCAPE","OPTIONS","HIGH SCORES","UPGRADES"],rl=["RESUME","OPTIONS","UPGRADES","QUIT TO TITLE"],ol=["small","medium","large"],al=["easy","normal","hard"],I={gridSize:"medium",difficulty:"normal",particles:!0,dreamIdx:0};let Ce=[],_e=0,Z=0,be=[],Q="B",se=0;function ze(e){Q=e}function Ve(e){se=e}function il(e){se+=e}function tl(e=1){Z+=e}function We(e){Z=Math.max(0,Z-e)}function nl(e){be.push(e)}function Ue(e){Ce=e}function fl(){_e=0,Z=0,be=[],Q="B",se=0}const h={maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0};function sl(){Object.assign(h,{maxHp:100,moveDelay:120,magnet:!1,shield:!1,shieldTimer:0,shieldCount:0,energyMax:100,energy:100,aura:!1,freeze:!1,freezeTimer:0,particleColor:"#00ff88",archetypePower:null,archetypeDuration:0,phaseShift:!1,phaseTimer:0,temporalRewind:!1,rewindBuffer:[],glitchPulse:!1,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,emotion:"neutral",emotionTimer:0})}function Ye(e){return{maxhp:h.maxHp>100,speed:h.moveDelay<120,magnet:h.magnet,freeze:h.freeze,aura:h.aura,energy:h.energyMax>100,rewind:h.temporalRewind,pulse:h.glitchPulse}[e]||!1}let B="title";function k(e){B=e}const R={menu:0,opt:0,pause:0,shop:0,upgradeFrom:"title"};function D(e){return Math.floor(Math.random()*e)}function ie(e){return e[D(e.length)]}function ue(e,l,o){return Math.max(l,Math.min(o,e))}const Oe=[1,1,2,3,5,8,13,21,34,55,89];function dl(e){return Oe[Math.min(e,Oe.length-1)]}const Ze="glitch_peace_v4";function hl(e){try{localStorage.setItem(Ze+"_scores",JSON.stringify(e))}catch{}}function qe(){try{const e=localStorage.getItem(Ze+"_scores");return e?JSON.parse(e):[]}catch{return[]}}function Re(){return Ke[I.gridSize]}function pl(){return Ge[I.difficulty]}function $e(){return Re()*p+(Re()-1)*H}function de(){return $e()+48}function he(){return $e()+148}function ul(e){const l=Array.from({length:e},()=>new Array(e).fill(a.VOID)),o=Math.floor(e*e*.07);for(let t=0;t<o;t++){const f=1+D(e-2),s=1+D(e-2);l[f][s]=a.WALL}return l}function fe(e,l,o,t,f){let s=0,u=0;for(;s<l&&u<9999;){u++;const n=D(t),d=D(t);if(e[n][d]===a.VOID){if(n<2&&d<2)continue;e[n][d]=o,s++}}}function yl(e,l,o,t,f,s,u){const n=pl(),d=ul(l);d[0][0]=a.VOID,l>1&&(d[0][1]=a.VOID,d[1][0]=a.VOID);const m=dl(o+2)+(l-13>0?l-13:0),c=1+Math.floor(o/3);if(e.hazardSet.forEach((O,C)=>{const S=Math.round((e.hazardCounts[C]||4)*n.hazMul);fe(d,S,O,l)}),fe(d,m,a.PEACE,l),fe(d,c,a.INSIGHT,l),e.specialTiles.forEach(O=>fe(d,2,O,l)),u&&u.length>0&&fe(d,3,a.MEMORY,l),e.id==="aztec")for(let O=0;O<l*2;O++){const C=1+D(l-2),S=1+D(l-2);d[C][S]===a.VOID&&(d[C][S]=a.WALL)}const y=e.id==="bedroom"?2:e.id==="summit"?1:0,_=Math.min(e.enemyCount+Math.floor(o*.5)+y,10),i=Math.max(1,_+(I.difficulty==="hard"?2:I.difficulty==="easy"?-1:0)),g=[],T=Math.max(2,Math.floor(l/5));for(let O=0;O<i;O++){let C,S,L=0;do C=T+D(l-T*2),S=T+D(l-T*2),L++;while((d[C][S]!==a.VOID||C<2&&S<2)&&L<400);g.push({y:C,x:S,timer:D(600),stunTimer:0,behavior:e.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,orbitAngle:Math.random()*Math.PI*2,orbitR:2+D(3),prevY:C,prevX:S,momentum:[0,0],type:"hunter"})}let P=null;if(o>=6&&(e.id==="summit"||e.id==="integration")){const O=Math.floor(l/2),C=Math.floor(l/2);d[C][O]=a.VOID,P={y:C,x:O,hp:5+o,timer:0,stunTimer:0,phase:"chase",phaseTimer:400}}return{grid:d,enemies:g,boss:P,sz:l,level:o,ds:e,player:{y:0,x:0},hp:f!==void 0?Math.min(s,f+25):s,score:t||0,particles:[],trail:[],echos:[],contZones:[],shakeFrames:0,peaceLeft:m,insightLeft:c,msg:null,msgColor:"#fff",msgTimer:0,flashColor:null,flashAlpha:0,tileFlicker:[],resonanceWave:null,peaceStreak:0,archetypeActive:!1,archetypeType:null,archetypeTimer:0,captureZones:[],environmentTimer:800+D(600),environmentActive:!1,spreadTimer:2e3,moveHistory:[],slowMoves:!1,speedBoost:!1,emotionTimer:0}}function V(e,l,o,t,f,s){if(!(!I.particles||!e))for(let u=0;u<f;u++){const n=Math.PI*2*u/f+Math.random()*.6,d=s*(.6+Math.random()*.8);e.particles.push({x:l*(p+H)+p/2,y:o*(p+H)+p/2,vx:Math.cos(n)*d,vy:Math.sin(n)*d-1,r:2+Math.random()*3,color:t,life:20+D(16),maxLife:36})}}function Se(e,l,o,t){!I.particles||!e||(e.resonanceWave={x:l*(p+H)+p/2,y:o*(p+H)+p/2,r:0,maxR:200,color:t,alpha:.55})}function je(e,l){I.particles&&e.echos.push({x:e.player.x*(p+H)+p/2,y:e.player.y*(p+H)+p/2,life:30,maxLife:30,size:p*.38,color:l==="A"?"rgba(200,0,80,0.35)":"rgba(0,255,136,0.3)"})}function ml(e,l,o,t,f,s,u){const n=e,d=n.sz,m=Ge[I.difficulty];if(!n||n.hp<=0)return;if(h.freeze&&h.freezeTimer>0){h.freezeTimer-=l;return}const c=n.slowMoves?1.5:1,y=m.eSpeedBase-n.level*30,_=Math.max(m.eSpeedMin,y)*(t==="A"?.65:1)*c;if(n.level>=3){if(f.splice(0,f.length,...f.filter(i=>i.life>0)),Math.random()<6e-4*n.level&&f.length<3){const i=D(d),g=D(d);n.grid[i][g]===a.VOID&&f.push({y:i,x:g,timer:0,life:5e3+D(4e3)})}for(const i of f)if(i.life-=l,i.timer+=l,i.timer>450){i.timer=0;const g=n.player.x-i.x,T=n.player.y-i.y,P=T>0?1:T<0?-1:0,O=g>0?1:g<0?-1:0,C=i.y+P,S=i.x+O;C>=0&&C<d&&S>=0&&S<d&&(i.y=C,i.x=S),i.y===n.player.y&&i.x===n.player.x&&(n.hp=Math.max(0,n.hp-8),i.life=0,n.shakeFrames=4,n.flashColor="#8800ff",n.flashAlpha=.18,s("CHAOS PHANTOM!","#aa00ff",35))}}if(n.boss&&n.boss.hp>0){const i=n.boss;if(i.timer+=l,i.phaseTimer-=l,i.phaseTimer<=0&&(i.phase=i.phase==="chase"?"orbit":"chase",i.phaseTimer=400+D(300)),i.timer>280){i.timer=0;let g=n.player.x,T=n.player.y;n.level>=8&&(g+=o.has("ArrowRight")||o.has("d")?1:o.has("ArrowLeft")||o.has("a")?-1:0,T+=o.has("ArrowDown")||o.has("s")?1:o.has("ArrowUp")||o.has("w")?-1:0);const P=T-i.y,O=g-i.x,C=P>0?1:P<0?-1:0,S=O>0?1:O<0?-1:0;if(C&&i.y+C>=0&&i.y+C<d?i.y+=C:S&&i.x+S>=0&&i.x+S<d&&(i.x+=S),i.y===n.player.y&&i.x===n.player.x){const L=Math.round(40*m.dmgMul*(t==="A"?1.3:1));n.hp=Math.max(0,n.hp-L),n.shakeFrames=14,n.flashColor="#ff00aa",n.flashAlpha=.45,V(n,n.player.x,n.player.y,"#ff00aa",22,5),s("BOSS! -"+L,"#ff00aa",50)}}}for(const i of n.enemies){if(i.stunTimer>0){i.stunTimer-=l;continue}if(i.timer+=l,i.timer<_)continue;i.timer=0,i.prevY=i.y,i.prevX=i.x;const g=i.behavior||n.ds.enemyBehavior,T=n.player.x-i.x,P=n.player.y-i.y,O=Math.abs(T)+Math.abs(P);let C=!1;if(g==="wander"||O>d*.7){const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[L,w]of S){const E=i.y+L,r=i.x+w;if(E>=0&&E<d&&r>=0&&r<d&&n.grid[E][r]!==a.WALL){i.y=E,i.x=r,C=!0;break}}}else if(g==="patrol"){i.patrolAngle+=(Math.random()-.5)*.4;const S=Math.round(Math.sin(i.patrolAngle)),L=Math.round(Math.cos(i.patrolAngle)),w=i.y+ue(S,-1,1),E=i.x+ue(L,-1,1);if(w>=0&&w<d&&E>=0&&E<d&&n.grid[w][E]!==a.WALL&&(i.y=w,i.x=E,C=!0),O<5&&Math.random()<.7){const r=P>0?1:P<0?-1:0,A=T>0?1:T<0?-1:0,v=i.y+r,N=i.x+A;v>=0&&v<d&&N>=0&&N<d&&n.grid[v][N]!==a.WALL&&(i.y=v,i.x=N)}}else if(g==="orbit"){i.orbitAngle+=.25;const S=n.player.x+Math.round(Math.cos(i.orbitAngle)*i.orbitR),L=n.player.y+Math.round(Math.sin(i.orbitAngle)*i.orbitR),w=L-i.y>0?1:L-i.y<0?-1:0,E=S-i.x>0?1:S-i.x<0?-1:0;i.y+w>=0&&i.y+w<d&&i.x+E>=0&&i.x+E<d&&n.grid[i.y+w][i.x+E]!==a.WALL&&(i.y+=w,i.x+=E)}else if(g==="chase_fast"||g==="adaptive"||g==="predictive"){let S=n.player.x,L=n.player.y;g==="predictive"&&n.level>=7&&(S+=o.has("ArrowRight")||o.has("d")?1:o.has("ArrowLeft")||o.has("a")?-1:0,L+=o.has("ArrowDown")||o.has("s")?1:o.has("ArrowUp")||o.has("w")?-1:0);const w=S-i.x,E=L-i.y,r=Math.abs(E)>=Math.abs(w)?[[E>0?1:-1,0],[0,w>0?1:-1]]:[[0,w>0?1:-1],[E>0?1:-1,0]];for(const[A,v]of r){const N=i.y+A,M=i.x+v;if(N>=0&&N<d&&M>=0&&M<d&&n.grid[N][M]!==a.WALL){i.y=N,i.x=M,C=!0;break}}if(!C){const A=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[v,N]of A){const M=i.y+v,W=i.x+N;if(M>=0&&M<d&&W>=0&&W<d&&n.grid[M][W]!==a.WALL){i.y=M,i.x=W;break}}}}else if(g==="rush"){const S=Math.abs(P)>=Math.abs(T)?[[P>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[P>0?1:-1,0]];for(const[L,w]of S){const E=i.y+L,r=i.x+w;if(E>=0&&E<d&&r>=0&&r<d&&n.grid[E][r]!==a.WALL){i.y=E,i.x=r,C=!0;break}}if(!C){const L=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[w,E]of L){const r=i.y+w,A=i.x+E;if(r>=0&&r<d&&A>=0&&A<d&&n.grid[r][A]!==a.WALL){i.y=r,i.x=A;break}}}}else if(g==="scatter"){const S=Math.abs(P)>=Math.abs(T)?[[P>0?-1:1,0],[0,T>0?-1:1]]:[[0,T>0?-1:1],[P>0?-1:1,0]];for(const[L,w]of S){const E=i.y+L,r=i.x+w;if(E>=0&&E<d&&r>=0&&r<d&&n.grid[E][r]!==a.WALL){i.y=E,i.x=r,C=!0;break}}if(!C){const L=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[w,E]of L){const r=i.y+w,A=i.x+E;if(r>=0&&r<d&&A>=0&&A<d&&n.grid[r][A]!==a.WALL){i.y=r,i.x=A;break}}}}else if(g==="labyrinth"){if(O<4){const S=Math.abs(P)>=Math.abs(T)?[[P>0?1:-1,0],[0,T>0?1:-1]]:[[0,T>0?1:-1],[P>0?1:-1,0]];for(const[L,w]of S){const E=i.y+L,r=i.x+w;if(E>=0&&E<d&&r>=0&&r<d&&n.grid[E][r]!==a.WALL){i.y=E,i.x=r,C=!0;break}}}if(!C){i.patrolAngle+=Math.random()<.35?(Math.random()-.5)*1.2:0;const S=Math.round(Math.sin(i.patrolAngle)),L=Math.round(Math.cos(i.patrolAngle)),w=i.y+ue(S,-1,1),E=i.x+ue(L,-1,1);if(w>=0&&w<d&&E>=0&&E<d&&n.grid[w][E]!==a.WALL&&(i.y=w,i.x=E,C=!0),!C){i.patrolAngle+=Math.PI*.5;const r=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[A,v]of r){const N=i.y+A,M=i.x+v;if(N>=0&&N<d&&M>=0&&M<d&&n.grid[N][M]!==a.WALL){i.y=N,i.x=M;break}}}}}else{const S=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-.5);for(const[L,w]of S){const E=i.y+L,r=i.x+w;if(E>=0&&E<d&&r>=0&&r<d&&n.grid[E][r]!==a.WALL){i.y=E,i.x=r;break}}}if(i.y===n.player.y&&i.x===n.player.x)if(h.shield&&h.shieldTimer>0)i.stunTimer=1300,s("SHIELD HELD!","#00ffcc",38),V(n,n.player.x,n.player.y,"#00ffcc",14,3);else{const S=Math.round(22*m.dmgMul*(t==="A"?1.3:1));n.hp=Math.max(0,n.hp-S),n.shakeFrames=8,n.flashColor="#ff2200",n.flashAlpha=.35,V(n,n.player.x,n.player.y,"#ff4400",16,4),i.stunTimer=900,h.shieldCount=0,h.comboCount=0,s("HIT! -"+S,"#ff4400",40),u(n,"panic")}for(const S of n.captureZones)Math.abs(i.x-n.player.x)<=S.r&&Math.abs(i.y-n.player.y)<=S.r&&(n.hp=Math.max(0,n.hp-5),s("CAPTURED!","#ff0044",25))}n.captureZones=n.captureZones.filter(i=>(i.timer--,i.timer>0))}function me(e,l){h.emotion=l,h.emotionTimer=120,e.emotionTimer=120,e.slowMoves=l==="hopeless"||l==="despair"}function re(e,l,o,t){e&&(e.msg=l,e.msgColor=o,e.msgTimer=t)}function El(e,l,o){const t=le[l];if(t){if(e.archetypeActive=!0,e.archetypeType=l,e.archetypeTimer=180,h.archetypePower=t.power,h.archetypeDuration=180,re(e,t.activationMsg,"#ffdd00",70),Se(e,e.player.x,e.player.y,"#ffdd00"),V(e,e.player.x,e.player.y,"#ffdd00",24,4),l==="child"){for(let f=0;f<e.sz;f++)for(let s=0;s<e.sz;s++)e.grid[f][s]===a.HIDDEN&&e.tileFlicker.push({y:f,x:s,t:200,reveal:!0});re(e,"CHILD REVEALS THE PATH…","#aaffcc",60)}l==="protector"&&(h.shield=!0,h.shieldTimer=30,V(e,e.player.x,e.player.y,"#88ccff",20,5)),l==="orb"&&(h.phaseShift=!0,h.phaseTimer=15),l==="captor"&&(h.temporalRewind=!0,h.rewindBuffer=h.rewindBuffer.slice(-3))}}function He(e){const l=h.archetypePower;if(!l)return;const o=e.sz;if(l==="wall_jump")for(const[t,f]of[[-2,0],[2,0],[0,-2],[0,2]]){const s=e.player.y+t,u=e.player.x+f;if(s>=0&&s<o&&u>=0&&u<o&&e.grid[s][u]!==a.WALL){je(e,"B"),e.player.y=s,e.player.x=u,V(e,u,s,"#ffaa00",16,3),re(e,"DRAGON LEAP!","#ffaa00",35);break}}else if(l==="phase_walk")h.phaseShift=!0,h.phaseTimer=10,re(e,"ORB PHASE ACTIVE","#aaddff",35);else if(l==="rewind")if(h.rewindBuffer.length>0){const t=h.rewindBuffer.pop();if(e.player.y=t.y,e.player.x=t.x,t.grid)for(let f=0;f<o;f++)for(let s=0;s<o;s++)e.grid[f][s]=t.grid[f][s];V(e,e.player.x,e.player.y,"#ffaadd",20,3),re(e,"TEMPORAL REWIND","#ffaadd",40)}else re(e,"NO REWIND MEMORY","#443344",30);else if(l==="shield_burst"){h.shield=!0,h.shieldTimer=25;for(const t of e.enemies)t.stunTimer=1500;e.boss&&(e.boss.stunTimer=2e3),V(e,e.player.x,e.player.y,"#88ccff",30,6),re(e,"PROTECT — ENEMIES STUNNED!","#88ccff",55)}}function Al(e,l,o,t,f,s,u,n){const d=e.sz,m=e.player.y+l,c=e.player.x+o;if(m<0||m>=d||c<0||c>=d)return!1;const y=e.grid[m][c];if(y===a.WALL&&!(h.phaseShift&&h.phaseTimer>0)||y===a.HIDDEN&&t==="A"&&!h.phaseShift)return!1;if(h.temporalRewind&&h.rewindBuffer.length<8){const i=e.grid.map(g=>[...g]);h.rewindBuffer.push({y:e.player.y,x:e.player.x,grid:i})}e.moveHistory.push({y:e.player.y,x:e.player.x}),e.moveHistory.length>15&&e.moveHistory.shift(),je(e,t),I.particles&&e.trail.push({x:e.player.x*(p+H)+p/2,y:e.player.y*(p+H)+p/2,life:14,maxLife:14,color:t==="A"?"rgba(180,0,80,0.45)":"rgba(0,255,136,0.38)"}),e.player.y=m,e.player.x=c,h.phaseShift&&h.phaseTimer>0&&(h.phaseTimer--,h.phaseTimer<=0&&(h.phaseShift=!1,s("PHASE FADED","#445566",25))),h.shield&&h.shieldTimer>0&&(h.shieldTimer--,h.shieldTimer<=0&&(h.shield=!1,s("SHIELD FADED","#445566",25))),t==="A"?h.energy=Math.max(0,h.energy-.9):h.energy=Math.min(h.energyMax,h.energy+.5),e.archetypeActive&&(e.archetypeTimer--,e.archetypeTimer<=0&&(e.archetypeActive=!1,h.archetypePower=null));const _={dmgMul:I.difficulty==="hard"?1.45:I.difficulty==="easy"?.55:1};if(y===a.PEACE){const i=Math.round((150+e.level*20)*h.resonanceMultiplier);e.score+=i,e.hp=Math.min(h.maxHp,e.hp+20),e.grid[m][c]=a.VOID,e.peaceLeft--,V(e,c,m,h.particleColor,18,3.5),h.shieldCount++,h.comboCount++,h.resonanceMultiplier=Math.min(4,1+h.comboCount*.25),h.glitchPulseCharge=Math.min(100,h.glitchPulseCharge+15),h.comboCount>=3&&!h.shield?(h.shield=!0,h.shieldTimer=20,Se(e,c,m,"#00ffcc"),V(e,c,m,"#00ffcc",26,5),s("SHIELD ACTIVE! ×"+h.resonanceMultiplier.toFixed(1),"#00ffcc",55)):s("+PEACE +"+i+(h.comboCount>1?" ×"+h.resonanceMultiplier.toFixed(1):""),"#00ffcc",38),me(e,"peace"),e.peaceLeft===0&&f()}else if(y===a.INSIGHT){const i=Math.round((300+e.level*50)*h.resonanceMultiplier);e.score+=i,n(u+1),e.grid[m][c]=a.VOID,e.insightLeft--,V(e,c,m,"#00eeff",24,4),Se(e,c,m,"#00eeff"),s("INSIGHT ◆×"+(u+1),"#00eeff",60);for(let g=0;g<d;g++)for(let T=0;T<d;T++)e.grid[g][T]===a.HIDDEN&&e.tileFlicker.push({y:g,x:T,t:100,reveal:!0});me(e,"clarity")}else if(y===a.ARCHETYPE){e.grid[m][c]=a.VOID;const i=e.ds.archetype==="all"?ie(Object.keys(le)):e.ds.archetype||"orb";El(e,i)}else if(y===a.TELEPORT){let i=0,g=D(d),T=D(d);for(;(e.grid[g][T]!==a.VOID||g===m&&T===c)&&i<200;)g=D(d),T=D(d),i++;e.player.y=g,e.player.x=T,e.grid[m][c]=a.VOID,V(e,T,g,"#00aaff",16,3),s("LEAP!","#00aaff",30)}else if(y===a.COVER){s("COVER","#446688",20);for(const i of e.enemies)Math.abs(i.y-m)+Math.abs(i.x-c)<=2&&(i.stunTimer=600)}else if(y===a.MEMORY)e.grid[m][c]=a.VOID,e.score+=50,s("MEMORY ECHO…","#88bbaa",30),V(e,c,m,"#88bbaa",10,2);else if(ee[y]&&ee[y].dmg>0)if(h.shield&&h.shieldTimer>0)s("SHIELDED","#00ffcc",20);else{const i=ee[y];let g=Math.round(i.dmg*_.dmgMul*(t==="A"?1.25:1));if(y===a.RAGE&&i.push>0){const C=m+l*i.push,S=c+o*i.push;C>=0&&C<d&&S>=0&&S<d&&e.grid[C][S]!==a.WALL&&(e.player.y=C,e.player.x=S,s("-RAGE (pushed!)","#ff0066",40))}if(y===a.SELF_HARM&&(e.grid[m][c]=a.PAIN),y===a.HOPELESS&&me(e,"hopeless"),y===a.DESPAIR&&Math.random()<.3){const C=[[1,0],[-1,0],[0,1],[0,-1]],[S,L]=ie(C),w=m+S,E=c+L;w>=0&&w<d&&E>=0&&E<d&&e.grid[w][E]===a.VOID&&(e.grid[w][E]=a.DESPAIR)}e.hp=Math.max(0,e.hp-g),e.shakeFrames=5;const T={[a.DESPAIR]:"#2244ff",[a.TERROR]:"#ff0000",[a.SELF_HARM]:"#660000",[a.RAGE]:"#ff0044",[a.HOPELESS]:"#004488",[a.GLITCH]:"#aa00ff",[a.TRAP]:"#ff8800",[a.PAIN]:"#440000"},P={[a.DESPAIR]:"#3355ff",[a.TERROR]:"#ff2222",[a.SELF_HARM]:"#880000",[a.RAGE]:"#ff0044",[a.HOPELESS]:"#004488",[a.GLITCH]:"#aa00ff",[a.TRAP]:"#ff8800",[a.PAIN]:"#440000"},O={[a.DESPAIR]:"-DESPAIR",[a.TERROR]:"-TERROR!",[a.SELF_HARM]:"-SELF·HARM",[a.RAGE]:"-RAGE",[a.HOPELESS]:"-HOPELESS",[a.GLITCH]:"-GLITCH",[a.TRAP]:"-TRAP",[a.PAIN]:"-PAIN"};e.flashColor=T[y]||"#ff0000",e.flashAlpha=.28,V(e,c,m,P[y]||"#ff2222",10,3),s((O[y]||"-HAZARD")+" -"+g,P[y]||"#ff3333",38),h.shieldCount=0,h.comboCount=0,h.resonanceMultiplier=1}return!0}function gl(e,l){if(!e||h.glitchPulseCharge<100)return;h.glitchPulseCharge=0;let o=0;for(let t=0;t<e.sz;t++)for(let f=0;f<e.sz;f++)Math.abs(t-e.player.y)+Math.abs(f-e.player.x)<=3&&ee[e.grid[t][f]]?.dmg>0&&(e.grid[t][f]=a.VOID,o++);for(const t of e.enemies)Math.abs(t.y-e.player.y)+Math.abs(t.x-e.player.x)<=4&&(t.stunTimer=1800);Se(e,e.player.x,e.player.y,"#aa00ff"),V(e,e.player.x,e.player.y,"#aa00ff",32,6),l("GLITCH PULSE! "+o+" CLEARED","#aa00ff",55)}function cl(e,l){if(e.spreadTimer-=l,e.spreadTimer>0)return;e.spreadTimer=3e3+D(1e3);const o=e.sz,t=[];for(let f=0;f<o;f++)for(let s=0;s<o;s++){const u=e.grid[f][s];if((u===a.DESPAIR||u===a.HOPELESS)&&ee[u].spread)for(const[n,d]of[[1,0],[-1,0],[0,1],[0,-1]]){const m=f+n,c=s+d;m>=0&&m<o&&c>=0&&c<o&&e.grid[m][c]===a.VOID&&Math.random()<.2&&t.push({y:m,x:c,type:u})}}for(const f of t.slice(0,2))e.grid[f.y][f.x]=f.type}function Sl(e){return e==="A"?xe:Qe}function Tl(e,l,o,t,f,s,u,n,d,m,c){const y=o;if(!y)return;const _=y.sz,i=_*p+(_-1)*H,g=i+48,T=i+148,P=Sl(t),O=y.ds;e.clearRect(0,0,g,T),e.fillStyle=O.bgColor,e.fillRect(0,0,g,T);const C=e.createRadialGradient(g*.7,T*.3,0,g*.7,T*.3,g*.8);C.addColorStop(0,O.bgAccent+"33"),C.addColorStop(1,"transparent"),e.fillStyle=C,e.fillRect(0,0,g,T),t==="A"&&(e.fillStyle="rgba(80,0,20,0.07)",e.fillRect(0,0,g,T));for(let r=0;r<T;r+=3)e.fillStyle="rgba(0,0,0,0.06)",e.fillRect(0,r,g,1);for(const r of f){const A=r.a*(.5+.5*Math.sin(l*8e-4+r.phase));e.globalAlpha=A,e.fillStyle="#ffffff",e.beginPath(),e.arc(r.x,r.y,r.r,0,Math.PI*2),e.fill()}e.globalAlpha=1,m>0&&(e.fillStyle=`rgba(${t==="A"?"180,0,60":"0,180,60"},0.04)`,e.fillRect(0,Math.floor(Math.random()*T),g,2+Math.floor(Math.random()*4)));let S=0,L=0;y.shakeFrames>0&&(S=(Math.random()-.5)*9*(y.shakeFrames/10),L=(Math.random()-.5)*9*(y.shakeFrames/10),y.shakeFrames--);const w=(g-i)/2+S,E=100+L;for(const r of s)r.x+=r.dx,r.y+=r.dy,r.life--,r.life>r.maxLife*.85?r.alpha=Math.min(r.targetAlpha,(r.maxLife-r.life)/(r.maxLife*.15)*r.targetAlpha):r.life<r.maxLife*.15&&(r.alpha=Math.max(0,r.life/(r.maxLife*.15)*r.targetAlpha)),r.life<=0&&(r.life=200+Math.floor(Math.random()*400),r.maxLife=600),e.globalAlpha=r.alpha*(t==="A"?.7:1),e.fillStyle=t==="A"?"#ff4488":"#00aa55",e.font="9px Courier New",e.textAlign="center",e.fillText(r.text,r.x,r.y);e.globalAlpha=1,e.textAlign="left";for(let r=0;r<_;r++)for(let A=0;A<_;A++){const v=y.grid[r][A],N=y.tileFlicker.find(G=>G.y===r&&G.x===A),M=N&&N.reveal&&v===a.HIDDEN?a.INSIGHT:v,W=ee[M]||ee[a.VOID],K=P[M]||P[a.VOID],z=w+A*(p+H),U=E+r*(p+H);if(n&&(r===d.row||A===d.col)?(e.shadowColor="#ffaa00",e.shadowBlur=10):K.glow?(e.shadowColor=K.glow,e.shadowBlur=12):e.shadowBlur=0,e.fillStyle=K.bg,e.beginPath(),e.roundRect(z,U,p,p,4),e.fill(),e.strokeStyle=K.bd,e.lineWidth=1,e.beginPath(),e.roundRect(z+.5,U+.5,p-1,p-1,4),e.stroke(),e.shadowBlur=0,M===a.PEACE){const G=(l*.05+r*6+A*4)%(p*2);if(G<p){const $=e.createLinearGradient(z,U+G-5,z,U+G+5);$.addColorStop(0,"rgba(0,255,140,0)"),$.addColorStop(.5,"rgba(0,255,140,0.45)"),$.addColorStop(1,"rgba(0,255,140,0)"),e.fillStyle=$,e.fillRect(z,U,p,p)}e.shadowColor="#00ffaa",e.shadowBlur=10,e.fillStyle="#00ffaa",e.beginPath(),e.arc(z+p/2,U+p/2,5+2*Math.sin(l*.006+A+r),0,Math.PI*2),e.fill(),e.shadowBlur=0}if(M===a.INSIGHT){e.shadowColor="#00eeff",e.shadowBlur=14;const G=l*.008+A*1.7+r*1.3;for(let $=0;$<4;$++){const ne=G+$*Math.PI*.5,X=7+2*Math.sin(l*.005+$);e.fillStyle=$%2===0?"#00eeff":"#00aacc",e.beginPath(),e.arc(z+p/2+Math.cos(ne)*X,U+p/2+Math.sin(ne)*X,2.5,0,Math.PI*2),e.fill()}e.shadowBlur=0}if(M===a.ARCHETYPE){const G=.5+.5*Math.sin(l*.01+A+r);e.shadowColor="#ffdd00",e.shadowBlur=16*G,e.fillStyle=`rgba(255,220,0,${.15*G})`,e.fillRect(z,U,p,p),e.font="18px Courier New",e.textAlign="center",e.fillStyle="#ffee44",e.fillText("☆",z+p/2,U+p/2+6),e.shadowBlur=0,e.textAlign="left"}if(M===a.TELEPORT){const G=.5+.5*Math.sin(l*.012+A*2+r);e.shadowColor="#00aaff",e.shadowBlur=12*G,e.fillStyle=`rgba(0,170,255,${.2*G})`,e.fillRect(z,U,p,p),e.font="14px Courier New",e.textAlign="center",e.fillStyle="#00ccff",e.fillText("⇒",z+p/2,U+p/2+5),e.shadowBlur=0,e.textAlign="left"}if(M===a.MEMORY){const G=.3+.3*Math.sin(l*.004+A+r);e.globalAlpha=.4+.2*G,e.fillStyle="rgba(100,200,150,0.15)",e.fillRect(z,U,p,p),e.globalAlpha=1}W.sym&&M!==a.VOID&&M!==a.WALL&&M!==a.PEACE&&M!==a.INSIGHT&&M!==a.ARCHETYPE&&M!==a.TELEPORT&&M!==a.HIDDEN&&M!==a.MEMORY&&(e.fillStyle=K.bd,e.font="12px Courier New",e.textAlign="center",e.globalAlpha=.55,e.fillText(W.sym,z+p/2,U+p/2+5),e.globalAlpha=1,e.textAlign="left"),(M===a.PEACE||M===a.INSIGHT)&&h.magnet&&Math.abs(r-y.player.y)+Math.abs(A-y.player.x)<=2&&(e.strokeStyle="rgba(0,255,180,0.28)",e.lineWidth=1,e.beginPath(),e.roundRect(z+2,U+2,p-4,p-4,4),e.stroke())}y.tileFlicker=y.tileFlicker.filter(r=>(r.t--,r.t>0));for(const r of y.captureZones)e.strokeStyle=`rgba(255,0,68,${.4*(r.timer/300)})`,e.lineWidth=2,e.setLineDash([3,3]),e.beginPath(),e.arc(w+r.x*(p+H)+p/2,E+r.y*(p+H)+p/2,(r.r+.5)*(p+H),0,Math.PI*2),e.stroke(),e.setLineDash([]);for(const r of y.echos)e.globalAlpha=r.life/r.maxLife*.55,e.fillStyle=r.color,e.beginPath(),e.arc(w+r.x,E+r.y,r.size*(r.life/r.maxLife),0,Math.PI*2),e.fill(),r.life--;if(y.echos=y.echos.filter(r=>r.life>0),e.globalAlpha=1,I.particles){for(const r of y.trail)e.globalAlpha=r.life/r.maxLife*.48,e.fillStyle=r.color,e.shadowColor=r.color,e.shadowBlur=4,e.beginPath(),e.arc(w+r.x,E+r.y,4*(r.life/r.maxLife),0,Math.PI*2),e.fill(),r.life--;y.trail=y.trail.filter(r=>r.life>0),e.globalAlpha=1,e.shadowBlur=0}for(const r of u){if(r.life<=0)continue;const A=w+r.x*(p+H),v=E+r.y*(p+H),N=.3+.25*Math.sin(Date.now()*.006+r.x);e.globalAlpha=N,e.fillStyle="#220044",e.shadowColor="#8800ff",e.shadowBlur=10,e.beginPath(),e.roundRect(A+8,v+8,p-16,p-16,4),e.fill(),e.fillStyle="rgba(170,0,255,0.6)",e.font="16px Courier New",e.textAlign="center",e.fillText("?",A+p/2,v+p/2+5),e.shadowBlur=0,e.globalAlpha=1,e.textAlign="left"}for(const r of y.enemies){const A=w+r.x*(p+H),v=E+r.y*(p+H),N=.6+.4*Math.sin(l*.007+r.x*1.3),M=r.stunTimer>0,W=r.type==="rush",K=M?"#8888ff":W?"#ff0066":t==="A"?"#ff0044":"#ff4400";e.shadowColor=K,e.shadowBlur=14*N,e.fillStyle=M?"#1c1c44":W?"#4a0022":t==="A"?"#660022":"#aa2200",e.beginPath(),e.roundRect(A+5,v+5,p-10,p-10,6),e.fill(),e.shadowBlur=0,e.fillStyle=M?"#4444aa":W?"#ff0066":t==="A"?"#ff2266":"#ff6622",e.beginPath(),e.moveTo(A+p/2,v+12),e.lineTo(A+p-12,v+p-12),e.lineTo(A+12,v+p-12),e.closePath(),e.fill(),e.fillStyle=M?"#6666cc":"#ffcc00",e.beginPath(),e.arc(A+p/2,v+p/2+2,4,0,Math.PI*2),e.fill()}if(y.boss&&y.boss.hp>0){const r=y.boss,A=w+r.x*(p+H),v=E+r.y*(p+H),N=.5+.5*Math.sin(l*.005);e.shadowColor="#ff00aa",e.shadowBlur=28*N,e.fillStyle="#330022",e.beginPath(),e.roundRect(A+1,v+1,p-2,p-2,8),e.fill(),e.fillStyle="#ff00aa",e.beginPath(),e.arc(A+p/2,v+p/2,p*.3+4*N,0,Math.PI*2),e.fill(),e.fillStyle="#ffccee",e.font="bold 10px Courier New",e.textAlign="center",e.fillText("HP:"+r.hp,A+p/2,v+p/2+4),e.textAlign="left",e.shadowBlur=0}{const r=w+y.player.x*(p+H),A=E+y.player.y*(p+H),v=.55+.45*Math.sin(l*.009),N=h.shield&&h.shieldTimer>0,M=h.phaseShift&&h.phaseTimer>0,W=h.emotion,z=t==="A"?"#ff0088":N?"#00ffff":M?"#00aaff":W==="panic"?"#ff0022":W==="hopeless"?"#0033aa":W==="peace"?"#00ffcc":W==="clarity"?"#00eeff":"#00ffaa";e.shadowColor=z,e.shadowBlur=(N?36:h.aura?30:22)*v;const U=t==="A"?"#aa0055":"#005533",G=t==="A"?"#cc0077":"#00cc77",$=t==="A"?"rgba(200,0,120,0.9)":"rgba(0,255,170,0.9)";if(e.fillStyle=U,e.beginPath(),e.roundRect(r+4,A+4,p-8,p-8,8),e.fill(),e.fillStyle=G,e.beginPath(),e.roundRect(r+9,A+9,p-18,p-18,5),e.fill(),e.fillStyle=$,e.beginPath(),e.roundRect(r+15,A+15,p-30,p-30,3),e.fill(),y.archetypeActive){const X=le[y.archetypeType||"orb"];e.strokeStyle=X.glow,e.lineWidth=2,e.shadowColor=X.glow,e.shadowBlur=16,e.beginPath(),e.roundRect(r+1,A+1,p-2,p-2,8),e.stroke()}N&&(e.strokeStyle="rgba(0,255,255,0.75)",e.lineWidth=2,e.beginPath(),e.roundRect(r,A,p,p,8),e.stroke()),M&&(e.globalAlpha=.4),h.aura&&(e.strokeStyle=`rgba(0,255,136,${.12+.08*v})`,e.lineWidth=3,e.beginPath(),e.arc(r+p/2,A+p/2,(p/2+7)*v,0,Math.PI*2),e.stroke()),e.globalAlpha=1,e.shadowBlur=0,e.strokeStyle=z,e.lineWidth=2;const ne=9;[[r,A],[r+p,A],[r,A+p],[r+p,A+p]].forEach(([X,pe],Le)=>{const ve=Le%2===0?1:-1,Ne=Le<2?1:-1;e.beginPath(),e.moveTo(X+ve*2,pe),e.lineTo(X+ve*(2+ne),pe),e.stroke(),e.beginPath(),e.moveTo(X,pe+Ne*2),e.lineTo(X,pe+Ne*(2+ne)),e.stroke()}),e.shadowBlur=0}if(I.particles){o.particles=o.particles.filter(r=>r.life>0);for(const r of o.particles)e.globalAlpha=Math.max(0,r.life/r.maxLife),e.fillStyle=r.color,e.shadowColor=r.color,e.shadowBlur=7,e.beginPath(),e.arc(w+r.x,E+r.y,r.r*(r.life/r.maxLife),0,Math.PI*2),e.fill(),r.x+=r.vx,r.y+=r.vy,r.vy+=.25,r.life--;e.globalAlpha=1,e.shadowBlur=0}if(y.resonanceWave){const r=y.resonanceWave;r.r+=7,r.alpha=Math.max(0,r.alpha-.55/r.maxR*7),e.strokeStyle=r.color,e.globalAlpha=r.alpha,e.lineWidth=2,e.shadowColor=r.color,e.shadowBlur=10,e.beginPath(),e.arc(w+r.x,E+r.y,r.r,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.shadowBlur=0,r.r>=r.maxR&&(y.resonanceWave=null)}if(y.flashAlpha>0&&(e.fillStyle=y.flashColor,e.globalAlpha=y.flashAlpha,e.fillRect(w,E,i,i),e.globalAlpha=1,y.flashAlpha=Math.max(0,y.flashAlpha-.04)),t==="A"){const r=e.createRadialGradient(g/2,T/2,T*.25,g/2,T/2,T*.9);r.addColorStop(0,"rgba(80,0,20,0)"),r.addColorStop(1,"rgba(80,0,20,0.22)"),e.fillStyle=r,e.fillRect(0,0,g,T)}bl(e,y,g,T,i,w,E,t)}function bl(e,l,o,t,f,s,u,n){const d=h,m=92;e.fillStyle="#070714",e.fillRect(0,0,o,m),e.strokeStyle="rgba(255,255,255,0.04)",e.lineWidth=1,e.beginPath(),e.moveTo(0,m),e.lineTo(o,m),e.stroke(),e.fillStyle=l.ds.bgAccent+"88",e.fillRect(0,0,o,16),e.fillStyle="#334455",e.font="8px Courier New",e.textAlign="center",e.fillText(l.ds.name+"  ·  "+l.ds.emotion,o/2,11),e.textAlign="left";const c=138;e.fillStyle="#333",e.font="9px Courier New",e.fillText("HP",14,30),e.fillStyle="#0e0e1e",e.fillRect(32,20,c,13);const y=l.hp/d.maxHp,_=y>.6?"#00ff88":y>.3?"#ffaa00":"#ff3333";e.fillStyle=_,e.shadowColor=_,e.shadowBlur=5,e.fillRect(32,20,c*y,13),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.06)",e.strokeRect(32,20,c,13),e.fillStyle="#444",e.font="8px Courier New",e.fillText(l.hp+"/"+d.maxHp,32+c+4,30);const i=138;e.fillStyle="#222",e.font="8px Courier New",e.fillText("EN",14,50),e.fillStyle="#0a0a1a",e.fillRect(32,41,i,9);const g=n==="A"?"#ff0055":"#0088ff";if(e.fillStyle=g,e.shadowColor=g,e.shadowBlur=4,e.fillRect(32,41,i*(d.energy/d.energyMax),9),e.shadowBlur=0,e.strokeStyle="rgba(255,255,255,0.04)",e.strokeRect(32,41,i,9),d.glitchPulse){e.fillStyle="#220a22",e.fillRect(32,53,i,6);const P=d.glitchPulseCharge/100;e.fillStyle=P>=1?"#ff00ff":"#660088",e.fillRect(32,53,i*P,6),e.strokeStyle="rgba(150,0,200,0.2)",e.strokeRect(32,53,i,6),e.fillStyle=P>=1?"#ff00ff":"#553355",e.font="7px Courier New",e.fillText("PULSE"+(P>=1?" READY":""),32+i+4,59)}if(l.archetypeActive&&l.archetypeType){const P=le[l.archetypeType];e.fillStyle=P?P.color:"#ffdd00",e.shadowColor=P?P.glow:"#ffdd00",e.shadowBlur=4,e.font="8px Courier New",e.fillText(P?P.name+" ACTIVE":"[ARCH ACTIVE]",14,68),e.shadowBlur=0}else d.shield&&d.shieldTimer>0?(e.fillStyle="#00ffff",e.font="8px Courier New",e.fillText("SHIELD×"+d.shieldTimer,14,68)):d.shieldCount>0&&(e.fillStyle="#334455",e.font="8px Courier New",e.fillText("streak "+d.shieldCount+"/3",14,68));d.comboCount>1&&(e.fillStyle="#ffcc00",e.shadowColor="#ffcc00",e.shadowBlur=6,e.font="8px Courier New",e.fillText("COMBO ×"+d.resonanceMultiplier.toFixed(1),14,80),e.shadowBlur=0),e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=5,e.font="9px Courier New",e.fillText("◆×"+(window._insightTokens||0),14,90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 19px Courier New",e.textAlign="center",e.fillText(String(l.score).padStart(7,"0"),o/2,38),e.shadowBlur=0,e.fillStyle="#222838",e.font="8px Courier New",e.fillText("SCORE",o/2,52);const T=n==="A"?"#ff0055":"#00aa55";e.fillStyle=T,e.shadowColor=T,e.shadowBlur=7,e.font="bold 10px Courier New",e.fillText("MTX·"+n,o/2-16,68),e.shadowBlur=0,e.textAlign="right",e.fillStyle="#445566",e.font="10px Courier New",e.fillText("LVL "+l.level,o-12,30),e.fillStyle="#005533",e.fillText("◈×"+l.peaceLeft,o-12,44),e.fillStyle="#223344",e.font="8px Courier New",e.fillText((window._dreamIdx+1||1)+"/10 DREAMS",o-12,58),e.textAlign="left",l.msg&&l.msgTimer>0&&(e.globalAlpha=Math.min(1,l.msgTimer/18),e.font="bold 16px Courier New",e.textAlign="center",e.fillStyle=l.msgColor,e.shadowColor=l.msgColor,e.shadowBlur=16,e.fillText(l.msg,o/2,u-16),e.textAlign="left",e.globalAlpha=1,e.shadowBlur=0,l.msgTimer--),e.fillStyle="#070714",e.fillRect(0,t-28,o,28),e.strokeStyle="rgba(255,255,255,0.03)",e.beginPath(),e.moveTo(0,t-28),e.lineTo(o,t-28),e.stroke(),e.fillStyle="#1a1a2a",e.font="8px Courier New",e.textAlign="center",e.fillText("WASD/ARROWS · SHIFT=matrix · ESC=pause · J=arch · R=pulse · Q=freeze · C=contain",o/2,t-11),e.textAlign="left"}function wl(e,l,o){for(const t of l)e.globalAlpha=t.a*(.5+.5*Math.sin(o*8e-4+t.phase)),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.x,t.y,t.r,0,Math.PI*2),e.fill();e.globalAlpha=1}function Cl(e,l,o,t,f,s){e.fillStyle="#02020a",e.fillRect(0,0,l,o);for(let n=0;n<o;n+=4)e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,n,l,1);wl(e,t,f),e.textAlign="center",e.fillStyle="#0a0a20",e.font="8px Courier New",e.fillText("A BEING NAVIGATES THE DREAMSCAPES",l/2,o/2-140),e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=32,e.font="bold 36px Courier New",e.fillText("GLITCH·PEACE",l/2,o/2-100),e.shadowBlur=0,e.fillStyle="#0a1a0a",e.font="9px Courier New",e.fillText("v4  ·  dreamscape consciousness simulation",l/2,o/2-78);const u=o/2-55;ll.forEach((n,d)=>{const m=d===s,c=u+d*36;m&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(l/2-130,c-19,260,28),e.strokeStyle="rgba(0,255,136,0.28)",e.strokeRect(l/2-130,c-19,260,28)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.shadowColor=m?"#00ff88":"transparent",e.shadowBlur=m?8:0,e.font=m?"bold 14px Courier New":"12px Courier New",e.fillText(n,l/2,c),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select",l/2,o-20),e.textAlign="left"}function Rl(e,l,o,t){e.fillStyle="#02020a",e.fillRect(0,0,l,o),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=18,e.font="bold 20px Courier New",e.fillText("SELECT DREAMSCAPE",l/2,50),e.shadowBlur=0,e.fillStyle="#223322",e.font="9px Courier New",e.fillText("journey begins from your chosen entry point",l/2,68);const f=Math.min(Y.length,6),s=Math.max(0,Math.min(t-Math.floor(f/2),Y.length-f));for(let u=0;u<f;u++){const n=s+u,d=Y[n],m=n===t,c=95+u*55;if(m&&(e.fillStyle="rgba(0,255,136,0.06)",e.fillRect(l/2-160,c-18,320,46),e.strokeStyle="rgba(0,255,136,0.25)",e.strokeRect(l/2-160,c-18,320,46)),e.fillStyle=m?"#00ff88":"#2a3a2a",e.font=m?"bold 12px Courier New":"11px Courier New",e.fillText(n+1+".  "+d.name,l/2,c),e.fillStyle=m?"#334455":"#1a2a1a",e.font="9px Courier New",e.fillText(d.subtitle+"  ·  "+d.emotion,l/2,c+16),m&&d.archetype&&le[d.archetype]){const y=le[d.archetype];e.fillStyle="#665522",e.fillText("archetype: "+y.name+" — "+y.powerDesc,l/2,c+30)}}e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER start here  ·  ESC back",l/2,o-20),e.textAlign="left"}function Ml(e,l,o,t){e.fillStyle="#02020a",e.fillRect(0,0,l,o),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("OPTIONS",l/2,50),e.shadowBlur=0,[{label:"GRID SIZE",opts:ol,cur:I.gridSize},{label:"DIFFICULTY",opts:al,cur:I.difficulty},{label:"PARTICLES",opts:["on","off"],cur:I.particles?"on":"off"},{label:"",opts:["← BACK"],cur:"← BACK"}].forEach((s,u)=>{const n=u===t,d=105+u*68;s.label&&(e.fillStyle="#334455",e.font="9px Courier New",e.fillText(s.label,l/2,d)),s.opts.forEach((m,c)=>{const y=m===s.cur,_=l/2+(c-(s.opts.length-1)/2)*110,i=d+24;e.fillStyle=n&&y?"rgba(0,255,136,0.12)":"rgba(255,255,255,0.02)",e.fillRect(_-44,i-16,88,24),e.strokeStyle=n&&y?"rgba(0,255,136,0.5)":y?"rgba(0,255,136,0.18)":"rgba(255,255,255,0.04)",e.strokeRect(_-44,i-16,88,24),e.fillStyle=y?"#00ff88":"#334455",e.shadowColor=y?"#00ff88":"transparent",e.shadowBlur=y?5:0,e.font=y?"bold 11px Courier New":"10px Courier New",e.fillText(m.toUpperCase(),_,i),e.shadowBlur=0}),n&&(e.fillStyle="#00ff88",e.font="12px Courier New",e.fillText("▶",l/2-154,d+24))}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ row  ·  ←→ value  ·  ENTER/ESC back",l/2,o-20),e.textAlign="left"}function Il(e,l,o,t){e.fillStyle="#02020a",e.fillRect(0,0,l,o),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("HIGH SCORES",l/2,50),e.shadowBlur=0,t.length?t.slice(0,8).forEach((f,s)=>{const u=95+s*38,n=s===0?"◈":s===1?"◇":"·";e.fillStyle=s===0?"#ffdd00":s===1?"#aaaaaa":s===2?"#cc8833":"#334455",e.font=s<3?"bold 12px Courier New":"11px Courier New",e.fillText(`${n}  ${String(f.score).padStart(7,"0")}   LVL${String(f.level).padStart(2,"0")}   ${f.dreamscape}   ${f.date}`,l/2,u)}):(e.fillStyle="#223322",e.font="12px Courier New",e.fillText("no scores yet…",l/2,o/2)),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("ENTER / ESC back",l/2,o-20),e.textAlign="left"}function Pl(e,l,o,t,f,s){e.fillStyle="#02020a",e.fillRect(0,0,l,o),e.textAlign="center",e.fillStyle="#00eeff",e.shadowColor="#00eeff",e.shadowBlur=16,e.font="bold 20px Courier New",e.fillText("UPGRADES",l/2,50),e.shadowBlur=0,e.fillStyle="#334455",e.font="10px Courier New",e.fillText("◆ insight tokens: "+f,l/2,68),oe.forEach((u,n)=>{const d=n===t,m=s(u.id),c=f>=u.cost&&!m,y=92+n*48;d&&(e.fillStyle="rgba(0,238,255,0.06)",e.fillRect(l/2-155,y-14,310,40),e.strokeStyle="rgba(0,238,255,0.22)",e.strokeRect(l/2-155,y-14,310,40)),e.fillStyle=m?"#00ff88":c?"#00ccdd":"#334455",e.shadowColor=m?"#00ff88":d?"#00ccdd":"transparent",e.shadowBlur=d&&!m?5:0,e.font="bold 11px Courier New",e.fillText(u.name,l/2-55,y),e.shadowBlur=0,e.fillStyle="#334",e.font="9px Courier New",e.fillText(u.desc,l/2-55,y+14),e.fillStyle=m?"#005533":c?"#006677":"#221122",e.font="10px Courier New",e.fillText(m?"OWNED":"◆×"+u.cost,l/2+88,y+4)}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ select  ·  ENTER buy  ·  ESC back",l/2,o-20),e.textAlign="left"}function Dl(e,l,o,t,f){e.fillStyle="rgba(0,0,0,0.87)",e.fillRect(0,0,l,o),e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=14,e.font="bold 24px Courier New",e.fillText("PAUSED",l/2,o/2-80),e.shadowBlur=0,t&&(e.fillStyle="#223322",e.font="9px Courier New",e.fillText(t.ds.name+"  ·  LEVEL "+t.level,l/2,o/2-58),e.fillStyle="#334455",e.fillText(t.ds.narrative,l/2,o/2-44)),rl.forEach((s,u)=>{const n=u===f,d=o/2-14+u*36;n&&(e.fillStyle="rgba(0,255,136,0.07)",e.fillRect(l/2-110,d-18,220,26),e.strokeStyle="rgba(0,255,136,0.26)",e.strokeRect(l/2-110,d-18,220,26)),e.fillStyle=n?"#00ff88":"#334433",e.shadowColor=n?"#00ff88":"transparent",e.shadowBlur=n?6:0,e.font=n?"bold 13px Courier New":"12px Courier New",e.fillText(s,l/2,d),e.shadowBlur=0}),e.fillStyle="#131328",e.font="8px Courier New",e.fillText("↑↓ navigate  ·  ENTER select  ·  ESC resume",l/2,o-20),e.textAlign="left"}function Ll(e,l,o,t,f){const s=1-t.timer/220,u=s<.1?s/.1:s>.9?(1-s)/.1:1,n=t.ds||Y[0];e.fillStyle=n.bgColor||"#02020a",e.fillRect(0,0,l,o);for(let d=0;d<7;d++){const m=(f*.02+d*l/7)%l;e.strokeStyle=`rgba(0,255,136,${.02*u})`,e.lineWidth=1,e.beginPath(),e.moveTo(m,0),e.lineTo(m-100,o),e.stroke()}if(e.globalAlpha=u,e.textAlign="center",e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=20,e.font="bold 14px Courier New",e.fillText(t.text,l/2,o/2-28),e.shadowBlur=0,e.fillStyle="#223322",e.font="11px Courier New",e.fillText("ENTERING: "+n.name,l/2,o/2+4),e.fillStyle="#334455",e.font="10px Courier New",e.fillText(n.narrative,l/2,o/2+24),n.archetype&&le[n.archetype]){const d=le[n.archetype];e.fillStyle=d.glow,e.shadowColor=d.glow,e.shadowBlur=10,e.font="10px Courier New",e.fillText("archetype: "+d.name,l/2,o/2+46),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="left"}function vl(e,l,o,t,f,s,u,n){e.fillStyle="rgba(8,0,0,0.97)",e.fillRect(0,0,l,o),e.textAlign="center";const d=t?.ds;if(e.fillStyle="#330000",e.font="9px Courier New",e.fillText("THE BEING DISSOLVES IN "+(d?.name||"THE VOID"),l/2,o/2-138),e.fillStyle="#ff2222",e.shadowColor="#ff2222",e.shadowBlur=30,e.font="bold 40px Courier New",e.fillText("ERASED",l/2,o/2-90),e.shadowBlur=0,e.fillStyle="#00ff88",e.shadowColor="#00ff88",e.shadowBlur=10,e.font="bold 26px Courier New",e.fillText(String(t.score).padStart(7,"0"),l/2,o/2-28),e.shadowBlur=0,e.fillStyle="#333",e.font="10px Courier New",e.fillText("FINAL SCORE  ·  LEVEL "+t.level,l/2,o/2-6),e.fillStyle="#223322",e.font="9px Courier New",e.fillText("dreams completed: "+s.length+"/"+Y.length,l/2,o/2+14),e.fillText("REP "+(n>=0?"+":"")+n+"  ·  ◆×"+u,l/2,o/2+32),f.length>0){const c=f.findIndex(y=>y.score===t.score);c>=0&&(e.fillStyle="#ffdd00",e.font="bold 11px Courier New",e.fillText("RANK #"+(c+1)+" ALL TIME",l/2,o/2+54))}const m=.7+.3*Math.sin(Date.now()*.004);e.fillStyle=`rgba(255,34,34,${.07*m})`,e.fillRect(l/2-110,o/2+70,220,34),e.strokeStyle=`rgba(255,34,34,${.45*m})`,e.strokeRect(l/2-110,o/2+70,220,34),e.fillStyle="#ff2222",e.font="12px Courier New",e.fillText("↺  ENTER TO TRY AGAIN",l/2,o/2+92),e.fillStyle="#221122",e.font="9px Courier New",e.fillText("ESC → TITLE",l/2,o/2+120),e.textAlign="left"}const ae=document.getElementById("c"),J=ae.getContext("2d"),ye=Math.min(window.devicePixelRatio||1,2);function De(){const e=de(),l=he();ae.width=e*ye,ae.height=l*ye,ae.style.width=Math.min(e,window.innerWidth-16)+"px",ae.style.height="auto",J.setTransform(1,0,0,1,0,0),J.scale(ye,ye)}De();let b=null,q=null,Be=0,Me=0;window._insightTokens=Z;window._dreamIdx=I.dreamIdx;let ke=0,Ee=500,Ae=!1,ge={row:-1,col:-1,t:0},Ie=[],Te=[],Pe=[],ce={text:"",timer:0,ds:null};const x=new Set;function Je(e,l){Te=[];for(let o=0;o<30;o++)Te.push({x:Math.random()*e,y:Math.random()*l,r:.5+Math.random()*1.5,a:Math.random()*.15,phase:Math.random()*Math.PI*2})}function Nl(e,l){Pe=[];for(let o=0;o<5;o++)Pe.push({text:ie(el),x:40+Math.random()*(e-80),y:90+Math.random()*(l-140),alpha:0,targetAlpha:.04+Math.random()*.07,life:200+D(500),maxLife:700,dx:(Math.random()-.5)*.05,dy:-.03-Math.random()*.04})}function F(e,l,o){b&&(b.msg=e,b.msgColor=l,b.msgTimer=o)}function Ol(e,l,o){const t=qe();t.push({score:e,level:l,dreamscape:o?.name||"?",date:new Date().toLocaleDateString()}),t.sort((s,u)=>u.score-s.score);const f=t.slice(0,8);Ue(f),hl(f)}function Hl(e){const l=e.ds.environmentEvent,o=e.sz;if(l){if(l==="gravity_shift"){const[t,f]=ie([[-1,0],[1,0],[0,-1],[0,1]]),s=e.player.y+t,u=e.player.x+f;s>=0&&s<o&&u>=0&&u<o&&e.grid[s][u]!==5&&(e.player.y=s,e.player.x=u,F("GRAVITY SHIFTS…","#8888ff",40))}else if(l==="loop_reset"){for(let t=-2;t<=2;t++)for(let f=-2;f<=2;f++){const s=e.player.y+t,u=e.player.x+f;s>=0&&s<o&&u>=0&&u<o&&e.grid[s][u]===0&&Math.random()<.25&&(e.grid[s][u]=8)}F("THE LOOP TIGHTENS…","#ff8800",40)}else if(l==="capture_zones"){const t=ie(e.enemies);t&&(e.captureZones=[{x:t.x,y:t.y,r:2,timer:300}]),F("CAPTURE ZONE ACTIVATED","#ff2244",40)}else if(l==="rapid_spawn"){if(e.enemies.length<10){const t=2+D(o-4),f=2+D(o-4);e.enemies.push({y:t,x:f,timer:0,stunTimer:0,behavior:"rush",patrolAngle:0,orbitAngle:0,orbitR:2,prevY:t,prevX:f,momentum:[0,0],type:"rush"}),F("CHAOS ERUPTS!","#ff0044",40)}}else if(l==="wall_phase"){let t=0;for(let f=0;f<o&&t<4;f++)for(let s=0;s<o&&t<4;s++)e.grid[f][s]===5&&Math.random()<.3&&(e.grid[f][s]=10,t++);F("MEMBRANE DISSOLVES…","#00ccff",40)}else if(l==="glide_nodes"){let t=0,f=0;for(;t<2&&f<999;){f++;const s=D(o),u=D(o);e.grid[s][u]===0&&(e.grid[s][u]=12,t++)}F("GLIDE NODES APPEAR","#00aaff",40)}else if(l==="mashup"){const t=ie(Y.filter(f=>f.id!==e.ds.id));if(t.hazardSet[0]){let f=0,s=0;for(;f<3&&s<999;){s++;const u=D(o),n=D(o);e.grid[u][n]===0&&(e.grid[u][n]=t.hazardSet[0],f++)}}F("DREAMSCAPES MERGE…","#ffaaff",40)}else if(l==="line_of_sight"){for(const s of e.enemies)s.stunTimer>0&&(s.stunTimer=0);let t=0,f=0;for(;t<3&&f<999;){f++;const s=D(o),u=D(o);e.grid[s][u]===0&&Math.random()<.5&&(e.grid[s][u]=2,t++)}F("THE SUMMIT WATCHES…","#ff4422",40)}else if(l==="dead_ends"){let t=0,f=0;for(;t<4&&f<999;){f++;const s=1+D(o-2),u=1+D(o-2);e.grid[s][u]===0&&(e.grid[s][u]=5,t++)}F("THE LABYRINTH SHIFTS…","#cc8800",40)}if(Math.random()<.4){const t=D(o);for(let f=0;f<o;f++)e.grid[t][f]===1?e.grid[t][f]=4:e.grid[t][f]===4&&Math.random()<.3&&(e.grid[t][f]=1);ge={row:t,col:-1,t:50},Ae=!0}}}function Xe(e,l,o,t){const f=(o||0)+1;De();const s=Y[e%Y.length];ze(s.matrixDefault);const u=yl(s,Re(),f,l,t,h.maxHp,be);return Nl(de(),he()),Ie=[],Ee=500+D(500),Je(de(),he()),u}function te(e){sl(),fl(),I.dreamIdx=e||0,window._insightTokens=0,window._dreamIdx=I.dreamIdx,b=Xe(I.dreamIdx,0,0,void 0),k("playing"),Me=0,Ve(0),cancelAnimationFrame(q),q=requestAnimationFrame(j)}function Bl(){const e=b,l=(I.dreamIdx+1)%Y.length;I.dreamIdx=l,window._dreamIdx=l,nl(e.ds.id),ce={text:e.ds.completionText,subtext:Y[l].narrative,timer:220,ds:Y[l]},k("interlude"),setTimeout(()=>{De(),b=Xe(l,e.score+400+e.level*60,e.level,e.hp),b.msg=Y[l].name,b.msgColor="#ffdd00",b.msgTimer=90,B==="interlude"&&k("playing")},3600)}function kl(e){const l=oe.find(o=>o.id===e);!l||Z<l.cost||Ye(e)||(We(l.cost),window._insightTokens=Z,e==="maxhp"&&(h.maxHp+=25,b&&(b.hp=Math.min(b.hp+25,h.maxHp))),e==="speed"&&(h.moveDelay=Math.max(55,h.moveDelay-15)),e==="magnet"&&(h.magnet=!0),e==="freeze"&&(h.freeze=!0),e==="aura"&&(h.aura=!0),e==="energy"&&(h.energyMax=Math.min(200,h.energyMax+30)),e==="rewind"&&(h.temporalRewind=!0),e==="pulse"&&(h.glitchPulse=!0))}function j(e){const l=e-Be;Be=e;const o=de(),t=he();if(B==="title"){Cl(J,o,t,Te,e,R.menu),q=requestAnimationFrame(j);return}if(B==="dreamselect"){Rl(J,o,t,I.dreamIdx),q=requestAnimationFrame(j);return}if(B==="options"){Ml(J,o,t,R.opt),q=requestAnimationFrame(j);return}if(B==="highscores"){Il(J,o,t,Ce),q=requestAnimationFrame(j);return}if(B==="upgrade"){Pl(J,o,t,R.shop,Z,Ye),q=requestAnimationFrame(j);return}if(B==="dead"){vl(J,o,t,b,Ce,be,Z,_e),q=requestAnimationFrame(j);return}if(B==="paused"){Dl(J,o,t,b,R.pause),q=requestAnimationFrame(j);return}if(B==="interlude"){Ll(J,o,t,ce,e),ce.timer--,ce.timer<=0&&B==="interlude"&&k("playing"),q=requestAnimationFrame(j);return}const f=b.slowMoves?h.moveDelay*1.5:h.moveDelay,s={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};if(e-Me>f){for(const[u,[n,d]]of Object.entries(s))if(x.has(u)){Al(b,n,d,Q,Bl,F,Z,m=>{for(;Z<m;)tl();window._insightTokens=Z}),Me=e;break}}if(b.emotionTimer>0&&(b.emotionTimer--,b.emotionTimer<=0&&(b.slowMoves=!1,h.emotion="neutral")),il(l),Q==="B"&&se>4e3&&Math.random()<2e-4*l&&(b.hp=Math.min(h.maxHp,b.hp+1)),Q==="A"&&se>2500&&Math.random()<3e-4*l&&(b.hp=Math.max(0,b.hp-1)),Ee-=l,Ee<=0&&(ke=2+D(4),Ee=500+D(700)),Ae&&(ge.t--,ge.t<=0&&(Ae=!1)),b.environmentTimer-=l,b.environmentTimer<=0&&(b.environmentTimer=900+D(700),Math.random()<.6&&Hl(b)),cl(b,l),ml(b,l,x,Q,Ie,F,me),b.hp<=0){Ol(b.score,b.level,b.ds),k("dead"),q=requestAnimationFrame(j);return}Tl(J,e,b,Q,Te,Pe,Ie,Ae,ge,ke),q=requestAnimationFrame(j)}window.addEventListener("keydown",e=>{if(x.add(e.key),B==="title"){e.key==="ArrowUp"&&(R.menu=(R.menu-1+5)%5),e.key==="ArrowDown"&&(R.menu=(R.menu+1)%5),(e.key==="Enter"||e.key===" ")&&(R.menu===0?te(I.dreamIdx):R.menu===1?k("dreamselect"):R.menu===2?(R.opt=0,k("options")):R.menu===3?k("highscores"):R.menu===4&&(R.shop=0,R.upgradeFrom="title",k("upgrade"))),e.preventDefault();return}if(B==="dreamselect"){e.key==="ArrowUp"&&(I.dreamIdx=(I.dreamIdx-1+Y.length)%Y.length),e.key==="ArrowDown"&&(I.dreamIdx=(I.dreamIdx+1)%Y.length),e.key==="Enter"&&te(I.dreamIdx),e.key==="Escape"&&k("title"),e.preventDefault();return}if(B==="options"){if(e.key==="ArrowUp"&&(R.opt=(R.opt-1+4)%4),e.key==="ArrowDown"&&(R.opt=(R.opt+1)%4),e.key==="ArrowLeft"||e.key==="ArrowRight"){const o=e.key==="ArrowLeft"?-1:1;if(R.opt===0){const t=["small","medium","large"].indexOf(I.gridSize);I.gridSize=["small","medium","large"][(t+o+3)%3]}else if(R.opt===1){const t=["easy","normal","hard"].indexOf(I.difficulty);I.difficulty=["easy","normal","hard"][(t+o+3)%3]}else R.opt===2&&(I.particles=!I.particles)}(e.key==="Enter"||e.key==="Escape")&&(R.opt===3||e.key==="Escape")&&k(b?"paused":"title"),e.preventDefault();return}if(B==="highscores"){(e.key==="Enter"||e.key==="Escape")&&k("title"),e.preventDefault();return}if(B==="upgrade"){e.key==="ArrowUp"&&(R.shop=(R.shop-1+oe.length)%oe.length),e.key==="ArrowDown"&&(R.shop=(R.shop+1)%oe.length),e.key==="Enter"&&kl(oe[R.shop].id),e.key==="Escape"&&k(R.upgradeFrom==="paused"?"paused":"title"),e.preventDefault();return}if(B==="dead"){(e.key==="Enter"||e.key===" ")&&te(I.dreamIdx),e.key==="Escape"&&(k("title"),R.menu=0),e.preventDefault();return}if(B==="paused"){e.key==="ArrowUp"&&(R.pause=(R.pause-1+4)%4),e.key==="ArrowDown"&&(R.pause=(R.pause+1)%4),e.key==="Enter"&&(R.pause===0?k("playing"):R.pause===1?(R.opt=0,k("options")):R.pause===2?(R.shop=0,R.upgradeFrom="paused",k("upgrade")):(k("title"),R.menu=0,b=null)),e.key==="Escape"&&k("playing"),e.preventDefault();return}if(B==="playing"){if(e.key==="Escape"&&(R.pause=0,k("paused")),e.key==="Shift"&&!e.repeat){const o=Q==="A"?"B":"A";ze(o),Ve(0);const t=o==="A"?"MATRIX·A  ⟨ERASURE⟩":"MATRIX·B  ⟨COHERENCE⟩",f=o==="A"?"#ff0055":"#00ff88";F(t,f,55),I.particles&&V(b,b.player.x,b.player.y,f,22,4)}(e.key==="j"||e.key==="J")&&!e.repeat&&(b.archetypeActive||h.temporalRewind&&h.rewindBuffer.length>0?He(b):F("NO ARCHETYPE ACTIVE","#334455",25)),(e.key==="r"||e.key==="R")&&!e.repeat&&(h.glitchPulse&&h.glitchPulseCharge>=100?gl(b,F):h.glitchPulse?F("CHARGING… "+Math.round(h.glitchPulseCharge)+"%","#660088",22):F("BUY GLITCH PULSE IN UPGRADES","#334455",28)),(e.key==="q"||e.key==="Q")&&!e.repeat&&h.freeze&&h.freezeTimer<=0&&(h.freezeTimer=2500,F("FREEZE ACTIVE!","#0088ff",50),V(b,b.player.x,b.player.y,"#0088ff",20,4)),(e.key==="c"||e.key==="C")&&!e.repeat&&(Z>=2?(We(2),window._insightTokens=Z,b.contZones||(b.contZones=[]),b.contZones.push({x:b.player.x,y:b.player.y,timer:240,maxTimer:240}),F("CONTAINMENT ZONE","#00ffcc",38)):F("NEED 2 ◆ FOR CONTAINMENT","#334455",28))}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()});window.addEventListener("keyup",e=>x.delete(e.key));function we(e,l){const o=document.getElementById(e);if(!o)return;let t;o.addEventListener("touchstart",f=>{f.preventDefault(),x.add(l),B==="title"&&te(I.dreamIdx),t=()=>x.delete(l)},{passive:!1}),o.addEventListener("touchend",f=>{f.preventDefault(),t&&t()},{passive:!1}),o.addEventListener("mousedown",()=>{x.add(l),B==="title"&&te(I.dreamIdx)}),o.addEventListener("mouseup",()=>x.delete(l))}we("btn-up","ArrowUp");we("btn-down","ArrowDown");we("btn-left","ArrowLeft");we("btn-right","ArrowRight");ae.addEventListener("click",()=>{B==="title"&&te(I.dreamIdx)});Ue(qe());Je(de(),he());q=requestAnimationFrame(j);
